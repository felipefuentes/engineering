<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Hub de Tecnologia - Ferramenta Executiva para gestão de frentes de engenharia, jornadas e maturidade de sistemas">
    <meta name="keywords" content="engenharia, tecnologia, maturidade, gestão, incidentes, SRE">
    <meta name="author" content="Engineering Team">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="Hub de Tecnologia - Ferramenta Executiva">
    <meta property="og:description" content="Gestão de frentes de engenharia, jornadas e maturidade de sistemas">
    
    <!-- Twitter -->
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Hub de Tecnologia - Ferramenta Executiva">
    <meta name="twitter:description" content="Gestão de frentes de engenharia, jornadas e maturidade de sistemas">
    
    <title>Hub de Tecnologia - Ferramenta Executiva</title>
    
    <!-- Preconnect para melhorar performance de recursos externos -->
    <link rel="preconnect" href="https://cdn.tailwindcss.com" crossorigin>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- SheetJS para manipulação de arquivos Excel -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    
    <!-- Font Awesome com integridade e crossorigin -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" 
          integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" 
          crossorigin="anonymous" referrerpolicy="no-referrer">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; }
        .star-filled { color: #facc15; }
        .star-empty { color: #e2e8f0; }
        .modal-overlay { animation: fadeIn 0.3s ease-in; }
        .modal-panel { animation: scaleIn 0.3s ease-out; max-height: 85vh; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes scaleIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .edit-modal { animation: zoomIn 0.3s ease-out; }
        @keyframes zoomIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        input, textarea, select { border: 1px solid #e2e8f0; border-radius: 0.375rem; padding: 0.5rem; font-family: inherit; }
        input:focus, textarea:focus, select:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        .filter-panel { animation: slideDown 0.3s ease-out; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .tab-button { padding: 0.75rem 1rem; border: none; background: none; cursor: pointer; font-weight: 600; border-bottom: 3px solid transparent; transition: all 0.3s; }
        .tab-button.active { color: #3b82f6; border-bottom-color: #3b82f6; }
        .tab-button:hover { color: #3b82f6; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .maturity-cell { cursor: pointer; transition: all 0.3s; border-radius: 0.5rem; padding: 1rem; text-align: center; font-weight: 600; border: 2px solid transparent; }
        .maturity-cell:hover { transform: scale(1.05); border-color: #3b82f6; }
        .maturity-0 { background-color: #fee2e2; color: #991b1b; }
        .maturity-25 { background-color: #fecaca; color: #7f1d1d; }
        .maturity-50 { background-color: #fbbf24; color: #78350f; }
        .maturity-75 { background-color: #86efac; color: #15803d; }
        .maturity-100 { background-color: #4ade80; color: #166534; }
        .slider-container { display: flex; align-items: center; gap: 1rem; }
        .slider-container input[type="range"] { flex: 1; padding: 0; height: 0.5rem; border: none; border-radius: 0.25rem; background: #e2e8f0; outline: none; -webkit-appearance: none; appearance: none; }
        .slider-container input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 1.5rem; height: 1.5rem; border-radius: 50%; background: #3b82f6; cursor: pointer; }
        .slider-container input[type="range"]::-moz-range-thumb { width: 1.5rem; height: 1.5rem; border-radius: 50%; background: #3b82f6; cursor: pointer; border: none; }
        .incident-badge { display: inline-block; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; }
        .incident-critical { background-color: #fee2e2; color: #991b1b; }
        .incident-high { background-color: #fecaca; color: #7f1d1d; }
        .incident-medium { background-color: #fbbf24; color: #78350f; }
        .incident-low { background-color: #86efac; color: #15803d; }
        .front-card { transition: all 0.3s; border: 2px solid #e2e8f0; }
        .front-card:hover { border-color: #3b82f6; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15); }
        .journey-card { transition: all 0.3s; border: 2px solid #e2e8f0; }
        .journey-card:hover { border-color: #3b82f6; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15); }
        .journey-card-actions { opacity: 0; transition: opacity 0.3s; }
        .journey-card:hover .journey-card-actions { opacity: 1; }
        .project-card { transition: all 0.3s; }
        .project-card-actions { opacity: 0; transition: opacity 0.3s; }
        .project-card:hover .project-card-actions { opacity: 1; }
        .incident-counter { cursor: pointer; transition: all 0.3s; }
        .incident-counter:hover { transform: scale(1.05); }
        .tag { display: inline-block; padding: 0.25rem 0.75rem; border-radius: 0.375rem; font-size: 0.75rem; font-weight: 600; margin-right: 0.5rem; margin-bottom: 0.5rem; }
        .tag-pillar { background-color: #dbeafe; color: #1e40af; }
        .tag-attribute { background-color: #f0fdf4; color: #166534; }
        .tag-mttr { background-color: #fef3c7; color: #92400e; }
        /* Acessibilidade: classe para elementos visuais apenas para leitores de tela */
        .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border-width: 0; }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-slate-100">
    <div id="app" role="main" aria-label="Aplicação Hub de Tecnologia"></div>
    <div id="aria-live-region" role="status" aria-live="polite" aria-atomic="true" class="sr-only"></div>

    <script>
        // Dados padrão das Frentes de Engenharia
        const defaultFronts = [
            {
                id: "1",
                name: "Gestão de Incidentes",
                ownerName: "Carlos Silva",
                ownerInitials: "CS",
                maturityLevel: 4,
                status: "in-progress",
                mainObjectives: ["Reduzir MTTR em 30%", "Implementar alertas automáticos", "Criar playbooks de resposta"],
                currentActions: ["Implementação de sistema de ticketing", "Treinamento de equipe", "Documentação de processos"],
                futureActions: ["Automação de resposta", "Integração com ferramentas de IA", "Análise preditiva de incidentes"],
                attentionPoints: ["Falta de automação em alertas", "Documentação incompleta"],
                maturityLevels: [
                    { level: 1, description: "Ad hoc", expectations: [{ description: "Registro manual de incidentes", status: "done" }, { description: "Comunicação ad-hoc", status: "done" }], problemsAvoided: [], evolutionIndicators: ["Tempo de resposta > 4 horas"] },
                    { level: 2, description: "Emergente", expectations: [{ description: "Processo de escalação definido", status: "done" }, { description: "Documentação básica", status: "in-progress" }], problemsAvoided: ["Confusão na escalação"], evolutionIndicators: ["MTTR reduzido para 2 horas"] },
                    { level: 3, description: "Padronizado", expectations: [{ description: "Métricas de incidente rastreadas", status: "done" }, { description: "Alertas automáticos", status: "in-progress" }], problemsAvoided: ["Perda de dados de incidentes", "Falta de rastreabilidade"], evolutionIndicators: ["MTTR < 1 hora", "Resolução em 1º nível > 60%"] },
                    { level: 4, description: "Integrado", expectations: [{ description: "Automação de resposta", status: "in-progress" }, { description: "Análise de causa raiz automatizada", status: "not-done" }], problemsAvoided: ["Erros humanos", "Atrasos na resposta"], evolutionIndicators: ["MTTR < 30 min", "Automação > 70%"] },
                    { level: 5, description: "Estratégico", expectations: [{ description: "Previsão de incidentes", status: "not-done" }, { description: "Auto-cicatrização", status: "not-done" }], problemsAvoided: ["Incidentes recorrentes"], evolutionIndicators: ["Redução de 90% em incidentes", "MTTR < 5 min"] }
                ]
            },
            {
                id: "2",
                name: "Gestão de Observabilidade",
                ownerName: "Ana Costa",
                ownerInitials: "AC",
                maturityLevel: 3,
                status: "in-progress",
                mainObjectives: ["Visibilidade completa dos sistemas", "Detecção proativa de anomalias", "Reduzir tempo de diagnóstico"],
                currentActions: ["Implementação de APM", "Centralização de logs", "Criação de dashboards"],
                futureActions: ["Machine learning para anomalias", "Correlação automática de eventos", "Alertas inteligentes"],
                attentionPoints: ["Retenção de dados cara", "Falta de padronização em logs"],
                maturityLevels: [
                    { level: 1, description: "Ad hoc", expectations: [{ description: "Logs em arquivo", status: "done" }, { description: "Monitoramento manual", status: "done" }], problemsAvoided: [], evolutionIndicators: ["Tempo de diagnóstico > 4 horas"] },
                    { level: 2, description: "Emergente", expectations: [{ description: "Logs centralizados", status: "done" }, { description: "Métricas básicas", status: "in-progress" }], problemsAvoided: ["Perda de logs"], evolutionIndicators: ["Tempo de diagnóstico 2-3 horas"] },
                    { level: 3, description: "Padronizado", expectations: [{ description: "Traces distribuídos", status: "done" }, { description: "Dashboards executivos", status: "done" }], problemsAvoided: ["Perda de contexto", "Diagnóstico lento"], evolutionIndicators: ["Tempo de diagnóstico < 30 min", "Cobertura > 80%"] },
                    { level: 4, description: "Integrado", expectations: [{ description: "Detecção de anomalias", status: "in-progress" }, { description: "Alertas inteligentes", status: "not-done" }], problemsAvoided: ["Alertas falsos"], evolutionIndicators: ["Tempo de diagnóstico < 10 min"] },
                    { level: 5, description: "Estratégico", expectations: [{ description: "Previsão de problemas", status: "not-done" }, { description: "Otimização automática", status: "not-done" }], problemsAvoided: ["Incidentes antes de ocorrer"], evolutionIndicators: ["Prevenção de 80% dos problemas"] }
                ]
            },
            {
                id: "3",
                name: "Gestão de Riscos",
                ownerName: "Roberto Mendes",
                ownerInitials: "RM",
                maturityLevel: 2,
                status: "at-risk",
                mainObjectives: ["Identificar riscos técnicos", "Priorizar mitigação", "Rastrear ações de risco"],
                currentActions: ["Registro de riscos iniciado", "Reuniões trimestrais de risco"],
                futureActions: ["Análise quantitativa de risco", "Monitoramento contínuo", "Integração com roadmap"],
                attentionPoints: ["Falta de propriedade clara", "Processo informal"],
                maturityLevels: [
                    { level: 1, description: "Ad hoc", expectations: [{ description: "Identificação ad-hoc", status: "done" }], problemsAvoided: [], evolutionIndicators: ["Riscos não documentados"] },
                    { level: 2, description: "Emergente", expectations: [{ description: "Registro de riscos", status: "done" }, { description: "Revisão periódica", status: "in-progress" }], problemsAvoided: ["Perda de histórico de risco"], evolutionIndicators: ["Cobertura de riscos > 50%"] },
                    { level: 3, description: "Padronizado", expectations: [{ description: "Matriz de risco", status: "not-done" }, { description: "Planos de mitigação", status: "not-done" }], problemsAvoided: [], evolutionIndicators: [] },
                    { level: 4, description: "Integrado", expectations: [{ description: "Análise de impacto", status: "not-done" }], problemsAvoided: [], evolutionIndicators: [] },
                    { level: 5, description: "Estratégico", expectations: [{ description: "Previsão de riscos", status: "not-done" }], problemsAvoided: [], evolutionIndicators: [] }
                ]
            },
            {
                id: "4",
                name: "Gestão de Alertas",
                ownerName: "Fernanda Oliveira",
                ownerInitials: "FO",
                maturityLevel: 3,
                status: "in-progress",
                mainObjectives: ["Reduzir ruído de alertas", "Melhorar precisão", "Implementar correlação"],
                currentActions: ["Implementação de plataforma de alertas", "Definição de thresholds", "Integração com canais de notificação"],
                futureActions: ["Machine learning para detecção de anomalias", "Agrupamento inteligente de alertas", "Análise de padrões"],
                attentionPoints: ["Muitos alertas falsos", "Falta de contexto nos alertas"],
                maturityLevels: [
                    { level: 1, description: "Ad hoc", expectations: [{ description: "Alertas por email", status: "done" }], problemsAvoided: [], evolutionIndicators: ["Tempo de notificação > 2 horas"] },
                    { level: 2, description: "Emergente", expectations: [{ description: "Plataforma centralizada", status: "done" }, { description: "Múltiplos canais", status: "in-progress" }], problemsAvoided: ["Perda de alertas"], evolutionIndicators: ["Tempo de notificação < 30 min"] },
                    { level: 3, description: "Padronizado", expectations: [{ description: "Correlação de alertas", status: "done" }, { description: "Supressão de duplicatas", status: "done" }], problemsAvoided: ["Ruído de alertas"], evolutionIndicators: ["Redução de 40% em alertas", "Tempo < 5 min"] },
                    { level: 4, description: "Integrado", expectations: [{ description: "Detecção de anomalias", status: "not-done" }], problemsAvoided: [], evolutionIndicators: [] },
                    { level: 5, description: "Estratégico", expectations: [{ description: "Alertas preditivos", status: "not-done" }], problemsAvoided: [], evolutionIndicators: [] }
                ]
            },
            {
                id: "5",
                name: "Gestão de Indicadores de Segurança",
                ownerName: "Marcelo Santos",
                ownerInitials: "MS",
                maturityLevel: 2,
                status: "at-risk",
                mainObjectives: ["Implementar SIEM", "Rastrear vulnerabilidades", "Conformidade regulatória"],
                currentActions: ["Coleta de logs de segurança", "Análise de vulnerabilidades"],
                futureActions: ["Implementação de SIEM", "Automação de resposta", "Conformidade com LGPD"],
                attentionPoints: ["Falta de automação", "Recursos limitados"],
                maturityLevels: [
                    { level: 1, description: "Ad hoc", expectations: [{ description: "Análise manual", status: "done" }], problemsAvoided: [], evolutionIndicators: [] },
                    { level: 2, description: "Emergente", expectations: [{ description: "Coleta de logs", status: "done" }, { description: "Análise básica", status: "in-progress" }], problemsAvoided: ["Perda de evidência"], evolutionIndicators: ["Cobertura > 50%"] },
                    { level: 3, description: "Padronizado", expectations: [{ description: "SIEM operacional", status: "not-done" }, { description: "Alertas de segurança", status: "not-done" }], problemsAvoided: [], evolutionIndicators: [] },
                    { level: 4, description: "Integrado", expectations: [{ description: "Resposta automática", status: "not-done" }], problemsAvoided: [], evolutionIndicators: [] },
                    { level: 5, description: "Estratégico", expectations: [{ description: "Prevenção de ataques", status: "not-done" }], problemsAvoided: [], evolutionIndicators: [] }
                ]
            },
            {
                id: "6",
                name: "Gestão de Infraestrutura",
                ownerName: "Lucas Ferreira",
                ownerInitials: "LF",
                maturityLevel: 4,
                status: "achieved",
                mainObjectives: ["Infraestrutura como código", "Escalabilidade automática", "Disaster recovery"],
                currentActions: ["Terraform para IaC", "Kubernetes em produção", "Backup automático"],
                futureActions: ["Multi-cloud strategy", "Edge computing", "Otimização de custos"],
                attentionPoints: [],
                maturityLevels: [
                    { level: 1, description: "Ad hoc", expectations: [{ description: "Provisionamento manual", status: "done" }], problemsAvoided: [], evolutionIndicators: [] },
                    { level: 2, description: "Emergente", expectations: [{ description: "Scripts de automação", status: "done" }], problemsAvoided: ["Erros humanos"], evolutionIndicators: [] },
                    { level: 3, description: "Padronizado", expectations: [{ description: "Terraform", status: "done" }, { description: "Versionamento", status: "done" }], problemsAvoided: ["Drift de configuração"], evolutionIndicators: ["Cobertura > 80%"] },
                    { level: 4, description: "Integrado", expectations: [{ description: "100% IaC", status: "done" }, { description: "GitOps", status: "done" }], problemsAvoided: ["Inconsistências"], evolutionIndicators: ["Tempo de deploy < 5 min"] },
                    { level: 5, description: "Estratégico", expectations: [{ description: "Auto-scaling inteligente", status: "not-done" }], problemsAvoided: [], evolutionIndicators: [] }
                ]
            },
            {
                id: "7",
                name: "Gestão de Qualidade de Testes",
                ownerName: "Patricia Gomes",
                ownerInitials: "PG",
                maturityLevel: 3,
                status: "in-progress",
                mainObjectives: ["Aumentar cobertura de testes", "Testes automatizados", "Qualidade de código"],
                currentActions: ["Implementação de testes unitários", "Testes de integração", "CI/CD pipeline"],
                futureActions: ["Testes de performance", "Testes de segurança", "Análise de cobertura"],
                attentionPoints: ["Cobertura ainda baixa", "Testes frágeis"],
                maturityLevels: [
                    { level: 1, description: "Ad hoc", expectations: [{ description: "Testes manuais", status: "done" }], problemsAvoided: [], evolutionIndicators: ["Cobertura < 20%"] },
                    { level: 2, description: "Emergente", expectations: [{ description: "Testes unitários", status: "done" }, { description: "Cobertura básica", status: "in-progress" }], problemsAvoided: ["Regressões"], evolutionIndicators: ["Cobertura 20-40%"] },
                    { level: 3, description: "Padronizado", expectations: [{ description: "Testes de integração", status: "done" }, { description: "CI/CD", status: "done" }], problemsAvoided: ["Bugs em produção"], evolutionIndicators: ["Cobertura > 60%", "Build time < 10 min"] },
                    { level: 4, description: "Integrado", expectations: [{ description: "Testes de performance", status: "not-done" }, { description: "Testes de segurança", status: "not-done" }], problemsAvoided: [], evolutionIndicators: [] },
                    { level: 5, description: "Estratégico", expectations: [{ description: "Testes com IA", status: "not-done" }], problemsAvoided: [], evolutionIndicators: [] }
                ]
            },
            {
                id: "8",
                name: "Gestão de SRE",
                ownerName: "Gabriel Costa",
                ownerInitials: "GC",
                maturityLevel: 3,
                status: "in-progress",
                mainObjectives: ["Implementar SLO/SLI", "Error budget", "Cultura de confiabilidade"],
                currentActions: ["Definição de SLO", "Implementação de SLI", "Runbooks"],
                futureActions: ["Error budget tracking", "Chaos engineering", "Treinamento contínuo"],
                attentionPoints: ["Falta de alinhamento com produto", "Recursos limitados"],
                maturityLevels: [
                    { level: 1, description: "Ad hoc", expectations: [{ description: "Resposta a incidentes", status: "done" }], problemsAvoided: [], evolutionIndicators: [] },
                    { level: 2, description: "Emergente", expectations: [{ description: "Runbooks", status: "done" }, { description: "On-call", status: "in-progress" }], problemsAvoided: ["Resposta desorganizada"], evolutionIndicators: ["MTTR reduzido"] },
                    { level: 3, description: "Padronizado", expectations: [{ description: "SLO definido", status: "done" }, { description: "SLI implementado", status: "done" }], problemsAvoided: ["Expectativas não alinhadas"], evolutionIndicators: ["Uptime > 99.5%", "Error budget tracking"] },
                    { level: 4, description: "Integrado", expectations: [{ description: "Chaos engineering", status: "not-done" }, { description: "Automação", status: "not-done" }], problemsAvoided: [], evolutionIndicators: [] },
                    { level: 5, description: "Estratégico", expectations: [{ description: "Previsão de falhas", status: "not-done" }], problemsAvoided: [], evolutionIndicators: [] }
                ]
            },
            {
                id: "9",
                name: "Gestão de Jornadas",
                ownerName: "Beatriz Lima",
                ownerInitials: "BL",
                maturityLevel: 2,
                status: "in-progress",
                mainObjectives: ["Mapear jornadas críticas", "Monitorar experiência", "Melhorar satisfação"],
                currentActions: ["Identificação de jornadas", "Instrumentação básica"],
                futureActions: ["Monitoramento de experiência", "Análise de impacto", "Otimização contínua"],
                attentionPoints: ["Falta de visibilidade", "Dados incompletos"],
                maturityLevels: [
                    { level: 1, description: "Ad hoc", expectations: [{ description: "Conhecimento informal", status: "done" }], problemsAvoided: [], evolutionIndicators: [] },
                    { level: 2, description: "Emergente", expectations: [{ description: "Jornadas identificadas", status: "done" }, { description: "Instrumentação", status: "in-progress" }], problemsAvoided: ["Falta de contexto"], evolutionIndicators: ["Cobertura > 50%"] },
                    { level: 3, description: "Padronizado", expectations: [{ description: "Monitoramento contínuo", status: "not-done" }, { description: "Dashboards", status: "not-done" }], problemsAvoided: [], evolutionIndicators: [] },
                    { level: 4, description: "Integrado", expectations: [{ description: "Análise de impacto", status: "not-done" }], problemsAvoided: [], evolutionIndicators: [] },
                    { level: 5, description: "Estratégico", expectations: [{ description: "Otimização automática", status: "not-done" }], problemsAvoided: [], evolutionIndicators: [] }
                ]
            },
            {
                id: "10",
                name: "Gestão de Contingência",
                ownerName: "Ricardo Alves",
                ownerInitials: "RA",
                maturityLevel: 2,
                status: "at-risk",
                mainObjectives: ["Planos de contingência", "Testes de DR", "Recuperação rápida"],
                currentActions: ["Documentação de planos", "Backups"],
                futureActions: ["Testes de DR regulares", "Automação de failover", "Simulações"],
                attentionPoints: ["Planos desatualizados", "Falta de testes"],
                maturityLevels: [
                    { level: 1, description: "Ad hoc", expectations: [{ description: "Resposta ad-hoc", status: "done" }], problemsAvoided: [], evolutionIndicators: [] },
                    { level: 2, description: "Emergente", expectations: [{ description: "Plano documentado", status: "done" }, { description: "Backups", status: "done" }], problemsAvoided: ["Perda de dados"], evolutionIndicators: ["RTO > 4 horas"] },
                    { level: 3, description: "Padronizado", expectations: [{ description: "Testes de DR", status: "not-done" }, { description: "Documentação atualizada", status: "not-done" }], problemsAvoided: [], evolutionIndicators: [] },
                    { level: 4, description: "Integrado", expectations: [{ description: "Failover automático", status: "not-done" }], problemsAvoided: [], evolutionIndicators: [] },
                    { level: 5, description: "Estratégico", expectations: [{ description: "Zero downtime", status: "not-done" }], problemsAvoided: [], evolutionIndicators: [] }
                ]
            }
        ];

        // Dados padrão das Jornadas
        const defaultJourneys = [
            {
                id: "j1",
                name: "Autenticação de Usuário",
                acronym: "AUTH",
                status: "active",
                owner: "João Silva",
                events: [
                    {
                        id: "inc1",
                        category: "Incidentes",
                        incidentNumber: "INC-2024-001",
                        date: "2024-01-15T14:30:00",
                        mttr: "2h 15min",
                        description: "Falha na autenticação de usuários",
                        affectedJourney: "j1",
                        relatedRisk: "Indisponibilidade do serviço",
                        origin: "Infraestrutura",
                        prevention: "Implementar health checks mais frequentes",
                        lessons: "Necessário melhorar monitoramento de banco de dados",
                        pillar: "availability",
                        attributes: ["Observability", "Alertas"]
                    }
                ],
                maturity: {
                    availability: {
                        "Arquitetura Escalável": 80,
                        "Self Healing": 60,
                        "Auto Scaling": 75,
                        "Alertas": 85,
                        "Observability": 70,
                        "Documentação": 65,
                        "Retentativa Simples": 90,
                        "Retentativa Exponencial": 75,
                        "Rate Limit": 80,
                        "Fallback": 70,
                        "Disponibilidade Multicloud": 50,
                        "Há Contingência": 60
                    },
                    quality: {
                        "Testes Unitários": 85,
                        "Testes Integração": 80,
                        "Testes Mutação": 60,
                        "Testes E2E": 75,
                        "Testes Estresse": 70,
                        "Teste Auto CI": 90,
                        "Deploy Canary": 80,
                        "Deploy Blue e Green": 75,
                        "Segregação Erros Negocio": 85,
                        "Segregação Erros Aplicação": 80,
                        "Feature Toggle": 70
                    },
                    security: {
                        "Criptografia de Dados em Trânsito": 95,
                        "Criptografia de Dados em Repouso": 90,
                        "Autenticação Multifator": 85,
                        "Validação de Entrada": 90,
                        "Proteção contra OWASP Top 10": 80,
                        "Auditoria de Acesso": 85,
                        "Gerenciamento de Secrets": 80,
                        "Testes de Segurança": 70,
                        "Conformidade Regulatória": 75,
                        "Rotação de Credenciais": 80,
                        "Detecção de Anomalias": 60,
                        "Isolamento de Rede": 85
                    },
                    performance: {
                        "Otimização de Queries": 80,
                        "Cache Strategy": 85,
                        "CDN Utilization": 75,
                        "Compressão de Dados": 90,
                        "Lazy Loading": 80,
                        "Minificação de Assets": 85,
                        "Database Indexing": 85,
                        "Connection Pooling": 80,
                        "Monitoring de Performance": 75,
                        "Load Testing": 70,
                        "Profiling de Código": 65,
                        "Otimização de Memória": 75
                    }
                }
            },
            {
                id: "j2",
                name: "Processamento de Pagamentos",
                acronym: "PAY",
                status: "active",
                owner: "Maria Santos",
                events: [
                    {
                        id: "inc2",
                        category: "Incidentes",
                        incidentNumber: "INC-2024-002",
                        date: "2024-01-20T10:00:00",
                        mttr: "45min",
                        description: "Timeout em processamento de pagamento",
                        affectedJourney: "j2",
                        relatedRisk: "Perda de receita",
                        origin: "Aplicação",
                        prevention: "Aumentar timeout e implementar circuit breaker",
                        lessons: "Necessário testes de carga mais realistas",
                        pillar: "performance",
                        attributes: ["Connection Pooling", "Load Testing"]
                    },
                    {
                        id: "inc3",
                        category: "Incidentes",
                        incidentNumber: "INC-2024-003",
                        date: "2024-01-25T16:20:00",
                        mttr: "1h 30min",
                        description: "Falha de segurança em validação de cartão",
                        affectedJourney: "j2",
                        relatedRisk: "Comprometimento de dados de clientes",
                        origin: "Mudança",
                        prevention: "Implementar validação mais rigorosa",
                        lessons: "Código review insuficiente antes do deploy",
                        pillar: "security",
                        attributes: ["Validação de Entrada", "Testes de Segurança"]
                    }
                ],
                maturity: {
                    availability: {
                        "Arquitetura Escalável": 85,
                        "Self Healing": 70,
                        "Auto Scaling": 80,
                        "Alertas": 90,
                        "Observability": 85,
                        "Documentação": 80,
                        "Retentativa Simples": 95,
                        "Retentativa Exponencial": 85,
                        "Rate Limit": 90,
                        "Fallback": 85,
                        "Disponibilidade Multicloud": 75,
                        "Há Contingência": 80
                    },
                    quality: {
                        "Testes Unitários": 90,
                        "Testes Integração": 85,
                        "Testes Mutação": 75,
                        "Testes E2E": 85,
                        "Testes Estresse": 80,
                        "Teste Auto CI": 95,
                        "Deploy Canary": 85,
                        "Deploy Blue e Green": 85,
                        "Segregação Erros Negocio": 95,
                        "Segregação Erros Aplicação": 90,
                        "Feature Toggle": 80
                    },
                    security: {
                        "Criptografia de Dados em Trânsito": 100,
                        "Criptografia de Dados em Repouso": 100,
                        "Autenticação Multifator": 90,
                        "Validação de Entrada": 95,
                        "Proteção contra OWASP Top 10": 95,
                        "Auditoria de Acesso": 95,
                        "Gerenciamento de Secrets": 95,
                        "Testes de Segurança": 90,
                        "Conformidade Regulatória": 95,
                        "Rotação de Credenciais": 90,
                        "Detecção de Anomalias": 85,
                        "Isolamento de Rede": 95
                    },
                    performance: {
                        "Otimização de Queries": 85,
                        "Cache Strategy": 90,
                        "CDN Utilization": 80,
                        "Compressão de Dados": 95,
                        "Lazy Loading": 85,
                        "Minificação de Assets": 90,
                        "Database Indexing": 90,
                        "Connection Pooling": 85,
                        "Monitoring de Performance": 85,
                        "Load Testing": 80,
                        "Profiling de Código": 75,
                        "Otimização de Memória": 80
                    }
                }
            }
        ];
        const pillarAttributes = {
            availability: {
                "Arquitetura Escalável": "Capacidade de crescer horizontalmente",
                "Self Healing": "Recuperação automática de falhas",
                "Auto Scaling": "Ajuste automático de recursos",
                "Alertas": "Sistema de alertas proativo",
                "Observability": "Visibilidade completa do sistema",
                "Documentação": "Documentação técnica atualizada",
                "Retentativa Simples": "Retry com intervalo fixo",
                "Retentativa Exponencial": "Retry com backoff exponencial",
                "Rate Limit": "Proteção contra sobrecarga",
                "Fallback": "Plano B quando principal falha",
                "Disponibilidade Multicloud": "Distribuição em múltiplas clouds",
                "Há Contingência": "Plano de contingência documentado"
            },
            quality: {
                "Testes Unitários": "Cobertura de testes unitários",
                "Testes Integração": "Testes de integração entre componentes",
                "Testes Mutação": "Testes de mutação de código",
                "Testes E2E": "Testes end-to-end",
                "Testes Estresse": "Testes sob carga extrema",
                "Teste Auto CI": "Automação em CI/CD",
                "Deploy Canary": "Deploy canário implementado",
                "Deploy Blue e Green": "Deploy blue-green disponível",
                "Segregação Erros Negocio": "Tratamento de erros de negócio",
                "Segregação Erros Aplicação": "Tratamento de erros de aplicação",
                "Feature Toggle": "Feature flags implementadas"
            },
            security: {
                "Criptografia de Dados em Trânsito": "Dados criptografados em transmissão",
                "Criptografia de Dados em Repouso": "Dados criptografados armazenados",
                "Autenticação Multifator": "MFA implementado",
                "Validação de Entrada": "Validação rigorosa de inputs",
                "Proteção contra OWASP Top 10": "Proteção contra vulnerabilidades OWASP",
                "Auditoria de Acesso": "Logs de auditoria de acesso",
                "Gerenciamento de Secrets": "Gestão segura de secrets",
                "Testes de Segurança": "Testes de segurança regulares",
                "Conformidade Regulatória": "Conformidade com regulamentações",
                "Rotação de Credenciais": "Rotação automática de credenciais",
                "Detecção de Anomalias": "Detecção de comportamentos anômalos",
                "Isolamento de Rede": "Isolamento de rede implementado"
            },
            performance: {
                "Otimização de Queries": "Queries otimizadas no banco de dados",
                "Cache Strategy": "Estratégia de cache implementada",
                "CDN Utilization": "Utilização de CDN",
                "Compressão de Dados": "Compressão de dados em trânsito",
                "Lazy Loading": "Carregamento lazy implementado",
                "Minificação de Assets": "Assets minificados",
                "Database Indexing": "Índices de banco de dados otimizados",
                "Connection Pooling": "Pool de conexões configurado",
                "Monitoring de Performance": "Monitoramento de performance",
                "Load Testing": "Testes de carga realizados",
                "Profiling de Código": "Profiling de código realizado",
                "Otimização de Memória": "Otimização de uso de memória"
            }
        };

        const statusConfig = {
            "at-risk": { label: "Risco", bgColor: "bg-red-100", textColor: "text-red-800" },
            "in-progress": { label: "Em Progresso", bgColor: "bg-blue-100", textColor: "text-blue-800" },
            "canceled": { label: "Cancelado", bgColor: "bg-gray-100", textColor: "text-gray-800" },
            "achieved": { label: "Atingido", bgColor: "bg-green-100", textColor: "text-green-800" }
        };

        const journeyStatusConfig = {
            "active": { label: "Ativa", bgColor: "bg-green-100", textColor: "text-green-800" },
            "inactive": { label: "Inativa", bgColor: "bg-gray-100", textColor: "text-gray-800" },
            "discovery": { label: "Em Discovery", bgColor: "bg-yellow-100", textColor: "text-yellow-800" }
        };

        const EVENT_CATEGORY_INCIDENT_SERVICE = 'Incidentes - Quebra de Serviço';
        const EVENT_CATEGORY_INCIDENT_FUNCTIONAL = 'Incidentes Funcionais';
        const EVENT_CATEGORY_ALERT = 'Alertas';
        const EVENT_CATEGORY_OBSOLESCENCE = 'Obsolescência';
        const EVENT_CATEGORY_VULNERABILITY = 'Vulnerabilidades';
        const EVENT_CATEGORY_RISK = 'Riscos';
        const eventCategories = [
            EVENT_CATEGORY_INCIDENT_SERVICE,
            EVENT_CATEGORY_INCIDENT_FUNCTIONAL,
            EVENT_CATEGORY_ALERT,
            EVENT_CATEGORY_OBSOLESCENCE,
            EVENT_CATEGORY_VULNERABILITY,
            "Requisições",
            "Problemas",
            EVENT_CATEGORY_RISK
        ];
        const supportedJourneyEventCategories = [
            EVENT_CATEGORY_INCIDENT_SERVICE,
            EVENT_CATEGORY_INCIDENT_FUNCTIONAL,
            EVENT_CATEGORY_ALERT,
            EVENT_CATEGORY_OBSOLESCENCE,
            EVENT_CATEGORY_VULNERABILITY,
            EVENT_CATEGORY_RISK
        ];
        const journeyDefaultExportOptions = () => ({
            journeys: true,
            events: eventCategories.reduce((acc, category) => {
                acc[category] = supportedJourneyEventCategories.includes(category);
                return acc;
            }, {})
        });
        let showJourneysExportModal = false;
        let showJourneysImportModal = false;
        let showJourneysImportResultModal = false;
        let journeysImportSummary = '';
        let journeysExportOptions = journeyDefaultExportOptions();
        const journeySheetColumns = [
            { header: 'ID', key: 'id' },
            { header: 'Nome', key: 'name' },
            { header: 'Sigla', key: 'acronym' },
            { header: 'Status (active/inactive/discovery)', key: 'status' },
            { header: 'Owner/Gestor', key: 'owner' }
        ];
        const incidentSheetColumns = [
            { header: 'Jornada ID (opcional)', key: 'journeyId' },
            { header: 'Jornada (Nome ou Sigla)', key: 'journeyRef' },
            { header: 'Número do Incidente', key: 'incidentNumber' },
            { header: 'Data/Horário', key: 'date' },
            { header: 'MTTR', key: 'mttr' },
            { header: 'Descrição', key: 'description' },
            { header: 'Risco Relacionado', key: 'relatedRisk' },
            { header: 'Origem', key: 'origin' },
            { header: 'Ações de Prevenção', key: 'prevention' },
            { header: 'Lições Aprendidas', key: 'lessons' },
            { header: 'Pilar (Disponibilidade/Qualidade/Segurança/Performance)', key: 'pillar' },
            { header: 'Atributos Impactados (separados por ;)', key: 'attributes' }
        ];
        const functionalIncidentSheetColumns = [
            { header: 'Jornada ID (opcional)', key: 'journeyId' },
            { header: 'Jornada (Nome ou Sigla)', key: 'journeyRef' },
            { header: 'Número do Incidente', key: 'incidentNumber' },
            { header: 'Sigla Relacionada', key: 'acronym' },
            { header: 'Data de Criação', key: 'createdAt' },
            { header: 'Data de Resolução', key: 'resolvedAt' },
            { header: 'Descrição Curta', key: 'shortDescription' },
            { header: 'Descrição', key: 'description' },
            { header: 'Notas de Resolução', key: 'resolutionNotes' },
            { header: 'Tipo de Resolução', key: 'resolutionType' },
            { header: 'Classificação', key: 'classification' }
        ];
        const alertSheetColumns = [
            { header: 'Jornada ID (opcional)', key: 'journeyId' },
            { header: 'Jornada (Nome ou Sigla)', key: 'journeyRef' },
            { header: 'Identificador do Alerta', key: 'alertId' },
            { header: 'Título / Descrição Curta', key: 'title' },
            { header: 'Fonte', key: 'source' },
            { header: 'Severidade', key: 'severity' },
            { header: 'Status', key: 'status' },
            { header: 'Data de Abertura', key: 'openedAt' },
            { header: 'Data de Fechamento', key: 'closedAt' },
            { header: 'Serviço Impactado', key: 'impactedService' },
            { header: 'Responsável', key: 'owner' },
            { header: 'Tags (separadas por ;)', key: 'tags' },
            { header: 'URL de Referência', key: 'url' },
            { header: 'Notas', key: 'notes' }
        ];
        const obsolescenceSheetColumns = [
            { header: 'Jornada ID (opcional)', key: 'journeyId' },
            { header: 'Jornada (Nome ou Sigla)', key: 'journeyRef' },
            { header: 'Componente/Produto', key: 'component' },
            { header: 'Fornecedor / Tecnologia', key: 'vendor' },
            { header: 'Versão Atual', key: 'currentVersion' },
            { header: 'Versão Recomendada', key: 'targetVersion' },
            { header: 'Data de Fim de Suporte', key: 'endOfSupport' },
            { header: 'Impacto', key: 'impact' },
            { header: 'Plano de Remediação', key: 'remediationPlan' },
            { header: 'Status', key: 'status' },
            { header: 'Responsável', key: 'owner' },
            { header: 'Notas', key: 'notes' }
        ];
        const vulnerabilitySheetColumns = [
            { header: 'Jornada ID (opcional)', key: 'journeyId' },
            { header: 'Jornada (Nome ou Sigla)', key: 'journeyRef' },
            { header: 'Identificador (CVE ou Ticket)', key: 'identifier' },
            { header: 'Severidade', key: 'severity' },
            { header: 'Pontuação CVSS', key: 'cvssScore' },
            { header: 'Componente/Serviço', key: 'affectedService' },
            { header: 'Data de Descoberta', key: 'discoveredAt' },
            { header: 'Prazo para Correção', key: 'dueAt' },
            { header: 'Status', key: 'status' },
            { header: 'Responsável', key: 'owner' },
            { header: 'Notas', key: 'notes' }
        ];
        const riskSheetColumns = [
            { header: 'Jornada ID (opcional)', key: 'journeyId' },
            { header: 'Jornada (Nome ou Sigla)', key: 'journeyRef' },
            { header: 'ID do Planner/Task', key: 'plannerId' },
            { header: 'Nome da Tarefa', key: 'taskName' },
            { header: 'Progresso (%)', key: 'progress' },
            { header: 'Prioridade', key: 'priority' },
            { header: 'Atribuído a', key: 'assignedTo' },
            { header: 'Criado por', key: 'createdBy' },
            { header: 'Criado em', key: 'createdAt' },
            { header: 'Data de Início', key: 'startDate' },
            { header: 'Data de Conclusão', key: 'dueDate' },
            { header: 'É Recorrente? (Sim/Não)', key: 'isRecurring' },
            { header: 'Está Atrasado? (Sim/Não)', key: 'isOverdue' },
            { header: 'Está Concluído? (Sim/Não)', key: 'isCompleted' },
            { header: 'Concluído em', key: 'completedAt' },
            { header: 'Concluído por', key: 'completedBy' },
            { header: 'Checklist', key: 'checklist' },
            { header: 'Rótulos', key: 'labels' },
            { header: 'Descrição', key: 'description' }
        ];
        const incidentOrigins = ["Mudança", "Projetos", "Infraestrutura", "Redes", "Parceiro", "Aplicação", "Banco de Dados"];
        const alertSeverityOptions = ["Critical", "High", "Medium", "Low", "Info"];
        const alertStatusOptions = ["Aberto", "Em tratamento", "Resolvido", "Cancelado"];
        const alertSourceOptions = ["Dynatrace", "ServiceNow", "Centro de Operações", "Outro"];
        const obsolescenceStatusOptions = ["Planejado", "Em andamento", "Concluído", "Postergado"];
        const vulnerabilitySeverityOptions = ["Critical", "High", "Medium", "Low"];
        const vulnerabilityStatusOptions = ["Aberta", "Em correção", "Validada", "Encerrada"];
const riskBucketOptions = ["Identificação", "Avaliação", "Mitigação", "Monitoramento", "Encerrado"];
const riskPriorityOptions = ["Critical", "High", "Medium", "Low"];

        let fronts = JSON.parse(localStorage.getItem('fronts')) || JSON.parse(JSON.stringify(defaultFronts));
        let journeys = JSON.parse(localStorage.getItem('journeys')) || JSON.parse(JSON.stringify(defaultJourneys));
        
        // Garantir que todas as jornadas tenham o campo owner
        journeys.forEach(journey => {
            if (!journey.hasOwnProperty('owner')) {
                journey.owner = '';
            }
        });
        if (journeys.some(j => !j.hasOwnProperty('owner'))) {
            saveJourneys();
        }
        (function normalizeJourneyEventsData() {
            let changed = false;
            journeys.forEach(journey => {
                if (!journey.events) return;
                journey.events.forEach(event => {
                    if (event.category === 'Incidentes') {
                        event.category = EVENT_CATEGORY_INCIDENT_SERVICE;
                        changed = true;
                    }
                });
            });
            if (changed) {
                saveJourneys();
            }
        })();
        // Migração: Atualizar descrições dos níveis de maturidade das frentes para nomenclatura padronizada
        (function migrateFrontMaturityLevels() {
            const targetDescriptions = {
                1: 'Ad hoc',
                2: 'Emergente',
                3: 'Padronizado',
                4: 'Integrado',
                5: 'Estratégico'
            };
            let changed = false;
            fronts.forEach(front => {
                if (!front.maturityLevels || !Array.isArray(front.maturityLevels)) return;
                front.maturityLevels.forEach(level => {
                    if (!level || !level.description) return;
                    const targetDescription = targetDescriptions[level.level];
                    if (!targetDescription) return;
                    // Atualiza qualquer descrição que não seja exatamente a nomenclatura padronizada
                    if (level.description.trim() !== targetDescription) {
                        level.description = targetDescription;
                        changed = true;
                    }
                });
            });
            if (changed) {
                saveFronts();
            }
        })();
        // Estruturas de dados para OKRs e Indicadores
        const defaultOKRs = [];
        const defaultIndicators = {
            // Estrutura por pilares para Evolução de Indicadores (Run the Bank)
            'Gestão de Incidentes': {
                'Volume de Abertura de Incidentes Funcionais': {},
                'Volume de Resolução de Incidentes Funcionais': {},
                'MTTR (Mean Time To Repair)': {},
                'MTBF (Mean Time Between Failures)': {}
            },
            'Gestão de Problemas': {
                'Volume de Abertura': {},
                'Volume de Resolução': {}
            },
            'Gestão de Requisições': {
                'Volume de Abertura': {},
                'Volume de Resolução': {},
                'Média de Aging': {}
            },
            'Gestão de Abends': {
                'Volume de Abends Abertos': {},
                'Volume de Abends Resolvidos': {}
            },
            'Gestão de Mudanças': {
                'Volume de Mudanças Realizadas': {},
                'Volume de Rollbacks': {}
            },
            'Gestão de Alertas': {
                'Volume de Alertas Recebidos': {},
                'Volume de Alertas Resolvidos': {},
                'Alertas de Certificados Recebidos': {},
                'Alertas de Certificados Resolvidos': {}
            },
            'Qualidade': {
                '% Reuso': {},
                'Densidade de Testes': {},
                'Automação': {}
            },
            'Segurança': {
                'Vulnerabilidades Corrigidas': {},
                'Obsolescências Corrigidas': {}
            }
        };
        
        let okrs = JSON.parse(localStorage.getItem('okrs')) || JSON.parse(JSON.stringify(defaultOKRs));
        let indicators = JSON.parse(localStorage.getItem('indicators')) || JSON.parse(JSON.stringify(defaultIndicators));
        
        // Dados para Projetos e Quicks Wins
        const defaultProjects = [];
        let projects = JSON.parse(localStorage.getItem('projects')) || JSON.parse(JSON.stringify(defaultProjects));
        
        function saveProjects() {
            localStorage.setItem('projects', JSON.stringify(projects));
        }

        // Dados para Painel Executivo
        const defaultExecutivoPanels = [];
        let executivoPanels = JSON.parse(localStorage.getItem('executivoPanels')) || JSON.parse(JSON.stringify(defaultExecutivoPanels));
        
        function saveExecutivoPanels() {
            localStorage.setItem('executivoPanels', JSON.stringify(executivoPanels));
        }

        // Sistema de Coleções de Painéis Executivos
        const defaultExecutivoCollections = [];
        let executivoCollections = JSON.parse(localStorage.getItem('executivoCollections')) || JSON.parse(JSON.stringify(defaultExecutivoCollections));
        
        function saveExecutivoCollections() {
            localStorage.setItem('executivoCollections', JSON.stringify(executivoCollections));
        }
        
        let currentPage = 'dashboard'; // Dashboard como página padrão
        let selectedFrontId = null;
        let expandedLevels = {};
        let editingFrontId = null;
        let creatingNewFront = false;
        let filtersExpanded = false;
        let newFrontTab = 'basic';
        let editFrontTab = 'basic';
        let creatingNewJourney = false;
        let editingJourneyId = null;
        let showEditJourneyModal = false;
        let editingJourneyModalId = null;
        let selectedPillar = null;
        let selectedAttribute = null;
        let filters = {
            status: [],
            maturityLevel: [],
            owner: [],
            name: ''
        };
        let showEventModal = false;
        let selectedEventJourneyId = null;
        let selectedEventCategory = null;
        let showIncidentForm = false;
        let showRiskForm = false;
        let showFunctionalIncidentForm = false;
        let showAlertForm = false;
        let showObsolescenceForm = false;
        let showVulnerabilityForm = false;
        let showFunctionalIncidentOverview = false;
        let functionalIncidentOverviewJourneyId = null;
        let showRiskOverview = false;
        let riskOverviewJourneyId = null;
        let showAlertOverview = false;
        let alertOverviewJourneyId = null;
        let showObsolescenceOverview = false;
        let obsolescenceOverviewJourneyId = null;
        let showVulnerabilityOverview = false;
        let vulnerabilityOverviewJourneyId = null;
        let expandedJourneySections = {}; // Armazena seções expandidas por jornada
        let showIncidentOverview = false;
        let incidentOverviewJourneyId = null;
        
        // Estados para edição de eventos (incidentes e riscos)
        let editingEventId = null;
        let editingEventJourneyId = null;
        let editingEventCategory = null;
        let showEditEventModal = false;
        
        // Estados para OKRs
        let creatingNewOKR = false;
        let editingOKRId = null;
        let showingFrontsRelationModal = null; // Formato: 'okrId|krId' ou null
        let draggedFrontId = null; // Para drag and drop
        
        // Estados para Projetos
        let creatingNewProject = false;
        let editingProjectId = null;
        let showingTasksModal = null; // ID do projeto cujo modal de tarefas está aberto
        let editingTaskIndex = null; // Índice da tarefa sendo editada (null = nova tarefa)
        let showingTaskForm = false; // Controla se o formulário de tarefa está aberto
        
        // Estados para Filtros de Projetos
        let projectFiltersExpanded = false;
        let projectFilters = {
            type: [], // 'project' ou 'quick-win'
            searchTitle: '',
            owner: [],
            sponsor: [],
            minProgress: null,
            maxProgress: null,
            status: [] // 'active', 'overdue', 'completed', 'upcoming'
        };
        // Estados para Indicadores
        let selectedIndicatorMonth = new Date().getMonth() + 1;
        let selectedIndicatorYear = new Date().getFullYear();
        let selectedIndicatorPillar = null; // null = visão estratégica, senão mostra o pilar selecionado

        // Estados para Painel Executivo
        let creatingNewExecutivoPanel = false;
        let editingExecutivoPanelId = null;
        let currentExecutivoPanelIndex = 0;
        let executivoCarouselAutoPlay = false;
        let selectedExecutivoCollectionId = null; // null = lista de coleções, string = carrossel da coleção
        let creatingNewExecutivoCollection = false;
        let editingExecutivoCollectionId = null;
        
        // Estados para Integra
        let cmdbData = JSON.parse(localStorage.getItem('cmdbData')) || [];
        let servicenowApiConfig = JSON.parse(localStorage.getItem('servicenowApiConfig')) || {
            instanceUrl: '',
            username: '',
            password: '',
            apiVersion: 'v1'
        };
        let showServiceNowApiModal = false;
        let showCMDBImportModal = false;
        let expandedIntegraSections = {}; // Controla seções expandidas
        
        // Estados para filtros e ordenação de Jornadas
        let journeyFiltersExpanded = false;
        let journeyFilters = {
            status: [],
            owner: [],
            searchName: '',
            searchAcronym: '',
            minMaturity: null,
            maxMaturity: null,
            eventDatePreset: 'all',
            eventDateStart: '',
            eventDateEnd: ''
        };
        let journeySortBy = null; // 'incidents', 'risks', 'problems', 'requests', 'maturity'
        let journeySortOrder = 'desc'; // 'asc' ou 'desc'

        function hasActiveJourneyFilters() {
            return (
                journeyFilters.status.length > 0 ||
                journeyFilters.owner.length > 0 ||
                (journeyFilters.searchName && journeyFilters.searchName.trim() !== '') ||
                (journeyFilters.searchAcronym && journeyFilters.searchAcronym.trim() !== '') ||
                journeyFilters.minMaturity !== null ||
                journeyFilters.maxMaturity !== null ||
                (journeyFilters.eventDatePreset && journeyFilters.eventDatePreset !== 'all') ||
                (journeyFilters.eventDateStart && journeyFilters.eventDateStart !== '') ||
                (journeyFilters.eventDateEnd && journeyFilters.eventDateEnd !== '')
            );
        }

        function saveUIState() {
            const uiState = {
                currentPage,
                filtersExpanded,
                filters
            };
            localStorage.setItem('uiState', JSON.stringify(uiState));
        }

        (function restoreUIState() {
            try {
                const saved = JSON.parse(localStorage.getItem('uiState'));
                if (saved && typeof saved === 'object') {
                    if (saved.currentPage) currentPage = saved.currentPage;
                    if (typeof saved.filtersExpanded === 'boolean') filtersExpanded = saved.filtersExpanded;
                    if (saved.filters && typeof saved.filters === 'object') filters = Object.assign(filters, saved.filters);
                }
            } catch (e) {}
        })();

        function saveFronts() {
            localStorage.setItem('fronts', JSON.stringify(fronts));
        }

        function saveJourneys() {
            localStorage.setItem('journeys', JSON.stringify(journeys));
        }

        function saveOKRs() {
            localStorage.setItem('okrs', JSON.stringify(okrs));
        }

        function saveIndicators() {
            localStorage.setItem('indicators', JSON.stringify(indicators));
        }

        function saveCMDBData() {
            localStorage.setItem('cmdbData', JSON.stringify(cmdbData));
        }

        function saveServiceNowApiConfig() {
            localStorage.setItem('servicenowApiConfig', JSON.stringify(servicenowApiConfig));
        }

        function countIncidents(journeyId) {
            const journey = journeys.find(j => j.id === journeyId);
            if (!journey || !journey.events) return 0;
            const bounds = getJourneyEventFilterBounds();
            return getJourneyIncidents(journey, bounds).length;
        }

        function countRisks(journeyId) {
            const journey = journeys.find(j => j.id === journeyId);
            if (!journey || !journey.events) return 0;
            const bounds = getJourneyEventFilterBounds();
            return getJourneyRisks(journey, bounds).length;
        }
        function countFunctionalIncidents(journeyId) {
            const journey = journeys.find(j => j.id === journeyId);
            if (!journey) return 0;
            const bounds = getJourneyEventFilterBounds();
            return getJourneyFunctionalIncidents(journey, bounds).length;
        }
        function countAlerts(journeyId) {
            const journey = journeys.find(j => j.id === journeyId);
            if (!journey) return 0;
            const bounds = getJourneyEventFilterBounds();
            return getJourneyAlerts(journey, bounds).length;
        }
        function countObsolescenceItems(journeyId) {
            const journey = journeys.find(j => j.id === journeyId);
            if (!journey) return 0;
            const bounds = getJourneyEventFilterBounds();
            return getJourneyObsolescenceItems(journey, bounds).length;
        }
        function countVulnerabilities(journeyId) {
            const journey = journeys.find(j => j.id === journeyId);
            if (!journey) return 0;
            const bounds = getJourneyEventFilterBounds();
            return getJourneyVulnerabilities(journey, bounds).length;
        }

        function countProblems(journeyId) {
            const journey = journeys.find(j => j.id === journeyId);
            if (!journey || !journey.events) return 0;
            return journey.events.filter(e => e.category === 'Problemas').length;
        }

        function countRequests(journeyId) {
            const journey = journeys.find(j => j.id === journeyId);
            if (!journey || !journey.events) return 0;
            return journey.events.filter(e => e.category === 'Requisições').length;
        }

        function countTotalEvents(journeyId) {
            const journey = journeys.find(j => j.id === journeyId);
            if (!journey || !journey.events) return 0;
            return journey.events.length;
        }
        function getFilteredAndSortedJourneys() {
            let filtered = journeys.filter(journey => {
                // Filtro por status
                if (journeyFilters.status.length > 0 && !journeyFilters.status.includes(journey.status)) {
                    return false;
                }
                
                // Filtro por owner
                if (journeyFilters.owner.length > 0) {
                    const journeyOwner = journey.owner || '';
                    if (!journeyFilters.owner.some(owner => journeyOwner.toLowerCase().includes(owner.toLowerCase()))) {
                        return false;
                    }
                }
                
                // Filtro por nome
                if (journeyFilters.searchName && !journey.name.toLowerCase().includes(journeyFilters.searchName.toLowerCase())) {
                    return false;
                }
                
                // Filtro por sigla
                if (journeyFilters.searchAcronym && !journey.acronym.toLowerCase().includes(journeyFilters.searchAcronym.toLowerCase())) {
                    return false;
                }
                
                // Filtro por maturidade
                const availabilityMaturity = calculatePillarMaturity(journey, 'availability');
                const qualityMaturity = calculatePillarMaturity(journey, 'quality');
                const securityMaturity = calculatePillarMaturity(journey, 'security');
                const performanceMaturity = calculatePillarMaturity(journey, 'performance');
                const overallMaturity = Math.round((availabilityMaturity + qualityMaturity + securityMaturity + performanceMaturity) / 4);
                
                if (journeyFilters.minMaturity !== null && overallMaturity < journeyFilters.minMaturity) {
                    return false;
                }
                if (journeyFilters.maxMaturity !== null && overallMaturity > journeyFilters.maxMaturity) {
                    return false;
                }
                
                return true;
            });
            // Ordenação
            if (journeySortBy) {
                filtered.sort((a, b) => {
                    let valueA, valueB;
                    
                    switch(journeySortBy) {
                        case 'incidents':
                            valueA = countIncidents(a.id);
                            valueB = countIncidents(b.id);
                            break;
                        case 'risks':
                            valueA = countRisks(a.id);
                            valueB = countRisks(b.id);
                            break;
                        case 'problems':
                            valueA = countProblems(a.id);
                            valueB = countProblems(b.id);
                            break;
                        case 'requests':
                            valueA = countRequests(a.id);
                            valueB = countRequests(b.id);
                            break;
                        case 'maturity':
                            const aMaturity = Math.round((
                                calculatePillarMaturity(a, 'availability') +
                                calculatePillarMaturity(a, 'quality') +
                                calculatePillarMaturity(a, 'security') +
                                calculatePillarMaturity(a, 'performance')
                            ) / 4);
                            const bMaturity = Math.round((
                                calculatePillarMaturity(b, 'availability') +
                                calculatePillarMaturity(b, 'quality') +
                                calculatePillarMaturity(b, 'security') +
                                calculatePillarMaturity(b, 'performance')
                            ) / 4);
                            valueA = aMaturity;
                            valueB = bMaturity;
                            break;
                        case 'name':
                            valueA = a.name.toLowerCase();
                            valueB = b.name.toLowerCase();
                            break;
                        default:
                            return 0;
                    }
                    
                    if (journeySortOrder === 'asc') {
                        return valueA > valueB ? 1 : valueA < valueB ? -1 : 0;
                    } else {
                        return valueA < valueB ? 1 : valueA > valueB ? -1 : 0;
                    }
                });
            }
            
            return filtered;
        }

        function toggleJourneyFilters() {
            journeyFiltersExpanded = !journeyFiltersExpanded;
            render();
        }

        function updateJourneyFilterStatus(status) {
            const idx = journeyFilters.status.indexOf(status);
            if (idx > -1) {
                journeyFilters.status.splice(idx, 1);
            } else {
                journeyFilters.status.push(status);
            }
            render();
        }

        function updateJourneyFilterOwner(owner) {
            const idx = journeyFilters.owner.indexOf(owner);
            if (idx > -1) {
                journeyFilters.owner.splice(idx, 1);
            } else {
                journeyFilters.owner.push(owner);
            }
            render();
        }

        function updateJourneyEventDatePreset(preset) {
            journeyFilters.eventDatePreset = preset;
            if (preset === 'custom') {
                if (!journeyFilters.eventDateStart && !journeyFilters.eventDateEnd) {
                    const today = new Date();
                    const todayStr = today.toISOString().split('T')[0];
                    journeyFilters.eventDateStart = todayStr;
                    journeyFilters.eventDateEnd = todayStr;
                }
            } else {
                const range = getJourneyEventPresetRange(preset);
                journeyFilters.eventDateStart = range.start || '';
                journeyFilters.eventDateEnd = range.end || '';
            }
            render();
        }

        function updateJourneyEventDateRange(field, value) {
            journeyFilters[field] = value;
            if (journeyFilters.eventDateStart || journeyFilters.eventDateEnd) {
                journeyFilters.eventDatePreset = 'custom';
            } else {
                journeyFilters.eventDatePreset = 'all';
            }
            render();
        }

        function getJourneyEventPresetRange(preset) {
            const today = new Date();
            const endToday = today.toISOString().split('T')[0];
            const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            const startOfYear = new Date(today.getFullYear(), 0, 1);
            const previousMonthStart = new Date(today.getFullYear(), today.getMonth() - 1, 1);
            const previousMonthEnd = new Date(today.getFullYear(), today.getMonth(), 0);

            switch (preset) {
                case 'current-month':
                    return { start: startOfMonth.toISOString().split('T')[0], end: endToday };
                case 'previous-month':
                    return {
                        start: previousMonthStart.toISOString().split('T')[0],
                        end: previousMonthEnd.toISOString().split('T')[0]
                    };
                case 'year-to-date':
                    return { start: startOfYear.toISOString().split('T')[0], end: endToday };
                case 'last-30-days': {
                    const last30 = new Date(today);
                    last30.setDate(today.getDate() - 29);
                    return { start: last30.toISOString().split('T')[0], end: endToday };
                }
                default:
                    return { start: '', end: '' };
            }
        }

        function getJourneyEventFilterBounds() {
            const start = journeyFilters.eventDateStart ? new Date(`${journeyFilters.eventDateStart}T00:00:00`) : null;
            const end = journeyFilters.eventDateEnd ? new Date(`${journeyFilters.eventDateEnd}T23:59:59.999`) : null;
            return {
                start: start && !Number.isNaN(start.getTime()) ? start.getTime() : null,
                end: end && !Number.isNaN(end.getTime()) ? end.getTime() : null
            };
        }

        function parseEventDateValue(value) {
            if (!value) return null;
            const date = new Date(value);
            if (Number.isNaN(date.getTime())) return null;
            return date.getTime();
        }

        function toISODateTime(value) {
            if (!value) return '';
            const date = new Date(value);
            if (Number.isNaN(date.getTime())) {
                return value;
            }
            return date.toISOString();
        }

        function formatDateDisplay(value) {
            if (!value) return 'Não informado';
            try {
                const date = new Date(value);
                if (Number.isNaN(date.getTime())) return value;
                return date.toLocaleDateString('pt-BR');
            } catch {
                return value;
            }
        }

        function formatDateTimeDisplay(value) {
            if (!value) return 'Não informado';
            try {
                const date = new Date(value);
                if (Number.isNaN(date.getTime())) return value;
                return date.toLocaleString('pt-BR');
            } catch {
                return value;
            }
        }
        function formatDateDisplay(value) {
            if (!value) return 'Não informado';
            try {
                const date = new Date(value);
                if (Number.isNaN(date.getTime())) return value;
                return date.toLocaleDateString('pt-BR');
            } catch {
                return value;
            }
        }

        function incidentMatchesDateFilter(incident, bounds) {
            if (!bounds.start && !bounds.end) return true;
            const timestamp = parseEventDateValue(incident?.date || incident?.createdAt);
            if (timestamp === null) return true;
            if (bounds.start !== null && timestamp < bounds.start) return false;
            if (bounds.end !== null && timestamp > bounds.end) return false;
            return true;
        }

        function riskMatchesDateFilter(risk, bounds) {
            if (!bounds.start && !bounds.end) return true;
            const dateCandidates = [
                risk?.createdAt,
                risk?.startDate,
                risk?.dueDate,
                risk?.completedAt
            ];
            let timestamp = null;
            for (const candidate of dateCandidates) {
                timestamp = parseEventDateValue(candidate);
                if (timestamp !== null) break;
            }
            if (timestamp === null) return true;
            if (bounds.start !== null && timestamp < bounds.start) return false;
            if (bounds.end !== null && timestamp > bounds.end) return false;
            return true;
        }
        function alertMatchesDateFilter(alert, bounds) {
            if (!bounds.start && !bounds.end) return true;
            const dateCandidates = [
                alert?.openedAt,
                alert?.closedAt,
                alert?.date,
                alert?.createdAt
            ];
            let timestamp = null;
            for (const candidate of dateCandidates) {
                timestamp = parseEventDateValue(candidate);
                if (timestamp !== null) break;
            }
            if (timestamp === null) return true;
            if (bounds.start !== null && timestamp < bounds.start) return false;
            if (bounds.end !== null && timestamp > bounds.end) return false;
            return true;
        }
        function obsolescenceMatchesDateFilter(item, bounds) {
            if (!bounds.start && !bounds.end) return true;
            const dateCandidates = [
                item?.endOfSupport,
                item?.createdAt,
                item?.date
            ];
            let timestamp = null;
            for (const candidate of dateCandidates) {
                timestamp = parseEventDateValue(candidate);
                if (timestamp !== null) break;
            }
            if (timestamp === null) return true;
            if (bounds.start !== null && timestamp < bounds.start) return false;
            if (bounds.end !== null && timestamp > bounds.end) return false;
            return true;
        }
        function vulnerabilityMatchesDateFilter(vuln, bounds) {
            if (!bounds.start && !bounds.end) return true;
            const dateCandidates = [
                vuln?.discoveredAt,
                vuln?.dueAt,
                vuln?.createdAt,
                vuln?.date
            ];
            let timestamp = null;
            for (const candidate of dateCandidates) {
                timestamp = parseEventDateValue(candidate);
                if (timestamp !== null) break;
            }
            if (timestamp === null) return true;
            if (bounds.start !== null && timestamp < bounds.start) return false;
            if (bounds.end !== null && timestamp > bounds.end) return false;
            return true;
        }

        function getJourneyIncidents(journey, bounds = getJourneyEventFilterBounds()) {
            if (!journey || !journey.events) return [];
            const validCategories = new Set(['Incidentes', EVENT_CATEGORY_INCIDENT_SERVICE]);
            return journey.events.filter(event =>
                validCategories.has(event.category) && incidentMatchesDateFilter(event, bounds)
            );
        }
        function getJourneyFunctionalIncidents(journey, bounds = getJourneyEventFilterBounds()) {
            if (!journey) return [];

            const matches = [];
            const targetJourneyId = journey.id;

            journeys.forEach(sourceJourney => {
                const events = sourceJourney?.events;
                if (!Array.isArray(events) || events.length === 0) return;

                events.forEach(event => {
                    if (event?.category !== EVENT_CATEGORY_INCIDENT_FUNCTIONAL) return;

                    const owningJourneyId = sourceJourney.id;
                    const affectedJourneyId = event.affectedJourney || owningJourneyId;

                    if (affectedJourneyId !== targetJourneyId) return;
                    if (!incidentMatchesDateFilter(event, bounds)) return;

                    matches.push({ ...event, sourceJourneyId: owningJourneyId });
                });
            });

            return matches;
        }
        function getJourneyAlerts(journey, bounds = getJourneyEventFilterBounds()) {
            if (!journey || !journey.events) return [];
            return journey.events.filter(event =>
                event.category === EVENT_CATEGORY_ALERT && alertMatchesDateFilter(event, bounds)
            );
        }
        function getJourneyObsolescenceItems(journey, bounds = getJourneyEventFilterBounds()) {
            if (!journey || !journey.events) return [];
            return journey.events.filter(event =>
                event.category === EVENT_CATEGORY_OBSOLESCENCE && obsolescenceMatchesDateFilter(event, bounds)
            );
        }
        function getJourneyVulnerabilities(journey, bounds = getJourneyEventFilterBounds()) {
            if (!journey || !journey.events) return [];
            return journey.events.filter(event =>
                event.category === EVENT_CATEGORY_VULNERABILITY && vulnerabilityMatchesDateFilter(event, bounds)
            );
        }

        function getJourneyRisks(journey, bounds = getJourneyEventFilterBounds()) {
            if (!journey || !journey.events) return [];
            const validCategories = new Set(['Riscos', EVENT_CATEGORY_RISK]);
            return journey.events.filter(event =>
                validCategories.has(event.category) && riskMatchesDateFilter(event, bounds)
            );
        }

        function updateJourneySort(sortBy) {
            if (journeySortBy === sortBy) {
                journeySortOrder = journeySortOrder === 'asc' ? 'desc' : 'asc';
            } else {
                journeySortBy = sortBy;
                journeySortOrder = 'desc';
            }
            render();
        }

        function clearJourneyFilters() {
            journeyFilters = {
                status: [],
                owner: [],
                searchName: '',
                searchAcronym: '',
                minMaturity: null,
                maxMaturity: null,
                eventDatePreset: 'all',
                eventDateStart: '',
                eventDateEnd: ''
            };
            journeySortBy = null;
            journeySortOrder = 'desc';
            render();
        }

        function openIncidentOverview(journeyId) {
            incidentOverviewJourneyId = journeyId;
            showIncidentOverview = true;
            render();
        }

        function closeIncidentOverview() {
            showIncidentOverview = false;
            incidentOverviewJourneyId = null;
            render();
        }

        function openFunctionalIncidentOverview(journeyId) {
            functionalIncidentOverviewJourneyId = journeyId;
            showFunctionalIncidentOverview = true;
            render();
        }

        function closeFunctionalIncidentOverview() {
            showFunctionalIncidentOverview = false;
            functionalIncidentOverviewJourneyId = null;
            render();
        }
        function openAlertOverview(journeyId) {
            alertOverviewJourneyId = journeyId;
            showAlertOverview = true;
            render();
        }
        function closeAlertOverview() {
            alertOverviewJourneyId = null;
            showAlertOverview = false;
            render();
        }
        function openObsolescenceOverview(journeyId) {
            obsolescenceOverviewJourneyId = journeyId;
            showObsolescenceOverview = true;
            render();
        }
        function closeObsolescenceOverview() {
            obsolescenceOverviewJourneyId = null;
            showObsolescenceOverview = false;
            render();
        }
        function openVulnerabilityOverview(journeyId) {
            vulnerabilityOverviewJourneyId = journeyId;
            showVulnerabilityOverview = true;
            render();
        }
        function closeVulnerabilityOverview() {
            vulnerabilityOverviewJourneyId = null;
            showVulnerabilityOverview = false;
            render();
        }

        function openRiskOverview(journeyId) {
            riskOverviewJourneyId = journeyId;
            showRiskOverview = true;
            render();
        }

        function closeRiskOverview() {
            showRiskOverview = false;
            riskOverviewJourneyId = null;
            render();
        }

        function toggleJourneySection(journeyId, sectionName) {
            const key = `${journeyId}_${sectionName}`;
            expandedJourneySections[key] = !expandedJourneySections[key];
            render();
        }

        function isJourneySectionExpanded(journeyId, sectionName) {
            const key = `${journeyId}_${sectionName}`;
            return expandedJourneySections[key] || false;
        }

        function openEventModal(journeyId) {
            selectedEventJourneyId = journeyId;
            showEventModal = true;
            selectedEventCategory = null;
            showIncidentForm = false;
            showRiskForm = false;
            showFunctionalIncidentForm = false;
            showAlertForm = false;
            showObsolescenceForm = false;
            showVulnerabilityForm = false;
            render();
        }
        function closeEventModal() {
            showEventModal = false;
            selectedEventJourneyId = null;
            selectedEventCategory = null;
            showIncidentForm = false;
            showRiskForm = false;
            showFunctionalIncidentForm = false;
            showAlertForm = false;
            showObsolescenceForm = false;
            showVulnerabilityForm = false;
            render();
        }
        function selectEventCategory(category) {
            selectedEventCategory = category;
            if (category === EVENT_CATEGORY_INCIDENT_SERVICE) {
                showIncidentForm = true;
                showFunctionalIncidentForm = false;
                showRiskForm = false;
                showAlertForm = false;
                showObsolescenceForm = false;
                showVulnerabilityForm = false;
            } else if (category === EVENT_CATEGORY_INCIDENT_FUNCTIONAL) {
                showIncidentForm = false;
                showFunctionalIncidentForm = true;
                showRiskForm = false;
                showAlertForm = false;
                showObsolescenceForm = false;
                showVulnerabilityForm = false;
            } else if (category === EVENT_CATEGORY_ALERT) {
                showIncidentForm = false;
                showFunctionalIncidentForm = false;
                showRiskForm = false;
                showAlertForm = true;
                showObsolescenceForm = false;
                showVulnerabilityForm = false;
            } else if (category === EVENT_CATEGORY_OBSOLESCENCE) {
                showIncidentForm = false;
                showFunctionalIncidentForm = false;
                showRiskForm = false;
                showAlertForm = false;
                showObsolescenceForm = true;
                showVulnerabilityForm = false;
            } else if (category === EVENT_CATEGORY_VULNERABILITY) {
                showIncidentForm = false;
                showFunctionalIncidentForm = false;
                showRiskForm = false;
                showAlertForm = false;
                showObsolescenceForm = false;
                showVulnerabilityForm = true;
            } else if (category === EVENT_CATEGORY_RISK) {
                showRiskForm = true;
                showIncidentForm = false;
                showFunctionalIncidentForm = false;
                showAlertForm = false;
                showObsolescenceForm = false;
                showVulnerabilityForm = false;
            } else {
                showIncidentForm = false;
                showRiskForm = false;
                showFunctionalIncidentForm = false;
                showAlertForm = false;
                showObsolescenceForm = false;
                showVulnerabilityForm = false;
            }
            render();
        }
        function saveIncident() {
            const incidentNumber = document.getElementById('incident-number').value.trim();
            const incidentDate = document.getElementById('incident-date').value;
            const mttr = document.getElementById('incident-mttr').value.trim();
            const description = document.getElementById('incident-description').value.trim();
            const affectedJourneySelect = document.getElementById('incident-journey').value;
            const relatedRisk = document.getElementById('incident-risk').value.trim();
            const origin = document.getElementById('incident-origin').value;
            const prevention = document.getElementById('incident-prevention').value.trim();
            const lessons = document.getElementById('incident-lessons').value.trim();
            const pillar = document.getElementById('incident-pillar').value;
            const attributes = Array.from(document.querySelectorAll('input[name="incident-attributes"]:checked')).map(el => el.value);

            if (!incidentNumber || !incidentDate || !mttr || !description) {
                alert('Preencha todos os campos obrigatórios!');
                return;
            }

            const journey = journeys.find(j => j.id === selectedEventJourneyId);
            if (!journey) return;

            if (!journey.events) {
                journey.events = [];
            }

            const targetJourneyId = affectedJourneySelect || selectedEventJourneyId;

            const newIncident = {
                id: 'inc' + Date.now(),
                category: EVENT_CATEGORY_INCIDENT_SERVICE,
                incidentNumber: incidentNumber,
                date: incidentDate,
                mttr: mttr,
                description: description,
                affectedJourney: targetJourneyId,
                relatedRisk: relatedRisk,
                origin: origin,
                prevention: prevention,
                lessons: lessons,
                pillar: pillar,
                attributes: attributes,
                createdAt: new Date().toISOString()
            };

            journey.events.push(newIncident);
            saveJourneys();
            closeEventModal();
        }
        function saveFunctionalIncident() {
            const incidentNumber = document.getElementById('functional-incident-number').value.trim();
            const incidentAcronym = document.getElementById('functional-incident-acronym').value.trim();
            const createdAtValue = document.getElementById('functional-incident-created-at').value;
            const resolvedAtValue = document.getElementById('functional-incident-resolved-at').value;
            const shortDescription = document.getElementById('functional-incident-short-description').value.trim();
            const description = document.getElementById('functional-incident-description').value.trim();
            const resolutionNotes = document.getElementById('functional-incident-resolution-notes').value.trim();
            const resolutionType = document.getElementById('functional-incident-resolution-type').value.trim();
            const classification = document.getElementById('functional-incident-classification').value.trim();
            const affectedJourneySelect = document.getElementById('functional-incident-journey').value;

            if (!incidentNumber || !createdAtValue || !shortDescription) {
                alert('Preencha ao menos o número, data de criação e a descrição curta!');
                return;
            }

            const journey = journeys.find(j => j.id === selectedEventJourneyId);
            if (!journey) return;

            if (!journey.events) {
                journey.events = [];
            }

            const targetJourneyId = affectedJourneySelect || selectedEventJourneyId;

            const newFunctionalIncident = {
                id: 'func' + Date.now(),
                category: EVENT_CATEGORY_INCIDENT_FUNCTIONAL,
                incidentNumber: incidentNumber,
                acronym: incidentAcronym,
                createdAt: toISODateTime(createdAtValue),
                resolvedAt: toISODateTime(resolvedAtValue),
                shortDescription: shortDescription,
                description: description,
                resolutionNotes: resolutionNotes,
                resolutionType: resolutionType,
                classification: classification,
                affectedJourney: targetJourneyId,
                updatedAt: new Date().toISOString()
            };

            journey.events.push(newFunctionalIncident);
            saveJourneys();
            closeEventModal();
        }
        function saveAlert() {
            const journey = journeys.find(j => j.id === selectedEventJourneyId);
            if (!journey) return;

            const alertIdInput = document.getElementById('alert-id');
            const titleInput = document.getElementById('alert-title');
            if (!alertIdInput || !titleInput) return;

            const alertId = alertIdInput.value.trim();
            const title = titleInput.value.trim();
            if (!alertId || !title) {
                alert('Preencha os campos obrigatórios (identificador e título do alerta).');
                return;
            }

            if (!journey.events) journey.events = [];

            const payload = {
                id: 'alert' + Date.now(),
                category: EVENT_CATEGORY_ALERT,
                alertId,
                title,
                source: document.getElementById('alert-source')?.value.trim() || '',
                severity: document.getElementById('alert-severity')?.value.trim() || '',
                status: document.getElementById('alert-status')?.value.trim() || '',
                openedAt: document.getElementById('alert-opened-at')?.value || '',
                closedAt: document.getElementById('alert-closed-at')?.value || '',
                impactedService: document.getElementById('alert-impacted-service')?.value.trim() || '',
                owner: document.getElementById('alert-owner')?.value.trim() || '',
                tags: document.getElementById('alert-tags')?.value.trim() || '',
                url: document.getElementById('alert-url')?.value.trim() || '',
                notes: document.getElementById('alert-notes')?.value.trim() || '',
                createdAt: new Date().toISOString()
            };

            journey.events.push(payload);
            saveJourneys();
            closeEventModal();
        }
        function saveObsolescence() {
            const journey = journeys.find(j => j.id === selectedEventJourneyId);
            if (!journey) return;

            const componentInput = document.getElementById('obsolescence-component');
            if (!componentInput) return;
            const component = componentInput.value.trim();
            if (!component) {
                alert('Informe o componente ou produto afetado.');
                return;
            }

            if (!journey.events) journey.events = [];

            const payload = {
                id: 'obs' + Date.now(),
                category: EVENT_CATEGORY_OBSOLESCENCE,
                component,
                vendor: document.getElementById('obsolescence-vendor')?.value.trim() || '',
                currentVersion: document.getElementById('obsolescence-current-version')?.value.trim() || '',
                targetVersion: document.getElementById('obsolescence-target-version')?.value.trim() || '',
                endOfSupport: document.getElementById('obsolescence-end-of-support')?.value || '',
                impact: document.getElementById('obsolescence-impact')?.value.trim() || '',
                remediationPlan: document.getElementById('obsolescence-remediation-plan')?.value.trim() || '',
                status: document.getElementById('obsolescence-status')?.value.trim() || '',
                owner: document.getElementById('obsolescence-owner')?.value.trim() || '',
                notes: document.getElementById('obsolescence-notes')?.value.trim() || '',
                createdAt: new Date().toISOString()
            };

            journey.events.push(payload);
            saveJourneys();
            closeEventModal();
        }
        function saveVulnerability() {
            const journey = journeys.find(j => j.id === selectedEventJourneyId);
            if (!journey) return;

            const identifierInput = document.getElementById('vulnerability-identifier');
            const serviceInput = document.getElementById('vulnerability-service');
            if (!identifierInput || !serviceInput) return;

            const identifier = identifierInput.value.trim();
            const affectedService = serviceInput.value.trim();
            if (!identifier || !affectedService) {
                alert('Informe o identificador e o componente/serviço afetado.');
                return;
            }

            if (!journey.events) journey.events = [];

            const payload = {
                id: 'vuln' + Date.now(),
                category: EVENT_CATEGORY_VULNERABILITY,
                identifier,
                severity: document.getElementById('vulnerability-severity')?.value.trim() || '',
                cvssScore: document.getElementById('vulnerability-cvss')?.value.trim() || '',
                affectedService,
                discoveredAt: document.getElementById('vulnerability-discovered-at')?.value || '',
                dueAt: document.getElementById('vulnerability-due-at')?.value || '',
                status: document.getElementById('vulnerability-status')?.value.trim() || '',
                owner: document.getElementById('vulnerability-owner')?.value.trim() || '',
                notes: document.getElementById('vulnerability-notes')?.value.trim() || '',
                createdAt: new Date().toISOString()
            };

            journey.events.push(payload);
            saveJourneys();
            closeEventModal();
        }
        function saveRisk() {
            const plannerId = document.getElementById('risk-planner-id').value.trim();
            const taskName = document.getElementById('risk-task-name').value.trim();
            const bucket = document.getElementById('risk-bucket').value;
            const progress = parseInt(document.getElementById('risk-progress').value) || 0;
            const priority = document.getElementById('risk-priority').value;
            const assignedTo = document.getElementById('risk-assigned-to').value.trim();
            const createdBy = document.getElementById('risk-created-by').value.trim();
            const createdAt = document.getElementById('risk-created-at').value;
            const startDate = document.getElementById('risk-start-date').value;
            const dueDate = document.getElementById('risk-due-date').value;
            const isRecurring = document.getElementById('risk-recurring').checked;
            const isOverdue = document.getElementById('risk-overdue').checked;
            const isCompleted = document.getElementById('risk-completed').checked;
            const completedAt = document.getElementById('risk-completed-at').value;
            const completedBy = document.getElementById('risk-completed-by').value.trim();
            const checklist = document.getElementById('risk-checklist').value.trim();
            const labels = document.getElementById('risk-labels').value.trim();
            const description = document.getElementById('risk-description').value.trim();

            if (!plannerId || !taskName || !bucket) {
                alert('Preencha todos os campos obrigatórios!');
                return;
            }

            const journey = journeys.find(j => j.id === selectedEventJourneyId);
            if (!journey) return;

            // Garantir que o array events existe
            if (!journey.events) {
                journey.events = [];
            }

            const newRisk = {
                id: 'risk' + Date.now(),
                category: 'Riscos',
                plannerId: plannerId,
                taskName: taskName,
                bucket: bucket,
                progress: progress,
                priority: priority,
                assignedTo: assignedTo,
                createdBy: createdBy,
                createdAt: createdAt,
                startDate: startDate,
                dueDate: dueDate,
                isRecurring: isRecurring,
                isOverdue: isOverdue,
                isCompleted: isCompleted,
                completedAt: completedAt,
                completedBy: completedBy,
                checklist: checklist,
                labels: labels,
                description: description
            };

            journey.events.push(newRisk);
            saveJourneys();
            closeEventModal();
        }

        function deleteEvent(journeyId, eventId) {
            if (confirm('Tem certeza que deseja deletar este evento?')) {
                const journey = journeys.find(j => j.id === journeyId);
                if (journey) {
                    journey.events = journey.events.filter(e => e.id !== eventId);
                    saveJourneys();
                    render();
                }
            }
        }
        function openEditEvent(journeyId, eventId) {
            const journey = journeys.find(j => j.id === journeyId);
            if (!journey) return;
            
            const event = journey.events.find(e => e.id === eventId);
            if (!event) return;
            
            editingEventId = eventId;
            editingEventJourneyId = journeyId;
            editingEventCategory = event.category;
            showEditEventModal = true;
            
            // Fechar overview se estiver aberto
            if (showIncidentOverview && incidentOverviewJourneyId === journeyId) {
                showIncidentOverview = false;
            }
            if (showRiskOverview && riskOverviewJourneyId === journeyId) {
                showRiskOverview = false;
            }
            
            render();
        }
        function closeEditEventModal() {
            editingEventId = null;
            editingEventJourneyId = null;
            editingEventCategory = null;
            showEditEventModal = false;
            render();
        }

        function saveEditIncident() {
            const journey = journeys.find(j => j.id === editingEventJourneyId);
            if (!journey) return;
            
            const event = journey.events.find(e => e.id === editingEventId);
            if (!event) return;
            
            const incidentNumber = document.getElementById('edit-incident-number').value.trim();
            const incidentDate = document.getElementById('edit-incident-date').value;
            const mttr = document.getElementById('edit-incident-mttr').value.trim();
            const description = document.getElementById('edit-incident-description').value.trim();
            const affectedJourney = document.getElementById('edit-incident-journey').value;
            const relatedRisk = document.getElementById('edit-incident-risk').value.trim();
            const origin = document.getElementById('edit-incident-origin').value;
            const prevention = document.getElementById('edit-incident-prevention').value.trim();
            const lessons = document.getElementById('edit-incident-lessons').value.trim();
            const pillar = document.getElementById('edit-incident-pillar').value;
            const attributes = Array.from(document.querySelectorAll('input[name="edit-incident-attributes"]:checked')).map(el => el.value);

            if (!incidentNumber || !incidentDate || !mttr || !description) {
                alert('Preencha todos os campos obrigatórios!');
                return;
            }

            // Atualizar o evento existente
            event.category = EVENT_CATEGORY_INCIDENT_SERVICE;
            event.incidentNumber = incidentNumber;
            event.date = incidentDate;
            event.mttr = mttr;
            event.description = description;
            event.affectedJourney = affectedJourney || editingEventJourneyId;
            event.relatedRisk = relatedRisk;
            event.origin = origin;
            event.prevention = prevention;
            event.lessons = lessons;
            event.pillar = pillar;
            event.attributes = attributes;
            event.updatedAt = new Date().toISOString();

            saveJourneys();
            closeEditEventModal();
        }
        function saveEditFunctionalIncident() {
            const journey = journeys.find(j => j.id === editingEventJourneyId);
            if (!journey) return;
            
            const event = journey.events.find(e => e.id === editingEventId);
            if (!event) return;
            
            const incidentNumber = document.getElementById('edit-functional-incident-number').value.trim();
            const incidentAcronym = document.getElementById('edit-functional-incident-acronym').value.trim();
            const createdAtValue = document.getElementById('edit-functional-incident-created-at').value;
            const resolvedAtValue = document.getElementById('edit-functional-incident-resolved-at').value;
            const shortDescription = document.getElementById('edit-functional-incident-short-description').value.trim();
            const description = document.getElementById('edit-functional-incident-description').value.trim();
            const resolutionNotes = document.getElementById('edit-functional-incident-resolution-notes').value.trim();
            const resolutionType = document.getElementById('edit-functional-incident-resolution-type').value.trim();
            const classification = document.getElementById('edit-functional-incident-classification').value.trim();
            const affectedJourney = document.getElementById('edit-functional-incident-journey').value;

            if (!incidentNumber || !createdAtValue || !shortDescription) {
                alert('Preencha ao menos o número, data de criação e a descrição curta!');
                return;
            }

            event.category = EVENT_CATEGORY_INCIDENT_FUNCTIONAL;
            event.incidentNumber = incidentNumber;
            event.acronym = incidentAcronym;
            event.createdAt = toISODateTime(createdAtValue);
            event.resolvedAt = toISODateTime(resolvedAtValue);
            event.shortDescription = shortDescription;
            event.description = description;
            event.resolutionNotes = resolutionNotes;
            event.resolutionType = resolutionType;
            event.classification = classification;
            event.affectedJourney = affectedJourney || editingEventJourneyId;
            event.updatedAt = new Date().toISOString();

            saveJourneys();
            closeEditEventModal();
        }
        function saveEditRisk() {
            const journey = journeys.find(j => j.id === editingEventJourneyId);
            if (!journey) return;
            
            const event = journey.events.find(e => e.id === editingEventId);
            if (!event) return;
            
            const plannerId = document.getElementById('edit-risk-planner-id').value.trim();
            const taskName = document.getElementById('edit-risk-task-name').value.trim();
            const bucket = document.getElementById('edit-risk-bucket').value;
            const progress = parseInt(document.getElementById('edit-risk-progress').value) || 0;
            const priority = document.getElementById('edit-risk-priority').value;
            const assignedTo = document.getElementById('edit-risk-assigned-to').value.trim();
            const createdBy = document.getElementById('edit-risk-created-by').value.trim();
            const createdAt = document.getElementById('edit-risk-created-at').value;
            const startDate = document.getElementById('edit-risk-start-date').value;
            const dueDate = document.getElementById('edit-risk-due-date').value;
            const isRecurring = document.getElementById('edit-risk-recurring').checked;
            const isOverdue = document.getElementById('edit-risk-overdue').checked;
            const isCompleted = document.getElementById('edit-risk-completed').checked;
            const completedAt = document.getElementById('edit-risk-completed-at').value;
            const completedBy = document.getElementById('edit-risk-completed-by').value.trim();
            const checklist = document.getElementById('edit-risk-checklist').value.trim();
            const labels = document.getElementById('edit-risk-labels').value.trim();
            const description = document.getElementById('edit-risk-description').value.trim();

            if (!plannerId || !taskName || !bucket) {
                alert('Preencha todos os campos obrigatórios!');
                return;
            }

            // Atualizar o evento existente
            event.plannerId = plannerId;
            event.taskName = taskName;
            event.bucket = bucket;
            event.progress = progress;
            event.priority = priority;
            event.assignedTo = assignedTo;
            event.createdBy = createdBy;
            event.createdAt = createdAt;
            event.startDate = startDate;
            event.dueDate = dueDate;
            event.isRecurring = isRecurring;
            event.isOverdue = isOverdue;
            event.isCompleted = isCompleted;
            event.completedAt = completedAt;
            event.completedBy = completedBy;
            event.checklist = checklist;
            event.labels = labels;
            event.description = description;
            event.updatedAt = new Date().toISOString();

            saveJourneys();
            closeEditEventModal();
        }

        function calculatePillarMaturity(journey, pillar) {
            const attributes = journey.maturity[pillar];
            const values = Object.values(attributes);
            return Math.round(values.reduce((a, b) => a + b, 0) / values.length);
        }

        function getMaturityColor(value) {
            if (value < 25) return 'maturity-0';
            if (value < 50) return 'maturity-25';
            if (value < 75) return 'maturity-50';
            if (value < 100) return 'maturity-75';
            return 'maturity-100';
        }
        function openDetailModalJourney(journeyId, pillar, attribute) {
            selectedPillar = pillar;
            selectedAttribute = attribute; // mantido por compatibilidade, mas não é necessário para a nova UI
            editingJourneyId = journeyId;
            render();
        }

        function closeDetailModalJourney() {
            selectedPillar = null;
            selectedAttribute = null;
            editingJourneyId = null;
            render();
        }

        function updateAttributeValue(journeyId, pillar, attribute, value) {
            const journey = journeys.find(j => j.id === journeyId);
            if (journey) {
                journey.maturity[pillar][attribute] = parseInt(value);
                
                // Salvar histórico de maturidade
                if (!journey.maturityHistory) journey.maturityHistory = [];
                const today = new Date().toISOString().split('T')[0];
                const overallMaturity = Math.round((
                    calculatePillarMaturity(journey, 'availability') +
                    calculatePillarMaturity(journey, 'quality') +
                    calculatePillarMaturity(journey, 'security') +
                    calculatePillarMaturity(journey, 'performance')
                ) / 4);
                
                // Verificar se já existe snapshot para hoje
                const todaySnapshot = journey.maturityHistory.find(s => s.date === today);
                if (todaySnapshot) {
                    todaySnapshot.overall = overallMaturity;
                    todaySnapshot[pillar] = calculatePillarMaturity(journey, pillar);
                } else {
                    journey.maturityHistory.push({
                        date: today,
                        overall: overallMaturity,
                        availability: calculatePillarMaturity(journey, 'availability'),
                        quality: calculatePillarMaturity(journey, 'quality'),
                        security: calculatePillarMaturity(journey, 'security'),
                        performance: calculatePillarMaturity(journey, 'performance')
                    });
                }
                
                // Manter apenas últimos 12 meses
                journey.maturityHistory.sort((a, b) => new Date(b.date) - new Date(a.date));
                if (journey.maturityHistory.length > 12) {
                    journey.maturityHistory = journey.maturityHistory.slice(0, 12);
                }
                
                saveJourneys();
                render();
            }
        }
        function getJourneyOKRsContribution(journeyId) {
            // Buscar OKRs que estão relacionados a frentes que podem contribuir para esta jornada
            // Por enquanto, vamos mostrar uma mensagem genérica
            // Futuramente pode ser expandido com relacionamento direto jornada-OKR
            return okrs.filter(okr => {
                // Verificar se há alguma relação indireta através de frentes
                // Por enquanto, retornar vazio e mostrar mensagem genérica
                return false;
            });
        }
        function renderJourneyEvolutionChart(journey) {
            if (!journey.maturityHistory || journey.maturityHistory.length === 0) {
                return '<p class="text-sm text-slate-500 italic">Nenhum histórico disponível ainda. Atualize os valores de maturidade para ver a evolução.</p>';
            }
            
            const history = journey.maturityHistory.sort((a, b) => new Date(a.date) - new Date(b.date));
            const maxValue = 100;
            const chartHeight = 200;
            
            return `
                <div class="relative" style="height: ${chartHeight}px;">
                    <svg class="w-full h-full" viewBox="0 0 ${history.length * 60 + 40} ${chartHeight + 40}" preserveAspectRatio="xMidYMid meet">
                        <!-- Eixos -->
                        <line x1="30" y1="${chartHeight + 10}" x2="${history.length * 60 + 10}" y2="${chartHeight + 10}" stroke="#cbd5e1" stroke-width="2"/>
                        <line x1="30" y1="10" x2="30" y2="${chartHeight + 10}" stroke="#cbd5e1" stroke-width="2"/>
                        
                        <!-- Linha de evolução -->
                        <polyline 
                            points="${history.map((snapshot, idx) => {
                                const x = 40 + (idx * 60);
                                const y = chartHeight - (snapshot.overall / maxValue) * chartHeight;
                                return `${x},${y}`;
                            }).join(' ')}"
                            fill="none"
                            stroke="#3b82f6"
                            stroke-width="3"
                            stroke-linecap="round"
                        />
                        
                        <!-- Pontos -->
                        ${history.map((snapshot, idx) => {
                            const x = 40 + (idx * 60);
                            const y = chartHeight - (snapshot.overall / maxValue) * chartHeight;
                            return `
                                <circle cx="${x}" cy="${y}" r="4" fill="#3b82f6"/>
                                <text x="${x}" y="${chartHeight + 25}" text-anchor="middle" class="text-xs fill-slate-600" font-size="10">
                                    ${new Date(snapshot.date).toLocaleDateString('pt-BR', { month: 'short', day: 'numeric' })}
                                </text>
                                <text x="${x}" y="${y - 5}" text-anchor="middle" class="text-xs fill-slate-900 font-semibold" font-size="10">
                                    ${snapshot.overall}%
                                </text>
                            `;
                        }).join('')}
                        
                        <!-- Grade -->
                        ${[0, 25, 50, 75, 100].map(val => {
                            const y = chartHeight - (val / maxValue) * chartHeight;
                            return `
                                <line x1="30" y1="${y}" x2="${history.length * 60 + 10}" y2="${y}" stroke="#e2e8f0" stroke-width="1" stroke-dasharray="4,4"/>
                                <text x="25" y="${y + 4}" text-anchor="end" class="text-xs fill-slate-500" font-size="10">${val}%</text>
                            `;
                        }).join('')}
                    </svg>
                </div>
            `;
        }

        function openNewJourneyModal() {
            creatingNewJourney = true;
            render();
        }

        function closeNewJourneyModal() {
            creatingNewJourney = false;
            render();
        }

        function saveNewJourney() {
            const name = document.getElementById('new-journey-name').value.trim();
            const acronym = document.getElementById('new-journey-acronym').value.trim();
            const status = document.getElementById('new-journey-status').value;
            const owner = document.getElementById('new-journey-owner').value.trim();
            if (!name || !acronym) {
                alert('Nome e Sigla são obrigatórios!');
                return;
            }
            const newJourney = {
                id: 'j' + Date.now(),
                name: name,
                acronym: acronym.toUpperCase(),
                status: status,
                owner: owner || '',
                events: [],
                maturity: {
                    availability: {},
                    quality: {},
                    security: {},
                    performance: {}
                }
            };
            Object.keys(pillarAttributes).forEach(pillar => {
                Object.keys(pillarAttributes[pillar]).forEach(attr => {
                    newJourney.maturity[pillar][attr] = 0;
                });
            });
            journeys.push(newJourney);
            saveJourneys();
            closeNewJourneyModal();
        }

        function deleteJourney(journeyId) {
            if (confirm('Tem certeza que deseja deletar esta jornada?')) {
                journeys = journeys.filter(j => j.id !== journeyId);
                saveJourneys();
                render();
            }
        }

        function openEditJourneyModal(journeyId) {
            editingJourneyModalId = journeyId;
            showEditJourneyModal = true;
            render();
        }

        function closeEditJourneyModal() {
            editingJourneyModalId = null;
            showEditJourneyModal = false;
            render();
        }

        function saveEditJourney() {
            const journey = journeys.find(j => j.id === editingJourneyModalId);
            if (!journey) {
                alert('Jornada não encontrada!');
                return;
            }
            const name = document.getElementById('edit-journey-name').value.trim();
            const acronym = document.getElementById('edit-journey-acronym').value.trim();
            const status = document.getElementById('edit-journey-status').value;
            const owner = document.getElementById('edit-journey-owner').value.trim();
            if (!name || !acronym) {
                alert('Nome e Sigla são obrigatórios!');
                return;
            }
            journey.name = name;
            journey.acronym = acronym.toUpperCase();
            journey.status = status;
            journey.owner = owner || '';
            saveJourneys();
            closeEditJourneyModal();
        }

        function toggleFilter() {
            filtersExpanded = !filtersExpanded;
            saveUIState();
            render();
        }

        function updateFilterStatus(status) {
            const idx = filters.status.indexOf(status);
            if (idx > -1) {
                filters.status.splice(idx, 1);
            } else {
                filters.status.push(status);
            }
            saveUIState();
            render();
        }

        function updateFilterMaturityLevel(level) {
            const idx = filters.maturityLevel.indexOf(level);
            if (idx > -1) {
                filters.maturityLevel.splice(idx, 1);
            } else {
                filters.maturityLevel.push(level);
            }
            saveUIState();
            render();
        }

        function updateFilterOwner(owner) {
            const idx = filters.owner.indexOf(owner);
            if (idx > -1) {
                filters.owner.splice(idx, 1);
            } else {
                filters.owner.push(owner);
            }
            saveUIState();
            render();
        }
        function updateFilterName(name) {
            filters.name = name;
            saveUIState();
            render();
        }
        function clearFilters() {
            filters = { status: [], maturityLevel: [], owner: [], name: '' };
            saveUIState();
            render();
        }

        function navigateTo(page) {
            currentPage = page;
            saveUIState();
            render();
        }
        function exportData() {
            const data = { fronts, journeys };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'hub-tecnologia-dados.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        function exportAllData() {
            // Coletar todos os dados do sistema
            const allData = {
                version: '1.0',
                exportDate: Date.now(),
                exportDateISO: new Date().toISOString(),
                data: {
                    fronts: fronts,
                    journeys: journeys,
                    okrs: okrs,
                    indicators: indicators,
                    projects: projects,
                    executivoPanels: executivoPanels,
                    executivoCollections: executivoCollections,
                    cmdbData: cmdbData,
                    servicenowApiConfig: servicenowApiConfig,
                    uiState: {
                        currentPage,
                        filtersExpanded,
                        filters
                    }
                },
                metadata: {
                    frontsCount: fronts.length,
                    journeysCount: journeys.length,
                    okrsCount: okrs.length,
                    projectsCount: projects.length,
                    executivoPanelsCount: executivoPanels.length,
                    executivoCollectionsCount: executivoCollections.length,
                    indicatorsPillarsCount: Object.keys(indicators).filter(k => k !== 'defaultIndicators').length,
                    cmdbDataCount: cmdbData.length
                }
            };
            
            const blob = new Blob([JSON.stringify(allData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            const dateStr = new Date().toISOString().split('T')[0];
            a.href = url;
            a.download = `hub-tecnologia-backup-completo_${dateStr}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            // Mostrar mensagem de sucesso
            alert(`Backup completo exportado com sucesso!\n\nConteúdo:\n- ${allData.metadata.frontsCount} Frentes\n- ${allData.metadata.journeysCount} Jornadas\n- ${allData.metadata.okrsCount} OKRs\n- ${allData.metadata.projectsCount} Projetos\n- ${allData.metadata.executivoPanelsCount} Painéis Executivos\n- ${allData.metadata.indicatorsPillarsCount} Pilares de Indicadores\n- ${allData.metadata.cmdbDataCount} Itens CMDB`);
        }

        function importDataFromFile(file) {
            const reader = new FileReader();
            reader.onload = function() {
                try {
                    const data = JSON.parse(reader.result);
                    if (!data || typeof data !== 'object') throw new Error('Formato inválido');
                    if (!confirm('Importar substituirá os dados atuais. Continuar?')) return;
                    if (Array.isArray(data.fronts)) fronts = data.fronts;
                    if (Array.isArray(data.journeys)) journeys = data.journeys;
                    saveFronts();
                    saveJourneys();
                    render();
                } catch (e) {
                    alert('Arquivo inválido para importação.');
                }
            };
            reader.readAsText(file);
        }
        function importAllDataFromFile(file) {
            const reader = new FileReader();
            reader.onload = function() {
                try {
                    const data = JSON.parse(reader.result);
                    if (!data || typeof data !== 'object') throw new Error('Formato inválido');
                    
                    // Verificar se é backup completo ou backup antigo (apenas fronts/journeys)
                    let backupData = data;
                    if (data.data && typeof data.data === 'object') {
                        // Novo formato de backup completo
                        backupData = data.data;
                        
                        // Mostrar informações do backup
                        if (data.metadata) {
                            const metadata = data.metadata;
                            const info = `Backup encontrado!\n\nData: ${data.exportDateISO ? new Date(data.exportDateISO).toLocaleString('pt-BR') : 'Data não disponível'}\n\nConteúdo:\n- ${metadata.frontsCount || 0} Frentes\n- ${metadata.journeysCount || 0} Jornadas\n- ${metadata.okrsCount || 0} OKRs\n- ${metadata.projectsCount || 0} Projetos\n- ${metadata.executivoPanelsCount || 0} Painéis Executivos\n- ${metadata.executivoCollectionsCount || 0} Coleções Executivas\n- ${metadata.indicatorsPillarsCount || 0} Pilares de Indicadores\n- ${metadata.cmdbDataCount || 0} Itens CMDB\n\nDeseja importar todos esses dados?`;
                            if (!confirm(info)) return;
                        }
                    } else {
                        // Formato antigo - apenas fronts e journeys
                        if (!confirm('Arquivo de backup antigo detectado (apenas Frentes e Jornadas). Importar?')) return;
                    }
                    
                    // Importar dados
                    let importedCount = 0;
                    
                    if (Array.isArray(backupData.fronts)) {
                        fronts = backupData.fronts;
                        saveFronts();
                        importedCount++;
                    }
                    
                    if (Array.isArray(backupData.journeys)) {
                        journeys = backupData.journeys;
                        saveJourneys();
                        importedCount++;
                    }
                    
                    if (Array.isArray(backupData.okrs)) {
                        okrs = backupData.okrs;
                        saveOKRs();
                        importedCount++;
                    }
                    
                    if (backupData.indicators && typeof backupData.indicators === 'object') {
                        indicators = backupData.indicators;
                        saveIndicators();
                        importedCount++;
                    }
                    
                    if (Array.isArray(backupData.projects)) {
                        projects = backupData.projects;
                        saveProjects();
                        importedCount++;
                    }
                    
                    if (Array.isArray(backupData.executivoPanels)) {
                        executivoPanels = backupData.executivoPanels;
                        saveExecutivoPanels();
                        importedCount++;
                    }
                    
                    if (Array.isArray(backupData.executivoCollections)) {
                        executivoCollections = backupData.executivoCollections;
                        saveExecutivoCollections();
                        importedCount++;
                    }
                    
                    if (Array.isArray(backupData.cmdbData)) {
                        cmdbData = backupData.cmdbData;
                        saveCMDBData();
                        importedCount++;
                    }
                    
                    if (backupData.servicenowApiConfig && typeof backupData.servicenowApiConfig === 'object') {
                        servicenowApiConfig = backupData.servicenowApiConfig;
                        saveServiceNowApiConfig();
                        importedCount++;
                    }
                    
                    if (backupData.uiState && typeof backupData.uiState === 'object') {
                        if (backupData.uiState.currentPage) currentPage = backupData.uiState.currentPage;
                        if (typeof backupData.uiState.filtersExpanded === 'boolean') filtersExpanded = backupData.uiState.filtersExpanded;
                        if (backupData.uiState.filters && typeof backupData.uiState.filters === 'object') {
                            filters = Object.assign(filters, backupData.uiState.filters);
                        }
                        saveUIState();
                    }
                    
                    // Recarregar página para aplicar todos os dados
                    render();
                    
                    // Mensagem de sucesso
                    setTimeout(() => {
                        alert(`Backup importado com sucesso!\n\n${importedCount} tipo(s) de dados restaurado(s).`);
                    }, 100);
                    
                } catch (e) {
                    alert(`Erro ao importar backup: ${e.message}\n\nVerifique se o arquivo é um backup válido do Hub de Tecnologia.`);
                    console.error('Erro na importação:', e);
                }
            };
            reader.readAsText(file);
        }

        function handleImportFile(input) {
            const file = input && input.files && input.files[0];
            if (file) {
                importDataFromFile(file);
            }
            if (input) input.value = '';
        }

        function handleImportAllFile(input) {
            const file = input && input.files && input.files[0];
            if (file) {
                importAllDataFromFile(file);
            }
            if (input) input.value = '';
        }
        function openJourneysExportModal() {
            showJourneysExportModal = true;
            render();
        }

        function closeJourneysExportModal() {
            showJourneysExportModal = false;
            render();
        }

        function openJourneysImportModal() {
            showJourneysImportModal = true;
            render();
        }

        function closeJourneysImportModal() {
            showJourneysImportModal = false;
            render();
        }

        function closeJourneysImportResultModal() {
            showJourneysImportResultModal = false;
            journeysImportSummary = '';
            render();
        }

        function copyJourneysImportSummary() {
            if (!journeysImportSummary) return;
            if (navigator?.clipboard?.writeText) {
                navigator.clipboard.writeText(journeysImportSummary)
                    .then(() => alert('Resumo copiado para a área de transferência!'))
                    .catch(() => fallbackCopyJourneysSummary());
            } else {
                fallbackCopyJourneysSummary();
            }
        }

        function fallbackCopyJourneysSummary() {
            const textarea = document.querySelector('#journeys-import-summary-textarea');
            if (!textarea) return;
            textarea.select();
            try {
                document.execCommand('copy');
                alert('Resumo copiado para a área de transferência!');
            } catch {
                alert('Não foi possível copiar automaticamente. Selecione o texto e copie manualmente.');
            }
        }

        function setJourneysExportOption(option, value) {
            journeysExportOptions[option] = !!value;
            render();
        }

        function setJourneysExportCategory(category, value) {
            if (!journeysExportOptions.events) journeysExportOptions.events = {};
            journeysExportOptions.events[category] = !!value;
            render();
        }

        function toggleAllJourneysExportCategories(value) {
            if (!journeysExportOptions.events) journeysExportOptions.events = {};
            eventCategories.forEach(category => {
                if (supportedJourneyEventCategories.includes(category)) {
                    journeysExportOptions.events[category] = !!value;
                }
            });
            render();
        }

        function resetJourneysExportOptions() {
            journeysExportOptions = journeyDefaultExportOptions();
            render();
        }

        function hasJourneysExportSelection() {
            const hasEvents = journeysExportOptions.events ? Object.values(journeysExportOptions.events).some(Boolean) : false;
            return !!journeysExportOptions.journeys || hasEvents;
        }
        function exportJourneysToExcel() {
            if (!hasJourneysExportSelection()) {
                alert('Selecione ao menos um tipo de dado para exportar.');
                return;
            }
            if (typeof XLSX === 'undefined') {
                alert('Biblioteca de planilhas não carregada. Verifique a conexão com a internet.');
                return;
            }
            try {
                const workbook = buildJourneysWorkbook('data', journeysExportOptions);
                const dateStr = new Date().toISOString().split('T')[0];
                const filename = `maturidade-jornadas_${dateStr}.xlsx`;
                const wbout = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });
                const blob = new Blob([wbout], { type: 'application/octet-stream' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(link.href);
                closeJourneysExportModal();
                alert('Exportação concluída! O arquivo foi gerado com o modelo pronto para importação.');
            } catch (error) {
                console.error('Erro ao exportar jornadas:', error);
                alert('Não foi possível gerar o arquivo de exportação. Tente novamente.');
            }
        }
        function downloadJourneysTemplate() {
            if (typeof XLSX === 'undefined') {
                alert('Biblioteca de planilhas não carregada. Verifique a conexão com a internet.');
                return;
            }
            try {
                const templateOptions = {
                    journeys: true,
                    events: eventCategories.reduce((acc, category) => {
                        if (supportedJourneyEventCategories.includes(category)) {
                            acc[category] = true;
                        }
                        return acc;
                    }, {})
                };
                const workbook = buildJourneysWorkbook('template', templateOptions);
                const filename = 'modelo-importacao-jornadas.xlsx';
                const wbout = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });
                const blob = new Blob([wbout], { type: 'application/octet-stream' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(link.href);
            } catch (error) {
                console.error('Erro ao gerar template de jornadas:', error);
                alert('Não foi possível gerar o modelo de importação. Tente novamente.');
            }
        }
        function buildSheetFromColumns(columns, rows) {
            // Criar array de arrays: primeira linha são os headers, seguida das linhas de dados
            const data = [];
            // Adicionar headers (primeira linha)
            const headers = columns.map(col => col.header);
            data.push(headers);
            // Adicionar linhas de dados
            rows.forEach(row => {
                const rowData = columns.map(col => {
                    const value = row[col.key];
                    // Converter valores undefined/null para string vazia
                    if (value === undefined || value === null) return '';
                    // Se for array, converter para string separada por ;
                    if (Array.isArray(value)) return value.join('; ');
                    // Se for objeto Date, converter para ISO string
                    if (value instanceof Date) return value.toISOString();
                    // Retornar o valor como string
                    return String(value);
                });
                data.push(rowData);
            });
            // Criar planilha a partir do array de arrays
            return XLSX.utils.aoa_to_sheet(data);
        }
        function collectIncidentRows() {
            const rows = [];
            journeys.forEach(journey => {
                if (!journey.events) return;
                const incidents = getJourneyIncidents(journey);
                incidents.forEach(incident => {
                    const affectedJourney = incident.affectedJourney 
                        ? journeys.find(j => j.id === incident.affectedJourney) || journey
                        : journey;
                    rows.push({
                        journeyId: journey.id,
                        journeyRef: journey.name,
                        incidentNumber: incident.incidentNumber || '',
                        date: incident.date || incident.createdAt || '',
                        mttr: incident.mttr || '',
                        description: incident.description || '',
                        relatedRisk: incident.relatedRisk || '',
                        origin: incident.origin || '',
                        prevention: incident.prevention || '',
                        lessons: incident.lessons || '',
                        pillar: incident.pillar ? (typeof incident.pillar === 'string' ? incident.pillar : Object.keys(incident.pillar)[0]) : '',
                        attributes: Array.isArray(incident.attributes) ? incident.attributes.join('; ') : (incident.attributes || '')
                    });
                });
            });
            return rows;
        }
        function collectFunctionalIncidentRows() {
            const rows = [];
            journeys.forEach(journey => {
                if (!journey.events) return;
                journey.events.forEach(event => {
                    if (event.category !== EVENT_CATEGORY_INCIDENT_FUNCTIONAL) return;
                    const affectedJourney = event.affectedJourney 
                        ? journeys.find(j => j.id === event.affectedJourney) || journey
                        : journey;
                    rows.push({
                        journeyId: journey.id,
                        journeyRef: affectedJourney.name,
                        incidentNumber: event.incidentNumber || '',
                        acronym: event.acronym || '',
                        createdAt: event.createdAt || '',
                        resolvedAt: event.resolvedAt || '',
                        shortDescription: event.shortDescription || '',
                        description: event.description || '',
                        resolutionNotes: event.resolutionNotes || '',
                        resolutionType: event.resolutionType || '',
                        classification: event.classification || ''
                    });
                });
            });
            return rows;
        }
        function collectRiskRows() {
            const rows = [];
            journeys.forEach(journey => {
                if (!journey.events) return;
                const risks = getJourneyRisks(journey);
                risks.forEach(risk => {
                    rows.push({
                        journeyId: journey.id,
                        journeyRef: journey.name,
                        plannerId: risk.plannerId || '',
                        taskName: risk.taskName || '',
                        progress: risk.progress || 0,
                        priority: risk.priority || '',
                        assignedTo: risk.assignedTo || '',
                        createdBy: risk.createdBy || '',
                        createdAt: risk.createdAt || '',
                        startDate: risk.startDate || '',
                        dueDate: risk.dueDate || '',
                        isRecurring: risk.isRecurring ? 'Sim' : 'Não',
                        isOverdue: risk.isOverdue ? 'Sim' : 'Não',
                        isCompleted: risk.isCompleted ? 'Sim' : 'Não',
                        completedAt: risk.completedAt || '',
                        completedBy: risk.completedBy || '',
                        checklist: risk.checklist || '',
                        labels: risk.labels || '',
                        description: risk.description || ''
                    });
                });
            });
            return rows;
        }
        function collectAlertRows() {
            const rows = [];
            journeys.forEach(journey => {
                if (!journey.events) return;
                const alerts = getJourneyAlerts(journey);
                alerts.forEach(alert => {
                    rows.push({
                        journeyId: journey.id,
                        journeyRef: journey.name,
                        alertId: alert.alertId || '',
                        title: alert.title || '',
                        source: alert.source || '',
                        severity: alert.severity || '',
                        status: alert.status || '',
                        openedAt: alert.openedAt || '',
                        closedAt: alert.closedAt || '',
                        impactedService: alert.impactedService || '',
                        owner: alert.owner || '',
                        tags: alert.tags || '',
                        url: alert.url || '',
                        notes: alert.notes || ''
                    });
                });
            });
            return rows;
        }
        function collectObsolescenceRows() {
            const rows = [];
            journeys.forEach(journey => {
                if (!journey.events) return;
                const obsolescenceItems = getJourneyObsolescenceItems(journey);
                obsolescenceItems.forEach(item => {
                    rows.push({
                        journeyId: journey.id,
                        journeyRef: journey.name,
                        component: item.component || '',
                        vendor: item.vendor || '',
                        currentVersion: item.currentVersion || '',
                        targetVersion: item.targetVersion || '',
                        endOfSupport: item.endOfSupport || '',
                        impact: item.impact || '',
                        remediationPlan: item.remediationPlan || '',
                        status: item.status || '',
                        owner: item.owner || '',
                        notes: item.notes || ''
                    });
                });
            });
            return rows;
        }
        function collectVulnerabilityRows() {
            const rows = [];
            journeys.forEach(journey => {
                if (!journey.events) return;
                const vulnerabilities = getJourneyVulnerabilities(journey);
                vulnerabilities.forEach(vuln => {
                    rows.push({
                        journeyId: journey.id,
                        journeyRef: journey.name,
                        identifier: vuln.identifier || '',
                        severity: vuln.severity || '',
                        cvssScore: vuln.cvssScore || '',
                        affectedService: vuln.affectedService || '',
                        discoveredAt: vuln.discoveredAt || '',
                        dueAt: vuln.dueAt || '',
                        status: vuln.status || '',
                        owner: vuln.owner || '',
                        notes: vuln.notes || ''
                    });
                });
            });
            return rows;
        }

        function buildJourneysWorkbook(mode, options) {
            const workbook = XLSX.utils.book_new();

            if (mode === 'template') {
                const instructions = [
                    ['Instruções para preenchimento'],
                    ['1. Utilize a aba "Jornadas" para cadastrar ou atualizar jornadas existentes.'],
                    ['2. Utilize a aba "Incidentes Quebra Servico" para relacionar incidentes de quebra de serviço.'],
                    ['3. Utilize a aba "Incidentes Funcionais" para registrar incidentes funcionais.'],
                    ['4. Utilize a aba "Riscos" para relacionar riscos às jornadas.'],
                    ['5. Utilize a aba "Alertas" para registrar alertas das ferramentas de monitoramento.'],
                    ['6. Utilize a aba "Obsolescência" para registrar itens com fim de suporte próximo.'],
                    ['7. Utilize a aba "Vulnerabilidades" para registrar vulnerabilidades de segurança.'],
                    ['8. Sempre informe ao menos o Nome e a Sigla da jornada.'],
                    ['9. Para eventos, a jornada precisa existir antes da importação.'],
                    ['10. Colunas marcadas como (opcional) podem ser deixadas em branco.']
                ];
                const instructionsSheet = XLSX.utils.aoa_to_sheet(instructions);
                XLSX.utils.book_append_sheet(workbook, instructionsSheet, 'Instruções');
            }

            if (options.journeys) {
                const journeyRows = mode === 'data'
                    ? journeys.map(journey => ({
                        id: journey.id,
                        name: journey.name,
                        acronym: journey.acronym,
                        status: journey.status,
                        owner: journey.owner || ''
                    }))
                    : [{
                        id: '',
                        name: journeys[0]?.name || 'Ex: Jornada de Pagamentos',
                        acronym: journeys[0]?.acronym || 'EXEMPLO',
                        status: journeys[0]?.status || 'active',
                        owner: journeys[0]?.owner || 'Ex: Maria Oliveira'
                    }];

                const journeySheet = buildSheetFromColumns(journeySheetColumns, journeyRows);
                XLSX.utils.book_append_sheet(workbook, journeySheet, 'Jornadas');
            }
            const selectedEvents = Object.entries(options.events || {}).filter(([, enabled]) => enabled);
            selectedEvents.forEach(([category]) => {
                if (!supportedJourneyEventCategories.includes(category)) return;
                if (category === EVENT_CATEGORY_INCIDENT_SERVICE) {
                    const incidentRows = mode === 'data'
                        ? collectIncidentRows()
                        : [{
                            journeyId: '',
                            journeyRef: journeys[0] ? `${journeys[0].name}` : 'Ex: Jornada de Pagamentos',
                            incidentNumber: journeys[0]?.events?.find(e => e.category === EVENT_CATEGORY_INCIDENT_SERVICE || e.category === 'Incidentes')?.incidentNumber || 'INC-2024-0001',
                            date: new Date().toISOString(),
                            mttr: '2h 00min',
                            description: 'Descrição do incidente que impactou a jornada.',
                            relatedRisk: 'Risco relacionado (opcional)',
                            origin: 'Aplicação',
                            prevention: 'Ações para evitar recorrência',
                            lessons: 'Lições aprendidas',
                            pillar: 'Disponibilidade',
                            attributes: 'Alertas; Observability'
                        }];
                    const incidentSheet = buildSheetFromColumns(incidentSheetColumns, incidentRows);
                    XLSX.utils.book_append_sheet(workbook, incidentSheet, 'Incidentes Quebra Servico');
                } else if (category === EVENT_CATEGORY_INCIDENT_FUNCTIONAL) {
                    const functionalRows = mode === 'data'
                        ? collectFunctionalIncidentRows()
                        : [{
                            journeyId: '',
                            journeyRef: journeys[0] ? `${journeys[0].name}` : 'Ex: Jornada de Pagamentos',
                            incidentNumber: 'FIC-2024-0001',
                            acronym: journeys[0]?.acronym || 'JRN',
                            createdAt: new Date().toISOString(),
                            resolvedAt: '',
                            shortDescription: 'Resumo do incidente funcional.',
                            description: 'Detalhes do incidente funcional.',
                            resolutionNotes: 'Notas sobre a resolução aplicada.',
                            resolutionType: 'Correção definitiva',
                            classification: 'Funcional'
                        }];
                    const functionalSheet = buildSheetFromColumns(functionalIncidentSheetColumns, functionalRows);
                    XLSX.utils.book_append_sheet(workbook, functionalSheet, 'Incidentes Funcionais');
                } else if (category === EVENT_CATEGORY_RISK) {
                    const riskRows = mode === 'data'
                        ? collectRiskRows()
                        : [{
                            journeyId: '',
                            journeyRef: journeys[0] ? `${journeys[0].name}` : 'Ex: Jornada de Pagamentos',
                            plannerId: 'TASK-123',
                            taskName: 'Mitigar falha de autenticação',
                            progress: 50,
                            priority: 'Alta',
                            assignedTo: 'Responsável pelo risco',
                            createdBy: 'Quem registrou',
                            createdAt: new Date().toISOString().split('T')[0],
                            startDate: new Date().toISOString().split('T')[0],
                            dueDate: '',
                            isRecurring: 'Não',
                            isOverdue: 'Não',
                            isCompleted: 'Não',
                            completedAt: '',
                            completedBy: '',
                            checklist: 'Item 1\nItem 2',
                            labels: 'Segurança; Urgente',
                            description: 'Descrição do risco e plano de ação'
                        }];
                    const riskSheet = buildSheetFromColumns(riskSheetColumns, riskRows);
                    XLSX.utils.book_append_sheet(workbook, riskSheet, 'Riscos');
                } else if (category === EVENT_CATEGORY_ALERT) {
                    const alertRows = mode === 'data'
                        ? collectAlertRows()
                        : [{
                            journeyId: '',
                            journeyRef: journeys[0] ? `${journeys[0].name}` : 'Ex: Jornada de Pagamentos',
                            alertId: 'ALERT-12345',
                            title: 'Alta utilização de CPU no serviço X',
                            source: 'Dynatrace',
                            severity: 'High',
                            status: 'Aberto',
                            openedAt: new Date().toISOString(),
                            closedAt: '',
                            impactedService: 'Serviço de Pagamentos',
                            owner: 'Responsável',
                            tags: '#producao; #critico',
                            url: 'https://link.para.ocorrencia',
                            notes: 'Observações e ações adotadas'
                        }];
                    const alertSheet = buildSheetFromColumns(alertSheetColumns, alertRows);
                    XLSX.utils.book_append_sheet(workbook, alertSheet, 'Alertas');
                } else if (category === EVENT_CATEGORY_OBSOLESCENCE) {
                    const obsolescenceRows = mode === 'data'
                        ? collectObsolescenceRows()
                        : [{
                            journeyId: '',
                            journeyRef: journeys[0] ? `${journeys[0].name}` : 'Ex: Jornada de Pagamentos',
                            component: 'SQL Server 2012',
                            vendor: 'Microsoft',
                            currentVersion: '2012',
                            targetVersion: '2019',
                            endOfSupport: new Date(new Date().setFullYear(new Date().getFullYear() + 1)).toISOString().split('T')[0],
                            impact: 'Impacto operacional descrito',
                            remediationPlan: 'Plano de remediação resumido',
                            status: 'Em análise',
                            owner: 'Responsável',
                            notes: 'Observações adicionais'
                        }];
                    const obsolescenceSheet = buildSheetFromColumns(obsolescenceSheetColumns, obsolescenceRows);
                    XLSX.utils.book_append_sheet(workbook, obsolescenceSheet, 'Obsolescência');
                } else if (category === EVENT_CATEGORY_VULNERABILITY) {
                    const vulnerabilityRows = mode === 'data'
                        ? collectVulnerabilityRows()
                        : [{
                            journeyId: '',
                            journeyRef: journeys[0] ? `${journeys[0].name}` : 'Ex: Jornada de Pagamentos',
                            identifier: 'CVE-2023-12345',
                            severity: 'High',
                            cvssScore: '7.5 (Base Score)',
                            affectedService: 'API Gateway',
                            discoveredAt: new Date().toISOString().split('T')[0],
                            dueAt: new Date(new Date().setMonth(new Date().getMonth() + 1)).toISOString().split('T')[0],
                            status: 'Aberto',
                            owner: 'Responsável',
                            notes: 'Detalhes, evidências e plano de ação'
                        }];
                    const vulnerabilitySheet = buildSheetFromColumns(vulnerabilitySheetColumns, vulnerabilityRows);
                    XLSX.utils.book_append_sheet(workbook, vulnerabilitySheet, 'Vulnerabilidades');
                }
            });
            return workbook;
        }
        function processJourneysWorkbook(workbook) {
            const stats = {
                journeysCreated: 0,
                journeysUpdated: 0,
                incidentsProcessed: 0,
                risksProcessed: 0
            };
            const errors = [];
            const details = {
                createdJourneys: [],
                updatedJourneys: [],
                skippedJourneys: [],
                incidentUpdates: [],
                riskUpdates: []
            };
            const usedAcronyms = new Set(journeys.filter(j => j.acronym).map(j => j.acronym.toLowerCase()));

            const sheetNames = workbook.SheetNames || [];
            if (sheetNames.length === 0) {
                throw new Error('Arquivo sem abas. Verifique se o modelo foi utilizado.');
            }

            const journeysSheet = workbook.Sheets['Jornadas'] || workbook.Sheets['jornadas'];
            if (journeysSheet) {
                const rows = XLSX.utils.sheet_to_json(journeysSheet, { defval: '' });
                rows.forEach((row, index) => {
                    if (isRowEmpty(row)) return;
                    const name = (row['Nome'] || '').toString().trim();
                    let acronym = (row['Sigla'] || '').toString().trim();
                    if (!name) {
                        errors.push(`Jornadas linha ${index + 2}: Nome é obrigatório e a linha foi ignorada.`);
                        details.skippedJourneys.push(`Linha ${index + 2}: Nome ausente`);
                        return;
                    }
                    if (!acronym) {
                        const generated = generateJourneyAcronym(name, usedAcronyms);
                        acronym = generated.value;
                        errors.push(`Jornadas linha ${index + 2}: ${generated.message}`);
                    }

                    const providedIdRaw = (row['ID'] || '').toString().trim();
                    const statusRaw = (row['Status (active/inactive/discovery)'] || '').toString().trim();
                    const ownerRaw = (row['Owner/Gestor'] || '').toString().trim();
                    const status = normalizeJourneyStatus(statusRaw);

                    let journey = null;
                    if (providedIdRaw) {
                        journey = journeys.find(j => j.id === providedIdRaw);
                    }
                    if (!journey) {
                        journey = journeys.find(j => j.acronym && j.acronym.toLowerCase() === acronym.toLowerCase());
                    }
                    if (!journey) {
                        journey = journeys.find(j => (j.name || '').toLowerCase() === name.toLowerCase());
                    }

                    if (journey) {
                        journey.name = name;
                        journey.acronym = acronym.toUpperCase();
                        journey.status = status;
                        journey.owner = ownerRaw;
                        stats.journeysUpdated++;
                        usedAcronyms.add(journey.acronym.toLowerCase());
                        details.updatedJourneys.push(`Linha ${index + 2}: ${journey.name} (${journey.acronym})`);
                    } else {
                        const generatedId = providedIdRaw && !journeys.some(j => j.id === providedIdRaw)
                            ? providedIdRaw
                            : 'j' + Date.now() + index;
                        const newJourney = {
                            id: generatedId,
                            name: name,
                            acronym: acronym.toUpperCase(),
                            status: status,
                            owner: ownerRaw,
                            events: [],
                            maturity: {}
                        };
                        Object.keys(pillarAttributes).forEach(pillar => {
                            newJourney.maturity[pillar] = {};
                            Object.keys(pillarAttributes[pillar]).forEach(attr => {
                                newJourney.maturity[pillar][attr] = 0;
                            });
                        });
                        journeys.push(newJourney);
                        stats.journeysCreated++;
                        usedAcronyms.add(newJourney.acronym.toLowerCase());
                        details.createdJourneys.push(`Linha ${index + 2}: ${newJourney.name} (${newJourney.acronym})`);
                    }
                });
            }

            const incidentsSheet = workbook.Sheets['Incidentes Quebra Servico'] || workbook.Sheets['Incidentes'] || workbook.Sheets['incidentes'];
            if (incidentsSheet) {
                const rows = XLSX.utils.sheet_to_json(incidentsSheet, { defval: '' });
                rows.forEach((row, index) => {
                    if (isRowEmpty(row)) return;
                    const journeyRefId = (row['Jornada ID (opcional)'] || '').toString().trim();
                    const journeyRefName = (row['Jornada (Nome ou Sigla)'] || '').toString().trim();
                    const incidentNumber = (row['Número do Incidente'] || '').toString().trim();
                    const description = (row['Descrição'] || '').toString().trim();
                    const journey = findJourneyByReference(journeyRefId, journeyRefName);
                    if (!journey) {
                        errors.push(`Incidentes linha ${index + 2}: Jornada não encontrada (${journeyRefName || journeyRefId || 'sem referência'}).`);
                        details.incidentUpdates.push(`Linha ${index + 2}: Incidente ignorado (jornada não encontrada)`);
                        return;
                    }
                    if (!incidentNumber || !description) {
                        errors.push(`Incidentes linha ${index + 2}: Número do Incidente e Descrição são obrigatórios.`);
                        details.incidentUpdates.push(`Linha ${index + 2}: Incidente ignorado (campos obrigatórios ausentes)`);
                        return;
                    }

                    if (!Array.isArray(journey.events)) {
                        journey.events = [];
                    }

                    const existing = journey.events.find(event => (event.category === EVENT_CATEGORY_INCIDENT_SERVICE || event.category === 'Incidentes') && event.incidentNumber === incidentNumber);
                    const payload = {
                        category: EVENT_CATEGORY_INCIDENT_SERVICE,
                        incidentNumber: incidentNumber,
                        date: convertExcelDate(row['Data/Horário']),
                        mttr: (row['MTTR'] || '').toString().trim(),
                        description: description,
                        affectedJourney: journey.id,
                        relatedRisk: (row['Risco Relacionado'] || '').toString().trim(),
                        origin: (row['Origem'] || '').toString().trim(),
                        prevention: (row['Ações de Prevenção'] || '').toString().trim(),
                        lessons: (row['Lições Aprendidas'] || '').toString().trim(),
                        pillar: normalizePillar(row['Pilar (Disponibilidade/Qualidade/Segurança/Performance)']),
                        attributes: parseAttributesCell(row['Atributos Impactados (separados por ;)']),
                        updatedAt: new Date().toISOString()
                    };

                    if (existing) {
                        Object.assign(existing, payload);
                        details.incidentUpdates.push(`Linha ${index + 2}: Atualizado incidente ${incidentNumber} (Jornada ${journey.name})`);
                    } else {
                        journey.events.push({
                            id: 'inc' + Date.now() + index,
                            createdAt: new Date().toISOString(),
                            ...payload
                        });
                        details.incidentUpdates.push(`Linha ${index + 2}: Criado incidente ${incidentNumber} (Jornada ${journey.name})`);
                    }
                    stats.incidentsProcessed++;
                });
            }

            const functionalIncidentsSheet = workbook.Sheets['Incidentes Funcionais'] || workbook.Sheets['incidentes funcionais'];
            if (functionalIncidentsSheet) {
                const rows = XLSX.utils.sheet_to_json(functionalIncidentsSheet, { defval: '' });
                rows.forEach((row, index) => {
                    if (isRowEmpty(row)) return;
                    const journeyRefId = (row['Jornada ID (opcional)'] || '').toString().trim();
                    const journeyRefName = (row['Jornada (Nome ou Sigla)'] || '').toString().trim();
                    const incidentNumber = (row['Número do Incidente'] || '').toString().trim();
                    const shortDescription = (row['Descrição Curta'] || '').toString().trim();
                    const journey = findJourneyByReference(journeyRefId, journeyRefName);
                    if (!journey) {
                        errors.push(`Incidentes Funcionais linha ${index + 2}: Jornada não encontrada (${journeyRefName || journeyRefId || 'sem referência'}).`);
                        details.incidentUpdates.push(`Linha ${index + 2}: Incidente funcional ignorado (jornada não encontrada)`);
                        return;
                    }
                    if (!incidentNumber || !shortDescription) {
                        errors.push(`Incidentes Funcionais linha ${index + 2}: Número do Incidente e Descrição Curta são obrigatórios.`);
                        details.incidentUpdates.push(`Linha ${index + 2}: Incidente funcional ignorado (campos obrigatórios ausentes)`);
                        return;
                    }

                    if (!Array.isArray(journey.events)) {
                        journey.events = [];
                    }

                    const existing = journey.events.find(event => event.category === EVENT_CATEGORY_INCIDENT_FUNCTIONAL && event.incidentNumber === incidentNumber);
                    const payload = {
                        category: EVENT_CATEGORY_INCIDENT_FUNCTIONAL,
                        incidentNumber: incidentNumber,
                        acronym: (row['Sigla'] || row['Sigla Relacionada'] || '').toString().trim(),
                        createdAt: convertExcelDate(row['Data de Criação']),
                        resolvedAt: convertExcelDate(row['Data de Resolução']),
                        shortDescription: shortDescription,
                        description: (row['Descrição'] || '').toString().trim(),
                        resolutionNotes: (row['Notas de Resolução'] || '').toString().trim(),
                        resolutionType: (row['Tipo de Resolução'] || '').toString().trim(),
                        classification: (row['Classificação'] || '').toString().trim(),
                        affectedJourney: journey.id,
                        updatedAt: new Date().toISOString()
                    };

                    if (existing) {
                        Object.assign(existing, payload);
                        details.incidentUpdates.push(`Linha ${index + 2}: Atualizado incidente funcional ${incidentNumber} (Jornada ${journey.name})`);
                    } else {
                        journey.events.push({
                            id: 'func' + Date.now() + index,
                            ...payload
                        });
                        details.incidentUpdates.push(`Linha ${index + 2}: Criado incidente funcional ${incidentNumber} (Jornada ${journey.name})`);
                    }
                    stats.incidentsProcessed++;
                });
            }

            const risksSheet = workbook.Sheets['Riscos'] || workbook.Sheets['riscos'];
            if (risksSheet) {
                const rows = XLSX.utils.sheet_to_json(risksSheet, { defval: '' });
                rows.forEach((row, index) => {
                    if (isRowEmpty(row)) return;
                    const plannerId = (row['ID do Planner/Task'] || '').toString().trim();
                    const taskName = (row['Nome da Tarefa'] || '').toString().trim();
                    const journeyRefId = (row['Jornada ID (opcional)'] || '').toString().trim();
                    const journeyRefName = (row['Jornada (Nome ou Sigla)'] || '').toString().trim();
                    const journey = findJourneyByReference(journeyRefId, journeyRefName);
                    if (!journey) {
                        errors.push(`Riscos linha ${index + 2}: Jornada não encontrada (${journeyRefName || journeyRefId || 'sem referência'}).`);
                        details.riskUpdates.push(`Linha ${index + 2}: Ignorado (jornada não encontrada)`);
                        return;
                    }
                    if (!plannerId || !taskName) {
                        errors.push(`Riscos linha ${index + 2}: ID do Planner e Nome da Tarefa são obrigatórios.`);
                        details.riskUpdates.push(`Linha ${index + 2}: Ignorado (campos obrigatórios ausentes)`);
                        return;
                    }

                    if (!Array.isArray(journey.events)) {
                        journey.events = [];
                    }

                    const existing = journey.events.find(event => event.category === EVENT_CATEGORY_RISK && event.plannerId === plannerId);
                    const payload = {
                        category: EVENT_CATEGORY_RISK,
                        plannerId: plannerId,
                        taskName: taskName,
                        bucket: journey.id,
                        progress: parseInt(row['Progresso (%)'], 10) || 0,
                        priority: (row['Prioridade'] || '').toString().trim(),
                        assignedTo: (row['Atribuído a'] || '').toString().trim(),
                        createdBy: (row['Criado por'] || '').toString().trim(),
                        createdAt: convertExcelDate(row['Criado em'], true),
                        startDate: convertExcelDate(row['Data de Início'], true),
                        dueDate: convertExcelDate(row['Data de Conclusão'], true),
                        isRecurring: parseBooleanCell(row['É Recorrente? (Sim/Não)']),
                        isOverdue: parseBooleanCell(row['Está Atrasado? (Sim/Não)']),
                        isCompleted: parseBooleanCell(row['Está Concluído? (Sim/Não)']),
                        completedAt: convertExcelDate(row['Concluído em'], true),
                        completedBy: (row['Concluído por'] || '').toString().trim(),
                        checklist: (row['Checklist'] || '').toString(),
                        labels: (row['Rótulos'] || '').toString(),
                        description: (row['Descrição'] || '').toString(),
                        updatedAt: new Date().toISOString()
                    };

                    if (existing) {
                        Object.assign(existing, payload);
                        details.riskUpdates.push(`Linha ${index + 2}: Atualizado risco ${plannerId} (Jornada ${journey.name})`);
                    } else {
                        journey.events.push({
                            id: 'risk' + Date.now() + index,
                            ...payload
                        });
                        details.riskUpdates.push(`Linha ${index + 2}: Criado risco ${plannerId} (Jornada ${journey.name})`);
                    }
                    stats.risksProcessed++;
                });
            }

            return { stats, errors, details };
        }

        function generateJourneyAcronym(name, usedAcronyms) {
            const sanitize = (text) => text
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '')
                .replace(/[^A-Za-z0-9]/g, '');

            const words = name.split(/\s+/).filter(Boolean);
            let base = sanitize(words.map(word => word[0]).join(''));
            if (!base || base.length < 2) {
                base = sanitize(name).slice(0, 4);
            }
            if (!base) {
                base = 'JOR';
            }
            base = base.toUpperCase().slice(0, 8);

            let candidate = base;
            let suffix = 2;
            while (usedAcronyms.has(candidate.toLowerCase())) {
                candidate = `${base}${suffix}`;
                suffix++;
            }

            usedAcronyms.add(candidate.toLowerCase());
            return {
                value: candidate,
                message: `Sigla ausente; gerado automaticamente "${candidate}".`
            };
        }

        function isRowEmpty(row) {
            return Object.values(row).every(value => value === '' || value === null || value === undefined);
        }

        function normalizeJourneyStatus(status) {
            const normalized = status.toString().toLowerCase();
            if (['active', 'in-progress', 'ativo'].includes(normalized)) return 'active';
            if (['inactive', 'inativa'].includes(normalized)) return 'inactive';
            if (['discovery', 'em discovery', 'discovery'].includes(normalized)) return 'discovery';
            return 'active';
        }

        function findJourneyByReference(journeyIdValue, journeyRefValue) {
            const journeyId = journeyIdValue ? journeyIdValue.toString().trim() : '';
            const ref = journeyRefValue ? journeyRefValue.toString().trim() : '';
            if (journeyId) {
                const byId = journeys.find(j => j.id === journeyId);
                if (byId) return byId;
            }
            if (ref) {
                const lowerRef = ref.toLowerCase();
                const byName = journeys.find(j => (j.name || '').toLowerCase() === lowerRef);
                if (byName) return byName;
                const byAcronym = journeys.find(j => (j.acronym || '').toLowerCase() === lowerRef);
                if (byAcronym) return byAcronym;
            }
            return null;
        }
        function convertExcelDate(value, dateOnly = false) {
            if (!value) return '';
            if (value instanceof Date && !Number.isNaN(value.getTime())) {
                return dateOnly ? value.toISOString().split('T')[0] : value.toISOString();
            }
            if (typeof value === 'number' && typeof XLSX !== 'undefined' && XLSX && XLSX.SSF) {
                const date = XLSX.SSF.parse_date_code(value);
                if (date) {
                    const jsDate = new Date(Date.UTC(
                        date.y,
                        (date.m || 1) - 1,
                        date.d || 1,
                        date.H || 0,
                        date.M || 0,
                        date.S || 0
                    ));
                    return dateOnly ? jsDate.toISOString().split('T')[0] : jsDate.toISOString();
                }
            }
            if (typeof value === 'string') {
                const trimmed = value.trim();
                if (!trimmed) return '';
                const parsed = new Date(trimmed);
                if (!Number.isNaN(parsed.getTime())) {
                    return dateOnly ? parsed.toISOString().split('T')[0] : parsed.toISOString();
                }
                return trimmed;
            }
            return '';
        }

        function parseBooleanCell(value) {
            if (typeof value === 'boolean') return value;
            if (typeof value === 'number') return value === 1;
            if (!value) return false;
            const normalized = value.toString().trim().toLowerCase();
            return ['sim', 'true', '1', 'yes', 'y', 's'].includes(normalized);
        }

        function normalizePillar(value) {
            if (!value) return '';
            const normalized = value.toString().trim().toLowerCase();
            const map = {
                'disponibilidade': 'availability',
                'availability': 'availability',
                'qualidade': 'quality',
                'quality': 'quality',
                'segurança': 'security',
                'seguranca': 'security',
                'security': 'security',
                'performance': 'performance'
            };
            return map[normalized] || '';
        }

        function parseAttributesCell(value) {
            if (!value) return [];
            if (Array.isArray(value)) return value.filter(Boolean).map(item => item.toString().trim());
            return value.toString()
                .split(/;|,/)
                .map(item => item.trim())
                .filter(item => item.length > 0);
        }

        function resetJourneys() {
            if (confirm('Restaurar Jornadas para os dados originais? Isso apagará alterações!')) {
                journeys = JSON.parse(JSON.stringify(defaultJourneys));
                saveJourneys();
                render();
            }
        }
        function closeAnyOpenModal() {
            let changed = false;
            if (selectedFrontId) { selectedFrontId = null; changed = true; }
            if (editingFrontId) { editingFrontId = null; changed = true; }
            if (creatingNewFront) { creatingNewFront = false; changed = true; }
            if (showEventModal) { showEventModal = false; changed = true; }
            if (selectedPillar || editingJourneyId) { selectedPillar = null; selectedAttribute = null; editingJourneyId = null; changed = true; }
            if (showIncidentOverview) { showIncidentOverview = false; incidentOverviewJourneyId = null; changed = true; }
            if (showFunctionalIncidentOverview) { showFunctionalIncidentOverview = false; functionalIncidentOverviewJourneyId = null; changed = true; }
            if (showRiskOverview) { showRiskOverview = false; riskOverviewJourneyId = null; changed = true; }
            if (showEditEventModal) { showEditEventModal = false; editingEventId = null; editingEventJourneyId = null; editingEventCategory = null; changed = true; }
            if (showServiceNowApiModal) { showServiceNowApiModal = false; changed = true; }
            if (showCMDBImportModal) { showCMDBImportModal = false; changed = true; }
            if (creatingNewJourney) { creatingNewJourney = false; changed = true; }
            if (showEditJourneyModal) { showEditJourneyModal = false; editingJourneyModalId = null; changed = true; }
            if (creatingNewOKR) { creatingNewOKR = false; changed = true; }
            if (editingOKRId) { editingOKRId = null; changed = true; }
            if (showingFrontsRelationModal) { showingFrontsRelationModal = null; draggedFrontId = null; changed = true; }
            if (showingTasksModal) { showingTasksModal = null; changed = true; }
            if (editingTaskIndex !== null) { editingTaskIndex = null; changed = true; }
            if (showingTaskForm) { showingTaskForm = false; changed = true; }
            if (changed) render();
        }
        function getFilteredFronts() {
            return fronts.filter(front => {
                if (filters.status.length > 0 && !filters.status.includes(front.status)) return false;
                if (filters.maturityLevel.length > 0 && !filters.maturityLevel.includes(front.maturityLevel)) return false;
                if (filters.owner.length > 0 && !filters.owner.includes(front.ownerName)) return false;
                if (filters.name && !front.name.toLowerCase().includes(filters.name.toLowerCase())) return false;
                return true;
            });
        }

        function getOKRsByFront(frontId) {
            // Buscar OKRs que tenham pelo menos um KR relacionado a esta frente
            return okrs.filter(okr => {
                return okr.krs && okr.krs.some(kr => kr.relatedFronts && kr.relatedFronts.includes(frontId));
            });
        }

        function openFrontDetail(frontId) {
            selectedFrontId = frontId;
            render();
        }
        function closeFrontDetail() {
            selectedFrontId = null;
            render();
        }

        function toggleLevel(level) {
            expandedLevels[level] = !expandedLevels[level];
            render();
        }

        function openEditFront(frontId) {
            editingFrontId = frontId;
            editFrontTab = 'basic';
            render();
        }

        function closeEditFront() {
            editingFrontId = null;
            render();
        }

        function openNewFront() {
            creatingNewFront = true;
            newFrontTab = 'basic';
            render();
        }

        function closeNewFront() {
            creatingNewFront = false;
            render();
        }
        function saveEditFront() {
            const front = fronts.find(f => f.id === editingFrontId);
            if (!front) return;

            const nameEl = document.getElementById('edit-front-name');
            const ownerEl = document.getElementById('edit-front-owner');
            const maturityEl = document.getElementById('edit-front-maturity');
            const statusEl = document.getElementById('edit-front-status');

            if (nameEl) front.name = nameEl.value.trim();
            if (ownerEl) {
                front.ownerName = ownerEl.value.trim();
                front.ownerInitials = front.ownerName.split(' ').map(n => n[0]).join('').toUpperCase();
            }
            if (maturityEl) front.maturityLevel = parseInt(maturityEl.value);
            if (statusEl) front.status = statusEl.value;

            const objectivesEl = document.getElementById('edit-front-objectives');
            if (objectivesEl) {
                const objectivesText = objectivesEl.value.trim();
                front.mainObjectives = objectivesText.split('\n').filter(o => o.trim());
            }

            const currentActionsEl = document.getElementById('edit-front-current-actions');
            if (currentActionsEl) {
                const currentActionsText = currentActionsEl.value.trim();
                front.currentActions = currentActionsText.split('\n').filter(a => a.trim());
            }

            const futureActionsEl = document.getElementById('edit-front-future-actions');
            if (futureActionsEl) {
                const futureActionsText = futureActionsEl.value.trim();
                front.futureActions = futureActionsText.split('\n').filter(a => a.trim());
            }

            const attentionPointsEl = document.getElementById('edit-front-attention-points');
            if (attentionPointsEl) {
                const attentionPointsText = attentionPointsEl.value.trim();
                front.attentionPoints = attentionPointsText.split('\n').filter(p => p.trim());
            }
            // Persistir Níveis de Maturidade quando a aba "maturity" for usada
            if (front.maturityLevels && Array.isArray(front.maturityLevels)) {
                front.maturityLevels = front.maturityLevels.map(levelObj => {
                    const level = levelObj.level;
                    const descEl = document.getElementById(`edit-level-${level}-description`);
                    const expEl = document.getElementById(`edit-level-${level}-expectations`);
                    const probEl = document.getElementById(`edit-level-${level}-problems`);
                    const indEl = document.getElementById(`edit-level-${level}-indicators`);

                    const next = { ...levelObj };
                    if (descEl) next.description = descEl.value.trim();
                    if (expEl) {
                        const lines = expEl.value.split('\n').map(l => l.trim()).filter(Boolean);
                        next.expectations = lines.map(line => {
                            const parts = line.split('|');
                            const description = (parts[0] || '').trim();
                            const rawStatus = (parts[1] || 'not-done').trim();
                            const status = ['done', 'in-progress', 'not-done'].includes(rawStatus) ? rawStatus : 'not-done';
                            return { description, status };
                        });
                    }
                    if (probEl) {
                        next.problemsAvoided = probEl.value.split('\n').map(l => l.trim()).filter(Boolean);
                    }
                    if (indEl) {
                        next.evolutionIndicators = indEl.value.split('\n').map(l => l.trim()).filter(Boolean);
                    }
                    return next;
                });
            }

            saveFronts();
            closeEditFront();
        }
        function saveNewFront() {
            const name = document.getElementById('new-front-name').value.trim();
            const ownerName = document.getElementById('new-front-owner').value.trim();
            const maturityLevel = parseInt(document.getElementById('new-front-maturity').value);
            const status = document.getElementById('new-front-status').value;

            if (!name || !ownerName) {
                alert('Nome e Owner são obrigatórios!');
                return;
            }

            const objectivesText = document.getElementById('new-front-objectives').value.trim();
            const mainObjectives = objectivesText.split('\n').filter(o => o.trim());

            const currentActionsText = document.getElementById('new-front-current-actions').value.trim();
            const currentActions = currentActionsText.split('\n').filter(a => a.trim());

            const futureActionsText = document.getElementById('new-front-future-actions').value.trim();
            const futureActions = futureActionsText.split('\n').filter(a => a.trim());

            const attentionPointsText = document.getElementById('new-front-attention-points').value.trim();
            const attentionPoints = attentionPointsText.split('\n').filter(p => p.trim());

            const newFront = {
                id: 'f' + Date.now(),
                name: name,
                ownerName: ownerName,
                ownerInitials: ownerName.split(' ').map(n => n[0]).join('').toUpperCase(),
                maturityLevel: maturityLevel,
                status: status,
                mainObjectives: mainObjectives,
                currentActions: currentActions,
                futureActions: futureActions,
                attentionPoints: attentionPoints,
                maturityLevels: [
                    { level: 1, description: "Nível 1", expectations: [], problemsAvoided: [], evolutionIndicators: [] },
                    { level: 2, description: "Nível 2", expectations: [], problemsAvoided: [], evolutionIndicators: [] },
                    { level: 3, description: "Nível 3", expectations: [], problemsAvoided: [], evolutionIndicators: [] },
                    { level: 4, description: "Nível 4", expectations: [], problemsAvoided: [], evolutionIndicators: [] },
                    { level: 5, description: "Nível 5", expectations: [], problemsAvoided: [], evolutionIndicators: [] }
                ]
            };

            fronts.push(newFront);
            saveFronts();
            closeNewFront();
        }

        function deleteFront(frontId) {
            const front = fronts.find(f => f.id === frontId);
            if (!front) return;
            
            // Verificar se há OKRs relacionados
            const relatedOKRs = getOKRsByFront(frontId);
            let warningMessage = 'Tem certeza que deseja deletar esta frente?';
            
            if (relatedOKRs.length > 0) {
                warningMessage = `Tem certeza que deseja deletar esta frente?\n\n⚠️ Atenção: Esta frente está relacionada a ${relatedOKRs.length} OKR(s). As relações serão removidas automaticamente.`;
            }
            
            if (confirm(warningMessage)) {
                // Remover a frente
                fronts = fronts.filter(f => f.id !== frontId);
                saveFronts();
                
                // Remover relações nos OKRs
                okrs.forEach(okr => {
                    okr.krs.forEach(kr => {
                        if (kr.relatedFronts && kr.relatedFronts.includes(frontId)) {
                            kr.relatedFronts = kr.relatedFronts.filter(id => id !== frontId);
                        }
                    });
                });
                saveOKRs();
                
                // Fechar modal de detalhes se estiver aberto
                if (selectedFrontId === frontId) {
                    selectedFrontId = null;
                }
                if (editingFrontId === frontId) {
                    editingFrontId = null;
                }
                
                render();
            }
        }

        function resetFronts() {
            if (confirm('Tem certeza que deseja restaurar todos os dados originais? Isso apagará todas as alterações!')) {
                fronts = JSON.parse(JSON.stringify(defaultFronts));
                saveFronts();
                render();
            }
        }
        // Funções auxiliares para cálculos de Dashboard
        function calculateOKRProgress() {
            if (!okrs || okrs.length === 0) return { average: 0, total: 0, onTrack: 0, atRisk: 0, behind: 0 };
            
            let totalProgress = 0;
            let onTrack = 0, atRisk = 0, behind = 0;
            
            okrs.forEach(okr => {
                if (okr.krs && okr.krs.length > 0) {
                    const okrProgress = okr.krs.reduce((sum, kr) => {
                        const progress = kr.realizado !== undefined && kr.target !== undefined && kr.target !== 0
                            ? (kr.realizado / kr.target) * 100 : 0;
                        return sum + Math.min(progress, 100);
                    }, 0) / okr.krs.length;
                    
                    totalProgress += okrProgress;
                    
                    if (okrProgress >= 80) onTrack++;
                    else if (okrProgress >= 50) atRisk++;
                    else behind++;
                }
            });
            
            return {
                average: okrs.length > 0 ? totalProgress / okrs.length : 0,
                total: okrs.length,
                onTrack,
                atRisk,
                behind
            };
        }

        function getFrontsMaturitySummary() {
            if (!fronts || fronts.length === 0) return { average: 0, distribution: {} };
            
            const maturitySum = fronts.reduce((sum, f) => sum + (f.maturityLevel || 0), 0);
            const distribution = {};
            
            fronts.forEach(f => {
                const level = f.maturityLevel || 0;
                distribution[level] = (distribution[level] || 0) + 1;
            });
            
            return {
                average: fronts.length > 0 ? maturitySum / fronts.length : 0,
                distribution,
                total: fronts.length
            };
        }
        function getExecutiveIndicatorsInsights() {
            const currentMonth = new Date().getMonth() + 1;
            const currentYear = new Date().getFullYear();
            
            // Calcular totais para o último mês disponível
            const getLastMonthValue = (pilar, indicador) => {
                // Tentar mês atual, depois mês anterior
                for (let monthOffset = 0; monthOffset >= -2; monthOffset--) {
                    const targetDate = new Date(currentYear, currentMonth - 1 + monthOffset, 1);
                    const monthYearKey = `${targetDate.getFullYear()}-${String(targetDate.getMonth() + 1).padStart(2, '0')}`;
                    const value = indicators[pilar]?.[indicador]?.[monthYearKey];
                    if (value !== undefined && value !== '') {
                        return parseFloat(value) || 0;
                    }
                }
                return 0;
            };
            
            // Calcular totais do último mês
            const lastMonthIncidents = getLastMonthValue('Gestão de Incidentes', 'Volume de Abertura de Incidentes Funcionais');
            const lastMonthChanges = getLastMonthValue('Gestão de Mudanças', 'Volume de Mudanças Realizadas');
            const lastMonthAlerts = getLastMonthValue('Gestão de Alertas', 'Volume de Alertas Recebidos');
            const lastMonthAbends = getLastMonthValue('Gestão de Abends', 'Volume de Abends Abertos');
            
            // Calcular variação nos últimos 3 meses
            const calculateTrend = (pilar, indicador) => {
                const values = [];
                for (let i = 2; i >= 0; i--) {
                    const targetDate = new Date(currentYear, currentMonth - 1 - i, 1);
                    const monthYearKey = `${targetDate.getFullYear()}-${String(targetDate.getMonth() + 1).padStart(2, '0')}`;
                    const value = indicators[pilar]?.[indicador]?.[monthYearKey];
                    if (value !== undefined && value !== '') {
                        values.push(parseFloat(value) || 0);
                    } else {
                        values.push(0);
                    }
                }
                
                if (values.length >= 2) {
                    const latest = values[values.length - 1];
                    const previous = values[values.length - 2];
                    if (previous !== 0) {
                        return ((latest - previous) / previous) * 100;
                    }
                }
                return 0;
            };
            
            return {
                totals: {
                    incidents: lastMonthIncidents,
                    changes: lastMonthChanges,
                    alerts: lastMonthAlerts,
                    abends: lastMonthAbends
                },
                trends: {
                    incidents: calculateTrend('Gestão de Incidentes', 'Volume de Abertura de Incidentes Funcionais'),
                    changes: calculateTrend('Gestão de Mudanças', 'Volume de Mudanças Realizadas'),
                    alerts: calculateTrend('Gestão de Alertas', 'Volume de Alertas Recebidos'),
                    abends: calculateTrend('Gestão de Abends', 'Volume de Abends Abertos')
                },
                summary: {
                    totalActivity: lastMonthIncidents + lastMonthChanges + lastMonthAlerts + lastMonthAbends,
                    healthScore: calculateHealthScore(lastMonthIncidents, lastMonthChanges, lastMonthAlerts, lastMonthAbends)
                }
            };
        }
        
        function calculateHealthScore(incidents, changes, alerts, abends) {
            // Score baseado em heurísticas de saúde operacional
            // Quanto menos incidentes e abends, melhor
            // Mudanças consistentes e alertas controlados = bom
            let score = 100;
            
            // Penalidades
            if (incidents > 50) score -= 20;
            else if (incidents > 20) score -= 10;
            
            if (abends > 10) score -= 15;
            else if (abends > 5) score -= 8;
            
            if (alerts > 200) score -= 10;
            
            // Bonificações
            if (changes > 0 && incidents < 10) score += 5;
            
            return Math.max(0, Math.min(100, score));
        }

        function getJourneysMaturitySummary() {
            if (!journeys || journeys.length === 0) return { average: 0, byPillar: {} };
            
            const pillarTotals = { availability: 0, quality: 0, security: 0, performance: 0 };
            let validJourneys = 0;
            
            journeys.forEach(j => {
                let hasData = false;
                Object.keys(pillarTotals).forEach(pillar => {
                    const maturity = calculatePillarMaturity(j, pillar);
                    if (maturity > 0) {
                        pillarTotals[pillar] += maturity;
                        hasData = true;
                    }
                });
                if (hasData) validJourneys++;
            });
            
            const byPillar = {};
            Object.keys(pillarTotals).forEach(pillar => {
                byPillar[pillar] = validJourneys > 0 ? pillarTotals[pillar] / validJourneys : 0;
            });
            
            const overallAvg = Object.values(byPillar).reduce((a, b) => a + b, 0) / Object.keys(byPillar).length;
            
            return {
                average: overallAvg,
                byPillar,
                total: journeys.length
            };
        }
        function renderDashboardPage() {
            const okrStats = calculateOKRProgress();
            const frontsStats = getFrontsMaturitySummary();
            const journeysStats = getJourneysMaturitySummary();
            const indicatorsInsights = getExecutiveIndicatorsInsights();
            
            return `
                <header class="bg-white border-b border-slate-200 shadow-sm sticky top-0 z-40">
                    <div class="max-w-7xl mx-auto px-6 py-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <h1 class="text-3xl font-bold text-slate-900">Hub de Tecnologia</h1>
                                <p class="text-slate-600 mt-1 text-sm">Dashboard Executivo - Visão Consolidada</p>
                            </div>
                            <nav class="flex items-center gap-2" aria-label="Navegação principal">
                                <button onclick="navigateTo('okrs')" class="px-3 py-2 bg-blue-500 hover:bg-blue-600 text-white font-semibold rounded transition-colors text-sm" aria-label="Ir para OKRs">
                                    <i class="fas fa-bullseye mr-1" aria-hidden="true"></i> OKRs
                                </button>
                                <button onclick="navigateTo('indicators')" class="px-3 py-2 bg-purple-500 hover:bg-purple-600 text-white font-semibold rounded transition-colors text-sm" aria-label="Ir para Evolução de Indicadores">
                                    <i class="fas fa-chart-line mr-1" aria-hidden="true"></i> Indicadores
                                </button>
                                <button onclick="navigateTo('projects')" class="px-3 py-2 bg-emerald-500 hover:bg-emerald-600 text-white font-semibold rounded transition-colors text-sm" aria-label="Ir para Projetos">
                                    <i class="fas fa-project-diagram mr-1" aria-hidden="true"></i> Projetos
                                </button>
                                <button onclick="navigateTo('fronts')" class="px-3 py-2 bg-green-500 hover:bg-green-600 text-white font-semibold rounded transition-colors text-sm" aria-label="Ir para Frentes de Engenharia">
                                    <i class="fas fa-layer-group mr-1" aria-hidden="true"></i> Frentes
                                </button>
                                <button onclick="navigateTo('journeys')" class="px-3 py-2 bg-orange-500 hover:bg-orange-600 text-white font-semibold rounded transition-colors text-sm" aria-label="Ir para Maturidade de Jornadas">
                                    <i class="fas fa-route mr-1" aria-hidden="true"></i> Jornadas
                                </button>
                                <button onclick="navigateTo('executivo')" class="px-3 py-2 bg-teal-500 hover:bg-teal-600 text-white font-semibold rounded transition-colors text-sm" aria-label="Ir para Painel Executivo">
                                    <i class="fas fa-tv mr-1" aria-hidden="true"></i> Painel Executivo
                                </button>
                                <button onclick="navigateTo('adjustments')" class="px-3 py-2 bg-slate-200 hover:bg-slate-300 text-slate-800 font-semibold rounded transition-colors text-sm" aria-label="Ir para Ajustes">
                                    <i class="fas fa-sliders-h mr-1" aria-hidden="true"></i> Ajustes
                                </button>
                            </nav>
                        </div>
                    </div>
                </header>
                <main class="max-w-7xl mx-auto px-6 py-8">
                    <!-- Cards de Progresso dos OKRs -->
                    <section class="mb-8" aria-labelledby="okrs-section">
                        <h2 id="okrs-section" class="text-2xl font-bold text-slate-900 mb-4">Progresso dos OKRs</h2>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                            <div class="bg-white rounded-lg shadow-md p-6 border-2 border-blue-200">
                                <div class="flex items-center justify-between mb-2">
                                    <h3 class="text-sm font-semibold text-slate-600">Progresso Médio</h3>
                                    <i class="fas fa-chart-pie text-blue-500 text-xl" aria-hidden="true"></i>
                                </div>
                                <div class="text-3xl font-bold text-blue-600">${Math.round(okrStats.average)}%</div>
                                <p class="text-xs text-slate-500 mt-1">${okrStats.total} OKR${okrStats.total !== 1 ? 's' : ''} cadastrado${okrStats.total !== 1 ? 's' : ''}</p>
                            </div>
                            <div class="bg-white rounded-lg shadow-md p-6 border-2 border-green-200">
                                <div class="flex items-center justify-between mb-2">
                                    <h3 class="text-sm font-semibold text-slate-600">No Prazo</h3>
                                    <i class="fas fa-check-circle text-green-500 text-xl" aria-hidden="true"></i>
                                </div>
                                <div class="text-3xl font-bold text-green-600">${okrStats.onTrack}</div>
                                <p class="text-xs text-slate-500 mt-1">≥ 80% de progresso</p>
                            </div>
                            <div class="bg-white rounded-lg shadow-md p-6 border-2 border-yellow-200">
                                <div class="flex items-center justify-between mb-2">
                                    <h3 class="text-sm font-semibold text-slate-600">Em Risco</h3>
                                    <i class="fas fa-exclamation-triangle text-yellow-500 text-xl" aria-hidden="true"></i>
                                </div>
                                <div class="text-3xl font-bold text-yellow-600">${okrStats.atRisk}</div>
                                <p class="text-xs text-slate-500 mt-1">50% - 79% de progresso</p>
                            </div>
                            <div class="bg-white rounded-lg shadow-md p-6 border-2 border-red-200">
                                <div class="flex items-center justify-between mb-2">
                                    <h3 class="text-sm font-semibold text-slate-600">Atrasados</h3>
                                    <i class="fas fa-times-circle text-red-500 text-xl" aria-hidden="true"></i>
                                </div>
                                <div class="text-3xl font-bold text-red-600">${okrStats.behind}</div>
                                <p class="text-xs text-slate-500 mt-1">&lt; 50% de progresso</p>
                            </div>
                        </div>
                        <button onclick="navigateTo('okrs')" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white font-semibold rounded transition-colors">
                            <i class="fas fa-arrow-right mr-2" aria-hidden="true"></i> Ver Todos os OKRs
                        </button>
                    </section>

                    <!-- Indicadores Operacionais Executivos -->
                    <section class="mb-8" aria-labelledby="indicators-section">
                        <div class="flex items-center justify-between mb-4">
                            <h2 id="indicators-section" class="text-2xl font-bold text-slate-900">Run the Bank - Indicadores Operacionais</h2>
                            <button onclick="navigateTo('indicators')" class="px-3 py-1.5 bg-purple-500 hover:bg-purple-600 text-white text-sm font-semibold rounded transition-colors">
                                <i class="fas fa-chart-line mr-1" aria-hidden="true"></i> Ver Detalhes
                            </button>
                        </div>
                        
                        <!-- Card de Health Score -->
                        <div class="bg-gradient-to-r from-red-600 to-red-700 rounded-xl shadow-xl p-6 mb-6 text-white" style="background: linear-gradient(135deg, #ec0000 0%, #cc0000 100%);">
                            <div class="flex items-center justify-between mb-4">
                                <div>
                                    <h3 class="text-lg font-semibold opacity-90 mb-1">Health Score Operacional</h3>
                                    <p class="text-sm opacity-75">Medida de saúde do ambiente de TI</p>
                                </div>
                                <i class="fas fa-heartbeat text-4xl opacity-80"></i>
                            </div>
                            <div class="flex items-baseline gap-3">
                                <div class="text-5xl font-bold">${indicatorsInsights.summary.healthScore}</div>
                                <span class="text-2xl opacity-75">/ 100</span>
                            </div>
                            <div class="mt-4 h-2 bg-white/20 rounded-full overflow-hidden">
                                <div class="h-full bg-white rounded-full transition-all duration-1000" style="width: ${indicatorsInsights.summary.healthScore}%"></div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                            <!-- Incidentes -->
                            <div class="bg-white rounded-lg shadow-md border-2 ${indicatorsInsights.trends.incidents > 10 ? 'border-red-300' : indicatorsInsights.trends.incidents < -10 ? 'border-green-300' : 'border-slate-200'} p-5">
                                <div class="flex items-center justify-between mb-3">
                                    <div class="p-2 bg-blue-100 rounded-lg">
                                        <i class="fas fa-exclamation-circle text-blue-600 text-xl"></i>
                                    </div>
                                    ${indicatorsInsights.trends.incidents !== 0 ? `
                                        <div class="flex items-center gap-1 ${indicatorsInsights.trends.incidents > 0 ? 'text-red-600' : 'text-green-600'}">
                                            <i class="fas fa-${indicatorsInsights.trends.incidents > 0 ? 'arrow-up' : 'arrow-down'} text-xs"></i>
                                            <span class="text-xs font-semibold">${Math.abs(indicatorsInsights.trends.incidents).toFixed(1)}%</span>
                                        </div>
                                    ` : ''}
                                </div>
                                <h3 class="text-3xl font-bold text-slate-900 mb-1">${indicatorsInsights.totals.incidents}</h3>
                                <p class="text-sm text-slate-600">Incidentes Funcionais</p>
                            </div>
                            
                            <!-- Mudanças -->
                            <div class="bg-white rounded-lg shadow-md border-2 ${indicatorsInsights.trends.changes > 20 ? 'border-green-300' : 'border-slate-200'} p-5">
                                <div class="flex items-center justify-between mb-3">
                                    <div class="p-2 bg-purple-100 rounded-lg">
                                        <i class="fas fa-sync-alt text-purple-600 text-xl"></i>
                                    </div>
                                    ${indicatorsInsights.trends.changes !== 0 ? `
                                        <div class="flex items-center gap-1 text-green-600">
                                            <i class="fas fa-arrow-up text-xs"></i>
                                            <span class="text-xs font-semibold">${Math.abs(indicatorsInsights.trends.changes).toFixed(1)}%</span>
                                        </div>
                                    ` : ''}
                                </div>
                                <h3 class="text-3xl font-bold text-slate-900 mb-1">${indicatorsInsights.totals.changes}</h3>
                                <p class="text-sm text-slate-600">Mudanças Realizadas</p>
                            </div>
                            
                            <!-- Alertas -->
                            <div class="bg-white rounded-lg shadow-md border-2 ${indicatorsInsights.trends.alerts > 10 ? 'border-yellow-300' : 'border-slate-200'} p-5">
                                <div class="flex items-center justify-between mb-3">
                                    <div class="p-2 bg-yellow-100 rounded-lg">
                                        <i class="fas fa-bell text-yellow-600 text-xl"></i>
                                    </div>
                                    ${indicatorsInsights.trends.alerts !== 0 ? `
                                        <div class="flex items-center gap-1 ${indicatorsInsights.trends.alerts > 0 ? 'text-yellow-600' : 'text-green-600'}">
                                            <i class="fas fa-${indicatorsInsights.trends.alerts > 0 ? 'arrow-up' : 'arrow-down'} text-xs"></i>
                                            <span class="text-xs font-semibold">${Math.abs(indicatorsInsights.trends.alerts).toFixed(1)}%</span>
                                        </div>
                                    ` : ''}
                                </div>
                                <h3 class="text-3xl font-bold text-slate-900 mb-1">${indicatorsInsights.totals.alerts}</h3>
                                <p class="text-sm text-slate-600">Alertas Recebidos</p>
                            </div>
                            
                            <!-- Abends -->
                            <div class="bg-white rounded-lg shadow-md border-2 ${indicatorsInsights.totals.abends > 0 ? 'border-red-300' : 'border-green-300'} p-5">
                                <div class="flex items-center justify-between mb-3">
                                    <div class="p-2 bg-red-100 rounded-lg">
                                        <i class="fas fa-bug text-red-600 text-xl"></i>
                                    </div>
                                    ${indicatorsInsights.totals.abends === 0 ? `
                                        <div class="flex items-center gap-1 text-green-600">
                                            <i class="fas fa-check-circle text-xs"></i>
                                        </div>
                                    ` : ''}
                                </div>
                                <h3 class="text-3xl font-bold text-slate-900 mb-1">${indicatorsInsights.totals.abends}</h3>
                                <p class="text-sm text-slate-600">Abends Abertos</p>
                            </div>
                        </div>
                        
                        <!-- Alerta Executivo -->
                        ${indicatorsInsights.summary.healthScore < 70 ? `
                            <div class="bg-red-50 border-2 border-red-200 rounded-lg p-4 flex items-start gap-3">
                                <i class="fas fa-exclamation-triangle text-red-600 text-2xl mt-1"></i>
                                <div>
                                    <h4 class="font-semibold text-red-900 mb-1">Atenção Requerida</h4>
                                    <p class="text-sm text-red-800">O Health Score está abaixo do esperado. Recomendamos análise detalhada dos indicadores para identificar ações corretivas.</p>
                                </div>
                            </div>
                        ` : indicatorsInsights.summary.healthScore >= 90 ? `
                            <div class="bg-green-50 border-2 border-green-200 rounded-lg p-4 flex items-start gap-3">
                                <i class="fas fa-check-circle text-green-600 text-2xl mt-1"></i>
                                <div>
                                    <h4 class="font-semibold text-green-900 mb-1">Excelente Performance</h4>
                                    <p class="text-sm text-green-800">Ambiente de TI operando com excelência. Health Score acima de 90 pontos.</p>
                                </div>
                            </div>
                        ` : ''}
                    </section>
                    <!-- Cards de Evolução das Frentes -->
                    <section class="mb-8" aria-labelledby="fronts-section">
                        <h2 id="fronts-section" class="text-2xl font-bold text-slate-900 mb-4">Evolução das Frentes de Engenharia</h2>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                            <div class="bg-white rounded-lg shadow-md p-6 border-2 border-slate-200">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="text-lg font-semibold text-slate-800">Maturidade Média</h3>
                                    <div class="flex items-center gap-1">
                                        ${[...Array(5)].map((_, i) => `
                                            <i class="fas fa-star ${i < Math.round(frontsStats.average) ? 'star-filled' : 'star-empty'} text-sm" aria-hidden="true"></i>
                                        `).join('')}
                                    </div>
                                </div>
                                <div class="text-4xl font-bold text-slate-900">${frontsStats.average.toFixed(1)}</div>
                                <p class="text-sm text-slate-600 mt-2">de 5.0 (${frontsStats.total} frentes)</p>
                            </div>
                            <div class="bg-white rounded-lg shadow-md p-6 border-2 border-slate-200">
                                <h3 class="text-lg font-semibold text-slate-800 mb-4">Distribuição por Nível</h3>
                                <div class="space-y-2">
                                    ${[1, 2, 3, 4, 5].map(level => {
                                        const count = frontsStats.distribution[level] || 0;
                                        const percentage = frontsStats.total > 0 ? (count / frontsStats.total) * 100 : 0;
                                        return `
                                            <div class="flex items-center justify-between text-sm">
                                                <span class="text-slate-600">Nível ${level}</span>
                                                <div class="flex items-center gap-2">
                                                    <div class="w-24 h-2 bg-slate-200 rounded-full overflow-hidden">
                                                        <div class="h-full bg-blue-500 rounded-full" style="width: ${percentage}%"></div>
                                                    </div>
                                                    <span class="font-semibold text-slate-700 w-8 text-right">${count}</span>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                            <div class="bg-white rounded-lg shadow-md p-6 border-2 border-slate-200">
                                <h3 class="text-lg font-semibold text-slate-800 mb-2">Resumo</h3>
                                <div class="space-y-3 mt-4">
                                    <div class="flex items-center justify-between">
                                        <span class="text-sm text-slate-600">Total de Frentes</span>
                                        <span class="text-xl font-bold text-slate-900">${frontsStats.total}</span>
                                    </div>
                                    <button onclick="navigateTo('fronts')" class="w-full px-4 py-2 bg-green-500 hover:bg-green-600 text-white font-semibold rounded transition-colors text-sm">
                                        <i class="fas fa-arrow-right mr-2" aria-hidden="true"></i> Ver Detalhes
                                    </button>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Mini Gráfico de Maturidade de Jornadas -->
                    <section class="mb-8" aria-labelledby="journeys-section">
                        <h2 id="journeys-section" class="text-2xl font-bold text-slate-900 mb-4">Maturidade das Jornadas</h2>
                        <div class="bg-white rounded-lg shadow-md p-6 border-2 border-slate-200">
                            <div class="grid grid-cols-1 md:grid-cols-5 gap-6 mb-6">
                                ${Object.entries(journeysStats.byPillar).map(([pillar, value]) => {
                                    const pillarNames = { availability: 'Disponibilidade', quality: 'Qualidade', security: 'Segurança', performance: 'Performance' };
                                    const colorClasses = {
                                        availability: 'from-blue-400 to-blue-600',
                                        quality: 'from-green-400 to-green-600',
                                        security: 'from-red-400 to-red-600',
                                        performance: 'from-purple-400 to-purple-600'
                                    };
                                    return `
                                        <div class="text-center">
                                            <div class="mb-2">
                                                <div class="inline-flex items-center justify-center w-20 h-20 rounded-full bg-gradient-to-br ${colorClasses[pillar]} text-white text-2xl font-bold">
                                                    ${Math.round(value)}%
                                                </div>
                                            </div>
                                            <h4 class="text-sm font-semibold text-slate-700">${pillarNames[pillar]}</h4>
                                        </div>
                                    `;
                                }).join('')}
                                <div class="text-center">
                                    <div class="mb-2">
                                        <div class="inline-flex items-center justify-center w-20 h-20 rounded-full bg-gradient-to-br from-slate-400 to-slate-600 text-white text-2xl font-bold border-4 border-current">
                                            ${Math.round(journeysStats.average)}%
                                        </div>
                                    </div>
                                    <h4 class="text-sm font-semibold text-slate-700">Geral</h4>
                                </div>
                            </div>
                            <button onclick="navigateTo('journeys')" class="w-full px-4 py-2 bg-orange-500 hover:bg-orange-600 text-white font-semibold rounded transition-colors">
                                <i class="fas fa-arrow-right mr-2" aria-hidden="true"></i> Ver Detalhes das Jornadas
                            </button>
                        </div>
                    </section>

                    <!-- Acesso Rápido -->
                    <section aria-labelledby="quick-access-section">
                        <h2 id="quick-access-section" class="text-2xl font-bold text-slate-900 mb-4">Acesso Rápido</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 xl:grid-cols-5 gap-4">
                            <button onclick="navigateTo('okrs'); if(okrs.length === 0) { creatingNewOKR = true; render(); }" class="bg-white rounded-lg shadow-md p-6 border-2 border-blue-200 hover:border-blue-400 transition-colors text-left group">
                                <div class="flex items-center justify-between mb-3">
                                    <i class="fas fa-bullseye text-blue-500 text-2xl" aria-hidden="true"></i>
                                    <i class="fas fa-arrow-right text-blue-500 group-hover:translate-x-1 transition-transform" aria-hidden="true"></i>
                                </div>
                                <h3 class="font-bold text-slate-900 mb-1">OKRs da Organização</h3>
                                <p class="text-sm text-slate-600">Defina e acompanhe objetivos e resultados-chave</p>
                            </button>
                            <button onclick="navigateTo('indicators')" class="bg-white rounded-lg shadow-md p-6 border-2 border-purple-200 hover:border-purple-400 transition-colors text-left group">
                                <div class="flex items-center justify-between mb-3">
                                    <i class="fas fa-chart-line text-purple-500 text-2xl" aria-hidden="true"></i>
                                    <i class="fas fa-arrow-right text-purple-500 group-hover:translate-x-1 transition-transform" aria-hidden="true"></i>
                                </div>
                                <h3 class="font-bold text-slate-900 mb-1">Evolução de Indicadores</h3>
                                <p class="text-sm text-slate-600">Alimente e acompanhe métricas Run the Bank</p>
                            </button>
                            <button onclick="navigateTo('fronts')" class="bg-white rounded-lg shadow-md p-6 border-2 border-green-200 hover:border-green-400 transition-colors text-left group">
                                <div class="flex items-center justify-between mb-3">
                                    <i class="fas fa-layer-group text-green-500 text-2xl" aria-hidden="true"></i>
                                    <i class="fas fa-arrow-right text-green-500 group-hover:translate-x-1 transition-transform" aria-hidden="true"></i>
                                </div>
                                <h3 class="font-bold text-slate-900 mb-1">Frentes de Engenharia</h3>
                                <p class="text-sm text-slate-600">Gerencie frentes e seus níveis de maturidade</p>
                            </button>
                            <button onclick="navigateTo('journeys')" class="bg-white rounded-lg shadow-md p-6 border-2 border-orange-200 hover:border-orange-400 transition-colors text-left group">
                                <div class="flex items-center justify-between mb-3">
                                    <i class="fas fa-route text-orange-500 text-2xl" aria-hidden="true"></i>
                                    <i class="fas fa-arrow-right text-orange-500 group-hover:translate-x-1 transition-transform" aria-hidden="true"></i>
                                </div>
                                <h3 class="font-bold text-slate-900 mb-1">Maturidade das Jornadas</h3>
                                <p class="text-sm text-slate-600">Avalie maturidade por pilares e jornadas</p>
                            </button>
                            <button onclick="navigateTo('executivo')" class="bg-white rounded-lg shadow-md p-6 border-2 border-teal-200 hover:border-teal-400 transition-colors text-left group">
                                <div class="flex items-center justify-between mb-3">
                                    <i class="fas fa-tv text-teal-500 text-2xl" aria-hidden="true"></i>
                                    <i class="fas fa-arrow-right text-teal-500 group-hover:translate-x-1 transition-transform" aria-hidden="true"></i>
                                </div>
                                <h3 class="font-bold text-slate-900 mb-1">Painel Executivo</h3>
                                <p class="text-sm text-slate-600">Carrossel de apresentação por Squads</p>
                            </button>
                        </div>
                    </section>
                </main>
            `;
        }

        function renderAdjustmentsPage() {
            return `
                <header class="bg-white border-b border-slate-200 shadow-sm sticky top-0 z-40">
                    <div class="max-w-7xl mx-auto px-6 py-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <h1 class="text-3xl font-bold text-slate-900">Ajustes e Utilitários</h1>
                                <p class="text-slate-600 mt-1 text-sm">Centralize operações administrativas do Hub de Tecnologia</p>
                            </div>
                            <nav class="flex items-center gap-2" aria-label="Navegação principal">
                                <button onclick="navigateTo('dashboard')" class="px-3 py-2 bg-indigo-500 hover:bg-indigo-600 text-white font-semibold rounded transition-colors text-sm">
                                    <i class="fas fa-home mr-1"></i> Dashboard
                                </button>
                                <button onclick="navigateTo('integra')" class="px-3 py-2 bg-pink-500 hover:bg-pink-600 text-white font-semibold rounded transition-colors text-sm">
                                    <i class="fas fa-plug mr-1"></i> Integra
                                </button>
                            </nav>
                        </div>
                    </div>
                </header>
                <main class="max-w-4xl mx-auto px-6 py-8 space-y-8">
                    <section class="bg-white rounded-lg shadow-md border-2 border-slate-200 p-6">
                        <h2 class="text-2xl font-bold text-slate-900 mb-2">Backup e Restauração</h2>
                        <p class="text-sm text-slate-600 mb-4">
                            Faça o download completo dos dados atuais ou restaure um arquivo previamente exportado.
                        </p>
                        <div class="flex flex-col sm:flex-row gap-3">
                            <button onclick="exportAllData()" class="flex-1 px-4 py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded transition-colors">
                                <i class="fas fa-download mr-2"></i> Exportar Backup Completo
                            </button>
                            <button onclick="document.getElementById('import-input-all').click()" class="flex-1 px-4 py-3 bg-slate-200 hover:bg-slate-300 text-slate-800 font-semibold rounded transition-colors">
                                <i class="fas fa-upload mr-2"></i> Restaurar a partir de Arquivo
                            </button>
                        </div>
                        <input id="import-input-all" type="file" accept="application/json" class="hidden" onchange="handleImportAllFile(this)" aria-label="Selecionar arquivo de backup completo">
                        <p class="text-xs text-slate-500 mt-3">
                            O backup inclui frentes, jornadas, projetos, indicadores, painéis executivos, integrações e estado da interface.
                        </p>
                    </section>

                    <section class="bg-white rounded-lg shadow-md border-2 border-slate-200 p-6">
                        <h2 class="text-2xl font-bold text-slate-900 mb-2">Integrações &amp; CMDB</h2>
                        <p class="text-sm text-slate-600 mb-4">
                            Configure integrações com ServiceNow, importe dados de CMDB e acompanhe automações.
                        </p>
                        <button onclick="navigateTo('integra')" class="px-4 py-3 bg-pink-500 hover:bg-pink-600 text-white font-semibold rounded transition-colors">
                            <i class="fas fa-plug mr-2"></i> Abrir página Integra
                        </button>
                    </section>

                    <section class="bg-slate-50 border border-slate-200 rounded-lg p-6">
                        <h2 class="text-lg font-semibold text-slate-800 mb-2">Outras ações</h2>
                        <p class="text-sm text-slate-600">
                            Utilize esta página para concentrar futuros ajustes administrativos (ex: redefinir dados, configurar acessos, ativar recursos beta).
                        </p>
                    </section>
                </main>
            `;
        }
        function renderFrontsPage() {
            const filteredFronts = getFilteredFronts();
            const allOwners = [...new Set(fronts.map(f => f.ownerName))].sort();
            const activeFiltersCount = filters.status.length + filters.maturityLevel.length + filters.owner.length + (filters.name ? 1 : 0);
            return `
                <header class="bg-white border-b border-slate-200 shadow-sm sticky top-0 z-40">
                    <div class="max-w-7xl mx-auto px-6 py-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <h1 class="text-3xl font-bold text-slate-900">Hub de Tecnologia</h1>
                                <p class="text-slate-600 mt-1 text-sm">Ferramenta Executiva de Storytelling de Confiabilidade</p>
                            </div>
                            <nav class="flex items-center gap-3" aria-label="Navegação principal">
                                <button onclick="navigateTo('dashboard')" class="px-3 py-2 bg-indigo-500 hover:bg-indigo-600 text-white font-semibold rounded transition-colors text-sm" aria-label="Ir para Dashboard">
                                    <i class="fas fa-home mr-1" aria-hidden="true"></i> Dashboard
                                </button>
                                <input id="import-input-fronts" type="file" accept="application/json" class="hidden" onchange="handleImportFile(this)" aria-label="Selecionar arquivo para importar">
                                <button onclick="exportData()" class="px-3 py-2 bg-slate-200 hover:bg-slate-300 text-slate-800 font-semibold rounded transition-colors text-sm" aria-label="Exportar dados">
                                    <i class="fas fa-file-export mr-1" aria-hidden="true"></i> Exportar
                                </button>
                                <button onclick="document.getElementById('import-input-fronts').click()" class="px-3 py-2 bg-slate-200 hover:bg-slate-300 text-slate-800 font-semibold rounded transition-colors text-sm" aria-label="Importar dados">
                                    <i class="fas fa-file-import mr-1" aria-hidden="true"></i> Importar
                                </button>
                                <button onclick="navigateTo('journeys')" class="px-3 py-2 bg-blue-500 hover:bg-blue-600 text-white font-semibold rounded transition-colors text-sm" aria-label="Ir para página de Jornadas">
                                    <i class="fas fa-route mr-1" aria-hidden="true"></i> Jornadas
                                </button>
                            </nav>
                        </div>
                    </div>
                </header>
                <main class="max-w-7xl mx-auto px-6 py-8">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center gap-3">
                            <button onclick="toggleFilter()" class="px-4 py-2 bg-slate-200 hover:bg-slate-300 text-slate-700 font-semibold rounded transition-colors text-sm" aria-label="${filtersExpanded ? 'Ocultar' : 'Mostrar'} painel de filtros" aria-expanded="${filtersExpanded}">
                                <i class="fas fa-filter mr-2" aria-hidden="true"></i> Filtros ${activeFiltersCount > 0 ? `(${activeFiltersCount})` : ''}
                            </button>
                            <span class="text-sm text-slate-600" role="status" aria-live="polite">${filteredFronts.length}/${fronts.length} Frentes</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <button onclick="openNewFront()" class="px-3 py-2 bg-green-500 hover:bg-green-600 text-white font-semibold rounded transition-colors text-sm" aria-label="Criar nova frente de engenharia">
                                <i class="fas fa-plus mr-1" aria-hidden="true"></i> Novo
                            </button>
                            <button onclick="resetFronts()" class="px-3 py-2 bg-yellow-500 hover:bg-yellow-600 text-white font-semibold rounded transition-colors text-sm" aria-label="Restaurar frentes para os dados padrão">
                                <i class="fas fa-redo mr-1" aria-hidden="true"></i> Reset
                            </button>
                        </div>
                    </div>

                    ${filtersExpanded ? `
                        <div class="bg-white rounded-lg shadow-md p-6 mb-6 border-2 border-slate-200 filter-panel">
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                                <div>
                                    <label for="filter-name" class="block text-sm font-semibold text-slate-700 mb-3">Buscar por Nome</label>
                                    <input type="text" id="filter-name" placeholder="Digite o nome..." value="${filters.name}" onchange="updateFilterName(this.value)" class="w-full" aria-label="Buscar frentes por nome">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-slate-700 mb-3">Status</label>
                                    <div class="space-y-2">
                                        ${Object.entries(statusConfig).map(([key, config]) => `
                                            <label class="flex items-center gap-2 cursor-pointer">
                                                <input type="checkbox" ${filters.status.includes(key) ? 'checked' : ''} onchange="updateFilterStatus('${key}')" class="w-4 h-4">
                                                <span class="text-sm text-slate-700">${config.label}</span>
                                            </label>
                                        `).join('')}
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-slate-700 mb-3">Nível de Maturidade</label>
                                    <div class="space-y-2">
                                        ${[1, 2, 3, 4, 5].map(level => `
                                            <label class="flex items-center gap-2 cursor-pointer">
                                                <input type="checkbox" ${filters.maturityLevel.includes(level) ? 'checked' : ''} onchange="updateFilterMaturityLevel(${level})" class="w-4 h-4">
                                                <span class="text-sm text-slate-700">Nível ${level}</span>
                                            </label>
                                        `).join('')}
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-slate-700 mb-3">Owner</label>
                                    <div class="space-y-2 max-h-40 overflow-y-auto">
                                        ${allOwners.map(owner => `
                                            <label class="flex items-center gap-2 cursor-pointer">
                                                <input type="checkbox" ${filters.owner.includes(owner) ? 'checked' : ''} onchange="updateFilterOwner('${owner}')" class="w-4 h-4">
                                                <span class="text-sm text-slate-700">${owner}</span>
                                            </label>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                            <div class="flex gap-3 mt-6 pt-6 border-t border-slate-200">
                                <button onclick="clearFilters()" class="px-4 py-2 bg-slate-300 hover:bg-slate-400 text-slate-700 font-semibold rounded transition-colors text-sm">
                                    <i class="fas fa-times mr-2"></i> Limpar Filtros
                                </button>
                            </div>
                        </div>
                    ` : ''}

                    ${filteredFronts.length === 0 ? `
                        <div class="bg-white rounded-lg shadow-md p-12 text-center border-2 border-slate-200">
                            <i class="fas fa-search text-4xl text-slate-400 mb-4"></i>
                            <p class="text-slate-600 text-lg">Nenhuma frente encontrada com os filtros aplicados</p>
                        </div>
                    ` : `
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            ${filteredFronts.map(front => {
                                const status = statusConfig[front.status];
                                return `
                                    <div class="bg-white rounded-lg shadow-md p-6 border-2 border-slate-200 front-card">
                                        <div class="flex items-start justify-between mb-4">
                                            <div class="flex items-center gap-3">
                                                <div class="w-12 h-12 rounded-full bg-gradient-to-br from-blue-400 to-blue-600 flex items-center justify-center text-white font-bold text-lg">
                                                    ${front.ownerInitials}
                                                </div>
                                                <div>
                                                    <h3 class="font-bold text-slate-900">${front.name}</h3>
                                                    <p class="text-xs text-slate-600">${front.ownerName}</p>
                                                </div>
                                            </div>
                                            <div class="flex items-center gap-1">
                                            <button onclick="openEditFront('${front.id}')" class="p-2 hover:bg-slate-100 rounded-lg transition-colors text-slate-600 hover:text-blue-600" aria-label="Editar frente ${front.name}">
                                                <i class="fas fa-edit" aria-hidden="true"></i>
                                            </button>
                                                <button onclick="deleteFront('${front.id}')" class="p-2 hover:bg-red-50 rounded-lg transition-colors text-slate-600 hover:text-red-600" aria-label="Deletar frente ${front.name}">
                                                    <i class="fas fa-trash" aria-hidden="true"></i>
                                            </button>
                                            </div>
                                        </div>

                                        <div class="flex items-center gap-2 mb-4">
                                            ${[...Array(5)].map((_, i) => `
                                                <i class="fas fa-star ${i < front.maturityLevel ? 'star-filled' : 'star-empty'}"></i>
                                            `).join('')}
                                            <span class="text-xs text-slate-600 ml-2">${front.maturityLevel}/5</span>
                                        </div>

                                        <span class="inline-block px-3 py-1 rounded-full text-xs font-semibold mb-4 ${status.bgColor} ${status.textColor}">
                                            ${status.label}
                                        </span>

                                        ${(() => {
                                            const relatedOKRs = getOKRsByFront(front.id);
                                            if (relatedOKRs.length > 0) {
                                                return `
                                                    <div class="mb-3">
                                                        <div class="flex items-center gap-2 px-2 py-1 bg-blue-50 border border-blue-200 rounded text-xs">
                                                            <i class="fas fa-bullseye text-blue-600" aria-hidden="true"></i>
                                                            <span class="font-semibold text-blue-700">${relatedOKRs.length} OKR${relatedOKRs.length !== 1 ? 's' : ''} relacionado${relatedOKRs.length !== 1 ? 's' : ''}</span>
                                                        </div>
                                                    </div>
                                                `;
                                            }
                                            return '';
                                        })()}

                                        <div class="space-y-2 mb-4">
                                            ${front.mainObjectives.slice(0, 2).map(obj => `
                                                <p class="text-xs text-slate-600"><i class="fas fa-check text-green-600 mr-2"></i>${obj}</p>
                                            `).join('')}
                                            ${front.mainObjectives.length > 2 ? `<p class="text-xs text-slate-500 italic">+${front.mainObjectives.length - 2} objetivo(s)</p>` : ''}
                                        </div>

                                        <button onclick="openFrontDetail('${front.id}')" class="w-full px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white font-semibold rounded transition-colors text-sm" aria-label="Ver detalhes da frente ${front.name}">
                                            <i class="fas fa-eye mr-2" aria-hidden="true"></i> Ver Detalhes
                                        </button>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `}
                </main>

                ${selectedFrontId ? renderFrontDetailModal() : ''}
                ${editingFrontId ? renderEditFrontModal() : ''}
                ${creatingNewFront ? renderNewFrontModal() : ''}
            `;
        }
        function renderFrontDetailModal() {
            const front = fronts.find(f => f.id === selectedFrontId);
            if (!front) return '';
            const status = statusConfig[front.status];
            return `
                <div class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center overflow-auto modal-overlay" onclick="if(event.target === this) closeFrontDetail()" role="dialog" aria-modal="true" aria-labelledby="front-detail-title">
                    <div class="bg-white rounded-lg shadow-2xl max-w-4xl w-full m-4 modal-panel" onclick="event.stopPropagation()">
                        <div class="bg-white border-b border-slate-200 p-6 flex items-center justify-between sticky top-0">
                            <div class="flex items-center gap-4">
                                <div class="w-16 h-16 rounded-full bg-gradient-to-br from-blue-400 to-blue-600 flex items-center justify-center text-white font-bold text-2xl" aria-hidden="true">
                                    ${front.ownerInitials}
                                </div>
                                <div>
                                    <h2 id="front-detail-title" class="text-2xl font-bold text-slate-900">${front.name}</h2>
                                    <p class="text-sm text-slate-600">${front.ownerName}</p>
                                </div>
                            </div>
                            <button onclick="closeFrontDetail()" class="p-2 hover:bg-slate-100 rounded-lg transition-colors" aria-label="Fechar modal de detalhes">
                                <i class="fas fa-times text-slate-600 text-xl" aria-hidden="true"></i>
                            </button>
                        </div>

                        <div class="p-6 space-y-6 overflow-y-auto max-h-[calc(85vh-120px)]">
                            <div class="grid grid-cols-3 gap-4">
                                <div class="bg-slate-50 rounded-lg p-4">
                                    <p class="text-xs text-slate-600 mb-2">Nível de Maturidade</p>
                                    <div class="flex items-center gap-2">
                                        ${[...Array(5)].map((_, i) => `
                                            <i class="fas fa-star ${i < front.maturityLevel ? 'star-filled text-lg' : 'star-empty text-lg'}"></i>
                                        `).join('')}
                                    </div>
                                </div>
                                <div class="bg-slate-50 rounded-lg p-4">
                                    <p class="text-xs text-slate-600 mb-2">Status</p>
                                    <span class="inline-block px-3 py-1 rounded-full text-xs font-semibold ${status.bgColor} ${status.textColor}">
                                        ${status.label}
                                    </span>
                                </div>
                                <div class="bg-slate-50 rounded-lg p-4">
                                    <p class="text-xs text-slate-600 mb-2">Ações</p>
                                    <button onclick="openEditFront('${front.id}')" class="px-3 py-1 bg-blue-500 hover:bg-blue-600 text-white text-xs font-semibold rounded transition-colors">
                                        <i class="fas fa-edit mr-1"></i> Editar
                                    </button>
                                </div>
                            </div>

                            <div>
                                <h3 class="font-semibold text-slate-900 mb-3">Visão Executiva</h3>
                                <div class="space-y-4">
                                    <div>
                                        <h4 class="text-sm font-semibold text-slate-800 mb-2">Principais Objetivos</h4>
                                        <ul class="space-y-1">
                                            ${front.mainObjectives.map(obj => `
                                                <li class="text-sm text-slate-700"><i class="fas fa-check text-green-600 mr-2"></i>${obj}</li>
                                            `).join('')}
                                        </ul>
                                    </div>

                                    <div>
                                        <h4 class="text-sm font-semibold text-slate-800 mb-2 text-green-700">Ações que Viabilizaram o Nível Atual</h4>
                                        <ul class="space-y-1">
                                            ${front.currentActions.map(action => `
                                                <li class="text-sm text-slate-700"><i class="fas fa-check-circle text-green-600 mr-2"></i>${action}</li>
                                            `).join('')}
                                        </ul>
                                    </div>

                                    <div>
                                        <h4 class="text-sm font-semibold text-slate-800 mb-2 text-yellow-700">Ações para Evoluir para o Próximo Nível</h4>
                                        <ul class="space-y-1">
                                            ${front.futureActions.map(action => `
                                                <li class="text-sm text-slate-700"><i class="fas fa-arrow-up text-yellow-600 mr-2"></i>${action}</li>
                                            `).join('')}
                                        </ul>
                                    </div>

                                    ${front.attentionPoints.length > 0 ? `
                                        <div>
                                            <h4 class="text-sm font-semibold text-slate-800 mb-2 text-red-700">Pontos de Atenção Declarados</h4>
                                            <ul class="space-y-1">
                                                ${front.attentionPoints.map(point => `
                                                    <li class="text-sm text-slate-700"><i class="fas fa-exclamation-circle text-red-600 mr-2"></i>${point}</li>
                                                `).join('')}
                                            </ul>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>

                            <div class="border-t border-slate-200 pt-6">
                                <h3 class="font-semibold text-slate-900 mb-4">Mapa de Maturidade</h3>
                                <div class="space-y-3">
                                    ${front.maturityLevels.map(level => `
                                        <div class="border border-slate-200 rounded-lg">
                                            <button onclick="toggleLevel(${level.level})" class="w-full px-4 py-3 flex items-center justify-between hover:bg-slate-50 transition-colors">
                                                <div class="flex items-center gap-3">
                                                    <span class="font-semibold text-slate-900">Nível ${level.level}</span>
                                                    <span class="text-sm text-slate-600">${level.description}</span>
                                                </div>
                                                <i class="fas fa-chevron-${expandedLevels[level.level] ? 'up' : 'down'} text-slate-600"></i>
                                            </button>
                                            ${expandedLevels[level.level] ? `
                                                <div class="border-t border-slate-200 p-4 space-y-3">
                                                    ${level.expectations.length > 0 ? `
                                                        <div>
                                                            <h5 class="text-sm font-semibold text-slate-800 mb-2">Expectativas</h5>
                                                            <ul class="space-y-1">
                                                                ${level.expectations.map(exp => `
                                                                    <li class="text-sm text-slate-700">
                                                                        <i class="fas fa-${exp.status === 'done' ? 'check-circle text-green-600' : exp.status === 'in-progress' ? 'clock text-yellow-600' : 'circle text-slate-400'} mr-2"></i>
                                                                        ${exp.description}
                                                                    </li>
                                                                `).join('')}
                                                            </ul>
                                                        </div>
                                                    ` : ''}
                                                    ${level.problemsAvoided.length > 0 ? `
                                                        <div>
                                                            <h5 class="text-sm font-semibold text-slate-800 mb-2">Problemas Evitados</h5>
                                                            <ul class="space-y-1">
                                                                ${level.problemsAvoided.map(prob => `
                                                                    <li class="text-sm text-slate-700"><i class="fas fa-shield text-green-600 mr-2"></i>${prob}</li>
                                                                `).join('')}
                                                            </ul>
                                                        </div>
                                                    ` : ''}
                                                    ${level.evolutionIndicators.length > 0 ? `
                                                        <div>
                                                            <h5 class="text-sm font-semibold text-slate-800 mb-2">Indicadores de Evolução (KPIs)</h5>
                                                            <ul class="space-y-1">
                                                                ${level.evolutionIndicators.map(kpi => `
                                                                    <li class="text-sm text-slate-700"><i class="fas fa-chart-line text-blue-600 mr-2"></i>${kpi}</li>
                                                                `).join('')}
                                                            </ul>
                                                        </div>
                                                    ` : ''}
                                                </div>
                                            ` : ''}
                                        </div>
                                    `).join('')}
                                </div>
                            </div>

                            ${(() => {
                                const relatedOKRs = getOKRsByFront(front.id);
                                if (relatedOKRs.length > 0) {
                                    return `
                                        <div class="border-t border-slate-200 pt-6">
                                            <h3 class="font-semibold text-slate-900 mb-4">OKRs Relacionados</h3>
                                            <div class="space-y-3">
                                                ${relatedOKRs.map(okr => {
                                                    const okrStatus = calculateOKRStatus(okr);
                                                    return `
                                                        <div class="border border-slate-200 rounded-lg p-4 hover:bg-slate-50 transition-colors cursor-pointer" onclick="navigateTo('okrs'); render(); setTimeout(() => { const okrEl = document.querySelector('[data-okr-id=\"${okr.id}\"]'); if(okrEl) okrEl.scrollIntoView({behavior: 'smooth', block: 'center'}); }, 100);">
                                                            <div class="flex items-start justify-between mb-2">
                                                                <div class="flex-1">
                                                                    <h4 class="font-semibold text-slate-900 mb-1">${okr.objetivo}</h4>
                                                                    <div class="flex items-center gap-2">
                                                                        <span class="inline-block px-2 py-1 rounded text-xs font-semibold ${okrStatus.color} ${okrStatus.textColor}">
                                                                            ${okrStatus.label}
                                                                        </span>
                                                                        ${okrStatus.progress !== undefined ? `<span class="text-xs text-slate-600">${Math.round(okrStatus.progress)}%</span>` : ''}
                                                                    </div>
                                                                </div>
                                                                <button onclick="event.stopPropagation(); navigateTo('okrs'); render();" class="px-2 py-1 bg-blue-500 hover:bg-blue-600 text-white text-xs font-semibold rounded transition-colors" aria-label="Ir para OKR">
                                                                    <i class="fas fa-arrow-right" aria-hidden="true"></i>
                                                                </button>
                                                            </div>
                                                            <div class="text-xs text-slate-600 mt-2">
                                                                <span class="font-semibold">${okr.krs.length} KR${okr.krs.length !== 1 ? 's' : ''}</span>
                                                                ${okr.relatedFronts && okr.relatedFronts.length > 1 ? `• Relacionado a ${okr.relatedFronts.length} frentes` : ''}
                                                            </div>
                                                        </div>
                                                    `;
                                                }).join('')}
                                            </div>
                                            <div class="mt-4">
                                                <button onclick="navigateTo('okrs'); render();" class="w-full px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white font-semibold rounded transition-colors text-sm">
                                                    <i class="fas fa-bullseye mr-2" aria-hidden="true"></i> Ver Todos os OKRs
                                                </button>
                                            </div>
                                        </div>
                                    `;
                                } else {
                                    return `
                                        <div class="border-t border-slate-200 pt-6">
                                            <h3 class="font-semibold text-slate-900 mb-4">OKRs Relacionados</h3>
                                            <div class="bg-slate-50 border border-slate-200 rounded-lg p-6 text-center">
                                                <i class="fas fa-bullseye text-4xl text-slate-300 mb-3" aria-hidden="true"></i>
                                                <p class="text-slate-600 mb-4">Esta frente ainda não está relacionada a nenhum OKR.</p>
                                                <button onclick="navigateTo('okrs'); render();" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white font-semibold rounded transition-colors text-sm">
                                                    <i class="fas fa-link mr-2" aria-hidden="true"></i> Relacionar a um OKR
                                                </button>
                                            </div>
                                        </div>
                                    `;
                                }
                            })()}
                            <div class="flex gap-3 pt-4 border-t border-slate-200 mt-6">
                                <button onclick="openEditFront('${front.id}')" class="flex-1 px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white font-semibold rounded transition-colors">
                                    <i class="fas fa-edit mr-2"></i> Editar
                                </button>
                                <button onclick="deleteFront('${front.id}')" class="flex-1 px-4 py-2 bg-red-500 hover:bg-red-600 text-white font-semibold rounded transition-colors">
                                    <i class="fas fa-trash mr-2"></i> Deletar
                                </button>
                                <button onclick="closeFrontDetail()" class="flex-1 px-4 py-2 bg-slate-300 hover:bg-slate-400 text-slate-700 font-semibold rounded transition-colors">
                                    <i class="fas fa-times mr-2"></i> Fechar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        function renderEditFrontModal() {
            const front = fronts.find(f => f.id === editingFrontId);
            if (!front) return '';

            return `
                <div class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center overflow-auto modal-overlay" onclick="if(event.target === this) closeEditFront()">
                    <div class="bg-white rounded-lg shadow-2xl max-w-2xl w-full m-4 edit-modal" onclick="event.stopPropagation()">
                        <div class="sticky top-0 bg-white border-b border-slate-200 p-6 flex items-center justify-between">
                            <h2 class="text-2xl font-bold text-slate-900">Editar Frente</h2>
                            <button onclick="closeEditFront()" class="p-2 hover:bg-slate-100 rounded-lg transition-colors">
                                <i class="fas fa-times text-slate-600 text-xl"></i>
                            </button>
                        </div>

                        <div class="p-6 space-y-4 overflow-y-auto max-h-[calc(85vh-120px)]">
                            <div class="flex gap-2 border-b border-slate-200 mb-4">
                                <button onclick="editFrontTab = 'basic'; render()" class="tab-button ${editFrontTab === 'basic' ? 'active' : ''}">Básico</button>
                                <button onclick="editFrontTab = 'actions'; render()" class="tab-button ${editFrontTab === 'actions' ? 'active' : ''}">Objetivos e Ações</button>
                                <button onclick="editFrontTab = 'maturity'; render()" class="tab-button ${editFrontTab === 'maturity' ? 'active' : ''}">Níveis de Maturidade</button>
                            </div>

                            ${editFrontTab === 'basic' ? `
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-semibold text-slate-700 mb-2">Nome da Frente</label>
                                        <input type="text" id="edit-front-name" value="${front.name}" class="w-full">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold text-slate-700 mb-2">Owner</label>
                                        <input type="text" id="edit-front-owner" value="${front.ownerName}" class="w-full">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold text-slate-700 mb-2">Nível de Maturidade (1-5)</label>
                                        <input type="number" id="edit-front-maturity" min="1" max="5" value="${front.maturityLevel}" class="w-full">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold text-slate-700 mb-2">Status</label>
                                        <select id="edit-front-status" class="w-full">
                                            <option value="at-risk" ${front.status === 'at-risk' ? 'selected' : ''}>Risco</option>
                                            <option value="in-progress" ${front.status === 'in-progress' ? 'selected' : ''}>Em Progresso</option>
                                            <option value="canceled" ${front.status === 'canceled' ? 'selected' : ''}>Cancelado</option>
                                            <option value="achieved" ${front.status === 'achieved' ? 'selected' : ''}>Atingido</option>
                                        </select>
                                    </div>
                                </div>
                            ` : editFrontTab === 'actions' ? `
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-semibold text-slate-700 mb-2">Objetivos Principais (um por linha)</label>
                                        <textarea id="edit-front-objectives" rows="4" class="w-full">${front.mainObjectives.join('\n')}</textarea>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold text-slate-700 mb-2">Ações Atuais (um por linha)</label>
                                        <textarea id="edit-front-current-actions" rows="4" class="w-full">${front.currentActions.join('\n')}</textarea>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold text-slate-700 mb-2">Ações Futuras (um por linha)</label>
                                        <textarea id="edit-front-future-actions" rows="4" class="w-full">${front.futureActions.join('\n')}</textarea>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold text-slate-700 mb-2">Pontos de Atenção (um por linha)</label>
                                        <textarea id="edit-front-attention-points" rows="4" class="w-full">${front.attentionPoints.join('\n')}</textarea>
                                    </div>
                                </div>
                            ` : `
                                <div class="space-y-4">
                                    ${front.maturityLevels.map((lvl, idx) => `
                                        <div class="border border-slate-200 rounded-lg p-4">
                                            <div class="flex items-center justify-between mb-3">
                                                <div class="flex items-center gap-3">
                                                    <span class="font-semibold text-slate-900">Nível ${lvl.level}</span>
                                                </div>
                                            </div>
                                            <div class="space-y-3">
                                                <div>
                                                    <label class="block text-sm font-semibold text-slate-700 mb-2">Descrição</label>
                                                    <input type="text" id="edit-level-${lvl.level}-description" value="${lvl.description || ''}" class="w-full">
                                                </div>
                                                <div>
                                                    <label class="block text-sm font-semibold text-slate-700 mb-2">Expectativas (uma por linha no formato: Descrição | status)</label>
                                                    <textarea id="edit-level-${lvl.level}-expectations" rows="3" class="w-full">${(lvl.expectations || []).map(e => `${e.description} | ${e.status || 'not-done'}`).join('\n')}</textarea>
                                                    <p class="text-xs text-slate-500 mt-1">Status válidos: done, in-progress, not-done</p>
                                                </div>
                                                <div>
                                                    <label class="block text-sm font-semibold text-slate-700 mb-2">Problemas Evitados (um por linha)</label>
                                                    <textarea id="edit-level-${lvl.level}-problems" rows="2" class="w-full">${(lvl.problemsAvoided || []).join('\n')}</textarea>
                                                </div>
                                                <div>
                                                    <label class="block text-sm font-semibold text-slate-700 mb-2">Indicadores de Evolução (um por linha)</label>
                                                    <textarea id="edit-level-${lvl.level}-indicators" rows="2" class="w-full">${(lvl.evolutionIndicators || []).join('\n')}</textarea>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            `}

                            <div class="flex gap-3 pt-4 border-t border-slate-200">
                                <button onclick="saveEditFront()" class="flex-1 px-4 py-2 bg-green-500 hover:bg-green-600 text-white font-semibold rounded transition-colors">
                                    <i class="fas fa-save mr-2"></i> Salvar Alterações
                                </button>
                                <button onclick="closeEditFront()" class="flex-1 px-4 py-2 bg-slate-300 hover:bg-slate-400 text-slate-700 font-semibold rounded transition-colors">
                                    <i class="fas fa-times mr-2"></i> Cancelar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        function renderNewFrontModal() {
            return `
                <div class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center overflow-auto modal-overlay" onclick="if(event.target === this) closeNewFront()">
                    <div class="bg-white rounded-lg shadow-2xl max-w-2xl w-full m-4 edit-modal" onclick="event.stopPropagation()">
                        <div class="sticky top-0 bg-white border-b border-slate-200 p-6 flex items-center justify-between">
                            <h2 class="text-2xl font-bold text-slate-900">Nova Frente de Engenharia</h2>
                            <button onclick="closeNewFront()" class="p-2 hover:bg-slate-100 rounded-lg transition-colors">
                                <i class="fas fa-times text-slate-600 text-xl"></i>
                            </button>
                        </div>

                        <div class="p-6 space-y-4 overflow-y-auto max-h-[calc(85vh-120px)]">
                            <div class="flex gap-2 border-b border-slate-200 mb-4">
                                <button onclick="newFrontTab = 'basic'; render()" class="tab-button ${newFrontTab === 'basic' ? 'active' : ''}">Básico</button>
                                <button onclick="newFrontTab = 'actions'; render()" class="tab-button ${newFrontTab === 'actions' ? 'active' : ''}">Objetivos e Ações</button>
                            </div>

                            ${newFrontTab === 'basic' ? `
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-semibold text-slate-700 mb-2">Nome da Frente *</label>
                                        <input type="text" id="new-front-name" placeholder="Ex: Gestão de Incidentes" class="w-full">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold text-slate-700 mb-2">Owner *</label>
                                        <input type="text" id="new-front-owner" placeholder="Ex: João Silva" class="w-full">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold text-slate-700 mb-2">Nível de Maturidade (1-5)</label>
                                        <input type="number" id="new-front-maturity" min="1" max="5" value="1" class="w-full">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold text-slate-700 mb-2">Status</label>
                                        <select id="new-front-status" class="w-full">
                                            <option value="at-risk">Risco</option>
                                            <option value="in-progress" selected>Em Progresso</option>
                                            <option value="canceled">Cancelado</option>
                                            <option value="achieved">Atingido</option>
                                        </select>
                                    </div>
                                </div>
                            ` : `
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-semibold text-slate-700 mb-2">Objetivos Principais (um por linha)</label>
                                        <textarea id="new-front-objectives" rows="4" placeholder="Digite os objetivos..."></textarea>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold text-slate-700 mb-2">Ações Atuais (um por linha)</label>
                                        <textarea id="new-front-current-actions" rows="4" placeholder="Digite as ações atuais..."></textarea>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold text-slate-700 mb-2">Ações Futuras (um por linha)</label>
                                        <textarea id="new-front-future-actions" rows="4" placeholder="Digite as ações futuras..."></textarea>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold text-slate-700 mb-2">Pontos de Atenção (um por linha)</label>
                                        <textarea id="new-front-attention-points" rows="4" placeholder="Digite os pontos de atenção..."></textarea>
                                    </div>
                                </div>
                            `}

                            <div class="flex gap-3 pt-4 border-t border-slate-200">
                                <button onclick="saveNewFront()" class="flex-1 px-4 py-2 bg-green-500 hover:bg-green-600 text-white font-semibold rounded transition-colors">
                                    <i class="fas fa-plus mr-2"></i> Criar Frente
                                </button>
                                <button onclick="closeNewFront()" class="flex-1 px-4 py-2 bg-slate-300 hover:bg-slate-400 text-slate-700 font-semibold rounded transition-colors">
                                    <i class="fas fa-times mr-2"></i> Cancelar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // ========== PÁGINA DE OKRs ==========
        const measurementUnits = ['%', 'R$', 'unidades', 'Dias'];
        
        function openNewOKRModal() {
            creatingNewOKR = true;
            render();
        }

        function closeNewOKRModal() {
            creatingNewOKR = false;
            render();
        }

        function addKRToOKR() {
            const krsContainer = document.getElementById('okr-krs-container');
            if (!krsContainer) return;
            
            const krIndex = krsContainer.querySelectorAll('.kr-item').length;
            const krHTML = `
                <div class="kr-item border border-slate-200 rounded-lg p-4 mb-3 bg-slate-50">
                    <div class="flex items-center justify-between mb-3">
                        <h4 class="font-semibold text-slate-700">Resultado-Chave ${krIndex + 1}</h4>
                        <button type="button" onclick="this.closest('.kr-item').remove()" class="text-red-500 hover:text-red-700" aria-label="Remover KR">
                            <i class="fas fa-times" aria-hidden="true"></i>
                        </button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-2">Descrição do KR *</label>
                            <input type="text" name="kr-description" placeholder="Ex: Reduzir MTTR em 30%" class="w-full" required>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-2">Unidade de Medida *</label>
                            <select name="kr-unit" class="w-full" required>
                                <option value="">Selecione...</option>
                                ${measurementUnits.map(unit => `<option value="${unit}">${unit}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-2">Baseline *</label>
                            <input type="number" name="kr-baseline" placeholder="0" step="0.01" class="w-full" required>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-2">Target *</label>
                            <input type="number" name="kr-target" placeholder="0" step="0.01" class="w-full" required>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-2">Indicador Relacionado</label>
                            <select name="kr-indicator" class="w-full">
                                <option value="">Nenhum</option>
                                ${Object.entries(indicators).map(([pilar, indicadores]) => 
                                    typeof indicadores === 'object' && indicadores !== null
                                        ? Object.keys(indicadores).map(ind => 
                                            `<option value="${pilar}|${ind}">${pilar} - ${ind}</option>`
                                          ).join('')
                                        : ''
                                ).join('')}
                            </select>
                        </div>
                    </div>
                </div>
            `;
            krsContainer.insertAdjacentHTML('beforeend', krHTML);
        }
        function saveNewOKR() {
            const objetivo = document.getElementById('okr-objetivo').value.trim();
            const krsContainer = document.getElementById('okr-krs-container');
            
            if (!objetivo) {
                alert('O objetivo é obrigatório!');
                return;
            }
            
            const krItems = krsContainer.querySelectorAll('.kr-item');
            if (krItems.length === 0) {
                alert('Adicione pelo menos um Resultado-Chave (KR)!');
                return;
            }
            
            const krs = Array.from(krItems).map((item, index) => {
                const description = item.querySelector('[name="kr-description"]').value.trim();
                const unit = item.querySelector('[name="kr-unit"]').value;
                const baseline = parseFloat(item.querySelector('[name="kr-baseline"]').value) || 0;
                const target = parseFloat(item.querySelector('[name="kr-target"]').value) || 0;
                const indicatorPath = item.querySelector('[name="kr-indicator"]').value;
                
                if (!description || !unit) {
                    throw new Error(`KR ${index + 1}: Descrição e Unidade são obrigatórios!`);
                }
                
                return {
                    id: 'kr' + Date.now() + index,
                    description,
                    unit,
                    baseline,
                    target,
                    realizado: 0, // Será atualizado automaticamente pelos indicadores
                    varMoM: 0, // Será calculado automaticamente
                    indicatorPath: indicatorPath || null,
                    relatedFronts: [], // Frentes relacionadas a este KR específico
                    createdAt: new Date().toISOString()
                };
            });
            
            const newOKR = {
                id: 'okr' + Date.now(),
                objetivo,
                krs,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            okrs.push(newOKR);
            saveOKRs();
            // Sincronizar KRs como indicadores
            syncKRsToIndicators();
            closeNewOKRModal();
        }

        function calculateOKRStatus(okr) {
            if (!okr.krs || okr.krs.length === 0) return { status: 'no-data', color: 'bg-gray-100', textColor: 'text-gray-800', label: 'Sem dados' };
            
            const avgProgress = okr.krs.reduce((sum, kr) => {
                const progress = kr.realizado !== undefined && kr.target !== undefined && kr.target !== 0
                    ? (kr.realizado / kr.target) * 100 : 0;
                return sum + Math.min(progress, 100);
            }, 0) / okr.krs.length;
            
            if (avgProgress >= 80) return { status: 'on-track', color: 'bg-green-100', textColor: 'text-green-800', label: 'No Prazo', progress: avgProgress };
            if (avgProgress >= 50) return { status: 'at-risk', color: 'bg-yellow-100', textColor: 'text-yellow-800', label: 'Em Risco', progress: avgProgress };
            return { status: 'behind', color: 'bg-red-100', textColor: 'text-red-800', label: 'Atrasado', progress: avgProgress };
        }

        function openFrontsRelationModal(okrId, krId) {
            showingFrontsRelationModal = `${okrId}|${krId}`;
            render();
        }

        function closeFrontsRelationModal() {
            showingFrontsRelationModal = null;
            draggedFrontId = null;
            render();
        }

        function allowDrop(e) {
            e.preventDefault();
        }

        function dragStart(e, frontId) {
            draggedFrontId = frontId;
            e.dataTransfer.effectAllowed = 'move';
        }

        function dropOnKR(e, okrId, krId) {
            e.preventDefault();
            if (!draggedFrontId) return;
            
            const okr = okrs.find(o => o.id === okrId);
            if (!okr) return;
            
            const kr = okr.krs.find(k => k.id === krId);
            if (!kr) return;
            
            if (!kr.relatedFronts) kr.relatedFronts = [];
            if (!kr.relatedFronts.includes(draggedFrontId)) {
                kr.relatedFronts.push(draggedFrontId);
                saveOKRs();
            }
            
            draggedFrontId = null;
            render();
        }

        function addFrontToKR(okrId, krId, frontId) {
            const okr = okrs.find(o => o.id === okrId);
            if (!okr) return;
            
            const kr = okr.krs.find(k => k.id === krId);
            if (!kr) return;
            
            if (!kr.relatedFronts) kr.relatedFronts = [];
            if (!kr.relatedFronts.includes(frontId)) {
                kr.relatedFronts.push(frontId);
                saveOKRs();
                render();
            }
        }
        function removeFrontFromKR(okrId, krId, frontId) {
            const okr = okrs.find(o => o.id === okrId);
            if (!okr) return;
            
            const kr = okr.krs.find(k => k.id === krId);
            if (kr && kr.relatedFronts) {
                kr.relatedFronts = kr.relatedFronts.filter(f => f !== frontId);
                saveOKRs();
                render();
            }
        }

        function openEditOKR(okrId) {
            editingOKRId = okrId;
            render();
        }

        function closeEditOKR() {
            editingOKRId = null;
            render();
        }
        function saveEditOKR() {
            const okr = okrs.find(o => o.id === editingOKRId);
            if (!okr) return;

            const objetivo = document.getElementById('edit-okr-objetivo').value.trim();
            const krsContainer = document.getElementById('edit-okr-krs-container');
            
            if (!objetivo) {
                alert('O objetivo é obrigatório!');
                return;
            }
            
            const krItems = krsContainer.querySelectorAll('.kr-item');
            if (krItems.length === 0) {
                alert('Adicione pelo menos um Resultado-Chave (KR)!');
                return;
            }
            
            try {
                const krs = Array.from(krItems).map((item, index) => {
                    const krId = item.dataset.krId || ('kr' + Date.now() + index);
                    const description = item.querySelector('[name="kr-description"]').value.trim();
                    const unit = item.querySelector('[name="kr-unit"]').value;
                    const baseline = parseFloat(item.querySelector('[name="kr-baseline"]').value) || 0;
                    const target = parseFloat(item.querySelector('[name="kr-target"]').value) || 0;
                    const indicatorPath = item.querySelector('[name="kr-indicator"]').value;
                    
                    if (!description || !unit) {
                        throw new Error(`KR ${index + 1}: Descrição e Unidade são obrigatórios!`);
                    }
                    
                    // Manter dados existentes se for KR editado
                    const existingKr = okr.krs.find(k => k.id === krId);
                    
                    return {
                        id: krId,
                        description,
                        unit,
                        baseline,
                        target,
                        realizado: existingKr ? (existingKr.realizado || 0) : 0,
                        varMoM: existingKr ? parseFloat(existingKr.varMoM || 0) : 0,
                        indicatorPath: indicatorPath || null,
                        relatedFronts: existingKr ? (existingKr.relatedFronts || []) : [],
                        createdAt: existingKr ? existingKr.createdAt : new Date().toISOString()
                    };
                });
                
                okr.objetivo = objetivo;
                okr.krs = krs;
                okr.updatedAt = new Date().toISOString();
                
                // Sincronizar KRs como indicadores
                syncKRsToIndicators();
                
                saveOKRs();
                closeEditOKR();
            } catch (e) {
                alert(e.message);
            }
        }
        function addKRToEditOKR() {
            const krsContainer = document.getElementById('edit-okr-krs-container');
            if (!krsContainer) return;
            
            const krIndex = krsContainer.querySelectorAll('.kr-item').length;
            const krHTML = `
                <div class="kr-item border border-slate-200 rounded-lg p-4 mb-3 bg-slate-50">
                    <div class="flex items-center justify-between mb-3">
                        <h4 class="font-semibold text-slate-700">Resultado-Chave ${krIndex + 1}</h4>
                        <button type="button" onclick="this.closest('.kr-item').remove()" class="text-red-500 hover:text-red-700" aria-label="Remover KR">
                            <i class="fas fa-times" aria-hidden="true"></i>
                        </button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-2">Descrição do KR *</label>
                            <input type="text" name="kr-description" placeholder="Ex: Reduzir MTTR em 30%" class="w-full" required>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-2">Unidade de Medida *</label>
                            <select name="kr-unit" class="w-full" required>
                                <option value="">Selecione...</option>
                                ${measurementUnits.map(unit => `<option value="${unit}">${unit}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-2">Baseline *</label>
                            <input type="number" name="kr-baseline" placeholder="0" step="0.01" class="w-full" required>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-2">Target *</label>
                            <input type="number" name="kr-target" placeholder="0" step="0.01" class="w-full" required>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-2">Indicador Relacionado</label>
                            <select name="kr-indicator" class="w-full">
                                <option value="">Nenhum</option>
                                ${Object.entries(indicators).map(([pilar, indicadores]) => 
                                    typeof indicadores === 'object' && indicadores !== null
                                        ? Object.keys(indicadores).map(ind => 
                                            `<option value="${pilar}|${ind}">${pilar} - ${ind}</option>`
                                          ).join('')
                                        : ''
                                ).join('')}
                            </select>
                        </div>
                    </div>
                </div>
            `;
            krsContainer.insertAdjacentHTML('beforeend', krHTML);
        }

        function syncKRsToIndicators() {
            // Sincronizar todos os KRs como indicadores na seção de OKRs
            if (!indicators['KRs de OKRs']) {
                indicators['KRs de OKRs'] = {};
            }
            
            okrs.forEach(okr => {
                okr.krs.forEach(kr => {
                    // Usar ID único do KR como chave do indicador
                    const indicatorKey = `${okr.objetivo} - ${kr.description}`;
                    
                    // Se não existe, criar estrutura vazia
                    if (!indicators['KRs de OKRs'][indicatorKey]) {
                        indicators['KRs de OKRs'][indicatorKey] = {};
                    }
                    
                    // Se o KR tem indicatorPath, também criar referência no pilar correto
                    if (kr.indicatorPath) {
                        const [pilar, indicador] = kr.indicatorPath.split('|');
                        if (pilar && indicador) {
                            if (!indicators[pilar]) {
                                indicators[pilar] = {};
                            }
                            if (!indicators[pilar][indicador]) {
                                indicators[pilar][indicador] = {};
                            }
                        }
                    }
                });
            });
            
            saveIndicators();
        }

        function deleteOKR(okrId) {
            if (confirm('Tem certeza que deseja deletar este OKR?')) {
                okrs = okrs.filter(o => o.id !== okrId);
                saveOKRs();
                // Resincronizar indicadores após deletar
                syncKRsToIndicators();
                render();
            }
        }
        function exportOKRsToCSV() {
            const headers = ['Objetivo', 'KR', 'Unidade', 'Baseline', 'Target', 'Realizado', 'Var. MoM', 'Frentes Relacionadas'];
            const rows = [];
            
            okrs.forEach(okr => {
                okr.krs.forEach((kr, idx) => {
                    const relatedFrontsNames = (kr.relatedFronts || []).map(fId => {
                        const front = fronts.find(f => f.id === fId);
                        return front ? front.name : fId;
                    }).join('; ');
                    
                    rows.push([
                        idx === 0 ? okr.objetivo : '',
                        kr.description,
                        kr.unit,
                        kr.baseline,
                        kr.target,
                        kr.realizado || 0,
                        kr.varMoM || 0,
                        relatedFrontsNames
                    ]);
                });
            });
            
            const csvContent = [headers, ...rows].map(row => 
                row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')
            ).join('\n');
            
            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `okrs_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        function renderOKRsPage() {
            return `
                <header class="bg-white border-b border-slate-200 shadow-sm sticky top-0 z-40">
                    <div class="max-w-7xl mx-auto px-6 py-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <h1 class="text-3xl font-bold text-slate-900">OKRs da Organização</h1>
                                <p class="text-slate-600 mt-1 text-sm">Defina e acompanhe objetivos e resultados-chave</p>
                            </div>
                            <nav class="flex items-center gap-2" aria-label="Navegação principal">
                                <button onclick="navigateTo('dashboard')" class="px-3 py-2 bg-indigo-500 hover:bg-indigo-600 text-white font-semibold rounded transition-colors text-sm" aria-label="Ir para Dashboard">
                                    <i class="fas fa-home mr-1" aria-hidden="true"></i> Dashboard
                                </button>
                                <input id="import-input-okrs" type="file" accept=".csv,.xlsx,.xls" class="hidden">
                                <button onclick="exportOKRsToCSV()" class="px-3 py-2 bg-slate-200 hover:bg-slate-300 text-slate-800 font-semibold rounded transition-colors text-sm" aria-label="Exportar OKRs">
                                    <i class="fas fa-file-export mr-1" aria-hidden="true"></i> Exportar
                                </button>
                                <button onclick="document.getElementById('import-input-okrs').click()" class="px-3 py-2 bg-slate-200 hover:bg-slate-300 text-slate-800 font-semibold rounded transition-colors text-sm" aria-label="Importar OKRs">
                                    <i class="fas fa-file-import mr-1" aria-hidden="true"></i> Importar
                                </button>
                            </nav>
                        </div>
                    </div>
                </header>

                <main class="max-w-7xl mx-auto px-6 py-8">
                    ${okrs.length === 0 ? `
                        <div class="bg-white rounded-lg shadow-md p-12 text-center border-2 border-blue-200">
                            <i class="fas fa-bullseye text-6xl text-blue-400 mb-4" aria-hidden="true"></i>
                            <h2 class="text-2xl font-bold text-slate-900 mb-2">Comece agora - Defina seus OKRs</h2>
                            <p class="text-slate-600 mb-6">Ainda não há OKRs cadastrados. Crie seu primeiro objetivo e resultados-chave.</p>
                            <button onclick="openNewOKRModal()" class="px-6 py-3 bg-blue-500 hover:bg-blue-600 text-white font-semibold rounded-lg transition-colors">
                                <i class="fas fa-plus mr-2" aria-hidden="true"></i> Criar Primeiro OKR
                            </button>
                        </div>
                    ` : `
                        <div class="mb-6 flex justify-between items-center">
                            <h2 class="text-xl font-semibold text-slate-700">${okrs.length} OKR${okrs.length !== 1 ? 's' : ''} cadastrado${okrs.length !== 1 ? 's' : ''}</h2>
                            <button onclick="openNewOKRModal()" class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white font-semibold rounded transition-colors">
                                <i class="fas fa-plus mr-2" aria-hidden="true"></i> Novo OKR
                            </button>
                        </div>
                        
                        <div class="space-y-6">
                            ${okrs.map(okr => {
                                const status = calculateOKRStatus(okr);
                                
                                return `
                                    <div class="bg-white rounded-lg shadow-md border-2 ${status.color} ${status.textColor} p-6" data-okr-id="${okr.id}">
                                        <div class="flex items-start justify-between mb-4">
                                            <div class="flex-1">
                                                <h3 class="text-xl font-bold mb-2">${okr.objetivo}</h3>
                                                <div class="flex items-center gap-3">
                                                    <span class="inline-block px-3 py-1 rounded-full text-xs font-semibold ${status.color} ${status.textColor}">
                                                        ${status.label}
                                                    </span>
                                                    ${status.progress !== undefined ? `<span class="text-sm text-slate-600">Progresso: ${Math.round(status.progress)}%</span>` : ''}
                                                </div>
                                            </div>
                                            <div class="flex items-center gap-2">
                                                <button onclick="openEditOKR('${okr.id}')" class="px-3 py-1 bg-blue-500 hover:bg-blue-600 text-white text-xs font-semibold rounded transition-colors" aria-label="Editar OKR">
                                                    <i class="fas fa-edit" aria-hidden="true"></i>
                                                </button>
                                                <button onclick="deleteOKR('${okr.id}')" class="px-3 py-1 bg-red-500 hover:bg-red-600 text-white text-xs font-semibold rounded transition-colors" aria-label="Deletar OKR">
                                                    <i class="fas fa-trash" aria-hidden="true"></i>
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <div class="space-y-3">
                                            ${okr.krs.map(kr => {
                                                const krProgress = kr.target !== 0 ? (kr.realizado / kr.target) * 100 : 0;
                                                const krRelatedFronts = (kr.relatedFronts || []).map(fId => {
                                                    const front = fronts.find(f => f.id === fId);
                                                    return front ? front.name : '';
                                                }).filter(Boolean);
                                                return `
                                                    <div class="bg-slate-50 rounded-lg p-4 border border-slate-200" 
                                                         ondrop="dropOnKR(event, '${okr.id}', '${kr.id}')" ondragover="allowDrop(event)">
                                                        <div class="flex items-start justify-between mb-2">
                                                            <div class="flex-1">
                                                                <div class="flex items-center justify-between mb-1">
                                                                    <h4 class="font-semibold text-slate-800">${kr.description}</h4>
                                                                    <button onclick="openFrontsRelationModal('${okr.id}', '${kr.id}')" class="px-2 py-1 bg-blue-500 hover:bg-blue-600 text-white text-xs font-semibold rounded transition-colors" aria-label="Relacionar frentes para este KR">
                                                                        <i class="fas fa-magnet mr-1" aria-hidden="true"></i> Frentes
                                                                    </button>
                                                                </div>
                                                                <div class="text-xs text-slate-600 mt-1">
                                                                    Baseline: ${kr.baseline} ${kr.unit} → Target: ${kr.target} ${kr.unit}
                                                                </div>
                                                                ${krRelatedFronts.length > 0 ? `
                                                                    <div class="flex flex-wrap gap-1 mt-2">
                                                                        ${krRelatedFronts.map(name => `
                                                                            <span class="px-2 py-0.5 bg-blue-100 text-blue-800 rounded text-xs">${name}</span>
                                                                        `).join('')}
                                                                    </div>
                                                                ` : `
                                                                    <p class="text-xs text-slate-400 italic mt-1">Nenhuma frente relacionada</p>
                                                                `}
                                                            </div>
                                                            <div class="text-right ml-4">
                                                                <div class="text-lg font-bold text-slate-900">${kr.realizado || 0} ${kr.unit}</div>
                                                                <div class="text-xs text-slate-600">Var. MoM: ${parseFloat(kr.varMoM || 0).toFixed(2)}%</div>
                                                            </div>
                                                        </div>
                                                        <div class="w-full h-2 bg-slate-200 rounded-full overflow-hidden">
                                                            <div class="h-full bg-blue-500 rounded-full transition-all" style="width: ${Math.min(krProgress, 100)}%"></div>
                                                        </div>
                                                    </div>
                                                `;
                                            }).join('')}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `}
                </main>

                <!-- Modal de Criação de OKR -->
                ${creatingNewOKR ? `
                    <div class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center overflow-auto modal-overlay" onclick="if(event.target === this) closeNewOKRModal()" role="dialog" aria-modal="true" aria-labelledby="okr-modal-title">
                        <div class="bg-white rounded-lg shadow-2xl max-w-4xl w-full m-4 modal-panel" onclick="event.stopPropagation()">
                            <div class="bg-white border-b border-slate-200 p-6 flex items-center justify-between sticky top-0">
                                <h2 id="okr-modal-title" class="text-2xl font-bold text-slate-900">Novo OKR</h2>
                                <button onclick="closeNewOKRModal()" class="p-2 hover:bg-slate-100 rounded-lg transition-colors" aria-label="Fechar modal">
                                    <i class="fas fa-times text-slate-600 text-xl" aria-hidden="true"></i>
                                </button>
                            </div>
                            <div class="p-6 space-y-6 overflow-y-auto max-h-[calc(85vh-120px)]">
                                <div>
                                    <label for="okr-objetivo" class="block text-sm font-semibold text-slate-700 mb-2">Objetivo *</label>
                                    <input type="text" id="okr-objetivo" placeholder="Ex: Reduzir tempo de resposta a incidentes em 50%" class="w-full">
                                </div>
                                
                                <div>
                                    <div class="flex items-center justify-between mb-3">
                                        <label class="block text-sm font-semibold text-slate-700">Resultados-Chave (KRs)</label>
                                        <button type="button" onclick="addKRToOKR()" class="px-3 py-1 bg-blue-500 hover:bg-blue-600 text-white text-sm font-semibold rounded transition-colors">
                                            <i class="fas fa-plus mr-1" aria-hidden="true"></i> Adicionar KR
                                        </button>
                                    </div>
                                    <div id="okr-krs-container" class="space-y-3">
                                        <!-- KRs serão adicionados aqui -->
                                    </div>
                                </div>
                                
                                <div class="flex gap-3 pt-4 border-t border-slate-200">
                                    <button onclick="saveNewOKR()" class="flex-1 px-4 py-2 bg-green-500 hover:bg-green-600 text-white font-semibold rounded transition-colors">
                                        <i class="fas fa-save mr-2" aria-hidden="true"></i> Salvar OKR
                                    </button>
                                    <button onclick="closeNewOKRModal()" class="flex-1 px-4 py-2 bg-slate-300 hover:bg-slate-400 text-slate-700 font-semibold rounded transition-colors">
                                        <i class="fas fa-times mr-2" aria-hidden="true"></i> Cancelar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                ` : ''}
                <!-- Modal de Edição de OKR -->
                ${editingOKRId ? (() => {
                    const okr = okrs.find(o => o.id === editingOKRId);
                    if (!okr) return '';
                    return `
                        <div class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center overflow-auto modal-overlay" onclick="if(event.target === this) closeEditOKR()" role="dialog" aria-modal="true" aria-labelledby="edit-okr-modal-title">
                            <div class="bg-white rounded-lg shadow-2xl max-w-4xl w-full m-4 modal-panel" onclick="event.stopPropagation()">
                                <div class="bg-white border-b border-slate-200 p-6 flex items-center justify-between sticky top-0">
                                    <h2 id="edit-okr-modal-title" class="text-2xl font-bold text-slate-900">Editar OKR</h2>
                                    <button onclick="closeEditOKR()" class="p-2 hover:bg-slate-100 rounded-lg transition-colors" aria-label="Fechar modal">
                                        <i class="fas fa-times text-slate-600 text-xl" aria-hidden="true"></i>
                                    </button>
                                </div>
                                <div class="p-6 space-y-6 overflow-y-auto max-h-[calc(85vh-120px)]">
                                    <div>
                                        <label for="edit-okr-objetivo" class="block text-sm font-semibold text-slate-700 mb-2">Objetivo *</label>
                                        <input type="text" id="edit-okr-objetivo" value="${okr.objetivo}" placeholder="Ex: Reduzir tempo de resposta a incidentes em 50%" class="w-full">
                                    </div>
                                    
                                    <div>
                                        <div class="flex items-center justify-between mb-3">
                                            <label class="block text-sm font-semibold text-slate-700">Resultados-Chave (KRs)</label>
                                            <button type="button" onclick="addKRToEditOKR()" class="px-3 py-1 bg-blue-500 hover:bg-blue-600 text-white text-sm font-semibold rounded transition-colors">
                                                <i class="fas fa-plus mr-1" aria-hidden="true"></i> Adicionar KR
                                            </button>
                                        </div>
                                        <div id="edit-okr-krs-container" class="space-y-3">
                                            ${okr.krs.map((kr, idx) => {
                                                return `
                                                    <div class="kr-item border border-slate-200 rounded-lg p-4 mb-3 bg-slate-50" data-kr-id="${kr.id}">
                                                        <div class="flex items-center justify-between mb-3">
                                                            <h4 class="font-semibold text-slate-700">Resultado-Chave ${idx + 1}</h4>
                                                            <button type="button" onclick="this.closest('.kr-item').remove()" class="text-red-500 hover:text-red-700" aria-label="Remover KR">
                                                                <i class="fas fa-times" aria-hidden="true"></i>
                                                            </button>
                                                        </div>
                                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
                                                            <div>
                                                                <label class="block text-sm font-semibold text-slate-700 mb-2">Descrição do KR *</label>
                                                                <input type="text" name="kr-description" value="${kr.description}" placeholder="Ex: Reduzir MTTR em 30%" class="w-full" required>
                                                            </div>
                                                            <div>
                                                                <label class="block text-sm font-semibold text-slate-700 mb-2">Unidade de Medida *</label>
                                                                <select name="kr-unit" class="w-full" required>
                                                                    <option value="">Selecione...</option>
                                                                    ${measurementUnits.map(unit => `<option value="${unit}" ${unit === kr.unit ? 'selected' : ''}>${unit}</option>`).join('')}
                                                                </select>
                                                            </div>
                                                        </div>
                                                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                                            <div>
                                                                <label class="block text-sm font-semibold text-slate-700 mb-2">Baseline *</label>
                                                                <input type="number" name="kr-baseline" value="${kr.baseline}" placeholder="0" step="0.01" class="w-full" required>
                                                            </div>
                                                            <div>
                                                                <label class="block text-sm font-semibold text-slate-700 mb-2">Target *</label>
                                                                <input type="number" name="kr-target" value="${kr.target}" placeholder="0" step="0.01" class="w-full" required>
                                                            </div>
                                                            <div>
                                                                <label class="block text-sm font-semibold text-slate-700 mb-2">Indicador Relacionado</label>
                                                                <select name="kr-indicator" class="w-full">
                                                                    <option value="">Nenhum</option>
                                                                    ${Object.entries(indicators).map(([pilar, indicadores]) => 
                                                                        typeof indicadores === 'object' && indicadores !== null
                                                                            ? Object.keys(indicadores).map(ind => {
                                                                                const path = `${pilar}|${ind}`;
                                                                                return `<option value="${path}" ${kr.indicatorPath === path ? 'selected' : ''}>${pilar} - ${ind}</option>`;
                                                                            }).join('')
                                                                            : ''
                                                                    ).join('')}
                                                                </select>
                                                            </div>
                                                        </div>
                                                    </div>
                                                `;
                                            }).join('')}
                                        </div>
                                    </div>
                                    
                                    <div class="flex gap-3 pt-4 border-t border-slate-200">
                                        <button onclick="saveEditOKR()" class="flex-1 px-4 py-2 bg-green-500 hover:bg-green-600 text-white font-semibold rounded transition-colors">
                                            <i class="fas fa-save mr-2" aria-hidden="true"></i> Salvar Alterações
                                        </button>
                                        <button onclick="closeEditOKR()" class="flex-1 px-4 py-2 bg-slate-300 hover:bg-slate-400 text-slate-700 font-semibold rounded transition-colors">
                                            <i class="fas fa-times mr-2" aria-hidden="true"></i> Cancelar
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                })() : ''}

                <!-- Modal de Relacionamento com Frentes (por KR) -->
                ${showingFrontsRelationModal ? (() => {
                    const [okrId, krId] = showingFrontsRelationModal.split('|');
                    const okr = okrs.find(o => o.id === okrId);
                    if (!okr) return '';
                    const kr = okr.krs.find(k => k.id === krId);
                    if (!kr) return '';
                    
                    const krRelatedFronts = kr.relatedFronts || [];
                    const availableFronts = fronts.filter(f => !krRelatedFronts.includes(f.id));
                    
                    return `
                        <div class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center overflow-auto modal-overlay" onclick="if(event.target === this) closeFrontsRelationModal()" role="dialog" aria-modal="true">
                            <div class="bg-white rounded-lg shadow-2xl max-w-3xl w-full m-4 modal-panel" onclick="event.stopPropagation()">
                                <div class="bg-white border-b border-slate-200 p-6 flex items-center justify-between sticky top-0">
                                    <div>
                                        <h2 class="text-2xl font-bold text-slate-900">Relacionar Frentes para o KR</h2>
                                        <p class="text-sm text-slate-600 mt-1">${kr.description}</p>
                                    </div>
                                    <button onclick="closeFrontsRelationModal()" class="p-2 hover:bg-slate-100 rounded-lg transition-colors" aria-label="Fechar modal">
                                        <i class="fas fa-times text-slate-600 text-xl" aria-hidden="true"></i>
                                    </button>
                                </div>
                                <div class="p-6">
                                    <p class="text-sm text-slate-600 mb-4">Arraste as frentes da lista abaixo para associá-las a este Resultado-Chave, ou clique para adicionar/remover múltiplas frentes.</p>
                                    
                                    <div class="grid grid-cols-2 gap-6">
                                        <div>
                                            <h3 class="font-semibold text-slate-800 mb-3">Frentes Disponíveis</h3>
                                            <div class="space-y-2 max-h-96 overflow-y-auto">
                                                ${availableFronts.length > 0 ? availableFronts.map(front => `
                                                    <div draggable="true" ondragstart="dragStart(event, '${front.id}')" 
                                                         onclick="addFrontToKR('${okrId}', '${krId}', '${front.id}')"
                                                         class="p-3 bg-slate-100 hover:bg-slate-200 rounded cursor-move border border-slate-300 transition-colors">
                                                        <div class="flex items-center gap-2">
                                                            <i class="fas fa-grip-vertical text-slate-400" aria-hidden="true"></i>
                                                            <span class="font-medium text-slate-700">${front.name}</span>
                                                        </div>
                                                        <p class="text-xs text-slate-500 mt-1">Clique para adicionar</p>
                                                    </div>
                                                `).join('') : '<p class="text-sm text-slate-400 italic">Todas as frentes já estão relacionadas</p>'}
                                            </div>
                                        </div>
                                        <div>
                                            <h3 class="font-semibold text-slate-800 mb-3">Frentes Relacionadas</h3>
                                            <div class="space-y-2 max-h-96 overflow-y-auto" 
                                                 ondrop="dropOnKR(event, '${okrId}', '${krId}')" 
                                                 ondragover="allowDrop(event)">
                                                ${krRelatedFronts.length > 0 ? krRelatedFronts.map(fId => {
                                                    const front = fronts.find(f => f.id === fId);
                                                    if (!front) return '';
                                                    return `
                                                        <div class="p-3 bg-blue-100 border border-blue-300 rounded flex items-center justify-between">
                                                            <span class="font-medium text-blue-800">${front.name}</span>
                                                            <button onclick="removeFrontFromKR('${okrId}', '${krId}', '${fId}')" class="text-red-500 hover:text-red-700" aria-label="Remover">
                                                                <i class="fas fa-times" aria-hidden="true"></i>
                                                            </button>
                                                        </div>
                                                    `;
                                                }).join('') : '<p class="text-sm text-slate-500 italic">Arraste frentes aqui ou clique nas frentes disponíveis</p>'}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="flex gap-3 pt-6 border-t border-slate-200 mt-6">
                                        <button onclick="closeFrontsRelationModal()" class="flex-1 px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white font-semibold rounded transition-colors">
                                            <i class="fas fa-check mr-2" aria-hidden="true"></i> Fechar
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                })() : ''}
            `;
        }
        function updateIndicatorValue(pilar, indicador, value) {
            if (!indicators[pilar]) indicators[pilar] = {};
            if (typeof indicators[pilar] === 'object' && !Array.isArray(indicators[pilar])) {
                const monthYearKey = `${selectedIndicatorYear}-${String(selectedIndicatorMonth).padStart(2, '0')}`;
                if (!indicators[pilar][indicador]) indicators[pilar][indicador] = {};
                indicators[pilar][indicador][monthYearKey] = parseFloat(value) || 0;
                saveIndicators();
                
                // Atualizar OKRs relacionados automaticamente
                updateOKRsFromIndicators(pilar, indicador, parseFloat(value) || 0);
            }
        }
        function updateIndicatorPillar(pillar) {
            selectedIndicatorPillar = pillar === 'all' ? null : pillar;
            render();
        }
        function updateIndicatorMonth(month) {
            selectedIndicatorMonth = parseInt(month) || new Date().getMonth() + 1;
            render();
        }
        function updateIndicatorYear(year) {
            selectedIndicatorYear = parseInt(year) || new Date().getFullYear();
            render();
        }
        function updateOKRsFromIndicators(pilar, indicador, value) {
            const monthYearKey = `${selectedIndicatorYear}-${String(selectedIndicatorMonth).padStart(2, '0')}`;
            
            // Se for um indicador da seção "KRs de OKRs", atualizar o KR correspondente
            if (pilar === 'KRs de OKRs') {
                okrs.forEach(okr => {
                    okr.krs.forEach(kr => {
                        const krIndicatorKey = `${okr.objetivo} - ${kr.description}`;
                        if (indicador === krIndicatorKey) {
                            kr.realizado = value;
                            
                            // Calcular Var. MoM
                            const prevMonth = selectedIndicatorMonth === 1 ? 12 : selectedIndicatorMonth - 1;
                            const prevYear = selectedIndicatorMonth === 1 ? selectedIndicatorYear - 1 : selectedIndicatorYear;
                            const prevMonthKey = `${prevYear}-${String(prevMonth).padStart(2, '0')}`;
                            
                            const prevValue = indicators[pilar] && indicators[pilar][indicador] && indicators[pilar][indicador][prevMonthKey]
                                ? indicators[pilar][indicador][prevMonthKey] : kr.baseline;
                            
                            if (prevValue !== 0) {
                                kr.varMoM = parseFloat(((value - prevValue) / prevValue) * 100);
                            } else {
                                kr.varMoM = 0;
                            }
                        }
                    });
                });
                saveOKRs();
                return;
            }
            
            // Para indicadores tradicionais (relacionados via indicatorPath)
            const indicatorPath = `${pilar}|${indicador}`;
            okrs.forEach(okr => {
                okr.krs.forEach(kr => {
                    if (kr.indicatorPath === indicatorPath) {
                        kr.realizado = value;
                        
                        // Calcular Var. MoM (comparar com mês anterior)
                        const prevMonth = selectedIndicatorMonth === 1 ? 12 : selectedIndicatorMonth - 1;
                        const prevYear = selectedIndicatorMonth === 1 ? selectedIndicatorYear - 1 : selectedIndicatorYear;
                        const prevMonthKey = `${prevYear}-${String(prevMonth).padStart(2, '0')}`;
                        
                        const prevValue = indicators[pilar] && indicators[pilar][indicador] && indicators[pilar][indicador][prevMonthKey]
                            ? indicators[pilar][indicador][prevMonthKey] : kr.baseline;
                        
                        if (prevValue !== 0) {
                            kr.varMoM = parseFloat(((value - prevValue) / prevValue) * 100);
                        } else {
                            kr.varMoM = 0;
                        }
                    }
                });
            });
            saveOKRs();
        }
        function handleRiskImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const text = e.target.result;
                    const lines = text.split('\n').filter(line => line.trim());
                    
                    if (lines.length < 1) {
                        alert('Arquivo vazio ou inválido. O arquivo deve conter pelo menos uma linha de dados.');
                        return;
                    }

                    // Parse do CSV - usar ordem das colunas ao invés dos nomes
                    // A primeira linha pode ser cabeçalho ou dados - vamos detectar automaticamente
                    let startIndex = 0;
                    
                    // Verificar se a primeira linha parece ser cabeçalho
                    if (lines.length > 0) {
                        const firstLineValues = parseCSVLine(lines[0]);
                        // Se a primeira linha contém palavras típicas de cabeçalho, pular ela
                        if (firstLineValues.length > 0) {
                            const firstCell = firstLineValues[0].trim().toLowerCase();
                            if (firstCell.includes('id') || firstCell.includes('nome') || firstCell.includes('tarefa') || 
                                firstCell.includes('bucket') || firstCell.includes('jornada') || firstCell.includes('progresso')) {
                                // Parece ser cabeçalho, pular primeira linha
                                startIndex = 1;
                            }
                        }
                    }
                    
                    const linesToProcess = lines.slice(startIndex);
                    
                    // Ordem fixa das colunas (baseada na ordem original solicitada):
                    // 0: ID do Planner/Task
                    // 1: Nome da Tarefa
                    // 2: Bucket/Jornada
                    // 3: Progresso
                    // 4: Prioridade
                    // 5: Atribuído
                    // 6: Criado por
                    // 7: Criado em
                    // 8: Data de início
                    // 9: Data de conclusão
                    // 10: Recorrente
                    // 11: Atrasado
                    // 12: Concluído
                    // 13: Concluído em
                    // 14: Concluído por
                    // 15: Checklist
                    // 16: Rótulos/Labels
                    // 17: Descrição
                    
                    if (linesToProcess.length === 0) {
                        alert('Arquivo vazio ou inválido. O arquivo deve conter pelo menos uma linha de dados.');
                        return;
                    }

                    let importedCount = 0;
                    let errors = [];

                    linesToProcess.forEach((line, lineIndex) => {
                        if (!line.trim()) return;
                        
                        try {
                            const values = parseCSVLine(line);
                            
                            // Usar ordem fixa das colunas (índices fixos) ao invés de nomes
                            const plannerId = values[0]?.trim() || '';
                            const taskName = values[1]?.trim() || '';
                            const bucketName = values[2]?.trim() || '';

                            if (!plannerId || !taskName || !bucketName) {
                                errors.push(`Linha ${startIndex + lineIndex + 1}: Campos obrigatórios ausentes (ID, Nome da Tarefa e Bucket)`);
                                return;
                            }

                            // Encontrar jornada pelo nome ou sigla
                            const journey = journeys.find(j => 
                                j.name.toLowerCase() === bucketName.toLowerCase() || 
                                j.acronym.toLowerCase() === bucketName.toLowerCase()
                            );

                            if (!journey) {
                                errors.push(`Linha ${startIndex + lineIndex + 1}: Jornada "${bucketName}" não encontrada`);
                                return;
                            }

                            // Garantir que o array events existe
                            if (!journey.events) {
                                journey.events = [];
                            }

                            // Criar objeto de risco usando ordem fixa das colunas
                            const newRisk = {
                                id: 'risk' + Date.now() + lineIndex,
                                category: EVENT_CATEGORY_RISK,
                                plannerId: plannerId,
                                taskName: taskName,
                                bucket: journey.id,
                                progress: parseInt(values[3]) || 0,
                                priority: values[4]?.trim() || '',
                                assignedTo: values[5]?.trim() || '',
                                createdBy: values[6]?.trim() || '',
                                createdAt: values[7]?.trim() || '',
                                startDate: values[8]?.trim() || '',
                                dueDate: values[9]?.trim() || '',
                                isRecurring: (values[10]?.trim().toLowerCase() === 'true' || values[10]?.trim().toLowerCase() === 'sim' || values[10]?.trim() === '1'),
                                isOverdue: (values[11]?.trim().toLowerCase() === 'true' || values[11]?.trim().toLowerCase() === 'sim' || values[11]?.trim() === '1'),
                                isCompleted: (values[12]?.trim().toLowerCase() === 'true' || values[12]?.trim().toLowerCase() === 'sim' || values[12]?.trim() === '1'),
                                completedAt: values[13]?.trim() || '',
                                completedBy: values[14]?.trim() || '',
                                checklist: values[15]?.trim() || '',
                                labels: values[16]?.trim() || '',
                                description: values[17]?.trim() || ''
                            };

                            journey.events.push(newRisk);
                            importedCount++;
                        } catch (err) {
                            errors.push(`Linha ${startIndex + lineIndex + 1}: ${err.message}`);
                        }
                    });

                    if (importedCount > 0) {
                        saveJourneys();
                        let message = `${importedCount} risco(s) importado(s) com sucesso!`;
                        if (errors.length > 0) {
                            message += `\n\nErros encontrados (${errors.length}):\n${errors.slice(0, 5).join('\n')}${errors.length > 5 ? `\n... e mais ${errors.length - 5} erro(s)` : ''}`;
                        }
                        alert(message);
                        render();
                    } else {
                        alert('Nenhum risco foi importado. Verifique o formato do arquivo e tente novamente.\n\nErros:\n' + errors.slice(0, 10).join('\n'));
                    }

                    // Limpar o input
                    event.target.value = '';
                } catch (err) {
                    alert('Erro ao processar arquivo: ' + err.message);
                    event.target.value = '';
                }
            };
            reader.readAsText(file);
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    if (inQuotes && line[i + 1] === '"') {
                        current += '"';
                        i++; // Pular próximo "
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current); // Adicionar último campo
            return result;
        }

        function exportIndicatorsToCSV() {
            const headers = ['Pilar', 'Indicador', 'Mês/Ano', 'Valor'];
            const rows = [];
            
            Object.entries(indicators).forEach(([pilar, indicadores]) => {
                if (typeof indicadores === 'object' && indicadores !== null && !Array.isArray(indicadores)) {
                    Object.entries(indicadores).forEach(([indicador, valores]) => {
                        if (typeof valores === 'object' && valores !== null) {
                            Object.entries(valores).forEach(([monthYear, valor]) => {
                                rows.push([pilar, indicador, monthYear, valor]);
                            });
                        }
                    });
                }
            });
            
            const csvContent = [headers, ...rows].map(row => 
                row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')
            ).join('\n');
            
            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `indicadores_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function getIndicatorValue(pilar, indicador) {
            if (!indicators[pilar]) return '';
            if (typeof indicators[pilar] !== 'object' || indicators[pilar] === null) return '';
            if (!indicators[pilar][indicador]) return '';
            
            const monthYearKey = `${selectedIndicatorYear}-${String(selectedIndicatorMonth).padStart(2, '0')}`;
            return indicators[pilar][indicador][monthYearKey] || '';
        }

        function getIndicatorHistory(pilar, indicador, months = 6) {
            if (!indicators[pilar] || !indicators[pilar][indicador]) return [];
            
            const history = [];
            for (let i = months - 1; i >= 0; i--) {
                const targetDate = new Date(selectedIndicatorYear, selectedIndicatorMonth - 1 - i, 1);
                const monthYearKey = `${targetDate.getFullYear()}-${String(targetDate.getMonth() + 1).padStart(2, '0')}`;
                const value = indicators[pilar][indicador][monthYearKey] || 0;
                history.push({
                    month: targetDate.getMonth() + 1,
                    year: targetDate.getFullYear(),
                    value: parseFloat(value) || 0,
                    label: ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'][targetDate.getMonth()]
                });
            }
            return history;
        }

        function getIndicatorYearSeries(pilar, indicador, year) {
            if (!indicators[pilar] || !indicators[pilar][indicador]) return [];
            const series = [];
            for (let m = 1; m <= 12; m++) {
                const monthYearKey = `${year}-${String(m).padStart(2, '0')}`;
                const value = parseFloat(indicators[pilar][indicador][monthYearKey] || 0) || 0;
                series.push({
                    month: m,
                    year,
                    value,
                    label: ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'][m - 1]
                });
            }
            return series;
        }
        function renderAnnualSparkline(history) {
            if (!history || history.length === 0) return '<p class="text-xs text-slate-400 italic">Sem dados</p>';
            const max = Math.max(...history.map(h => h.value), 1);
            const chartHeight = 50;
            const chartWidth = 12 * 16;
            const padding = { top: 6, right: 6, bottom: 6, left: 6 };
            const points = history.map((h, i) => {
                const x = padding.left + (i / 11) * (chartWidth - padding.left - padding.right);
                const y = chartHeight - padding.bottom - (h.value / max) * (chartHeight - padding.top - padding.bottom);
                return `${x},${y}`;
            }).join(' ');
            return `
                <svg width="${chartWidth}" height="${chartHeight}" class="w-full" style="max-width: 100%; height: auto;">
                    <polyline points="${points}" fill="none" stroke="#475569" stroke-width="2"/>
                </svg>
            `;
        }
        function calculateIndicatorInsights() {
            const insights = {
                trends: [],
                topPerformers: [],
                alerts: []
            };
            
            // Análise de tendências (últimos 3 meses)
            Object.entries(indicators).forEach(([pilar, indicadores]) => {
                if (typeof indicadores === 'object' && indicadores !== null) {
                    Object.keys(indicadores).forEach(indicador => {
                        const history = getIndicatorHistory(pilar, indicador, 3);
                        if (history.length >= 2) {
                            const latest = history[history.length - 1].value;
                            const previous = history[history.length - 2].value;
                            const change = previous !== 0 ? ((latest - previous) / previous) * 100 : 0;
                            
                            if (Math.abs(change) > 10) {
                                insights.trends.push({
                                    pilar,
                                    indicador,
                                    change,
                                    direction: change > 0 ? 'up' : 'down',
                                    current: latest,
                                    previous: previous
                                });
                            }
                        }
                    });
                }
            });
            
            return insights;
        }
        function renderIndicatorChart(history, maxValue = null) {
            if (!history || history.length === 0) return '<p class="text-sm text-slate-400 italic">Sem dados suficientes para gráfico</p>';
            
            // Filtrar valores inválidos e garantir que todos os valores sejam números válidos
            const validHistory = history.map(h => ({
                ...h,
                value: typeof h.value === 'number' && !isNaN(h.value) && isFinite(h.value) ? h.value : 0
            }));
            
            // Calcular max garantindo que seja pelo menos 1
            const values = validHistory.map(h => h.value);
            const calculatedMax = values.length > 0 ? Math.max(...values, 0) : 1;
            const max = maxValue && !isNaN(maxValue) && isFinite(maxValue) && maxValue > 0 
                ? maxValue 
                : (calculatedMax > 0 ? calculatedMax : 1);
            
            const chartHeight = 150;
            const chartWidth = Math.max(validHistory.length * 50, 200);
            const padding = { top: 10, right: 20, bottom: 30, left: 40 };
            let chartAreaWidth = chartWidth - padding.left - padding.right;
            let chartAreaHeight = chartHeight - padding.top - padding.bottom;
            
            // Garantir que temos dimensões válidas
            if (chartAreaWidth <= 0) chartAreaWidth = 100;
            if (chartAreaHeight <= 0) chartAreaHeight = 100;
            
            // Garantir que temos pelo menos um ponto válido
            if (validHistory.length === 0) return '<p class="text-sm text-slate-400 italic">Sem dados válidos para gráfico</p>';
            
            // Calcular pontos com tratamento para divisão por zero e valores inválidos
            const points = validHistory.map((h, i) => {
                // Para um único ponto, colocar no meio do gráfico
                // Para múltiplos pontos, distribuir uniformemente
                let x;
                if (validHistory.length === 1) {
                    x = padding.left + chartAreaWidth / 2;
                } else {
                    const divisor = validHistory.length - 1;
                    x = padding.left + (i / divisor) * chartAreaWidth;
                }
                
                // Normalizar o valor entre 0 e 1
                const normalizedValue = max > 0 ? Math.max(0, Math.min(1, h.value / max)) : 0;
                const y = chartHeight - padding.bottom - normalizedValue * chartAreaHeight;
                
                // Garantir que x e y são números válidos e finitos
                let validX = x;
                let validY = y;
                
                if (isNaN(x) || !isFinite(x)) {
                    validX = padding.left + (chartAreaWidth / 2);
                } else {
                    validX = Math.max(padding.left, Math.min(chartWidth - padding.right, x));
                }
                
                if (isNaN(y) || !isFinite(y)) {
                    validY = chartHeight - padding.bottom;
                } else {
                    validY = Math.max(padding.top, Math.min(chartHeight - padding.bottom, y));
                }
                
                return `${validX.toFixed(2)},${validY.toFixed(2)}`;
            }).join(' ');
            
            if (!points || points.trim() === '') {
                return '<p class="text-sm text-slate-400 italic">Erro ao gerar gráfico</p>';
            }
            
            const pathData = points;
            const firstX = padding.left;
            const lastX = padding.left + chartAreaWidth;
            const bottomY = chartHeight - padding.bottom;
            const gradientId = `gradient-${Math.random().toString(36).substr(2, 9)}`;
            
            return `
                <svg width="${chartWidth}" height="${chartHeight}" class="w-full" style="max-width: 100%; height: auto;">
                    <defs>
                        <linearGradient id="${gradientId}" x1="0%" y1="0%" x2="0%" y2="100%">
                            <stop offset="0%" style="stop-color:#3b82f6;stop-opacity:0.3" />
                            <stop offset="100%" style="stop-color:#3b82f6;stop-opacity:0" />
                        </linearGradient>
                    </defs>
                    <!-- Grid -->
                    ${[0, 0.25, 0.5, 0.75, 1].map(p => {
                        const y = bottomY - p * chartAreaHeight;
                        return `<line x1="${padding.left}" y1="${y}" x2="${chartWidth - padding.right}" y2="${y}" stroke="#e5e7eb" stroke-width="1" stroke-dasharray="2,2" />`;
                    }).join('')}
                    <!-- Area under curve -->
                    <path d="M ${pathData} L ${lastX},${bottomY} L ${firstX},${bottomY} Z" fill="url(#${gradientId})" />
                    <!-- Line -->
                    <path d="M ${pathData}" stroke="#3b82f6" stroke-width="2" fill="none" />
                    <!-- Points -->
                    ${validHistory.map((h, i) => {
                        let x;
                        if (validHistory.length === 1) {
                            x = padding.left + chartAreaWidth / 2;
                        } else {
                            const divisor = validHistory.length - 1;
                            x = padding.left + (i / divisor) * chartAreaWidth;
                        }
                        
                        const normalizedValue = max > 0 ? Math.max(0, Math.min(1, h.value / max)) : 0;
                        const y = bottomY - normalizedValue * chartAreaHeight;
                        
                        let validX = isNaN(x) || !isFinite(x) ? (padding.left + chartAreaWidth / 2) : Math.max(padding.left, Math.min(chartWidth - padding.right, x));
                        let validY = isNaN(y) || !isFinite(y) ? bottomY : Math.max(padding.top, Math.min(chartHeight - padding.bottom, y));
                        
                        return `<circle cx="${validX.toFixed(2)}" cy="${validY.toFixed(2)}" r="3" fill="#3b82f6" />`;
                    }).join('')}
                    <!-- Labels -->
                    ${validHistory.map((h, i) => {
                        let x;
                        if (validHistory.length === 1) {
                            x = padding.left + chartAreaWidth / 2;
                        } else {
                            const divisor = validHistory.length - 1;
                            x = padding.left + (i / divisor) * chartAreaWidth;
                        }
                        
                        const validX = isNaN(x) || !isFinite(x) ? (padding.left + chartAreaWidth / 2) : Math.max(padding.left, Math.min(chartWidth - padding.right, x));
                        return `<text x="${validX.toFixed(2)}" y="${chartHeight - 5}" text-anchor="middle" font-size="10" fill="#6b7280">${h.label || ''}</text>`;
                    }).join('')}
                </svg>
            `;
        }
        function renderIndicatorsPage() {
            const months = [
                { value: 1, label: 'Janeiro' }, { value: 2, label: 'Fevereiro' }, { value: 3, label: 'Março' },
                { value: 4, label: 'Abril' }, { value: 5, label: 'Maio' }, { value: 6, label: 'Junho' },
                { value: 7, label: 'Julho' }, { value: 8, label: 'Agosto' }, { value: 9, label: 'Setembro' },
                { value: 10, label: 'Outubro' }, { value: 11, label: 'Novembro' }, { value: 12, label: 'Dezembro' }
            ];
            
            const currentYear = new Date().getFullYear();
            const years = Array.from({ length: 5 }, (_, i) => currentYear - 2 + i);
            
            return `
                <header class="bg-white border-b border-slate-200 shadow-sm sticky top-0 z-40">
                    <div class="max-w-7xl mx-auto px-6 py-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <h1 class="text-3xl font-bold text-slate-900">Evolução de Indicadores</h1>
                                <p class="text-slate-600 mt-1 text-sm">Run the Bank - Alimentação mensal de métricas</p>
                            </div>
                            <nav class="flex items-center gap-2" aria-label="Navegação principal">
                                <button onclick="navigateTo('dashboard')" class="px-3 py-2 bg-indigo-500 hover:bg-indigo-600 text-white font-semibold rounded transition-colors text-sm" aria-label="Ir para Dashboard">
                                    <i class="fas fa-home mr-1" aria-hidden="true"></i> Dashboard
                                </button>
                                <input id="import-input-indicators" type="file" accept=".csv,.xlsx,.xls" class="hidden">
                                <input id="import-input-risks" type="file" accept=".csv,.xlsx,.xls" class="hidden" onchange="handleRiskImport(event)">
                                <button onclick="exportIndicatorsToCSV()" class="px-3 py-2 bg-slate-200 hover:bg-slate-300 text-slate-800 font-semibold rounded transition-colors text-sm" aria-label="Exportar Indicadores">
                                    <i class="fas fa-file-export mr-1" aria-hidden="true"></i> Exportar
                                </button>
                                <button onclick="document.getElementById('import-input-indicators').click()" class="px-3 py-2 bg-slate-200 hover:bg-slate-300 text-slate-800 font-semibold rounded transition-colors text-sm" aria-label="Importar Indicadores">
                                    <i class="fas fa-file-import mr-1" aria-hidden="true"></i> Importar
                                </button>
                                <button onclick="document.getElementById('import-input-risks').click()" class="px-3 py-2 bg-yellow-500 hover:bg-yellow-600 text-white font-semibold rounded transition-colors text-sm" aria-label="Importar Riscos">
                                    <i class="fas fa-exclamation-triangle mr-1" aria-hidden="true"></i> Importar Riscos
                                </button>
                            </nav>
                        </div>
                    </div>
                </header>

                <main class="max-w-7xl mx-auto px-6 py-8">
                    <div class="mb-6 flex items-center gap-4 flex-wrap">
                        <div class="flex items-center gap-2">
                            <label for="indicator-pillar" class="text-sm font-semibold text-slate-700">Pilar:</label>
                            <select id="indicator-pillar" onchange="updateIndicatorPillar(this.value)" class="px-3 py-2 border border-slate-300 rounded">
                                <option value="all" ${selectedIndicatorPillar === null ? 'selected' : ''}>📊 Visão Estratégica (Todos)</option>
                                ${Object.keys(indicators).filter(p => p !== 'defaultIndicators').map(pilar => `
                                    <option value="${pilar}" ${selectedIndicatorPillar === pilar ? 'selected' : ''}>${pilar}</option>
                                `).join('')}
                            </select>
                        </div>
                        <div class="flex items-center gap-2">
                            <label for="indicator-month" class="text-sm font-semibold text-slate-700">Mês:</label>
                            <select id="indicator-month" onchange="updateIndicatorMonth(this.value)" class="px-3 py-2 border border-slate-300 rounded">
                                ${months.map(m => `
                                    <option value="${m.value}" ${m.value === selectedIndicatorMonth ? 'selected' : ''}>${m.label}</option>
                                `).join('')}
                            </select>
                        </div>
                        <div class="flex items-center gap-2">
                            <label for="indicator-year" class="text-sm font-semibold text-slate-700">Ano:</label>
                            <select id="indicator-year" onchange="updateIndicatorYear(this.value)" class="px-3 py-2 border border-slate-300 rounded">
                                ${years.map(y => `
                                    <option value="${y}" ${y === selectedIndicatorYear ? 'selected' : ''}>${y}</option>
                                `).join('')}
                            </select>
                        </div>
                        <div class="ml-auto">
                            <p class="text-sm text-slate-600">Os valores são salvos automaticamente</p>
                        </div>
                    </div>

                    <!-- Dashboard Executivo -->
                    ${(() => {
                        const insights = calculateIndicatorInsights();
                        
                        // Calcular totais por categoria
                        const calculateTotals = () => {
                            const monthYearKey = `${selectedIndicatorYear}-${String(selectedIndicatorMonth).padStart(2, '0')}`;
                            let totalIncidents = 0, totalChanges = 0, totalAlerts = 0, totalAbends = 0;
                            
                            if (indicators['Gestão de Incidentes']) {
                                totalIncidents = getIndicatorValue('Gestão de Incidentes', 'Volume de Abertura de Incidentes Funcionais') || 0;
                            }
                            if (indicators['Gestão de Mudanças']) {
                                totalChanges = getIndicatorValue('Gestão de Mudanças', 'Volume de Mudanças Realizadas') || 0;
                            }
                            if (indicators['Gestão de Alertas']) {
                                totalAlerts = getIndicatorValue('Gestão de Alertas', 'Volume de Alertas Recebidos') || 0;
                            }
                            if (indicators['Gestão de Abends']) {
                                totalAbends = getIndicatorValue('Gestão de Abends', 'Volume de Abends Abertos') || 0;
                            }
                            
                            return { totalIncidents, totalChanges, totalAlerts, totalAbends };
                        };
                        
                        const totals = calculateTotals();
                        
                        return `
                            <div class="mb-8 space-y-6">
                                <!-- Cards de Resumo Executivo -->
                                <section class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                    <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg shadow-lg p-6 text-white">
                                        <div class="flex items-center justify-between mb-2">
                                            <i class="fas fa-exclamation-circle text-3xl opacity-80"></i>
                                            <span class="text-xs bg-white/20 px-2 py-1 rounded-full">Este mês</span>
                                        </div>
                                        <h3 class="text-2xl font-bold mb-1">${totals.totalIncidents}</h3>
                                        <p class="text-sm opacity-90">Incidentes Funcionais</p>
                                    </div>
                                    
                                    <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-lg shadow-lg p-6 text-white">
                                        <div class="flex items-center justify-between mb-2">
                                            <i class="fas fa-sync-alt text-3xl opacity-80"></i>
                                            <span class="text-xs bg-white/20 px-2 py-1 rounded-full">Este mês</span>
                                        </div>
                                        <h3 class="text-2xl font-bold mb-1">${totals.totalChanges}</h3>
                                        <p class="text-sm opacity-90">Mudanças Realizadas</p>
                                    </div>
                                    
                                    <div class="bg-gradient-to-br from-yellow-500 to-yellow-600 rounded-lg shadow-lg p-6 text-white">
                                        <div class="flex items-center justify-between mb-2">
                                            <i class="fas fa-bell text-3xl opacity-80"></i>
                                            <span class="text-xs bg-white/20 px-2 py-1 rounded-full">Este mês</span>
                                        </div>
                                        <h3 class="text-2xl font-bold mb-1">${totals.totalAlerts}</h3>
                                        <p class="text-sm opacity-90">Alertas Recebidos</p>
                                    </div>
                                    
                                    <div class="bg-gradient-to-br from-red-500 to-red-600 rounded-lg shadow-lg p-6 text-white">
                                        <div class="flex items-center justify-between mb-2">
                                            <i class="fas fa-bug text-3xl opacity-80"></i>
                                            <span class="text-xs bg-white/20 px-2 py-1 rounded-full">Este mês</span>
                                        </div>
                                        <h3 class="text-2xl font-bold mb-1">${totals.totalAbends}</h3>
                                        <p class="text-sm opacity-90">Abends Abertos</p>
                                    </div>
                                </section>
                                <!-- Insights de Tendências -->
                                ${insights.trends.length > 0 ? `
                                    <section class="bg-white rounded-lg shadow-md p-6 border-2 border-blue-200">
                                        <div class="flex items-center gap-3 mb-4">
                                            <i class="fas fa-chart-line text-blue-600 text-2xl"></i>
                                            <h2 class="text-xl font-bold text-slate-900">Insights de Tendências</h2>
                                        </div>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            ${insights.trends.slice(0, 4).map(trend => {
                                                const color = trend.direction === 'up' ? 'text-green-600' : 'text-red-600';
                                                const icon = trend.direction === 'up' ? 'fa-arrow-up' : 'fa-arrow-down';
                                                return `
                                                    <div class="border border-slate-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                                                        <div class="flex items-center justify-between mb-2">
                                                            <span class="text-sm font-semibold text-slate-700">${trend.pilar}</span>
                                                            <i class="fas ${icon} ${color}"></i>
                                                        </div>
                                                        <h4 class="text-sm text-slate-600 mb-2">${trend.indicador}</h4>
                                                        <div class="flex items-baseline gap-2">
                                                            <span class="text-2xl font-bold ${color}">${Math.abs(trend.change).toFixed(1)}%</span>
                                                            <span class="text-xs text-slate-500">${trend.direction === 'up' ? 'aumento' : 'redução'}</span>
                                                        </div>
                                                    </div>
                                                `;
                                            }).join('')}
                                        </div>
                                    </section>
                                ` : ''}
                            </div>
                        `;
                    })()}

                    <!-- Visão Anual Consolidada -->
                    ${(() => {
                        const scopeAllPillars = selectedIndicatorPillar === null;
                        const selectedPilar = selectedIndicatorPillar;
                        const targetYear = selectedIndicatorYear;
                        const dataset = [];
                        Object.entries(indicators).forEach(([pilar, indicadores]) => {
                            if (pilar === 'defaultIndicators') return;
                            if (!scopeAllPillars && pilar !== selectedPilar) return;
                            if (typeof indicadores === 'object' && indicadores !== null) {
                                Object.keys(indicadores).forEach(indicador => {
                                    const series = getIndicatorYearSeries(pilar, indicador, targetYear);
                                    if (series.length === 12) {
                                        const values = series.map(s => s.value);
                                        const total = values.reduce((a, b) => a + b, 0);
                                        const avg = total / 12;
                                        const maxVal = Math.max(...values);
                                        const maxIdx = values.indexOf(maxVal);
                                        dataset.push({ pilar, indicador, total, avg, maxVal, maxMonthLabel: series[maxIdx].label, series });
                                    }
                                });
                            }
                        });

                        if (dataset.length === 0) {
                            return '';
                        }

                        const ranked = [...dataset].sort((a, b) => b.total - a.total);
                        const top5 = ranked.slice(0, 5);

                        return `
                            <section class="mt-8">
                                <div class="flex items-center justify-between mb-4">
                                    <div class="flex items-center gap-3">
                                        <i class="fas fa-calendar text-slate-600 text-xl"></i>
                                        <h2 class="text-xl font-bold text-slate-900">Visão Anual Consolidada (${targetYear}) ${scopeAllPillars ? '' : `• ${selectedPilar}`}</h2>
                                    </div>
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
                                    ${top5.map(item => `
                                        <div class="bg-white border-2 border-red-200 rounded-lg p-4 shadow-sm">
                                            <div class="text-xs text-slate-600 mb-1">${item.pilar}</div>
                                            <div class="font-semibold text-slate-900 mb-2" title="${item.indicador}">${item.indicador}</div>
                                            <div class="text-2xl font-bold text-red-600">${Math.round(item.total)}</div>
                                            <div class="text-xs text-slate-500">Pico: ${item.maxVal} em ${item.maxMonthLabel}</div>
                                        </div>
                                    `).join('')}
                                </div>

                                <div class="bg-white rounded-lg shadow-md border-2 border-slate-200 p-4 overflow-x-auto">
                                    <table class="w-full text-sm">
                                        <thead>
                                            <tr class="border-b border-slate-200">
                                                <th class="text-left py-3 px-4 font-semibold text-slate-700">Pilar</th>
                                                <th class="text-left py-3 px-4 font-semibold text-slate-700">Indicador</th>
                                                <th class="text-right py-3 px-4 font-semibold text-slate-700">Total (${targetYear})</th>
                                                <th class="text-right py-3 px-4 font-semibold text-slate-700">Média Mensal</th>
                                                <th class="text-center py-3 px-4 font-semibold text-slate-700">Evolução (12 meses)</th>
                                                <th class="text-right py-3 px-4 font-semibold text-slate-700">Pico</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${ranked.map(item => `
                                                <tr class="border-b border-slate-100 hover:bg-slate-50">
                                                    <td class="py-3 px-4 text-slate-800">${item.pilar}</td>
                                                    <td class="py-3 px-4 text-slate-800">${item.indicador}</td>
                                                    <td class="py-3 px-4 text-right font-semibold text-slate-900">${item.total.toFixed(0)}</td>
                                                    <td class="py-3 px-4 text-right text-slate-800">${item.avg.toFixed(1)}</td>
                                                    <td class="py-3 px-4">
                                                        <div style="width: 100%; max-width: 260px; margin: 0 auto;">
                                                            ${renderAnnualSparkline(item.series)}
                                                        </div>
                                                    </td>
                                                    <td class="py-3 px-4 text-right text-slate-800">${item.maxVal} (${item.maxMonthLabel})</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </section>
                        `;
                    })()}
                    <!-- Renderização baseada no pilar selecionado -->
                    ${selectedIndicatorPillar === null ? 
                        // VISÃO ESTRATÉGICA - Lista todos os pilares como cards compactos
                        `
                        <div class="grid grid-cols-1 gap-4">
                            ${Object.entries(indicators).filter(([pilar]) => pilar !== 'defaultIndicators').map(([pilar, indicadores]) => {
                                if (typeof indicadores !== 'object' || indicadores === null || Array.isArray(indicadores)) {
                                    return '';
                                }
                                
                                const indicadorKeys = Object.keys(indicadores);
                                if (indicadorKeys.length === 0) return '';
                                
                                // Calcular totais e estatísticas do pilar
                                let totalValue = 0;
                                let filledCount = 0;
                                indicadorKeys.forEach(indicador => {
                                    const value = getIndicatorValue(pilar, indicador);
                                    if (value && value > 0) {
                                        totalValue += parseFloat(value);
                                        filledCount++;
                                    }
                                });
                                
                                return `
                                    <div class="bg-white rounded-lg shadow-md border-2 border-slate-200 p-6 hover:border-blue-400 transition-colors cursor-pointer" onclick="updateIndicatorPillar('${pilar.replace(/'/g, "\\'")}')">
                                        <div class="flex items-center justify-between">
                                            <div class="flex-1">
                                                <h3 class="text-xl font-bold text-slate-900 mb-2">${pilar}</h3>
                                                <p class="text-sm text-slate-600">${indicadorKeys.length} indicador${indicadorKeys.length !== 1 ? 'es' : ''} • ${filledCount} preenchidos</p>
                                            </div>
                                            <div class="text-right">
                                                <div class="text-2xl font-bold text-blue-600">${filledCount > 0 ? Math.round((filledCount / indicadorKeys.length) * 100) : 0}%</div>
                                                <p class="text-xs text-slate-500">completude</p>
                                            </div>
                                            <button class="ml-4 px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white font-semibold rounded transition-colors">
                                                <i class="fas fa-arrow-right mr-1"></i> Editar
                                            </button>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        ` 
                        : 
                        // VISÃO DE PILAR ÚNICO - Mostra tabela detalhada
                        (() => {
                            const pilar = selectedIndicatorPillar;
                            const indicadores = indicators[pilar];
                            
                            if (typeof indicadores !== 'object' || indicadores === null || Array.isArray(indicadores)) {
                                return '<div class="bg-white rounded-lg shadow-md border-2 border-slate-200 p-6"><p class="text-slate-500 italic">Este pilar não possui indicadores específicos configurados.</p></div>';
                            }
                            
                            const indicadorKeys = Object.keys(indicadores);
                            if (indicadorKeys.length === 0) {
                                return '<div class="bg-white rounded-lg shadow-md border-2 border-slate-200 p-6"><p class="text-slate-500 italic">Nenhum indicador cadastrado para este pilar.</p></div>';
                            }
                            
                            return `
                                <div class="bg-white rounded-lg shadow-md border-2 border-blue-400 p-6">
                                    <div class="flex items-center justify-between mb-6">
                                        <h2 class="text-2xl font-bold text-slate-900">${pilar}</h2>
                                        <button onclick="updateIndicatorPillar('all')" class="px-4 py-2 bg-slate-200 hover:bg-slate-300 text-slate-800 font-semibold rounded transition-colors">
                                            <i class="fas fa-arrow-left mr-1"></i> Voltar
                                        </button>
                                    </div>
                                    <div class="overflow-x-auto">
                                        <table class="w-full">
                                            <thead>
                                                <tr class="border-b border-slate-200">
                                                    <th class="text-left py-3 px-4 font-semibold text-slate-700">Indicador</th>
                                                    <th class="text-right py-3 px-4 font-semibold text-slate-700">Valor (${months.find(m => m.value === selectedIndicatorMonth)?.label || selectedIndicatorMonth}/${selectedIndicatorYear})</th>
                                                    <th class="text-center py-3 px-4 font-semibold text-slate-700">Evolução (6 meses)</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${indicadorKeys.map(indicador => {
                                                    const currentValue = getIndicatorValue(pilar, indicador);
                                                    const history = getIndicatorHistory(pilar, indicador, 6);
                                                    return `
                                                        <tr class="border-b border-slate-100 hover:bg-slate-50">
                                                            <td class="py-3 px-4 text-slate-800">${indicador}</td>
                                                            <td class="py-3 px-4">
                                                                <input type="number" 
                                                                       step="0.01" 
                                                                       value="${currentValue}" 
                                                                       onchange="updateIndicatorValue('${pilar}', '${indicador}', this.value)"
                                                                       placeholder="0.00"
                                                                       class="w-full max-w-xs ml-auto text-right border border-slate-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                                            </td>
                                                            <td class="py-3 px-4">
                                                                <div style="width: 100%; max-width: 300px; margin: 0 auto;">
                                                                    ${renderIndicatorChart(history)}
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    `;
                                                }).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            `;
                        })()
                    }
                    
                    <div class="mt-8 bg-blue-50 border border-blue-200 rounded-lg p-6">
                        <div class="flex items-start gap-3">
                            <i class="fas fa-info-circle text-blue-500 text-xl mt-1" aria-hidden="true"></i>
                            <div>
                                <h3 class="font-semibold text-blue-900 mb-2">Como funciona:</h3>
                                <ul class="text-sm text-blue-800 space-y-1">
                                    <li>• <strong>Visão Estratégica:</strong> Veja todos os pilares e a completude de cada um</li>
                                    <li>• <strong>Pilar específico:</strong> Selecione um pilar para preencher os dados mensais</li>
                                    <li>• Os valores são salvos automaticamente ao alterar</li>
                                    <li>• OKRs relacionados são atualizados automaticamente quando você preenche um indicador</li>
                                    <li>• A variação MoM (Mês a Mês) é calculada automaticamente comparando com o mês anterior</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </main>
            `;
        }

        // ========== PÁGINA DE PROJETOS E QUICKS WINS ==========
        
        // Função para gerar timeline de meses baseado nas datas do projeto
        function generateTimelineMonths(startDate, endDate) {
            const months = [];
            const start = new Date(startDate);
            const end = new Date(endDate);
            
            // Normalizar para o primeiro dia do mês
            start.setDate(1);
            end.setDate(1);
            
            const current = new Date(start);
            while (current <= end) {
                months.push({
                    year: current.getFullYear(),
                    month: current.getMonth(),
                    label: current.toLocaleDateString('pt-BR', { month: 'short', year: 'numeric' })
                });
                current.setMonth(current.getMonth() + 1);
            }
            
            return months;
        }
        
        // Função para calcular posição e largura de uma tarefa na timeline
        function calculateTaskPosition(task, timelineMonths, projectStartDate) {
            if (!task.startDate || !task.endDate) return null;
            
            const taskStart = new Date(task.startDate);
            const taskEnd = new Date(task.endDate);
            const projectStart = new Date(projectStartDate);
            
            // Encontrar índices dos meses na timeline
            let startIndex = -1;
            let endIndex = -1;
            
            timelineMonths.forEach((month, index) => {
                const monthStart = new Date(month.year, month.month, 1);
                const monthEnd = new Date(month.year, month.month + 1, 0);
                
                if (startIndex === -1 && taskStart <= monthEnd) {
                    startIndex = index;
                }
                if (taskEnd >= monthStart) {
                    endIndex = index;
                }
            });
            
            if (startIndex === -1 || endIndex === -1) return null;
            
            // Calcular posição e largura em porcentagem
            const totalMonths = timelineMonths.length;
            const leftPercent = (startIndex / totalMonths) * 100;
            const widthPercent = ((endIndex - startIndex + 1) / totalMonths) * 100;
            
            return {
                left: leftPercent,
                width: widthPercent,
                startIndex,
                endIndex
            };
        }
        
        // Função para determinar cor do status da tarefa
        function getTaskStatusColor(task) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            if (task.status === 'completed') {
                return { bg: 'bg-blue-500', text: 'text-blue-700', border: 'border-blue-600' }; // Azul - Concluído
            } else if (task.status === 'in-progress') {
                return { bg: 'bg-green-500', text: 'text-green-700', border: 'border-green-600' }; // Verde - Em andamento
            } else if (task.status === 'blocked') {
                return { bg: 'bg-red-500', text: 'text-red-700', border: 'border-red-600' }; // Vermelho - Bloqueado
            } else {
                // Não iniciado - verificar se está atrasado
                if (task.startDate) {
                    const startDate = new Date(task.startDate);
                    startDate.setHours(0, 0, 0, 0);
                    if (today > startDate) {
                        return { bg: 'bg-red-500', text: 'text-red-700', border: 'border-red-600' }; // Vermelho - Atrasado
                    }
                }
                return { bg: 'bg-gray-400', text: 'text-gray-700', border: 'border-gray-500' }; // Cinza - Não iniciado
            }
        }
        
        // Funções de filtro para projetos
        function toggleProjectFilters() {
            projectFiltersExpanded = !projectFiltersExpanded;
            render();
        }
        
        function updateProjectFilterType(type) {
            const idx = projectFilters.type.indexOf(type);
            if (idx > -1) {
                projectFilters.type.splice(idx, 1);
            } else {
                projectFilters.type.push(type);
            }
            render();
        }
        
        function updateProjectFilterStatus(status) {
            const idx = projectFilters.status.indexOf(status);
            if (idx > -1) {
                projectFilters.status.splice(idx, 1);
            } else {
                projectFilters.status.push(status);
            }
            render();
        }
        function updateProjectFilterOwner(owner) {
            const idx = projectFilters.owner.indexOf(owner);
            if (idx > -1) {
                projectFilters.owner.splice(idx, 1);
            } else {
                projectFilters.owner.push(owner);
            }
            render();
        }
        
        // Arrays temporários para filtros
        let sortedOwners = [];
        let sortedSponsors = [];
        
        function updateProjectFilterOwnerByIndex(index) {
            const owner = sortedOwners[index];
            if (owner) updateProjectFilterOwner(owner);
        }
        
        function updateProjectFilterSponsor(sponsor) {
            const idx = projectFilters.sponsor.indexOf(sponsor);
            if (idx > -1) {
                projectFilters.sponsor.splice(idx, 1);
            } else {
                projectFilters.sponsor.push(sponsor);
            }
            render();
        }
        
        function updateProjectFilterSponsorByIndex(index) {
            const sponsor = sortedSponsors[index];
            if (sponsor) updateProjectFilterSponsor(sponsor);
        }
        
        function clearProjectFilters() {
            projectFilters = {
                type: [],
                searchTitle: '',
                owner: [],
                sponsor: [],
                minProgress: null,
                maxProgress: null,
                status: []
            };
            render();
        }
        function getFilteredProjects() {
            return projects.filter(project => {
                // Filtro por tipo
                if (projectFilters.type.length > 0 && !projectFilters.type.includes(project.type)) {
                    return false;
                }
                
                // Filtro por título
                if (projectFilters.searchTitle && !project.title.toLowerCase().includes(projectFilters.searchTitle.toLowerCase())) {
                    return false;
                }
                
                // Filtro por Owner
                if (projectFilters.owner.length > 0 && (!project.owner || !projectFilters.owner.includes(project.owner))) {
                    return false;
                }
                
                // Filtro por Sponsor
                if (projectFilters.sponsor.length > 0 && (!project.sponsor || !projectFilters.sponsor.includes(project.sponsor))) {
                    return false;
                }
                
                // Calcular progresso e status do projeto
                const tasksCompleted = project.tasks ? project.tasks.filter(t => t.status === 'completed').length : 0;
                const tasksTotal = project.tasks ? project.tasks.length : 0;
                const progress = tasksTotal > 0 ? (tasksCompleted / tasksTotal) * 100 : 0;
                
                // Filtro por progresso mínimo
                if (projectFilters.minProgress !== null && progress < projectFilters.minProgress) {
                    return false;
                }
                
                // Filtro por progresso máximo
                if (projectFilters.maxProgress !== null && progress > projectFilters.maxProgress) {
                    return false;
                }
                
                // Filtro por status
                if (projectFilters.status.length > 0) {
                    const today = new Date();
                    const endDate = new Date(project.endDate);
                    const startDate = new Date(project.startDate);
                    const isOverdue = endDate < today && progress < 100;
                    const isCompleted = progress >= 100;
                    const isUpcoming = startDate > today;
                    const isActive = !isUpcoming && !isCompleted && !isOverdue;
                    
                    let projectStatus = '';
                    if (isCompleted) projectStatus = 'completed';
                    else if (isOverdue) projectStatus = 'overdue';
                    else if (isUpcoming) projectStatus = 'upcoming';
                    else projectStatus = 'active';
                    
                    if (!projectFilters.status.includes(projectStatus)) {
                        return false;
                    }
                }
                
                return true;
            });
        }
        function renderProjectsPage() {
            return `
                ${creatingNewProject ? renderNewProjectModal() : ''}
                ${editingProjectId ? renderEditProjectModal() : ''}
                ${showingTasksModal ? renderTasksModal() : ''}
                <header class="bg-white border-b border-slate-200 shadow-sm sticky top-0 z-40">
                    <div class="max-w-7xl mx-auto px-6 py-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <h1 class="text-3xl font-bold text-slate-900">Projetos e Quicks Wins</h1>
                                <p class="text-slate-600 mt-1 text-sm">Gestão de entregas e melhoria contínua</p>
                            </div>
                            <nav class="flex items-center gap-2" aria-label="Navegação principal">
                                <button onclick="navigateTo('dashboard')" class="px-3 py-2 bg-indigo-500 hover:bg-indigo-600 text-white font-semibold rounded transition-colors text-sm" aria-label="Ir para Dashboard">
                                    <i class="fas fa-home mr-1" aria-hidden="true"></i> Dashboard
                                </button>
                                <button onclick="openNewProjectModal()" class="px-3 py-2 bg-green-500 hover:bg-green-600 text-white font-semibold rounded transition-colors text-sm" aria-label="Novo Projeto">
                                    <i class="fas fa-plus mr-1" aria-hidden="true"></i> Novo Projeto
                                </button>
                            </nav>
                        </div>
                    </div>
                </header>

                <main class="max-w-7xl mx-auto px-6 py-8">
                    ${projects.length === 0 ? `
                        <div class="bg-white rounded-lg shadow-md p-12 text-center border-2 border-blue-200">
                            <i class="fas fa-project-diagram text-6xl text-blue-400 mb-4" aria-hidden="true"></i>
                            <h2 class="text-2xl font-bold text-slate-900 mb-2">Gerencie seus Projetos e Quicks Wins</h2>
                            <p class="text-slate-600 mb-6">Comece criando seu primeiro projeto ou quick win para rastrear entregas e métricas.</p>
                            <button onclick="openNewProjectModal()" class="px-6 py-3 bg-blue-500 hover:bg-blue-600 text-white font-semibold rounded-lg transition-colors">
                                <i class="fas fa-plus mr-2" aria-hidden="true"></i> Criar Primeiro Projeto
                            </button>
                        </div>
                    ` : `
                        <!-- Filtros -->
                        <div class="mb-6">
                            <div class="flex items-center justify-between mb-4">
                                <button onclick="toggleProjectFilters()" class="px-4 py-2 bg-slate-200 hover:bg-slate-300 text-slate-700 font-semibold rounded transition-colors text-sm">
                                    <i class="fas fa-filter mr-2"></i> Filtros ${Object.values(projectFilters).some(v => (Array.isArray(v) && v.length > 0) || (typeof v === 'string' && v) || (typeof v === 'number' && v !== null)) ? '(Ativos)' : ''}
                                </button>
                            </div>
                            ${projectFiltersExpanded ? `
                                <div class="bg-white rounded-lg shadow-md p-6 border-2 border-slate-200 filter-panel mb-4">
                                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                                        <div>
                                            <label class="block text-sm font-semibold text-slate-700 mb-2">Buscar por Título</label>
                                            <input type="text" placeholder="Digite o título..." value="${projectFilters.searchTitle}" onchange="projectFilters.searchTitle = this.value; render()" class="w-full">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-semibold text-slate-700 mb-2">Progresso Mínimo (%)</label>
                                            <input type="number" min="0" max="100" placeholder="0" value="${projectFilters.minProgress || ''}" onchange="projectFilters.minProgress = this.value ? parseInt(this.value) : null; render()" class="w-full">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-semibold text-slate-700 mb-2">Progresso Máximo (%)</label>
                                            <input type="number" min="0" max="100" placeholder="100" value="${projectFilters.maxProgress || ''}" onchange="projectFilters.maxProgress = this.value ? parseInt(this.value) : null; render()" class="w-full">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-semibold text-slate-700 mb-3">Tipo</label>
                                            <div class="space-y-2">
                                                <label class="flex items-center gap-2 cursor-pointer">
                                                    <input type="checkbox" ${projectFilters.type.includes('project') ? 'checked' : ''} onchange="updateProjectFilterType('project')" class="w-4 h-4">
                                                    <span class="text-sm text-slate-700">Projeto</span>
                                                </label>
                                                <label class="flex items-center gap-2 cursor-pointer">
                                                    <input type="checkbox" ${projectFilters.type.includes('quick-win') ? 'checked' : ''} onchange="updateProjectFilterType('quick-win')" class="w-4 h-4">
                                                    <span class="text-sm text-slate-700">Quick Win</span>
                                                </label>
                                            </div>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-semibold text-slate-700 mb-3">Status</label>
                                            <div class="space-y-2">
                                                <label class="flex items-center gap-2 cursor-pointer">
                                                    <input type="checkbox" ${projectFilters.status.includes('active') ? 'checked' : ''} onchange="updateProjectFilterStatus('active')" class="w-4 h-4">
                                                    <span class="text-sm text-slate-700">Em Andamento</span>
                                                </label>
                                                <label class="flex items-center gap-2 cursor-pointer">
                                                    <input type="checkbox" ${projectFilters.status.includes('completed') ? 'checked' : ''} onchange="updateProjectFilterStatus('completed')" class="w-4 h-4">
                                                    <span class="text-sm text-slate-700">Concluído</span>
                                                </label>
                                                <label class="flex items-center gap-2 cursor-pointer">
                                                    <input type="checkbox" ${projectFilters.status.includes('overdue') ? 'checked' : ''} onchange="updateProjectFilterStatus('overdue')" class="w-4 h-4">
                                                    <span class="text-sm text-slate-700">Atrasado</span>
                                                </label>
                                                <label class="flex items-center gap-2 cursor-pointer">
                                                    <input type="checkbox" ${projectFilters.status.includes('upcoming') ? 'checked' : ''} onchange="updateProjectFilterStatus('upcoming')" class="w-4 h-4">
                                                    <span class="text-sm text-slate-700">Futuro</span>
                                                </label>
                                            </div>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-semibold text-slate-700 mb-3">Owner</label>
                                            <div class="space-y-2 max-h-40 overflow-y-auto">
                                                ${(() => {
                                                    sortedOwners = [...new Set(projects.map(p => p.owner).filter(Boolean))].sort();
                                                    return sortedOwners.map((owner, idx) => `
                                                        <label class="flex items-center gap-2 cursor-pointer">
                                                            <input type="checkbox" ${projectFilters.owner.includes(owner) ? 'checked' : ''} onchange="updateProjectFilterOwnerByIndex(${idx})" class="w-4 h-4">
                                                            <span class="text-sm text-slate-700">${owner}</span>
                                                        </label>
                                                    `).join('');
                                                })()}
                                                ${[...new Set(projects.map(p => p.owner).filter(Boolean))].length === 0 ? '<p class="text-xs text-slate-500 italic">Nenhum owner cadastrado</p>' : ''}
                                            </div>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-semibold text-slate-700 mb-3">Sponsor</label>
                                            <div class="space-y-2 max-h-40 overflow-y-auto">
                                                ${(() => {
                                                    sortedSponsors = [...new Set(projects.map(p => p.sponsor).filter(Boolean))].sort();
                                                    return sortedSponsors.map((sponsor, idx) => `
                                                        <label class="flex items-center gap-2 cursor-pointer">
                                                            <input type="checkbox" ${projectFilters.sponsor.includes(sponsor) ? 'checked' : ''} onchange="updateProjectFilterSponsorByIndex(${idx})" class="w-4 h-4">
                                                            <span class="text-sm text-slate-700">${sponsor}</span>
                                                        </label>
                                                    `).join('');
                                                })()}
                                                ${[...new Set(projects.map(p => p.sponsor).filter(Boolean))].length === 0 ? '<p class="text-xs text-slate-500 italic">Nenhum sponsor cadastrado</p>' : ''}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="flex gap-3 mt-6 pt-6 border-t border-slate-200">
                                        <button onclick="clearProjectFilters()" class="px-4 py-2 bg-slate-300 hover:bg-slate-400 text-slate-700 font-semibold rounded transition-colors text-sm">
                                            <i class="fas fa-times mr-2"></i> Limpar Filtros
                                        </button>
                                        <span class="text-sm text-slate-600 self-center">
                                            ${getFilteredProjects().length} de ${projects.length} projeto(s) exibido(s)
                                        </span>
                                    </div>
                                </div>
                            ` : ''}
                        <div class="grid grid-cols-1 gap-6">
                            ${getFilteredProjects().map(project => {
                                const tasksCompleted = project.tasks ? project.tasks.filter(t => t.status === 'completed').length : 0;
                                const tasksTotal = project.tasks ? project.tasks.length : 0;
                                const progress = tasksTotal > 0 ? (tasksCompleted / tasksTotal) * 100 : 0;
                                
                                const today = new Date();
                                const endDate = new Date(project.endDate);
                                const isOverdue = endDate < today && progress < 100;
                                
                                // Calcular velocidade (tasks por semana)
                                const weeksElapsed = Math.max(1, Math.ceil((today - new Date(project.startDate)) / (1000 * 60 * 60 * 24 * 7)));
                                const velocity = tasksCompleted / weeksElapsed;
                                const remainingTasks = tasksTotal - tasksCompleted;
                                const estimatedWeeksRemaining = remainingTasks / velocity;
                                
                                const statusColor = isOverdue ? 'bg-red-100 text-red-800' : 
                                                   progress >= 90 ? 'bg-green-100 text-green-800' :
                                                   progress >= 50 ? 'bg-yellow-100 text-yellow-800' : 'bg-blue-100 text-blue-800';
                                
                                // Gerar timeline de meses
                                const timelineMonths = generateTimelineMonths(project.startDate, project.endDate);
                                
                                return `
                                    <div class="bg-white rounded-lg shadow-md border-2 border-slate-200 overflow-hidden project-card">
                                        <div class="flex flex-col lg:flex-row">
                                            <!-- Card Vertical à Esquerda -->
                                            <div class="w-full lg:w-80 p-6 border-b lg:border-b-0 lg:border-r border-slate-200 bg-gradient-to-br from-slate-50 to-white">
                                        <div class="flex items-start justify-between mb-4">
                                            <div class="flex-1">
                                                <h3 class="text-xl font-bold text-slate-900 mb-2">${project.title}</h3>
                                                        <span class="inline-block px-2 py-1 rounded text-xs font-semibold ${project.type === 'quick-win' ? 'bg-purple-100 text-purple-800' : 'bg-blue-100 text-blue-800'} mb-2">
                                                            ${project.type === 'quick-win' ? 'Quick Win' : 'Projeto'}
                                                        </span>
                                                </div>
                                            <div class="project-card-actions flex items-center gap-2">
                                                        <button onclick="openEditProject('${project.id}')" class="px-2 py-1 bg-blue-500 hover:bg-blue-600 text-white text-xs font-semibold rounded transition-colors" aria-label="Editar Projeto" title="Editar Projeto">
                                                    <i class="fas fa-edit" aria-hidden="true"></i>
                                                </button>
                                                        <button onclick="deleteProject('${project.id}')" class="px-2 py-1 bg-red-500 hover:bg-red-600 text-white text-xs font-semibold rounded transition-colors" aria-label="Deletar Projeto" title="Excluir Projeto">
                                                    <i class="fas fa-trash" aria-hidden="true"></i>
                                                </button>
                                            </div>
                                        </div>
                                        
                                                <div class="mb-4">
                                                    <p class="text-sm font-semibold text-slate-700 mb-1">Descrição</p>
                                                    <p class="text-sm text-slate-600">${project.description || 'Sem descrição'}</p>
                                                </div>
                                                
                                                ${project.owner || project.sponsor ? `
                                                    <div class="mb-4">
                                                        ${project.owner ? `
                                                            <p class="text-sm font-semibold text-slate-700 mb-1">Owner</p>
                                                            <p class="text-sm text-slate-600"><i class="fas fa-user-tie mr-1 text-blue-600"></i>${project.owner}</p>
                                                        ` : ''}
                                                        ${project.sponsor ? `
                                                            <p class="text-sm font-semibold text-slate-700 mb-1 mt-2">Sponsor</p>
                                                            <p class="text-sm text-slate-600"><i class="fas fa-handshake mr-1 text-green-600"></i>${project.sponsor}</p>
                                                        ` : ''}
                                                    </div>
                                                ` : ''}
                                                
                                                ${project.acronyms && project.acronyms.length > 0 ? `
                                                    <div class="mb-4">
                                                        <p class="text-sm font-semibold text-slate-700 mb-2">Siglas</p>
                                                        <div class="flex flex-wrap gap-1">
                                                            ${project.acronyms.map(acronym => `
                                                                <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs font-semibold">${acronym}</span>
                                                            `).join('')}
                                                        </div>
                                                    </div>
                                                ` : ''}
                                                
                                                <div class="mb-4">
                                                    <p class="text-sm font-semibold text-slate-700 mb-1">Serviço Afetado</p>
                                                    <p class="text-sm text-slate-600">${project.affectedServices || 'Não especificado'}</p>
                                                </div>
                                        
                                        <div class="mb-4">
                                            <div class="flex items-center justify-between mb-2">
                                                <span class="text-sm font-semibold text-slate-700">Progresso</span>
                                                        <span class="text-sm font-bold text-slate-900">${Math.round(progress)}%</span>
                                            </div>
                                                    <div class="w-full h-2 bg-slate-200 rounded-full overflow-hidden">
                                                <div class="h-full bg-blue-500 rounded-full transition-all" style="width: ${Math.min(progress, 100)}%"></div>
                                            </div>
                                                    <p class="text-xs text-slate-500 mt-1">${tasksCompleted}/${tasksTotal} tarefas concluídas</p>
                                        </div>
                                        
                                                <div class="mb-4">
                                                    <p class="text-sm font-semibold text-slate-700 mb-2">Período</p>
                                                    <div class="text-xs text-slate-600 space-y-1">
                                                        <p><i class="fas fa-calendar-alt mr-1"></i> Início: ${new Date(project.startDate).toLocaleDateString('pt-BR')}</p>
                                                        <p><i class="fas fa-flag-checkered mr-1"></i> Fim: ${new Date(project.endDate).toLocaleDateString('pt-BR')}</p>
                                            </div>
                                            </div>
                                                
                                                <div class="pt-4 border-t border-slate-200">
                                                    <button onclick="openTasksModal('${project.id}')" class="w-full px-4 py-2 bg-green-500 hover:bg-green-600 text-white text-sm font-semibold rounded transition-colors" aria-label="Gerenciar Tarefas">
                                                        <i class="fas fa-tasks mr-2" aria-hidden="true"></i> Gerenciar Tarefas
                                                    </button>
                                            </div>
                                            </div>
                                            
                                            <!-- Timeline Horizontal à Direita -->
                                            <div class="flex-1 p-6 overflow-x-auto">
                                                <h4 class="text-lg font-semibold text-slate-800 mb-4">Timeline do Projeto</h4>
                                                
                                                ${timelineMonths.length > 0 ? `
                                                    <div class="relative" style="min-width: ${timelineMonths.length * 120}px;">
                                                        <!-- Cabeçalho da Timeline -->
                                                        <div class="flex border-b-2 border-slate-300 mb-4">
                                                            ${timelineMonths.map(month => `
                                                                <div class="flex-shrink-0 text-center border-r border-slate-200" style="width: 120px;">
                                                                    <div class="text-xs font-semibold text-slate-700 py-2">${month.label}</div>
                                                                </div>
                                                            `).join('')}
                                        </div>
                                        
                                                        <!-- Linha de Tarefas -->
                                                        <div class="relative" style="min-height: ${Math.max(project.tasks ? project.tasks.length * 50 : 50, 100)}px;">
                                                            ${project.tasks && project.tasks.length > 0 ? project.tasks.map((task, taskIndex) => {
                                                                const taskPos = calculateTaskPosition(task, timelineMonths, project.startDate);
                                                                const taskColor = getTaskStatusColor(task);
                                                                
                                                                if (!taskPos) {
                                                                    return `
                                                                        <div class="mb-2 p-2 bg-slate-100 rounded text-xs text-slate-500 flex items-center justify-between group">
                                                                            <span>${task.title} (sem datas definidas)</span>
                                                                            <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                                                                <button onclick="event.stopPropagation(); openEditTaskModal('${project.id}', ${taskIndex})" class="p-1 hover:bg-slate-200 rounded transition-colors" title="Editar tarefa">
                                                                                    <i class="fas fa-edit text-xs text-slate-600"></i>
                                                                                </button>
                                                                                <button onclick="event.stopPropagation(); deleteTask('${project.id}', ${taskIndex})" class="p-1 hover:bg-slate-200 rounded transition-colors" title="Excluir tarefa">
                                                                                    <i class="fas fa-trash text-xs text-slate-600"></i>
                                                                                </button>
                                                                            </div>
                                                                        </div>
                                                                    `;
                                                                }
                                                                
                                                        return `
                                                                    <div class="absolute mb-2 group" style="top: ${taskIndex * 50}px; left: ${taskPos.left}%; width: ${taskPos.width}%;">
                                                                        <div class="h-8 ${taskColor.bg} ${taskColor.border} border-2 rounded px-2 flex items-center justify-between shadow-sm hover:shadow-md transition-shadow cursor-pointer relative" title="${task.title} - ${task.description || ''}">
                                                                            <span class="text-xs font-semibold ${taskColor.text} truncate flex-1">${task.title}</span>
                                                                            <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                                                                ${task.status === 'completed' ? '<i class="fas fa-check-circle ml-2 text-blue-700"></i>' : ''}
                                                                                <button onclick="event.stopPropagation(); openEditTaskModal('${project.id}', ${taskIndex})" class="p-1 hover:bg-white/20 rounded transition-colors" title="Editar tarefa">
                                                                                    <i class="fas fa-edit text-xs ${taskColor.text}"></i>
                                                                                </button>
                                                                                <button onclick="event.stopPropagation(); deleteTask('${project.id}', ${taskIndex})" class="p-1 hover:bg-white/20 rounded transition-colors" title="Excluir tarefa">
                                                                                    <i class="fas fa-trash text-xs ${taskColor.text}"></i>
                                                                                </button>
                                                                            </div>
                                                                        </div>
                                                            </div>
                                                        `;
                                                            }).join('') : `
                                                                <div class="text-center text-slate-400 py-8">
                                                                    <i class="fas fa-tasks text-3xl mb-2"></i>
                                                                    <p class="text-sm">Nenhuma tarefa cadastrada</p>
                                                                    <button onclick="openTasksModal('${project.id}')" class="mt-2 px-3 py-1 bg-green-500 hover:bg-green-600 text-white text-xs font-semibold rounded transition-colors">
                                                                        Adicionar Tarefa
                                                                    </button>
                                                                </div>
                                                            `}
                                                        </div>
                                                        
                                                        <!-- Linha de hoje -->
                                                        <div class="absolute top-0 bottom-0 w-0.5 bg-red-500 z-10" style="left: ${(() => {
                                                            const today = new Date();
                                                            const projectStart = new Date(project.startDate);
                                                            const projectEnd = new Date(project.endDate);
                                                            if (today < projectStart || today > projectEnd) return '-100%';
                                                            const totalDays = (projectEnd - projectStart) / (1000 * 60 * 60 * 24);
                                                            const daysElapsed = (today - projectStart) / (1000 * 60 * 60 * 24);
                                                            return `${(daysElapsed / totalDays) * 100}%`;
                                                        })()};">
                                                            <div class="absolute -top-2 -left-2 w-4 h-4 bg-red-500 rounded-full border-2 border-white"></div>
                                                            <div class="absolute -bottom-6 left-0 text-xs text-red-600 font-semibold whitespace-nowrap">Hoje</div>
                                                        </div>
                                                </div>
                                            ` : `
                                                    <p class="text-slate-400 italic">Datas do projeto inválidas</p>
                                            `}
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `}
                </main>
            `;
        }

        function openNewProjectModal() {
            creatingNewProject = true;
            projectAcronyms['new'] = [];
            render();
        }

        function closeNewProjectModal() {
            creatingNewProject = false;
            projectAcronyms['new'] = [];
            render();
        }

        function deleteProject(projectId) {
            if (confirm('Tem certeza que deseja deletar este projeto?')) {
                projects = projects.filter(p => p.id !== projectId);
                saveProjects();
                render();
            }
        }
        function renderNewProjectModal() {
            return `
                <div class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center overflow-auto modal-overlay" onclick="if(event.target === this) closeNewProjectModal()" role="dialog" aria-modal="true">
                    <div class="bg-white rounded-lg shadow-2xl max-w-3xl w-full m-4 modal-panel" onclick="event.stopPropagation()">
                        <div class="bg-white border-b border-slate-200 p-6 flex items-center justify-between sticky top-0">
                            <h2 class="text-2xl font-bold text-slate-900">Novo Projeto / Quick Win</h2>
                            <button onclick="closeNewProjectModal()" class="p-2 hover:bg-slate-100 rounded-lg transition-colors" aria-label="Fechar modal">
                                <i class="fas fa-times text-slate-600 text-xl" aria-hidden="true"></i>
                            </button>
                        </div>
                        <div class="p-6 space-y-6 overflow-y-auto max-h-[calc(85vh-120px)]">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="project-title" class="block text-sm font-semibold text-slate-700 mb-2">Título *</label>
                                    <input type="text" id="project-title" placeholder="Ex: Melhoria de Observabilidade" class="w-full">
                                </div>
                                <div>
                                    <label for="project-type" class="block text-sm font-semibold text-slate-700 mb-2">Tipo</label>
                                    <select id="project-type" class="w-full">
                                        <option value="project">Projeto</option>
                                        <option value="quick-win">Quick Win</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div>
                                <label for="project-description" class="block text-sm font-semibold text-slate-700 mb-2">Descrição</label>
                                <textarea id="project-description" rows="3" placeholder="Descreva o objetivo do projeto..." class="w-full"></textarea>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="project-owner" class="block text-sm font-semibold text-slate-700 mb-2">Owner</label>
                                    <input type="text" id="project-owner" placeholder="Ex: João Silva" class="w-full">
                                    <p class="text-xs text-slate-500 mt-1">Responsável pelo projeto</p>
                                </div>
                                <div>
                                    <label for="project-sponsor" class="block text-sm font-semibold text-slate-700 mb-2">Sponsor</label>
                                    <input type="text" id="project-sponsor" placeholder="Ex: Maria Santos" class="w-full">
                                    <p class="text-xs text-slate-500 mt-1">Patrocinador do projeto</p>
                                </div>
                            </div>
                            
                            <div>
                                <label for="project-acronyms" class="block text-sm font-semibold text-slate-700 mb-2">Siglas</label>
                                <div id="acronyms-container-new" class="flex flex-wrap gap-2 mb-2 min-h-[40px] p-2 border border-slate-300 rounded bg-white">
                                    <!-- Siglas serão adicionadas aqui -->
                                </div>
                                <div class="flex gap-2">
                                    <input type="text" id="project-acronym-input-new" placeholder="Digite uma sigla e pressione Enter" class="flex-1" onkeypress="if(event.key === 'Enter') { event.preventDefault(); addAcronymToProject('new'); }">
                                    <button type="button" onclick="addAcronymToProject('new')" class="px-3 py-2 bg-blue-500 hover:bg-blue-600 text-white text-sm font-semibold rounded transition-colors">
                                        <i class="fas fa-plus"></i> Adicionar
                                    </button>
                                </div>
                                <p class="text-xs text-slate-500 mt-1">Adicione siglas relacionadas ao projeto</p>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="project-start-date" class="block text-sm font-semibold text-slate-700 mb-2">Data de Início *</label>
                                    <input type="date" id="project-start-date" class="w-full">
                                </div>
                                <div>
                                    <label for="project-end-date" class="block text-sm font-semibold text-slate-700 mb-2">Data de Fim *</label>
                                    <input type="date" id="project-end-date" class="w-full">
                                </div>
                            </div>
                            
                            <div>
                                <label for="project-affected-services" class="block text-sm font-semibold text-slate-700 mb-2">Serviços Afetados</label>
                                <input type="number" id="project-affected-services" min="0" value="0" class="w-full">
                            </div>
                            
                            <div class="flex gap-3 pt-4 border-t border-slate-200">
                                <button onclick="saveNewProject()" class="flex-1 px-4 py-2 bg-green-500 hover:bg-green-600 text-white font-semibold rounded transition-colors">
                                    <i class="fas fa-save mr-2" aria-hidden="true"></i> Salvar Projeto
                                </button>
                                <button onclick="closeNewProjectModal()" class="flex-1 px-4 py-2 bg-slate-300 hover:bg-slate-400 text-slate-700 font-semibold rounded transition-colors">
                                    <i class="fas fa-times mr-2" aria-hidden="true"></i> Cancelar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Funções para gerenciar siglas
        let projectAcronyms = {
            'new': [],
            'edit': []
        };
        function addAcronymToProject(mode) {
            const inputId = mode === 'new' ? 'project-acronym-input-new' : 'project-acronym-input-edit';
            const containerId = mode === 'new' ? 'acronyms-container-new' : 'acronyms-container-edit';
            const input = document.getElementById(inputId);
            
            if (!input || !input.value.trim()) return;
            
            const acronym = input.value.trim().toUpperCase();
            if (!projectAcronyms[mode].includes(acronym)) {
                projectAcronyms[mode].push(acronym);
                renderAcronyms(containerId, mode);
                input.value = '';
            }
        }
        
        function removeAcronymFromProject(mode, index) {
            projectAcronyms[mode].splice(index, 1);
            const containerId = mode === 'new' ? 'acronyms-container-new' : 'acronyms-container-edit';
            renderAcronyms(containerId, mode);
        }
        
        function renderAcronyms(containerId, mode) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            container.innerHTML = projectAcronyms[mode].map((acronym, index) => `
                <span class="inline-flex items-center gap-1 px-2 py-1 bg-blue-100 text-blue-800 rounded text-sm font-semibold">
                    ${acronym}
                    <button type="button" onclick="removeAcronymFromProject('${mode}', ${index})" class="text-blue-600 hover:text-blue-800">
                        <i class="fas fa-times text-xs"></i>
                    </button>
                </span>
            `).join('');
        }
        function saveNewProject() {
            const titleEl = document.getElementById('project-title');
            const descriptionEl = document.getElementById('project-description');
            const typeEl = document.getElementById('project-type');
            const ownerEl = document.getElementById('project-owner');
            const sponsorEl = document.getElementById('project-sponsor');
            const startDateEl = document.getElementById('project-start-date');
            const endDateEl = document.getElementById('project-end-date');
            const affectedServicesEl = document.getElementById('project-affected-services');
            
            if (!titleEl || !titleEl.value.trim()) {
                alert('Preencha o título do projeto');
                return;
            }
            
            if (!startDateEl || !startDateEl.value) {
                alert('Preencha a data de início');
                return;
            }
            
            if (!endDateEl || !endDateEl.value) {
                alert('Preencha a data de fim');
                return;
            }
            
            const newProject = {
                id: Date.now().toString(),
                title: titleEl.value.trim(),
                description: descriptionEl.value.trim() || '',
                type: typeEl.value,
                owner: ownerEl ? ownerEl.value.trim() : '',
                sponsor: sponsorEl ? sponsorEl.value.trim() : '',
                acronyms: [...projectAcronyms['new']],
                startDate: startDateEl.value,
                endDate: endDateEl.value,
                affectedServices: parseInt(affectedServicesEl.value) || 0,
                tasks: [],
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            projects.push(newProject);
            projectAcronyms['new'] = [];
            saveProjects();
            closeNewProjectModal();
            render();
        }

        function openEditProject(projectId) {
            editingProjectId = projectId;
            const project = projects.find(p => p.id === projectId);
            if (project) {
                projectAcronyms['edit'] = [...(project.acronyms || [])];
            }
            render();
        }

        function closeEditProjectModal() {
            editingProjectId = null;
            projectAcronyms['edit'] = [];
            render();
        }
        function renderEditProjectModal() {
            const project = projects.find(p => p.id === editingProjectId);
            if (!project) return '';
            
            return `
                <div class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center overflow-auto modal-overlay" onclick="if(event.target === this) closeEditProjectModal()" role="dialog" aria-modal="true">
                    <div class="bg-white rounded-lg shadow-2xl max-w-3xl w-full m-4 modal-panel" onclick="event.stopPropagation()">
                        <div class="bg-white border-b border-slate-200 p-6 flex items-center justify-between sticky top-0">
                            <h2 class="text-2xl font-bold text-slate-900">Editar Projeto</h2>
                            <button onclick="closeEditProjectModal()" class="p-2 hover:bg-slate-100 rounded-lg transition-colors" aria-label="Fechar modal">
                                <i class="fas fa-times text-slate-600 text-xl" aria-hidden="true"></i>
                            </button>
                        </div>
                        <div class="p-6 space-y-6 overflow-y-auto max-h-[calc(85vh-120px)]">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="edit-project-title" class="block text-sm font-semibold text-slate-700 mb-2">Título *</label>
                                    <input type="text" id="edit-project-title" value="${project.title}" class="w-full">
                                </div>
                                <div>
                                    <label for="edit-project-type" class="block text-sm font-semibold text-slate-700 mb-2">Tipo</label>
                                    <select id="edit-project-type" class="w-full">
                                        <option value="project" ${project.type === 'project' ? 'selected' : ''}>Projeto</option>
                                        <option value="quick-win" ${project.type === 'quick-win' ? 'selected' : ''}>Quick Win</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div>
                                <label for="edit-project-description" class="block text-sm font-semibold text-slate-700 mb-2">Descrição</label>
                                <textarea id="edit-project-description" rows="3" class="w-full">${project.description}</textarea>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="edit-project-owner" class="block text-sm font-semibold text-slate-700 mb-2">Owner</label>
                                    <input type="text" id="edit-project-owner" value="${project.owner || ''}" placeholder="Ex: João Silva" class="w-full">
                                    <p class="text-xs text-slate-500 mt-1">Responsável pelo projeto</p>
                                </div>
                                <div>
                                    <label for="edit-project-sponsor" class="block text-sm font-semibold text-slate-700 mb-2">Sponsor</label>
                                    <input type="text" id="edit-project-sponsor" value="${project.sponsor || ''}" placeholder="Ex: Maria Santos" class="w-full">
                                    <p class="text-xs text-slate-500 mt-1">Patrocinador do projeto</p>
                                </div>
                            </div>
                            
                            <div>
                                <label for="edit-project-acronyms" class="block text-sm font-semibold text-slate-700 mb-2">Siglas</label>
                                <div id="acronyms-container-edit" class="flex flex-wrap gap-2 mb-2 min-h-[40px] p-2 border border-slate-300 rounded bg-white">
                                    ${projectAcronyms['edit'].map((acronym, idx) => `
                                        <span class="inline-flex items-center gap-1 px-2 py-1 bg-blue-100 text-blue-800 rounded text-sm font-semibold">
                                            ${acronym}
                                            <button type="button" onclick="removeAcronymFromProject('edit', ${idx})" class="text-blue-600 hover:text-blue-800">
                                                <i class="fas fa-times text-xs"></i>
                                            </button>
                                        </span>
                                    `).join('')}
                                </div>
                                <div class="flex gap-2">
                                    <input type="text" id="project-acronym-input-edit" placeholder="Digite uma sigla e pressione Enter" class="flex-1" onkeypress="if(event.key === 'Enter') { event.preventDefault(); addAcronymToProject('edit'); }">
                                    <button type="button" onclick="addAcronymToProject('edit')" class="px-3 py-2 bg-blue-500 hover:bg-blue-600 text-white text-sm font-semibold rounded transition-colors">
                                        <i class="fas fa-plus"></i> Adicionar
                                    </button>
                                </div>
                                <p class="text-xs text-slate-500 mt-1">Adicione siglas relacionadas ao projeto</p>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="edit-project-start-date" class="block text-sm font-semibold text-slate-700 mb-2">Data de Início *</label>
                                    <input type="date" id="edit-project-start-date" value="${project.startDate}" class="w-full">
                                </div>
                                <div>
                                    <label for="edit-project-end-date" class="block text-sm font-semibold text-slate-700 mb-2">Data de Fim *</label>
                                    <input type="date" id="edit-project-end-date" value="${project.endDate}" class="w-full">
                                </div>
                            </div>
                            <div>
                                <label for="edit-project-affected-services" class="block text-sm font-semibold text-slate-700 mb-2">Serviços Afetados</label>
                                <input type="number" id="edit-project-affected-services" min="0" value="${project.affectedServices || 0}" class="w-full">
                            </div>
                            
                            <div class="flex gap-3 pt-4 border-t border-slate-200">
                                <button onclick="saveEditProject()" class="flex-1 px-4 py-2 bg-green-500 hover:bg-green-600 text-white font-semibold rounded transition-colors">
                                    <i class="fas fa-save mr-2" aria-hidden="true"></i> Salvar Alterações
                                </button>
                                <button onclick="closeEditProjectModal()" class="flex-1 px-4 py-2 bg-slate-300 hover:bg-slate-400 text-slate-700 font-semibold rounded transition-colors">
                                    <i class="fas fa-times mr-2" aria-hidden="true"></i> Cancelar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        function saveEditProject() {
            const project = projects.find(p => p.id === editingProjectId);
            if (!project) return;
            
            const titleEl = document.getElementById('edit-project-title');
            const descriptionEl = document.getElementById('edit-project-description');
            const typeEl = document.getElementById('edit-project-type');
            const ownerEl = document.getElementById('edit-project-owner');
            const sponsorEl = document.getElementById('edit-project-sponsor');
            const startDateEl = document.getElementById('edit-project-start-date');
            const endDateEl = document.getElementById('edit-project-end-date');
            const affectedServicesEl = document.getElementById('edit-project-affected-services');
            
            if (!titleEl || !titleEl.value.trim()) {
                alert('Preencha o título do projeto');
                return;
            }
            
            if (!startDateEl || !startDateEl.value) {
                alert('Preencha a data de início');
                return;
            }
            
            if (!endDateEl || !endDateEl.value) {
                alert('Preencha a data de fim');
                return;
            }
            
            project.title = titleEl.value.trim();
            project.description = descriptionEl.value.trim();
            project.type = typeEl.value;
            project.owner = ownerEl ? ownerEl.value.trim() : '';
            project.sponsor = sponsorEl ? sponsorEl.value.trim() : '';
            project.acronyms = [...projectAcronyms['edit']];
            project.startDate = startDateEl.value;
            project.endDate = endDateEl.value;
            project.affectedServices = parseInt(affectedServicesEl.value) || 0;
            project.updatedAt = new Date().toISOString();
            
            saveProjects();
            closeEditProjectModal();
            render();
        }

        function openTasksModal(projectId) {
            showingTasksModal = projectId;
            showingTaskForm = false;
            editingTaskIndex = null;
            render();
        }

        function closeTasksModal() {
            showingTasksModal = null;
            showingTaskForm = false;
            editingTaskIndex = null;
            render();
        }
        function renderTasksModal() {
            const project = projects.find(p => p.id === showingTasksModal);
            if (!project) return '';
            
            return `
                <div class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center overflow-auto modal-overlay" onclick="if(event.target === this) closeTasksModal()" role="dialog" aria-modal="true">
                    <div class="bg-white rounded-lg shadow-2xl max-w-4xl w-full m-4 modal-panel" onclick="event.stopPropagation()">
                        <div class="bg-white border-b border-slate-200 p-6 flex items-center justify-between sticky top-0">
                            <div>
                                <h2 class="text-2xl font-bold text-slate-900">Gerenciar Tarefas</h2>
                                <p class="text-sm text-slate-600 mt-1">Projeto: ${project.title}</p>
                            </div>
                            <button onclick="closeTasksModal()" class="p-2 hover:bg-slate-100 rounded-lg transition-colors" aria-label="Fechar modal">
                                <i class="fas fa-times text-slate-600 text-xl" aria-hidden="true"></i>
                            </button>
                        </div>
                        <div class="p-6">
                            <div class="mb-6 flex justify-between items-center">
                                <h3 class="text-lg font-semibold text-slate-800">Tarefas do Projeto</h3>
                                <button onclick="openAddTaskModal('${project.id}')" class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white font-semibold rounded transition-colors">
                                    <i class="fas fa-plus mr-2" aria-hidden="true"></i> Nova Tarefa
                                </button>
                            </div>
                            
                            ${!project.tasks || project.tasks.length === 0 ? `
                                <div class="bg-slate-50 border border-slate-200 rounded-lg p-8 text-center">
                                    <i class="fas fa-tasks text-4xl text-slate-300 mb-3" aria-hidden="true"></i>
                                    <p class="text-slate-600">Nenhuma tarefa cadastrada ainda.</p>
                                    <button onclick="openAddTaskModal('${project.id}')" class="mt-4 px-4 py-2 bg-green-500 hover:bg-green-600 text-white font-semibold rounded transition-colors">
                                        <i class="fas fa-plus mr-2" aria-hidden="true"></i> Criar Primeira Tarefa
                                    </button>
                                </div>
                            ` : `
                                <div class="space-y-2 max-h-96 overflow-y-auto">
                                    ${project.tasks.map((task, index) => {
                                        const taskStatusClass = task.status === 'completed' ? 'bg-green-100 text-green-800' : 
                                                              task.status === 'in-progress' ? 'bg-blue-100 text-blue-800' : 
                                                              task.status === 'blocked' ? 'bg-red-100 text-red-800' : 'bg-slate-100 text-slate-800';
                                        return `
                                            <div class="flex items-center gap-3 p-3 bg-slate-50 rounded-lg border border-slate-200">
                                                <select onchange="updateTaskStatus('${project.id}', ${index}, this.value)" class="text-xs border border-slate-300 rounded px-2 py-1">
                                                    <option value="pending" ${task.status === 'pending' ? 'selected' : ''}>Pendente</option>
                                                    <option value="in-progress" ${task.status === 'in-progress' ? 'selected' : ''}>Em Andamento</option>
                                                    <option value="completed" ${task.status === 'completed' ? 'selected' : ''}>Concluído</option>
                                                    <option value="blocked" ${task.status === 'blocked' ? 'selected' : ''}>Bloqueado</option>
                                                </select>
                                                <div class="flex-1">
                                                    <div class="flex items-center gap-2 mb-1">
                                                        <span class="font-medium text-slate-900 ${task.status === 'completed' ? 'line-through text-slate-500' : ''}">${task.title}</span>
                                                        <span class="px-2 py-0.5 rounded text-xs font-semibold ${taskStatusClass}">${task.status === 'completed' ? 'Concluído' : task.status === 'in-progress' ? 'Em Andamento' : task.status === 'blocked' ? 'Bloqueado' : 'Pendente'}</span>
                                                    </div>
                                                    ${task.description ? `<p class="text-sm text-slate-600">${task.description}</p>` : ''}
                                                    ${task.startDate || task.endDate ? `
                                                        <p class="text-xs text-slate-500 mt-1">
                                                            ${task.startDate ? `Início: ${new Date(task.startDate).toLocaleDateString('pt-BR')}` : ''}
                                                            ${task.startDate && task.endDate ? ' - ' : ''}
                                                            ${task.endDate ? `Fim: ${new Date(task.endDate).toLocaleDateString('pt-BR')}` : ''}
                                                        </p>
                                                    ` : ''}
                                                </div>
                                                <button onclick="openEditTaskModal('${project.id}', ${index})" class="px-2 py-1 text-blue-500 hover:bg-blue-50 rounded transition-colors" aria-label="Editar tarefa">
                                                    <i class="fas fa-edit" aria-hidden="true"></i>
                                                </button>
                                                <button onclick="deleteTask('${project.id}', ${index})" class="px-2 py-1 text-red-500 hover:bg-red-50 rounded transition-colors" aria-label="Deletar tarefa">
                                                    <i class="fas fa-trash" aria-hidden="true"></i>
                                                </button>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            `}
                            
                            ${showingTaskForm && showingTasksModal ? renderTaskFormModal(showingTasksModal) : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        function addTaskToProject(projectId) {
            openAddTaskModal(projectId);
        }
        
        function openAddTaskModal(projectId) {
            showingTasksModal = projectId;
            editingTaskIndex = null;
            showingTaskForm = true;
            render();
        }
        
        function openEditTaskModal(projectId, taskIndex) {
            showingTasksModal = projectId;
            editingTaskIndex = taskIndex;
            showingTaskForm = true;
            render();
        }
        
        function closeTaskFormModal() {
            editingTaskIndex = null;
            showingTaskForm = false;
            render();
        }
        function renderTaskFormModal(projectId) {
            const project = projects.find(p => p.id === projectId);
            if (!project) return '';
            
            const task = editingTaskIndex !== null && project.tasks[editingTaskIndex] ? project.tasks[editingTaskIndex] : null;
            const isEditing = task !== null;
            
            return `
                <div class="fixed inset-0 bg-black/50 z-[60] flex items-center justify-center overflow-auto modal-overlay" onclick="if(event.target === this) closeTaskFormModal()" role="dialog" aria-modal="true">
                    <div class="bg-white rounded-lg shadow-2xl max-w-2xl w-full m-4 modal-panel" onclick="event.stopPropagation()">
                        <div class="bg-white border-b border-slate-200 p-6 flex items-center justify-between sticky top-0">
                            <h2 class="text-2xl font-bold text-slate-900">${isEditing ? 'Editar Tarefa' : 'Nova Tarefa'}</h2>
                            <button onclick="closeTaskFormModal()" class="p-2 hover:bg-slate-100 rounded-lg transition-colors" aria-label="Fechar modal">
                                <i class="fas fa-times text-slate-600 text-xl" aria-hidden="true"></i>
                            </button>
                        </div>
                        <div class="p-6 space-y-4">
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-2">Título *</label>
                                <input type="text" id="task-title" value="${task ? task.title : ''}" placeholder="Ex: Implementar autenticação" class="w-full">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-2">Descrição</label>
                                <textarea id="task-description" rows="3" placeholder="Descreva a tarefa..." class="w-full">${task ? (task.description || '') : ''}</textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-2">Atribuído a</label>
                                <input type="text" id="task-assigned-to" value="${task ? (task.assignedTo || '') : ''}" placeholder="Ex: João Silva" class="w-full">
                                <p class="text-xs text-slate-500 mt-1">Nome da pessoa responsável pela tarefa</p>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold text-slate-700 mb-2">Data de Início</label>
                                    <input type="date" id="task-start-date" value="${task && task.startDate ? task.startDate.split('T')[0] : ''}" class="w-full">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-slate-700 mb-2">Data de Fim</label>
                                    <input type="date" id="task-end-date" value="${task && task.endDate ? task.endDate.split('T')[0] : ''}" class="w-full">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-2">Status</label>
                                <select id="task-status" class="w-full">
                                    <option value="pending" ${task && task.status === 'pending' ? 'selected' : ''}>Pendente</option>
                                    <option value="in-progress" ${task && task.status === 'in-progress' ? 'selected' : ''}>Em Andamento</option>
                                    <option value="completed" ${task && task.status === 'completed' ? 'selected' : ''}>Concluído</option>
                                    <option value="blocked" ${task && task.status === 'blocked' ? 'selected' : ''}>Bloqueado</option>
                                </select>
                            </div>
                            <div class="flex gap-3 pt-4 border-t border-slate-200">
                                <button onclick="saveTask('${projectId}')" class="flex-1 px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white font-semibold rounded transition-colors">
                                    <i class="fas fa-save mr-2" aria-hidden="true"></i> Salvar
                                </button>
                                <button onclick="closeTaskFormModal()" class="flex-1 px-4 py-2 bg-slate-300 hover:bg-slate-400 text-slate-700 font-semibold rounded transition-colors">
                                    <i class="fas fa-times mr-2" aria-hidden="true"></i> Cancelar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function saveTask(projectId) {
            const project = projects.find(p => p.id === projectId);
            if (!project) return;
            
            const titleEl = document.getElementById('task-title');
            const descriptionEl = document.getElementById('task-description');
            const assignedToEl = document.getElementById('task-assigned-to');
            const startDateEl = document.getElementById('task-start-date');
            const endDateEl = document.getElementById('task-end-date');
            const statusEl = document.getElementById('task-status');
            
            if (!titleEl || !titleEl.value.trim()) {
                alert('Preencha o título da tarefa');
                return;
            }
            
            if (!project.tasks) project.tasks = [];
            
            const taskData = {
                title: titleEl.value.trim(),
                description: descriptionEl.value.trim(),
                assignedTo: assignedToEl ? assignedToEl.value.trim() : '',
                status: statusEl.value,
                startDate: startDateEl.value || null,
                endDate: endDateEl.value || null,
                updatedAt: new Date().toISOString()
            };
            
            if (editingTaskIndex !== null && project.tasks[editingTaskIndex]) {
                // Editar tarefa existente
                taskData.createdAt = project.tasks[editingTaskIndex].createdAt || new Date().toISOString();
                project.tasks[editingTaskIndex] = taskData;
            } else {
                // Nova tarefa
                taskData.createdAt = new Date().toISOString();
                project.tasks.push(taskData);
            }
            
            project.updatedAt = new Date().toISOString();
            saveProjects();
            closeTaskFormModal();
        }
        
        function updateTaskStatus(projectId, taskIndex, status) {
            const project = projects.find(p => p.id === projectId);
            if (!project || !project.tasks[taskIndex]) return;
            
            project.tasks[taskIndex].status = status;
            project.updatedAt = new Date().toISOString();
            
            saveProjects();
            render();
        }

        function toggleTaskStatus(projectId, taskIndex, isCompleted) {
            const project = projects.find(p => p.id === projectId);
            if (!project || !project.tasks[taskIndex]) return;
            
            project.tasks[taskIndex].status = isCompleted ? 'completed' : 'pending';
            project.updatedAt = new Date().toISOString();
            
            saveProjects();
            render();
        }

        function deleteTask(projectId, taskIndex) {
            const project = projects.find(p => p.id === projectId);
            if (!project || !project.tasks[taskIndex]) return;
            
            if (confirm('Tem certeza que deseja deletar esta tarefa?')) {
                project.tasks.splice(taskIndex, 1);
                saveProjects();
                render();
            }
        }
        function renderEditJourneyModal() {
            if (!showEditJourneyModal || !editingJourneyModalId) return '';
            const journey = journeys.find(j => j.id === editingJourneyModalId);
            if (!journey) return '';

            return `
                <div class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center overflow-auto modal-overlay" onclick="if(event.target === this) closeEditJourneyModal()">
                    <div class="bg-white rounded-lg shadow-2xl max-w-2xl w-full m-4 edit-modal" onclick="event.stopPropagation()">
                        <div class="sticky top-0 bg-white border-b border-slate-200 p-6 flex items-center justify-between">
                            <h2 class="text-2xl font-bold text-slate-900">Editar Jornada</h2>
                            <button onclick="closeEditJourneyModal()" class="p-2 hover:bg-slate-100 rounded-lg transition-colors" aria-label="Fechar modal de edição">
                                <i class="fas fa-times text-slate-600 text-xl"></i>
                            </button>
                        </div>

                        <div class="p-6 space-y-4 overflow-y-auto max-h-[calc(85vh-120px)]">
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-2">Nome da Jornada *</label>
                                <input type="text" id="edit-journey-name" value="${journey.name || ''}" class="w-full border border-slate-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ex: Jornada de Pagamentos">
                            </div>

                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-2">Sigla *</label>
                                <input type="text" id="edit-journey-acronym" value="${journey.acronym || ''}" class="w-full border border-slate-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ex: PAY" maxlength="10">
                            </div>

                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-2">Status</label>
                                <select id="edit-journey-status" class="w-full border border-slate-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    ${Object.entries(journeyStatusConfig).map(([key, config]) => `
                                        <option value="${key}" ${(journey.status || 'active') === key ? 'selected' : ''}>${config.label}</option>
                                    `).join('')}
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-2">Owner/Gestor</label>
                                <input type="text" id="edit-journey-owner" value="${journey.owner || ''}" class="w-full border border-slate-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Nome do responsável">
                            </div>

                            <div class="flex gap-3 pt-4 border-t border-slate-200">
                                <button onclick="saveEditJourney()" class="flex-1 px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white font-semibold rounded transition-colors">
                                    <i class="fas fa-save mr-2"></i> Salvar Alterações
                                </button>
                                <button onclick="closeEditJourneyModal()" class="flex-1 px-4 py-2 bg-slate-300 hover:bg-slate-400 text-slate-700 font-semibold rounded transition-colors">
                                    <i class="fas fa-times mr-2"></i> Cancelar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderJourneysPage() {
            return `
                <header class="bg-white border-b border-slate-200 shadow-sm sticky top-0 z-40">
                    <div class="max-w-7xl mx-auto px-6 py-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <h1 class="text-3xl font-bold text-slate-900">Maturidade de Jornadas</h1>
                                <p class="text-slate-600 mt-1 text-sm">Avaliação de maturidade por pilar</p>
                            </div>
                            <nav class="flex items-center gap-3" aria-label="Navegação principal">
                                <button onclick="navigateTo('dashboard')" class="px-3 py-2 bg-indigo-500 hover:bg-indigo-600 text-white font-semibold rounded transition-colors text-sm" aria-label="Ir para Dashboard">
                                    <i class="fas fa-home mr-1" aria-hidden="true"></i> Dashboard
                                </button>
                                <button onclick="openNewJourneyModal()" class="px-3 py-2 bg-green-500 hover:bg-green-600 text-white font-semibold rounded transition-colors text-sm">
                                    <i class="fas fa-plus mr-1" aria-hidden="true"></i> Nova Jornada
                                </button>
                                <button onclick="resetJourneys()" class="px-3 py-2 bg-yellow-500 hover:bg-yellow-600 text-white font-semibold rounded transition-colors text-sm">
                                    <i class="fas fa-redo mr-1" aria-hidden="true"></i> Reset Jornadas
                                </button>
                                <button onclick="openJourneysExportModal()" class="px-3 py-2 bg-slate-200 hover:bg-slate-300 text-slate-800 font-semibold rounded transition-colors text-sm" aria-label="Exportar dados de jornadas">
                                    <i class="fas fa-file-export mr-1" aria-hidden="true"></i> Exportar / Modelo
                                </button>
                                <button onclick="openJourneysImportModal()" class="px-3 py-2 bg-slate-200 hover:bg-slate-300 text-slate-800 font-semibold rounded transition-colors text-sm" aria-label="Importar dados de jornadas">
                                    <i class="fas fa-file-import mr-1" aria-hidden="true"></i> Importar Excel
                                </button>
                            </nav>
                        </div>
                    </div>
                </header>
                <main class="max-w-7xl mx-auto px-6 py-8">
                    <!-- Filtros e Ordenação -->
                    <div class="mb-6">
                        <div class="flex items-center justify-between mb-4">
                            <button onclick="toggleJourneyFilters()" class="px-4 py-2 bg-slate-200 hover:bg-slate-300 text-slate-700 font-semibold rounded transition-colors text-sm">
                                <i class="fas fa-filter mr-2"></i> Filtros ${hasActiveJourneyFilters() ? '(Ativos)' : ''}
                            </button>
                            <div class="flex items-center gap-2">
                                <span class="text-sm text-slate-600">Ordenar por:</span>
                                <select onchange="updateJourneySort(this.value)" class="text-sm border border-slate-300 rounded px-3 py-1">
                                    <option value="">Nenhuma</option>
                                    <option value="name" ${journeySortBy === 'name' ? 'selected' : ''}>Nome</option>
                                    <option value="incidents" ${journeySortBy === 'incidents' ? 'selected' : ''}>Incidentes</option>
                                    <option value="risks" ${journeySortBy === 'risks' ? 'selected' : ''}>Riscos</option>
                                    <option value="problems" ${journeySortBy === 'problems' ? 'selected' : ''}>Problemas</option>
                                    <option value="requests" ${journeySortBy === 'requests' ? 'selected' : ''}>Requisições</option>
                                    <option value="maturity" ${journeySortBy === 'maturity' ? 'selected' : ''}>Maturidade</option>
                                </select>
                                ${journeySortBy ? `
                                    <button onclick="updateJourneySort('${journeySortBy}')" class="px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs" title="${journeySortOrder === 'desc' ? 'Maior para Menor' : 'Menor para Maior'}">
                                        <i class="fas fa-sort-${journeySortOrder === 'desc' ? 'amount-down' : 'amount-up'}"></i>
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                        
                        ${journeyFiltersExpanded ? `
                            <div class="bg-white rounded-lg shadow-md p-6 border-2 border-slate-200 filter-panel mb-4">
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                                    <div>
                                        <label class="block text-sm font-semibold text-slate-700 mb-2">Buscar por Nome</label>
                                        <input type="text" placeholder="Digite o nome..." value="${journeyFilters.searchName}" onchange="journeyFilters.searchName = this.value; render()" class="w-full">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold text-slate-700 mb-2">Buscar por Sigla</label>
                                        <input type="text" placeholder="Digite a sigla..." value="${journeyFilters.searchAcronym}" onchange="journeyFilters.searchAcronym = this.value; render()" class="w-full">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold text-slate-700 mb-2">Maturidade Mínima (%)</label>
                                        <input type="number" min="0" max="100" placeholder="0" value="${journeyFilters.minMaturity || ''}" onchange="journeyFilters.minMaturity = this.value ? parseInt(this.value) : null; render()" class="w-full">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold text-slate-700 mb-2">Maturidade Máxima (%)</label>
                                        <input type="number" min="0" max="100" placeholder="100" value="${journeyFilters.maxMaturity || ''}" onchange="journeyFilters.maxMaturity = this.value ? parseInt(this.value) : null; render()" class="w-full">
                                    </div>
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-semibold text-slate-700 mb-2">Período de Eventos (Incidentes e Riscos)</label>
                                    <select onchange="updateJourneyEventDatePreset(this.value)" class="w-full border border-slate-300 rounded px-3 py-2 text-sm">
                                        <option value="all" ${journeyFilters.eventDatePreset === 'all' ? 'selected' : ''}>Todos os períodos</option>
                                        <option value="current-month" ${journeyFilters.eventDatePreset === 'current-month' ? 'selected' : ''}>Mês atual</option>
                                        <option value="previous-month" ${journeyFilters.eventDatePreset === 'previous-month' ? 'selected' : ''}>Mês anterior</option>
                                        <option value="year-to-date" ${journeyFilters.eventDatePreset === 'year-to-date' ? 'selected' : ''}>Ano atual (YTD)</option>
                                        <option value="last-30-days" ${journeyFilters.eventDatePreset === 'last-30-days' ? 'selected' : ''}>Últimos 30 dias</option>
                                        <option value="custom" ${journeyFilters.eventDatePreset === 'custom' ? 'selected' : ''}>Personalizado</option>
                                    </select>
                                    ${journeyFilters.eventDatePreset === 'custom' ? `
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-3">
                                            <div>
                                                <label class="block text-xs font-semibold text-slate-600 mb-1">Data inicial</label>
                                                <input type="date" value="${journeyFilters.eventDateStart}" onchange="updateJourneyEventDateRange('eventDateStart', this.value)" class="w-full">
                                            </div>
                                            <div>
                                                <label class="block text-xs font-semibold text-slate-600 mb-1">Data final</label>
                                                <input type="date" value="${journeyFilters.eventDateEnd}" onchange="updateJourneyEventDateRange('eventDateEnd', this.value)" class="w-full">
                                            </div>
                                        </div>
                                    ` : `
                                        <p class="text-xs text-slate-500 mt-2">Selecione um período pré-definido ou escolha "Personalizado" para informar datas específicas.</p>
                                    `}
                                </div>
                                    <div>
                                        <label class="block text-sm font-semibold text-slate-700 mb-3">Status</label>
                                        <div class="space-y-2">
                                            ${Object.entries(journeyStatusConfig).map(([key, config]) => `
                                                <label class="flex items-center gap-2 cursor-pointer">
                                                    <input type="checkbox" ${journeyFilters.status.includes(key) ? 'checked' : ''} onchange="updateJourneyFilterStatus('${key}')" class="w-4 h-4">
                                                    <span class="text-sm text-slate-700">${config.label}</span>
                                                </label>
                                            `).join('')}
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold text-slate-700 mb-3">Owner/Gestor</label>
                                        <div class="space-y-2 max-h-40 overflow-y-auto">
                                            ${[...new Set(journeys.map(j => j.owner).filter(Boolean))].sort().map(owner => `
                                                <label class="flex items-center gap-2 cursor-pointer">
                                                    <input type="checkbox" ${journeyFilters.owner.includes(owner) ? 'checked' : ''} onchange="updateJourneyFilterOwner('${owner}')" class="w-4 h-4">
                                                    <span class="text-sm text-slate-700">${owner}</span>
                                                </label>
                                            `).join('')}
                                            ${[...new Set(journeys.map(j => j.owner).filter(Boolean))].length === 0 ? '<p class="text-xs text-slate-500 italic">Nenhum owner cadastrado</p>' : ''}
                                        </div>
                                    </div>
                                </div>
                                <div class="flex gap-3 mt-6 pt-6 border-t border-slate-200">
                                    <button onclick="clearJourneyFilters()" class="px-4 py-2 bg-slate-300 hover:bg-slate-400 text-slate-700 font-semibold rounded transition-colors text-sm">
                                        <i class="fas fa-times mr-2"></i> Limpar Filtros
                                    </button>
                                    <span class="text-sm text-slate-600 self-center">
                                        ${getFilteredAndSortedJourneys().length} de ${journeys.length} jornada(s) exibida(s)
                                    </span>
                                </div>
                            </div>
                        ` : ''}
                    </div>

                    <div class="space-y-6">
                        ${(() => {
                            const filteredJourneys = getFilteredAndSortedJourneys();
                            if (filteredJourneys.length === 0) {
                                return `
                                    <div class="bg-white rounded-lg shadow-md p-12 text-center border-2 border-slate-200">
                                        <i class="fas fa-search text-4xl text-slate-400 mb-4"></i>
                                        <p class="text-slate-600 text-lg">Nenhuma jornada encontrada com os filtros aplicados</p>
                                    </div>
                                `;
                            }
                            return filteredJourneys.map(journey => {
                            const availabilityMaturity = calculatePillarMaturity(journey, 'availability');
                            const qualityMaturity = calculatePillarMaturity(journey, 'quality');
                            const securityMaturity = calculatePillarMaturity(journey, 'security');
                            const performanceMaturity = calculatePillarMaturity(journey, 'performance');
                            const overallMaturity = Math.round((availabilityMaturity + qualityMaturity + securityMaturity + performanceMaturity) / 4);
                            const status = journeyStatusConfig[journey.status];
                            const incidentCount = countIncidents(journey.id);

                            return `
                                <div class="bg-white rounded-lg shadow-md p-6 border-2 border-slate-200 journey-card">
                                    <div class="flex items-center justify-between mb-6">
                                        <div>
                                            <h3 class="text-xl font-bold text-slate-900">${journey.name}</h3>
                                            <div class="flex items-center gap-4 mt-1">
                                                <p class="text-sm text-slate-600">Sigla: <span class="font-semibold">${journey.acronym}</span></p>
                                                ${journey.owner ? `
                                                    <p class="text-sm text-slate-600">
                                                        <i class="fas fa-user-tie mr-1 text-blue-600"></i>
                                                        Owner: <span class="font-semibold text-blue-700">${journey.owner}</span>
                                                    </p>
                                                ` : ''}
                                        </div>
                                        </div>
                                        <div class="flex items-center gap-3 flex-wrap">
                                            <span class="px-3 py-1 rounded-full text-xs font-semibold ${status.bgColor} ${status.textColor}">${status.label}</span>
                                            ${incidentCount > 0 ? `
                                                <button onclick="openIncidentOverview('${journey.id}')" class="incident-counter px-3 py-2 rounded-lg text-xs font-semibold bg-red-100 text-red-800 hover:bg-red-200 transition-colors">
                                                    <i class="fas fa-exclamation-circle mr-1"></i> ${incidentCount} Incidente${incidentCount !== 1 ? 's' : ''}
                                                </button>
                                            ` : ''}
                                            ${(() => {
                                                const functionalCount = countFunctionalIncidents(journey.id);
                                                if (functionalCount <= 0) return '';
                                                const label = functionalCount === 1 ? 'Incidente Funcional' : 'Incidentes Funcionais';
                                                return `
                                                    <button onclick="openFunctionalIncidentOverview('${journey.id}')" class="incident-counter px-3 py-2 rounded-lg text-xs font-semibold bg-purple-100 text-purple-800 hover:bg-purple-200 transition-colors">
                                                        <i class="fas fa-headset mr-1"></i> ${functionalCount} ${label}
                                                    </button>
                                                `;
                                            })()}
                                            ${(() => {
                                                const alertCount = countAlerts(journey.id);
                                                if (alertCount <= 0) return '';
                                                const label = alertCount === 1 ? 'Alerta' : 'Alertas';
                                                return `
                                                    <button onclick="openAlertOverview('${journey.id}')" class="incident-counter px-3 py-2 rounded-lg text-xs font-semibold bg-amber-100 text-amber-800 hover:bg-amber-200 transition-colors">
                                                        <i class="fas fa-bell mr-1"></i> ${alertCount} ${label}
                                                    </button>
                                                `;
                                            })()}
                                            ${(() => {
                                                const obsolescenceCount = countObsolescenceItems(journey.id);
                                                if (obsolescenceCount <= 0) return '';
                                                const label = obsolescenceCount === 1 ? 'Obsolescência' : 'Obsolescências';
                                                return `
                                                    <button onclick="openObsolescenceOverview('${journey.id}')" class="incident-counter px-3 py-2 rounded-lg text-xs font-semibold bg-slate-200 text-slate-700 hover:bg-slate-300 transition-colors">
                                                        <i class="fas fa-clock-rotate-left mr-1"></i> ${obsolescenceCount} ${label}
                                                    </button>
                                                `;
                                            })()}
                                            ${(() => {
                                                const vulnerabilityCount = countVulnerabilities(journey.id);
                                                if (vulnerabilityCount <= 0) return '';
                                                const label = vulnerabilityCount === 1 ? 'Vulnerabilidade' : 'Vulnerabilidades';
                                                return `
                                                    <button onclick="openVulnerabilityOverview('${journey.id}')" class="incident-counter px-3 py-2 rounded-lg text-xs font-semibold bg-rose-100 text-rose-800 hover:bg-rose-200 transition-colors">
                                                        <i class="fas fa-shield-halved mr-1"></i> ${vulnerabilityCount} ${label}
                                                    </button>
                                                `;
                                            })()}
                                            ${(() => {
                                                const riskCount = countRisks(journey.id);
                                                return riskCount > 0 ? `
                                                    <button onclick="openRiskOverview('${journey.id}')" class="incident-counter px-3 py-2 rounded-lg text-xs font-semibold bg-yellow-100 text-yellow-800 hover:bg-yellow-200 transition-colors">
                                                        <i class="fas fa-exclamation-triangle mr-1"></i> ${riskCount} Risco${riskCount !== 1 ? 's' : ''}
                                                    </button>
                                                ` : '';
                                            })()}
                                            ${(() => {
                                                const problemCount = countProblems(journey.id);
                                                return problemCount > 0 ? `
                                                    <span class="px-3 py-2 rounded-lg text-xs font-semibold bg-orange-100 text-orange-800">
                                                        <i class="fas fa-bug mr-1"></i> ${problemCount} Problema${problemCount !== 1 ? 's' : ''}
                                                    </span>
                                                ` : '';
                                            })()}
                                            ${(() => {
                                                const requestCount = countRequests(journey.id);
                                                return requestCount > 0 ? `
                                                    <span class="px-3 py-2 rounded-lg text-xs font-semibold bg-blue-100 text-blue-800">
                                                        <i class="fas fa-clipboard-list mr-1"></i> ${requestCount} Requisição${requestCount !== 1 ? 'ões' : ''}
                                                    </span>
                                                ` : '';
                                            })()}
                                            <div class="journey-card-actions flex items-center gap-2">
                                                <button onclick="openEditJourneyModal('${journey.id}')" class="px-3 py-2 bg-blue-200 hover:bg-blue-300 text-blue-700 text-xs font-semibold rounded transition-colors" title="Editar Jornada">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button onclick="deleteJourney('${journey.id}')" class="px-3 py-2 bg-red-200 hover:bg-red-300 text-red-700 text-xs font-semibold rounded transition-colors" title="Excluir Jornada">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                    </div>
                                    <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
                                        <div onclick="openDetailModalJourney('${journey.id}', 'availability', Object.keys(pillarAttributes.availability)[0])" class="maturity-cell ${getMaturityColor(availabilityMaturity)}">
                                            <div class="text-sm font-semibold mb-2">Disponibilidade</div>
                                            <div class="text-3xl font-bold">${availabilityMaturity}%</div>
                                        </div>
                                        <div onclick="openDetailModalJourney('${journey.id}', 'quality', Object.keys(pillarAttributes.quality)[0])" class="maturity-cell ${getMaturityColor(qualityMaturity)}">
                                            <div class="text-sm font-semibold mb-2">Qualidade</div>
                                            <div class="text-3xl font-bold">${qualityMaturity}%</div>
                                        </div>
                                        <div onclick="openDetailModalJourney('${journey.id}', 'security', Object.keys(pillarAttributes.security)[0])" class="maturity-cell ${getMaturityColor(securityMaturity)}">
                                            <div class="text-sm font-semibold mb-2">Segurança</div>
                                            <div class="text-3xl font-bold">${securityMaturity}%</div>
                                        </div>
                                        <div onclick="openDetailModalJourney('${journey.id}', 'performance', Object.keys(pillarAttributes.performance)[0])" class="maturity-cell ${getMaturityColor(performanceMaturity)}">
                                            <div class="text-sm font-semibold mb-2">Performance</div>
                                            <div class="text-3xl font-bold">${performanceMaturity}%</div>
                                        </div>
                                        <div class="maturity-cell ${getMaturityColor(overallMaturity)}" style="border: 3px solid currentColor;">
                                            <div class="text-sm font-semibold mb-2">Geral</div>
                                            <div class="text-3xl font-bold">${overallMaturity}%</div>
                                        </div>
                                    </div>

                                    <!-- Gráfico de Evolução Temporal -->
                                    ${(() => {
                                        const sectionKey = 'evolution';
                                        const isExpanded = isJourneySectionExpanded(journey.id, sectionKey);
                                        return `
                                            <div class="mb-6 border-t border-slate-200 pt-6">
                                                <button onclick="toggleJourneySection('${journey.id}', '${sectionKey}')" class="flex items-center justify-between w-full text-left mb-4 hover:text-blue-600 transition-colors">
                                                    <h4 class="font-semibold text-slate-800">Evolução Temporal da Maturidade</h4>
                                                    <i class="fas fa-chevron-${isExpanded ? 'up' : 'down'} text-slate-400"></i>
                                                </button>
                                                ${isExpanded ? `
                                                    <div>
                                                        ${renderJourneyEvolutionChart(journey)}
                                                    </div>
                                                ` : `
                                                    <div class="text-sm text-slate-500 italic">
                                                        Clique para visualizar o gráfico de evolução temporal da maturidade.
                                                    </div>
                                                `}
                                            </div>
                                        `;
                                    })()}

                                    <!-- Contribuição para OKRs -->
                                    ${(() => {
                                        const sectionKey = 'okrs';
                                        const isExpanded = isJourneySectionExpanded(journey.id, sectionKey);
                                        const relatedOKRs = getJourneyOKRsContribution(journey.id);
                                        
                                        return `
                                            <div class="mb-6 border-t border-slate-200 pt-6">
                                                <button onclick="toggleJourneySection('${journey.id}', '${sectionKey}')" class="flex items-center justify-between w-full text-left mb-4 hover:text-blue-600 transition-colors">
                                                    <h4 class="font-semibold text-slate-800">Contribuição para OKRs</h4>
                                                    <div class="flex items-center gap-2">
                                                        ${relatedOKRs.length > 0 ? `<span class="text-xs px-2 py-1 bg-blue-100 text-blue-700 rounded-full">${relatedOKRs.length}</span>` : ''}
                                                        <i class="fas fa-chevron-${isExpanded ? 'up' : 'down'} text-slate-400"></i>
                                                    </div>
                                                </button>
                                                ${isExpanded ? `
                                                    ${relatedOKRs.length > 0 ? `
                                                        <div class="space-y-2">
                                                            ${relatedOKRs.map(okr => {
                                                                const okrStatus = calculateOKRStatus(okr);
                                                                return `
                                                                    <div class="flex items-center justify-between p-3 bg-blue-50 border border-blue-200 rounded">
                                                                        <span class="text-sm font-medium text-blue-900">${okr.objetivo}</span>
                                                                        <span class="text-xs px-2 py-1 rounded ${okrStatus.color} ${okrStatus.textColor}">${okrStatus.label}</span>
                                                                    </div>
                                                                `;
                                                            }).join('')}
                                                        </div>
                                                    ` : `
                                                        <div class="bg-slate-50 border border-slate-200 rounded-lg p-4 text-center">
                                                            <i class="fas fa-info-circle text-slate-400 text-2xl mb-2" aria-hidden="true"></i>
                                                            <p class="text-sm text-slate-600">A contribuição para OKRs é calculada através do relacionamento com frentes de engenharia.</p>
                                                        </div>
                                                    `}
                                                ` : `
                                                    <div class="text-sm text-slate-500 italic">
                                                        Clique para visualizar os OKRs relacionados ${relatedOKRs.length > 0 ? `(${relatedOKRs.length} OKR${relatedOKRs.length !== 1 ? 's' : ''})` : ''}.
                                                    </div>
                                                `}
                                            </div>
                                        `;
                                    })()}

                                    <div class="flex gap-3">
                                        <button onclick="openEventModal('${journey.id}')" class="flex-1 px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white font-semibold rounded transition-colors text-sm">
                                            <i class="fas fa-plus mr-2"></i> Adicionar Evento
                                        </button>
                                    </div>
                                </div>
                            `;
                            }).join('');
                        })()}
                    </div>

                    <div class="mt-8 bg-white rounded-lg shadow-md p-6 border-2 border-slate-200">
                        <h3 class="text-lg font-bold text-slate-900 mb-4">Resumo Geral</h3>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            ${['availability', 'quality', 'security', 'performance'].map(pillar => {
                                const pillarNames = { availability: 'Disponibilidade', quality: 'Qualidade', security: 'Segurança', performance: 'Performance' };
                                const avgMaturity = journeys.length > 0 ? Math.round(journeys.reduce((sum, j) => sum + calculatePillarMaturity(j, pillar), 0) / journeys.length) : 0;
                                return `
                                    <div class="bg-slate-50 rounded-lg p-4 border border-slate-200">
                                        <h4 class="font-semibold text-slate-800 mb-2">${pillarNames[pillar]}</h4>
                                        <div class="text-3xl font-bold text-blue-600">${avgMaturity}%</div>
                                        <p class="text-xs text-slate-600 mt-1">Média geral</p>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </main>
                ${showJourneysExportModal ? renderJourneysExportModal() : ''}
                ${showJourneysImportModal ? renderJourneysImportModal() : ''}
                ${showJourneysImportResultModal ? renderJourneysImportResultModal() : ''}
                ${showEventModal ? renderEventModal() : ''}
                ${selectedPillar ? renderDetailModalJourney() : ''}
                ${showIncidentOverview ? renderIncidentOverviewModal() : ''}
                ${showFunctionalIncidentOverview ? renderFunctionalIncidentOverviewModal() : ''}
                ${showAlertOverview ? renderAlertOverviewModal() : ''}
                ${showObsolescenceOverview ? renderObsolescenceOverviewModal() : ''}
                ${showVulnerabilityOverview ? renderVulnerabilityOverviewModal() : ''}
                ${showRiskOverview ? renderRiskOverviewModal() : ''}
                ${showEditEventModal ? renderEditEventModal() : ''}
                ${showEditJourneyModal ? renderEditJourneyModal() : ''}
            `;
        }
        function renderJourneysExportModal() {
            const hasSelection = hasJourneysExportSelection();
            return `
                <div class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center overflow-auto modal-overlay" onclick="if(event.target === this) closeJourneysExportModal()">
                    <div class="bg-white rounded-lg shadow-2xl max-w-3xl w-full m-4 modal-panel" onclick="event.stopPropagation()">
                            <div class="sticky top-0 bg-white border-b border-slate-200 p-6 flex items-center justify-between">
                            <div>
                                <h2 class="text-2xl font-bold text-slate-900">Exportar / Gerar Modelo Excel</h2>
                                <p class="text-sm text-slate-600 mt-1">Escolha quais informações deseja gerar para acelerar o preenchimento.</p>
                            </div>
                            <button onclick="closeJourneysExportModal()" class="p-2 hover:bg-slate-100 rounded-lg transition-colors" aria-label="Fechar modal de exportação">
                                    <i class="fas fa-times text-slate-600 text-xl"></i>
                                </button>
                            </div>
                        <div class="p-6 space-y-6 overflow-y-auto max-h-[calc(85vh-120px)]">
                            <div class="bg-slate-50 border border-slate-200 rounded-lg p-4">
                                <h3 class="text-sm font-semibold text-slate-800 mb-2">Opções de dados</h3>
                                <label class="flex items-center gap-3">
                                    <input type="checkbox" class="w-5 h-5" ${journeysExportOptions.journeys ? 'checked' : ''} onchange="setJourneysExportOption('journeys', this.checked)" aria-label="Incluir jornadas na exportação">
                                <div>
                                        <span class="text-sm font-semibold text-slate-800">Jornadas</span>
                                        <p class="text-xs text-slate-500">Inclui nome, sigla, status e owner de cada jornada.</p>
                                </div>
                                </label>
                                </div>

                            <div class="bg-slate-50 border border-slate-200 rounded-lg p-4 space-y-4">
                                <div class="flex items-center justify-between">
                                <div>
                                        <h3 class="text-sm font-semibold text-slate-800">Eventos relacionados</h3>
                                        <p class="text-xs text-slate-500">Selecione os tipos que deseja incluir no arquivo gerado.</p>
                                </div>
                                    <div class="flex gap-2">
                                        <button onclick="toggleAllJourneysExportCategories(true)" class="px-3 py-1 text-xs font-semibold bg-blue-100 text-blue-700 rounded transition-colors hover:bg-blue-200">
                                            Selecionar todos
                                    </button>
                                        <button onclick="toggleAllJourneysExportCategories(false)" class="px-3 py-1 text-xs font-semibold bg-slate-200 text-slate-700 rounded transition-colors hover:bg-slate-300">
                                            Limpar seleção
                                    </button>
                                </div>
                            </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                    ${eventCategories.map(category => {
                                        const isSupported = supportedJourneyEventCategories.includes(category);
                                        const isChecked = journeysExportOptions.events && journeysExportOptions.events[category];
                                        return `
                                            <label class="flex items-start gap-3 border border-slate-200 rounded-lg p-3 ${isSupported ? 'bg-white hover:border-blue-300 transition-colors cursor-pointer' : 'bg-slate-100 opacity-70 cursor-not-allowed'}">
                                                <input type="checkbox" class="mt-1 w-5 h-5" ${isChecked && isSupported ? 'checked' : ''} ${isSupported ? `onchange="setJourneysExportCategory('${category}', this.checked)"` : 'disabled'}>
                                                <div>
                                                    <span class="text-sm font-semibold text-slate-800">${category}</span>
                                                    <p class="text-xs text-slate-500 mt-1">
                                                        ${category === EVENT_CATEGORY_INCIDENT_SERVICE ? 'Incidentes de quebra de serviço (número, MTTR, origem, lições aprendidas e atributos impactados).' :
                                                          category === EVENT_CATEGORY_INCIDENT_FUNCTIONAL ? 'Incidentes funcionais (datas, descrições, notas de resolução, classificação e jornada impactada).' :
                                                          category === EVENT_CATEGORY_RISK ? 'Informações completas do risco (prioridade, progresso, responsáveis, datas e descrição).' :
                                                          'Categoria ainda não suportada para exportação por modelo. Em breve!'}
                                                    </p>
                        </div>
                                            </label>
                                        `;
                                    }).join('')}
                                </div>
                                ${supportedJourneyEventCategories.length === 0 ? `
                                    <div class="bg-yellow-50 border border-yellow-200 text-yellow-800 text-xs rounded-lg p-3">
                                        Nenhuma categoria de evento está disponível para exportação no momento.
                    </div>
                ` : ''}
                            </div>

                            <div class="bg-slate-100 border border-slate-200 rounded-lg p-4 text-xs text-slate-600 space-y-2">
                                <p><strong>Como funciona:</strong> o arquivo exportado já vem no formato aceito pela importação. Basta preencher ou atualizar as linhas e importar novamente.</p>
                                <p>Você também pode baixar apenas o modelo em branco para preencher manualmente.</p>
                            </div>
                        </div>
                        <div class="flex flex-col md:flex-row gap-3 p-6 border-t border-slate-200 bg-slate-50">
                            <button onclick="exportJourneysToExcel()" class="flex-1 px-4 py-3 bg-blue-500 hover:bg-blue-600 text-white font-semibold rounded transition-colors disabled:opacity-60 disabled:cursor-not-allowed" ${hasSelection ? '' : 'disabled'}>
                                <i class="fas fa-file-export mr-2"></i> Exportar selecionados
                            </button>
                            <button onclick="downloadJourneysTemplate()" class="flex-1 px-4 py-3 bg-slate-200 hover:bg-slate-300 text-slate-800 font-semibold rounded transition-colors">
                                <i class="fas fa-download mr-2"></i> Baixar modelo em branco
                            </button>
                            <button onclick="resetJourneysExportOptions()" class="px-4 py-3 bg-white border border-slate-300 hover:bg-slate-100 text-slate-700 font-semibold rounded transition-colors">
                                <i class="fas fa-undo mr-2"></i> Restaurar padrão
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        function renderJourneysImportModal() {
            return `
                <div class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center overflow-auto modal-overlay" onclick="if(event.target === this) closeJourneysImportModal()">
                    <div class="bg-white rounded-lg shadow-2xl max-w-3xl w-full m-4 modal-panel" onclick="event.stopPropagation()">
                        <div class="sticky top-0 bg-white border-b border-slate-200 p-6 flex items-center justify-between">
                            <div>
                                <h2 class="text-2xl font-bold text-slate-900">Importar dados de Jornadas</h2>
                                <p class="text-sm text-slate-600 mt-1">Utilize um arquivo gerado pelo sistema ou o modelo padrão em Excel.</p>
                            </div>
                            <button onclick="closeJourneysImportModal()" class="p-2 hover:bg-slate-100 rounded-lg transition-colors" aria-label="Fechar modal de importação">
                                <i class="fas fa-times text-slate-600 text-xl"></i>
                            </button>
                        </div>
                        <div class="p-6 space-y-6 overflow-y-auto max-h-[calc(85vh-120px)]">
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-blue-800 text-sm space-y-2">
                                <p class="font-semibold">Premissas importantes</p>
                                <ul class="list-disc list-inside space-y-1 text-xs md:text-sm">
                                    <li>Cada aba da planilha representa um tipo de informação (Jornadas, Incidentes, Riscos).</li>
                                    <li>Cadastre ou atualize as jornadas antes de relacionar incidentes e riscos a elas.</li>
                                    <li>Para atualizar dados existentes, mantenha o mesmo ID ou Sigla da jornada e os identificadores dos eventos.</li>
                                </ul>
                            </div>

                            <div class="bg-slate-50 border border-slate-200 rounded-lg p-4">
                                <input type="file" id="journeys-import-input" accept=".xlsx,.xls" class="hidden" onchange="handleJourneysImport(event)">
                                <div class="flex flex-col sm:flex-row gap-3">
                                    <button onclick="document.getElementById('journeys-import-input').click()" class="flex-1 px-4 py-3 bg-emerald-500 hover:bg-emerald-600 text-white font-semibold rounded transition-colors">
                                        <i class="fas fa-file-upload mr-2"></i> Selecionar arquivo Excel
                                    </button>
                                    <button onclick="downloadJourneysTemplate()" class="flex-1 px-4 py-3 bg-slate-200 hover:bg-slate-300 text-slate-800 font-semibold rounded transition-colors">
                                        <i class="fas fa-download mr-2"></i> Baixar modelo em branco
                                    </button>
                                </div>
                                <p class="text-xs text-slate-500 mt-3">Formatos aceitos: .xlsx, .xls. O arquivo deve seguir o padrão gerado pelo próprio sistema.</p>
                            </div>

                            <div class="bg-slate-50 border border-slate-200 rounded-lg p-4 text-xs text-slate-600 space-y-2">
                                <p><strong>Dica:</strong> você pode exportar seus dados atuais, atualizar diretamente no Excel e importar novamente para acelerar o cadastro.</p>
                                <p>Dados importados substituem registros com o mesmo identificador. Campos vazios não sobrescrevem informações já existentes.</p>
                            </div>
                        </div>
                        <div class="p-6 border-t border-slate-200 bg-slate-50 flex justify-end">
                            <button onclick="closeJourneysImportModal()" class="px-4 py-2 bg-white border border-slate-300 hover:bg-slate-100 text-slate-700 font-semibold rounded transition-colors">
                                Fechar
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        function renderJourneysImportResultModal() {
            return `
                <div class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center overflow-auto modal-overlay" onclick="if(event.target === this) closeJourneysImportResultModal()">
                    <div class="bg-white rounded-lg shadow-2xl max-w-3xl w-full m-4 modal-panel" onclick="event.stopPropagation()">
                        <div class="sticky top-0 bg-white border-b border-slate-200 p-6 flex items-center justify-between">
                            <div>
                                <h2 class="text-2xl font-bold text-slate-900">Resumo da Importação</h2>
                                <p class="text-sm text-slate-600 mt-1">Copie abaixo os detalhes para compartilhar ou analisar.</p>
                            </div>
                            <button onclick="closeJourneysImportResultModal()" class="p-2 hover:bg-slate-100 rounded-lg transition-colors" aria-label="Fechar modal de resumo">
                                <i class="fas fa-times text-slate-600 text-xl"></i>
                            </button>
                        </div>
                        <div class="p-6 space-y-4 overflow-y-auto max-h-[calc(85vh-160px)]">
                            <textarea id="journeys-import-summary-textarea" class="w-full h-64 md:h-80 border border-slate-300 rounded-lg p-4 text-sm font-mono text-slate-700 bg-slate-50 focus:ring-2 focus:ring-blue-200" readonly>${journeysImportSummary.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</textarea>
                            <p class="text-xs text-slate-500">Use o botão "Copiar resumo" ou selecione o texto manualmente (Ctrl+C / Cmd+C).</p>
                        </div>
                        <div class="p-6 border-t border-slate-200 bg-slate-50 flex flex-col md:flex-row gap-3">
                            <button onclick="copyJourneysImportSummary()" class="flex-1 px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white font-semibold rounded transition-colors">
                                <i class="fas fa-copy mr-2"></i> Copiar resumo
                            </button>
                            <button onclick="closeJourneysImportResultModal()" class="px-4 py-2 bg-white border border-slate-300 hover:bg-slate-100 text-slate-700 font-semibold rounded transition-colors">
                                Fechar
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        function renderIncidentOverviewModal() {
            const journey = journeys.find(j => j.id === incidentOverviewJourneyId);
            if (!journey) return '';

            const bounds = getJourneyEventFilterBounds();
            const incidents = getJourneyIncidents(journey, bounds);
            const pillarNames = {
                availability: 'Disponibilidade',
                quality: 'Qualidade',
                security: 'Segurança',
                performance: 'Performance'
            };

            const pillarCounts = incidents.reduce((acc, incident) => {
                const key = incident.pillar || 'não informado';
                acc[key] = (acc[key] || 0) + 1;
                return acc;
            }, {});

            const attributeCounts = incidents.reduce((acc, incident) => {
                if (Array.isArray(incident.attributes)) {
                    incident.attributes.forEach(attr => {
                        const key = attr || 'Não informado';
                        acc[key] = (acc[key] || 0) + 1;
                    });
                }
                return acc;
            }, {});

            const topEntries = (countsObj, limit = 3) => Object.entries(countsObj)
                .sort((a, b) => b[1] - a[1])
                .slice(0, limit);

            const topPillars = topEntries(pillarCounts);
            const topAttributes = topEntries(attributeCounts);

            return `
                <div class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center overflow-auto modal-overlay" onclick="if(event.target === this) closeIncidentOverview()">
                    <div class="bg-white rounded-lg shadow-2xl max-w-4xl w-full m-4 modal-panel" onclick="event.stopPropagation()">
                        <div class="bg-white border-b border-slate-200 p-6 flex items-center justify-between sticky top-0">
                            <div>
                                <h2 class="text-2xl font-bold text-slate-900">Overview de Incidentes - Quebra de Serviço</h2>
                                <p class="text-sm text-slate-600 mt-1">${journey.name} (${journey.acronym})</p>
                            </div>
                            <button onclick="closeIncidentOverview()" class="p-2 hover:bg-slate-100 rounded-lg transition-colors">
                                <i class="fas fa-times text-slate-600 text-xl"></i>
                            </button>
                        </div>

                        <div class="p-6 space-y-6 overflow-y-auto max-h-[calc(85vh-120px)]">
                            <div class="grid grid-cols-3 gap-4">
                                <div class="bg-red-50 rounded-lg p-4 border border-red-200">
                                    <p class="text-xs text-red-600 mb-2 font-semibold">TOTAL DE INCIDENTES</p>
                                    <div class="text-4xl font-bold text-red-700">${incidents.length}</div>
                                </div>
                                <div class="bg-yellow-50 rounded-lg p-4 border border-yellow-200">
                                    <p class="text-xs text-yellow-600 mb-2 font-semibold">PILAR MAIS IMPACTADO</p>
                                    <div class="text-lg font-bold text-yellow-700">${topPillars.length > 0 ? pillarNames[topPillars[0][0]] : 'N/A'}</div>
                                    <p class="text-xs text-yellow-600 mt-1">${topPillars.length > 0 ? topPillars[0][1] : 0} incidente(s)</p>
                                </div>
                                <div class="bg-blue-50 rounded-lg p-4 border border-blue-200">
                                    <p class="text-xs text-blue-600 mb-2 font-semibold">ATRIBUTO CRÍTICO</p>
                                    <div class="text-lg font-bold text-blue-700">${topAttributes.length > 0 ? topAttributes[0][0] : 'N/A'}</div>
                                    <p class="text-xs text-blue-600 mt-1">${topAttributes.length > 0 ? topAttributes[0][1] : 0} ocorrência(s)</p>
                                </div>
                            </div>

                            <div class="border-t border-slate-200 pt-6">
                                <h3 class="font-semibold text-slate-900 mb-4">Lista de Incidentes</h3>
                                <div class="space-y-3">
                                    ${incidents.map(incident => {
                                        const pillarName = pillarNames[incident.pillar] || 'N/A';
                                        return `
                                            <div class="bg-slate-50 rounded-lg p-4 border border-slate-200">
                                                <div class="flex items-start justify-between mb-3">
                                                    <div>
                                                        <h4 class="font-semibold text-slate-900">${incident.incidentNumber}</h4>
                                                        <p class="text-sm text-slate-600 mt-1">${incident.description}</p>
                                                    </div>
                                                    <div class="flex items-center gap-2">
                                                        <button onclick="openEditEvent('${journey.id}', '${incident.id}')" class="p-2 hover:bg-blue-100 rounded transition-colors text-blue-600" title="Editar incidente">
                                                            <i class="fas fa-edit"></i>
                                                        </button>
                                                        <button onclick="deleteEvent('${journey.id}', '${incident.id}')" class="p-2 hover:bg-red-100 rounded transition-colors text-red-600" title="Excluir incidente">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                    </div>
                                                </div>
                                                <div class="flex flex-wrap gap-2 mt-3">
                                                    <span class="tag tag-mttr"><i class="fas fa-hourglass-half mr-1"></i> MTTR: ${incident.mttr}</span>
                                                    <span class="tag tag-pillar"><i class="fas fa-cube mr-1"></i> ${pillarName}</span>
                                                    ${incident.attributes && incident.attributes.length > 0 ? incident.attributes.map(attr => `
                                                        <span class="tag tag-attribute"><i class="fas fa-check-circle mr-1"></i> ${attr}</span>
                                                    `).join('') : ''}
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>

                            ${topPillars.length > 0 || topAttributes.length > 0 ? `
                                <div class="border-t border-slate-200 pt-6">
                                    <h3 class="font-semibold text-slate-900 mb-4">Pilares e Atributos Campeões</h3>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div class="bg-yellow-50 rounded-lg p-4 border border-yellow-200">
                                            <h4 class="font-semibold text-yellow-900 mb-3">Pilares Mais Impactados</h4>
                                            <div class="space-y-2">
                                                ${topPillars.map((pillar, idx) => `
                                                    <div class="flex items-center justify-between">
                                                        <span class="text-sm text-yellow-800">${idx + 1}. ${pillarNames[pillar[0]]}</span>
                                                        <span class="px-2 py-1 bg-yellow-200 text-yellow-900 text-xs font-semibold rounded">${pillar[1]} incidente(s)</span>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                        <div class="bg-blue-50 rounded-lg p-4 border border-blue-200">
                                            <h4 class="font-semibold text-blue-900 mb-3">Atributos Críticos</h4>
                                            <div class="space-y-2">
                                                ${topAttributes.map((attr, idx) => `
                                                    <div class="flex items-center justify-between">
                                                        <span class="text-sm text-blue-800">${idx + 1}. ${attr[0]}</span>
                                                        <span class="px-2 py-1 bg-blue-200 text-blue-900 text-xs font-semibold rounded">${attr[1]} ocorrência(s)</span>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            ` : ''}

                            <div class="flex gap-3 pt-4 border-t border-slate-200">
                                <button onclick="closeIncidentOverview()" class="flex-1 px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white font-semibold rounded transition-colors">
                                    <i class="fas fa-check mr-2"></i> Fechar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        function renderRiskOverviewModal() {
            const journey = journeys.find(j => j.id === riskOverviewJourneyId);
            if (!journey) return '';

            const bounds = getJourneyEventFilterBounds();
            const risks = getJourneyRisks(journey, bounds);

            const completedCount = risks.filter(r => r.isCompleted).length;
            const overdueCount = risks.filter(r => r.isOverdue).length;
            const urgentCount = risks.filter(r => r.priority === 'Urgente' || r.priority === 'Alta').length;

            const avgProgress = risks.length > 0
                ? Math.round(risks.reduce((sum, r) => sum + (r.progress || 0), 0) / risks.length)
                : 0;

            return `
                <div class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center overflow-auto modal-overlay" onclick="if(event.target === this) closeRiskOverview()">
                    <div class="bg-white rounded-lg shadow-2xl max-w-4xl w-full m-4 modal-panel" onclick="event.stopPropagation()">
                        <div class="bg-white border-b border-slate-200 p-6 flex items-center justify-between sticky top-0">
                            <div>
                                <h2 class="text-2xl font-bold text-slate-900">Overview de Riscos</h2>
                                <p class="text-sm text-slate-600 mt-1">${journey.name} (${journey.acronym})</p>
                            </div>
                            <button onclick="closeRiskOverview()" class="p-2 hover:bg-slate-100 rounded-lg transition-colors">
                                <i class="fas fa-times text-slate-600 text-xl"></i>
                            </button>
                        </div>

                        <div class="p-6 space-y-6 overflow-y-auto max-h-[calc(85vh-120px)]">
                            <div class="grid grid-cols-4 gap-4">
                                <div class="bg-yellow-50 rounded-lg p-4 border border-yellow-200">
                                    <p class="text-xs text-yellow-600 mb-2 font-semibold">TOTAL DE RISCOS</p>
                                    <div class="text-4xl font-bold text-yellow-700">${risks.length}</div>
                                </div>
                                <div class="bg-green-50 rounded-lg p-4 border border-green-200">
                                    <p class="text-xs text-green-600 mb-2 font-semibold">CONCLUÍDOS</p>
                                    <div class="text-4xl font-bold text-green-700">${completedCount}</div>
                                </div>
                                <div class="bg-red-50 rounded-lg p-4 border border-red-200">
                                    <p class="text-xs text-red-600 mb-2 font-semibold">ATRASADOS</p>
                                    <div class="text-4xl font-bold text-red-700">${overdueCount}</div>
                                </div>
                                <div class="bg-orange-50 rounded-lg p-4 border border-orange-200">
                                    <p class="text-xs text-orange-600 mb-2 font-semibold">URGENTES</p>
                                    <div class="text-4xl font-bold text-orange-700">${urgentCount}</div>
                                </div>
                            </div>

                            <div class="bg-blue-50 rounded-lg p-4 border border-blue-200">
                                <p class="text-xs text-blue-600 mb-2 font-semibold">PROGRESSO MÉDIO</p>
                                <div class="flex items-center gap-3">
                                    <div class="flex-1 h-6 bg-blue-200 rounded-full overflow-hidden">
                                        <div class="h-full bg-blue-600 rounded-full transition-all" style="width: ${avgProgress}%"></div>
                                    </div>
                                    <span class="text-lg font-bold text-blue-700">${avgProgress}%</span>
                                </div>
                            </div>

                            <div class="border-t border-slate-200 pt-6">
                                <h3 class="font-semibold text-slate-900 mb-4">Lista de Riscos</h3>
                                <div class="space-y-3">
                                    ${risks.length > 0 ? risks.map(risk => {
                                        const priorityColors = {
                                            'Urgente': 'bg-red-100 text-red-800',
                                            'Alta': 'bg-orange-100 text-orange-800',
                                            'Média': 'bg-yellow-100 text-yellow-800',
                                            'Baixa': 'bg-blue-100 text-blue-800'
                                        };
                                        const priorityColor = priorityColors[risk.priority] || 'bg-gray-100 text-gray-800';
                                        
                                        return `
                                            <div class="bg-slate-50 rounded-lg p-4 border border-slate-200">
                                                <div class="flex items-start justify-between mb-3">
                                                    <div class="flex-1">
                                                        <div class="flex items-center gap-2 mb-1">
                                                            <h4 class="font-semibold text-slate-900">${risk.taskName}</h4>
                                                            ${risk.priority ? `<span class="px-2 py-1 rounded text-xs font-semibold ${priorityColor}">${risk.priority}</span>` : ''}
                                                            ${risk.isCompleted ? '<span class="px-2 py-1 rounded text-xs font-semibold bg-green-100 text-green-800">Concluído</span>' : ''}
                                                            ${risk.isOverdue ? '<span class="px-2 py-1 rounded text-xs font-semibold bg-red-100 text-red-800">Atrasado</span>' : ''}
                                                        </div>
                                                        <p class="text-xs text-slate-500 mt-1"><strong>ID:</strong> ${risk.plannerId}</p>
                                                        ${risk.description ? `<p class="text-sm text-slate-600 mt-2">${risk.description}</p>` : ''}
                                                    </div>
                                                    <div class="flex items-center gap-2">
                                                        <button onclick="openEditEvent('${journey.id}', '${risk.id}')" class="p-2 hover:bg-blue-100 rounded transition-colors text-blue-600" title="Editar risco">
                                                            <i class="fas fa-edit"></i>
                                                        </button>
                                                        <button onclick="deleteEvent('${journey.id}', '${risk.id}')" class="p-2 hover:bg-red-100 rounded transition-colors text-red-600" title="Excluir risco">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                    </div>
                                                </div>
                                                <div class="grid grid-cols-2 gap-4 text-sm">
                                                    ${risk.progress !== undefined ? `
                                                        <div>
                                                            <span class="text-slate-600">Progresso:</span>
                                                            <div class="flex items-center gap-2 mt-1">
                                                                <div class="flex-1 h-3 bg-slate-200 rounded-full overflow-hidden">
                                                                    <div class="h-full bg-blue-600 rounded-full transition-all" style="width: ${risk.progress}%"></div>
                                                                </div>
                                                                <span class="text-xs font-bold text-slate-700">${risk.progress}%</span>
                                                            </div>
                                                        </div>
                                                    ` : ''}
                                                    ${risk.assignedTo ? `<div><span class="text-slate-600">Atribuído a:</span> <span class="font-semibold text-slate-800">${risk.assignedTo}</span></div>` : ''}
                                                    ${risk.dueDate ? `<div><span class="text-slate-600">Prazo:</span> <span class="font-semibold text-slate-800">${new Date(risk.dueDate).toLocaleDateString('pt-BR')}</span></div>` : ''}
                                                    ${risk.createdBy ? `<div><span class="text-slate-600">Criado por:</span> <span class="font-semibold text-slate-800">${risk.createdBy}</span></div>` : ''}
                                                </div>
                                                ${risk.checklist ? `
                                                    <div class="mt-3 pt-3 border-t border-slate-200">
                                                        <p class="text-xs text-slate-600 mb-2 font-semibold">Checklist:</p>
                                                        <div class="text-sm text-slate-700 whitespace-pre-line">${risk.checklist}</div>
                                                    </div>
                                                ` : ''}
                                                ${risk.labels ? `
                                                    <div class="flex flex-wrap gap-2 mt-3">
                                                        ${(typeof risk.labels === 'string' ? risk.labels.split(/[,;]/) : []).map(label => `<span class="px-2 py-1 bg-purple-100 text-purple-800 rounded text-xs">${label.trim()}</span>`).join('')}
                                                    </div>
                                                ` : ''}
                                            </div>
                                        `;
                                    }).join('') : '<p class="text-center text-slate-500 italic">Nenhum risco cadastrado para esta jornada.</p>'}
                                </div>
                            </div>

                            <div class="flex gap-3 pt-4 border-t border-slate-200">
                                <button onclick="closeRiskOverview()" class="flex-1 px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white font-semibold rounded transition-colors">
                                    <i class="fas fa-check mr-2"></i> Fechar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        function renderEventModal() {
            const journey = journeys.find(j => j.id === selectedEventJourneyId);
            if (!journey) return '';

            return `
                <div class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center overflow-auto modal-overlay" onclick="if(event.target === this) closeEventModal()">
                    <div class="bg-white rounded-lg shadow-2xl max-w-2xl w-full m-4 edit-modal" onclick="event.stopPropagation()">
                        <div class="sticky top-0 bg-white border-b border-slate-200 p-6 flex items-center justify-between">
                            <h2 class="text-2xl font-bold text-slate-900">Adicionar Evento - ${journey.name}</h2>
                            <button onclick="closeEventModal()" class="p-2 hover:bg-slate-100 rounded-lg transition-colors">
                                <i class="fas fa-times text-slate-600 text-xl"></i>
                            </button>
                        </div>
                        <div class="p-6 space-y-4 overflow-y-auto max-h-[calc(85vh-120px)]">
                            ${!selectedEventCategory ? `
                                <div>
                                    <label class="block text-sm font-semibold text-slate-700 mb-3">Selecione a Categoria do Evento</label>
                                    <div class="grid grid-cols-2 gap-3">
                                        ${eventCategories.map(category => {
                                            const isSupported = supportedJourneyEventCategories.includes(category);
                                            const icon = category === EVENT_CATEGORY_INCIDENT_SERVICE
                                                ? 'bolt'
                                                : category === EVENT_CATEGORY_INCIDENT_FUNCTIONAL
                                                    ? 'headset'
                                                    : category === EVENT_CATEGORY_ALERT
                                                        ? 'bell'
                                                        : category === EVENT_CATEGORY_OBSOLESCENCE
                                                            ? 'clock-rotate-left'
                                                            : category === EVENT_CATEGORY_VULNERABILITY
                                                                ? 'shield-halved'
                                                    : category === EVENT_CATEGORY_RISK
                                                        ? 'triangle-exclamation'
                                                        : 'circle-question';
                                            const buttonClasses = `px-4 py-3 border-2 rounded-lg transition-colors text-sm font-semibold ${isSupported ? 'border-slate-300 hover:border-blue-500 text-slate-700 hover:text-blue-600 cursor-pointer' : 'border-slate-200 text-slate-400 cursor-not-allowed bg-slate-100'}`;
                                            const action = isSupported ? `onclick="selectEventCategory('${category}')"` : 'disabled';
                                            return `
                                        <button ${action} class="${buttonClasses}">
                                            <i class="fas fa-${icon} mr-2"></i>
                                                ${category}
                                            </button>
                                            `;
                                        }).join('')}
                                    </div>
                                </div>
                            ` : ''}

                            ${selectedEventCategory === EVENT_CATEGORY_INCIDENT_SERVICE && showIncidentForm ? `
                                <div class="space-y-4">
                                    <h3 class="font-semibold text-slate-900">Incidente - Quebra de Serviço</h3>
                                    
                                    <div>
                                        <label class="block text-sm font-semibold text-slate-700 mb-2">Nr do Incidente *</label>
                                        <input type="text" id="incident-number" placeholder="Ex: INC-2024-001" class="w-full">
                                    </div>

                                    <div>
                                        <label class="block text-sm font-semibold text-slate-700 mb-2">Quando Ocorreu *</label>
                                        <input type="datetime-local" id="incident-date" class="w-full">
                                    </div>

                                    <div>
                                        <label class="block text-sm font-semibold text-slate-700 mb-2">MTTR (Tempo de Resolução Total) *</label>
                                        <input type="text" id="incident-mttr" placeholder="Ex: 2h 30min" class="w-full">
                                    </div>

                                    <div>
                                        <label class="block text-sm font-semibold text-slate-700 mb-2">Descritivo sobre o Cenário *</label>
                                        <textarea id="incident-description" placeholder="Descreva o que aconteceu..." rows="3" class="w-full"></textarea>
                                    </div>

                                    <div>
                                        <label class="block text-sm font-semibold text-slate-700 mb-2">Qual Jornada Impactou?</label>
                                        <select id="incident-journey" class="w-full">
                                            <option value="">Selecione uma jornada...</option>
                                            ${journeys.map(j => `<option value="${j.id}">${j.name}</option>`).join('')}
                                        </select>
                                    </div>

                                    <div>
                                        <label class="block text-sm font-semibold text-slate-700 mb-2">Há Risco Relacionado?</label>
                                        <input type="text" id="incident-risk" placeholder="Descreva o risco..." class="w-full">
                                    </div>

                                    <div>
                                        <label class="block text-sm font-semibold text-slate-700 mb-2">Classificação de Origem</label>
                                        <select id="incident-origin" class="w-full">
                                            <option value="">Selecione a origem...</option>
                                            ${incidentOrigins.map(origin => `<option value="${origin}">${origin}</option>`).join('')}
                                        </select>
                                    </div>

                                    <div>
                                        <label class="block text-sm font-semibold text-slate-700 mb-2">Como Podemos Evitar?</label>
                                        <textarea id="incident-prevention" placeholder="Descreva as ações preventivas..." rows="2" class="w-full"></textarea>
                                    </div>

                                    <div>
                                        <label class="block text-sm font-semibold text-slate-700 mb-2">Lições Aprendidas</label>
                                        <textarea id="incident-lessons" placeholder="Descreva as lições aprendidas..." rows="2" class="w-full"></textarea>
                                    </div>

                                    <div>
                                        <label class="block text-sm font-semibold text-slate-700 mb-2">Pilar de Engenharia Relacionado</label>
                                        <select id="incident-pillar" class="w-full">
                                            <option value="">Selecione um pilar...</option>
                                            <option value="availability">Disponibilidade</option>
                                            <option value="quality">Qualidade</option>
                                            <option value="security">Segurança</option>
                                            <option value="performance">Performance</option>
                                        </select>
                                    </div>

                                    <div>
                                        <label class="block text-sm font-semibold text-slate-700 mb-3">Quais Atributos de Maturidade Podemos Evoluir?</label>
                                        <div class="space-y-2 max-h-40 overflow-y-auto">
                                            ${Object.entries(pillarAttributes).flatMap(([pillar, attrs]) => 
                                                Object.keys(attrs).map(attr => `
                                                    <label class="flex items-center gap-2 cursor-pointer">
                                                        <input type="checkbox" name="incident-attributes" value="${attr}" class="w-4 h-4">
                                                        <span class="text-sm text-slate-700">${attr}</span>
                                                    </label>
                                                `)
                                            ).join('')}
                                        </div>
                                    </div>

                                    <div class="flex gap-3 pt-4 border-t border-slate-200">
                                        <button onclick="saveIncident()" class="flex-1 px-4 py-2 bg-green-500 hover:bg-green-600 text-white font-semibold rounded transition-colors">
                                            <i class="fas fa-save mr-2"></i> Salvar Incidente
                                        </button>
                                        <button onclick="selectEventCategory(null); showIncidentForm = false; render()" class="flex-1 px-4 py-2 bg-slate-300 hover:bg-slate-400 text-slate-700 font-semibold rounded transition-colors">
                                            <i class="fas fa-arrow-left mr-2"></i> Voltar
                                        </button>
                                        <button onclick="closeEventModal()" class="flex-1 px-4 py-2 bg-red-300 hover:bg-red-400 text-red-700 font-semibold rounded transition-colors">
                                            <i class="fas fa-times mr-2"></i> Cancelar
                                        </button>
                                    </div>
                                </div>
                            ` : ''}
                            ${selectedEventCategory === EVENT_CATEGORY_INCIDENT_FUNCTIONAL && showFunctionalIncidentForm ? `
                                <div class="space-y-4">
                                    <h3 class="font-semibold text-slate-900">Incidente Funcional</h3>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-semibold text-slate-700 mb-2">Nr do Incidente *</label>
                                            <input type="text" id="functional-incident-number" placeholder="Ex: FIC-2024-001" class="w-full">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-semibold text-slate-700 mb-2">Sigla Relacionada</label>
                                            <input type="text" id="functional-incident-acronym" placeholder="Ex: PAY" class="w-full">
                                        </div>
                                    </div>

                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                            <label class="block text-sm font-semibold text-slate-700 mb-2">Data de Criação *</label>
                                            <input type="datetime-local" id="functional-incident-created-at" class="w-full">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-semibold text-slate-700 mb-2">Data de Resolução</label>
                                            <input type="datetime-local" id="functional-incident-resolved-at" class="w-full">
                                        </div>
                                    </div>

                                    <div>
                                        <label class="block text-sm font-semibold text-slate-700 mb-2">Descrição Curta *</label>
                                        <input type="text" id="functional-incident-short-description" placeholder="Resumo do incidente" class="w-full">
                                    </div>

                                    <div>
                                        <label class="block text-sm font-semibold text-slate-700 mb-2">Descrição Detalhada</label>
                                        <textarea id="functional-incident-description" placeholder="Conte mais detalhes sobre o incidente funcional..." rows="4" class="w-full"></textarea>
                                    </div>

                                    <div>
                                        <label class="block text-sm font-semibold text-slate-700 mb-2">Notas de Resolução</label>
                                        <textarea id="functional-incident-resolution-notes" placeholder="Observações sobre a resolução" rows="3" class="w-full"></textarea>
                                    </div>

                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-semibold text-slate-700 mb-2">Tipo de Resolução</label>
                                            <input type="text" id="functional-incident-resolution-type" placeholder="Ex: Workaround, Correção definitiva" class="w-full">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-semibold text-slate-700 mb-2">Classificação</label>
                                            <input type="text" id="functional-incident-classification" placeholder="Ex: Funcional, Interface" class="w-full">
                                        </div>
                                    </div>

                                    <div>
                                        <label class="block text-sm font-semibold text-slate-700 mb-2">Jornada Afetada</label>
                                        <select id="functional-incident-journey" class="w-full">
                                            <option value="">Selecione uma jornada...</option>
                                            ${journeys.map(j => `<option value="${j.id}">${j.name}</option>`).join('')}
                                        </select>
                                    </div>

                                    <div class="flex gap-3 pt-4 border-t border-slate-200">
                                        <button onclick="saveFunctionalIncident()" class="flex-1 px-4 py-2 bg-purple-500 hover:bg-purple-600 text-white font-semibold rounded transition-colors">
                                            <i class="fas fa-save mr-2"></i> Salvar Incidente Funcional
                                        </button>
                                        <button onclick="selectEventCategory(null); showFunctionalIncidentForm = false; render()" class="flex-1 px-4 py-2 bg-slate-300 hover:bg-slate-400 text-slate-700 font-semibold rounded transition-colors">
                                            <i class="fas fa-arrow-left mr-2"></i> Voltar
                                        </button>
                                        <button onclick="closeEventModal()" class="flex-1 px-4 py-2 bg-red-300 hover:bg-red-400 text-red-700 font-semibold rounded transition-colors">
                                            <i class="fas fa-times mr-2"></i> Cancelar
                                        </button>
                                    </div>
                                </div>
                            ` : ''}
                            ${selectedEventCategory === EVENT_CATEGORY_ALERT && showAlertForm ? `
                                <div class="space-y-4">
                                    <h3 class="font-semibold text-slate-900">Alerta Operacional</h3>

                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                            <label class="block text-sm font-semibold text-slate-700 mb-2">Identificador do Alerta *</label>
                                            <input type="text" id="alert-id" placeholder="Ex: ALERT-12345" class="w-full">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-semibold text-slate-700 mb-2">Fonte / Origem *</label>
                                            <select id="alert-source" class="w-full">
                                                <option value="">Selecione...</option>
                                                ${alertSourceOptions.map(option => `<option value="${option}">${option}</option>`).join('')}
                                            </select>
                                        </div>
                                    </div>

                                    <div>
                                        <label class="block text-sm font-semibold text-slate-700 mb-2">Título / Descrição Curta *</label>
                                        <input type="text" id="alert-title" placeholder="Resumo do alerta" class="w-full">
                                    </div>

                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-semibold text-slate-700 mb-2">Severidade</label>
                                            <select id="alert-severity" class="w-full">
                                                <option value="">Selecione...</option>
                                                ${alertSeverityOptions.map(option => `<option value="${option}">${option}</option>`).join('')}
                                        </select>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-semibold text-slate-700 mb-2">Status</label>
                                            <select id="alert-status" class="w-full">
                                                <option value="">Selecione...</option>
                                                ${alertStatusOptions.map(option => `<option value="${option}">${option}</option>`).join('')}
                                            </select>
                                        </div>
                                    </div>

                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                            <label class="block text-sm font-semibold text-slate-700 mb-2">Abertura</label>
                                            <input type="datetime-local" id="alert-opened-at" class="w-full">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-semibold text-slate-700 mb-2">Fechamento</label>
                                            <input type="datetime-local" id="alert-closed-at" class="w-full">
                                        </div>
                                    </div>

                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                            <label class="block text-sm font-semibold text-slate-700 mb-2">Serviço / Componente Impactado</label>
                                            <input type="text" id="alert-impacted-service" placeholder="Ex: API de Pagamentos" class="w-full">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-semibold text-slate-700 mb-2">Responsável</label>
                                            <input type="text" id="alert-owner" placeholder="Nome do responsável" class="w-full">
                                        </div>
                                    </div>

                                    <div>
                                        <label class="block text-sm font-semibold text-slate-700 mb-2">Tags / Labels</label>
                                        <input type="text" id="alert-tags" placeholder="Separar por ;" class="w-full">
                                    </div>

                                    <div>
                                        <label class="block text-sm font-semibold text-slate-700 mb-2">URL de Referência</label>
                                        <input type="url" id="alert-url" placeholder="https://service-now/registro" class="w-full">
                                    </div>

                                    <div>
                                        <label class="block text-sm font-semibold text-slate-700 mb-2">Observações / Ações Adotadas</label>
                                        <textarea id="alert-notes" rows="3" placeholder="Detalhes relevantes sobre o tratamento do alerta" class="w-full"></textarea>
                                    </div>

                                    <div class="flex gap-3 pt-4 border-t border-slate-200">
                                        <button onclick="saveAlert()" class="flex-1 px-4 py-2 bg-amber-500 hover:bg-amber-600 text-white font-semibold rounded transition-colors">
                                            <i class="fas fa-save mr-2"></i> Salvar Alerta
                                        </button>
                                        <button onclick="selectEventCategory(null); showAlertForm = false; render()" class="flex-1 px-4 py-2 bg-slate-300 hover:bg-slate-400 text-slate-700 font-semibold rounded transition-colors">
                                            <i class="fas fa-arrow-left mr-2"></i> Voltar
                                        </button>
                                        <button onclick="closeEventModal()" class="flex-1 px-4 py-2 bg-red-300 hover:bg-red-400 text-red-700 font-semibold rounded transition-colors">
                                            <i class="fas fa-times mr-2"></i> Cancelar
                                        </button>
                                    </div>
                                </div>
                            ` : ''}
                            ${selectedEventCategory === EVENT_CATEGORY_OBSOLESCENCE && showObsolescenceForm ? `
                                <div class="space-y-4">
                                    <h3 class="font-semibold text-slate-900">Item de Obsolescência</h3>

                                    <div>
                                        <label class="block text-sm font-semibold text-slate-700 mb-2">Componente / Produto *</label>
                                        <input type="text" id="obsolescence-component" placeholder="Ex: SQL Server 2012" class="w-full">
                                    </div>

                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-semibold text-slate-700 mb-2">Fornecedor / Tecnologia</label>
                                            <input type="text" id="obsolescence-vendor" placeholder="Ex: Microsoft" class="w-full">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-semibold text-slate-700 mb-2">Status</label>
                                            <select id="obsolescence-status" class="w-full">
                                                <option value="">Selecione...</option>
                                                ${obsolescenceStatusOptions.map(option => `<option value="${option}">${option}</option>`).join('')}
                                            </select>
                                        </div>
                                    </div>

                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-semibold text-slate-700 mb-2">Versão Atual</label>
                                            <input type="text" id="obsolescence-current-version" class="w-full">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-semibold text-slate-700 mb-2">Versão Recomendada</label>
                                            <input type="text" id="obsolescence-target-version" class="w-full">
                                        </div>
                                    </div>

                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                            <label class="block text-sm font-semibold text-slate-700 mb-2">Fim de Suporte (EoS/EoL)</label>
                                            <input type="date" id="obsolescence-end-of-support" class="w-full">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-semibold text-slate-700 mb-2">Responsável</label>
                                            <input type="text" id="obsolescence-owner" placeholder="Nome do responsável" class="w-full">
                                        </div>
                                    </div>

                                    <div>
                                        <label class="block text-sm font-semibold text-slate-700 mb-2">Impacto Operacional</label>
                                        <textarea id="obsolescence-impact" rows="2" placeholder="Descreva o impacto gerado pela obsolescência" class="w-full"></textarea>
                                    </div>

                                    <div>
                                        <label class="block text-sm font-semibold text-slate-700 mb-2">Plano de Remediação / Próxima Ação</label>
                                        <textarea id="obsolescence-remediation-plan" rows="2" placeholder="Ex: Atualizar para versão suportada no próximo quarter" class="w-full"></textarea>
                                    </div>

                                    <div>
                                        <label class="block text-sm font-semibold text-slate-700 mb-2">Observações</label>
                                        <textarea id="obsolescence-notes" rows="3" class="w-full"></textarea>
                                    </div>

                                    <div class="flex gap-3 pt-4 border-t border-slate-200">
                                        <button onclick="saveObsolescence()" class="flex-1 px-4 py-2 bg-slate-600 hover:bg-slate-700 text-white font-semibold rounded transition-colors">
                                            <i class="fas fa-save mr-2"></i> Salvar Item
                                        </button>
                                        <button onclick="selectEventCategory(null); showObsolescenceForm = false; render()" class="flex-1 px-4 py-2 bg-slate-300 hover:bg-slate-400 text-slate-700 font-semibold rounded transition-colors">
                                            <i class="fas fa-arrow-left mr-2"></i> Voltar
                                        </button>
                                        <button onclick="closeEventModal()" class="flex-1 px-4 py-2 bg-red-300 hover:bg-red-400 text-red-700 font-semibold rounded transition-colors">
                                            <i class="fas fa-times mr-2"></i> Cancelar
                                        </button>
                                    </div>
                                </div>
                            ` : ''}
                            ${selectedEventCategory === EVENT_CATEGORY_VULNERABILITY && showVulnerabilityForm ? `
                                <div class="space-y-4">
                                    <h3 class="font-semibold text-slate-900">Vulnerabilidade</h3>

                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-semibold text-slate-700 mb-2">Identificador (CVE ou Ticket) *</label>
                                            <input type="text" id="vulnerability-identifier" placeholder="Ex: CVE-2024-1234" class="w-full">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-semibold text-slate-700 mb-2">Severidade</label>
                                            <select id="vulnerability-severity" class="w-full">
                                                <option value="">Selecione...</option>
                                                ${vulnerabilitySeverityOptions.map(option => `<option value="${option}">${option}</option>`).join('')}
                                            </select>
                                        </div>
                                    </div>

                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                            <label class="block text-sm font-semibold text-slate-700 mb-2">Pontuação CVSS</label>
                                            <input type="number" step="0.1" min="0" max="10" id="vulnerability-cvss" placeholder="Ex: 7.5" class="w-full">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-semibold text-slate-700 mb-2">Status</label>
                                            <select id="vulnerability-status" class="w-full">
                                                <option value="">Selecione...</option>
                                                ${vulnerabilityStatusOptions.map(option => `<option value="${option}">${option}</option>`).join('')}
                                        </select>
                                        </div>
                                    </div>

                                    <div>
                                        <label class="block text-sm font-semibold text-slate-700 mb-2">Componente / Serviço Afetado *</label>
                                        <input type="text" id="vulnerability-service" placeholder="Ex: Serviço de Autenticação" class="w-full">
                                    </div>

                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-semibold text-slate-700 mb-2">Data de Descoberta</label>
                                            <input type="date" id="vulnerability-discovered-at" class="w-full">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-semibold text-slate-700 mb-2">Prazo para Correção</label>
                                            <input type="date" id="vulnerability-due-at" class="w-full">
                                        </div>
                                    </div>

                                    <div>
                                        <label class="block text-sm font-semibold text-slate-700 mb-2">Responsável</label>
                                        <input type="text" id="vulnerability-owner" placeholder="Nome do responsável" class="w-full">
                                    </div>

                                    <div>
                                        <label class="block text-sm font-semibold text-slate-700 mb-2">Notas / Evidências / Ações Corretivas</label>
                                        <textarea id="vulnerability-notes" rows="3" placeholder="Detalhes técnicos, evidências ou ações tomadas" class="w-full"></textarea>
                                    </div>

                                    <div class="flex gap-3 pt-4 border-t border-slate-200">
                                        <button onclick="saveVulnerability()" class="flex-1 px-4 py-2 bg-rose-500 hover:bg-rose-600 text-white font-semibold rounded transition-colors">
                                            <i class="fas fa-save mr-2"></i> Salvar Vulnerabilidade
                                        </button>
                                        <button onclick="selectEventCategory(null); showVulnerabilityForm = false; render()" class="flex-1 px-4 py-2 bg-slate-300 hover:bg-slate-400 text-slate-700 font-semibold rounded transition-colors">
                                            <i class="fas fa-arrow-left mr-2"></i> Voltar
                                        </button>
                                        <button onclick="closeEventModal()" class="flex-1 px-4 py-2 bg-red-300 hover:bg-red-400 text-red-700 font-semibold rounded transition-colors">
                                            <i class="fas fa-times mr-2"></i> Cancelar
                                        </button>
                                    </div>
                                </div>
                            ` : ''}
                            ${selectedEventCategory === EVENT_CATEGORY_RISK && showRiskForm ? `
                                <div class="space-y-4">
                                    <h3 class="font-semibold text-slate-900">Risco / Ação de Mitigação</h3>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-semibold text-slate-700 mb-2">ID do Planner / Tarefa *</label>
                                            <input type="text" id="risk-planner-id" placeholder="Ex: TASK-12345" class="w-full">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-semibold text-slate-700 mb-2">Bucket / Etapa *</label>
                                            <select id="risk-bucket" class="w-full">
                                                <option value="">Selecione...</option>
                                                ${riskBucketOptions.map(option => `<option value="${option}">${option}</option>`).join('')}
                                            </select>
                                        </div>
                                    </div>

                                    <div>
                                        <label class="block text-sm font-semibold text-slate-700 mb-2">Nome da Tarefa *</label>
                                        <input type="text" id="risk-task-name" placeholder="Ex: Mitigar falha de autenticação" class="w-full">
                                    </div>

                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div>
                                            <label class="block text-sm font-semibold text-slate-700 mb-2">Progresso (%)</label>
                                            <input type="number" min="0" max="100" id="risk-progress" placeholder="0 a 100" class="w-full">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-semibold text-slate-700 mb-2">Prioridade</label>
                                            <select id="risk-priority" class="w-full">
                                                <option value="">Selecione...</option>
                                                ${riskPriorityOptions.map(option => `<option value="${option}">${option}</option>`).join('')}
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-semibold text-slate-700 mb-2">Responsável</label>
                                            <input type="text" id="risk-assigned-to" placeholder="Atribuído a" class="w-full">
                                        </div>
                                    </div>

                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-semibold text-slate-700 mb-2">Criado por</label>
                                            <input type="text" id="risk-created-by" placeholder="Nome do criador" class="w-full">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-semibold text-slate-700 mb-2">Criado em</label>
                                            <input type="datetime-local" id="risk-created-at" class="w-full">
                                        </div>
                                    </div>

                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-semibold text-slate-700 mb-2">Data de Início</label>
                                            <input type="date" id="risk-start-date" class="w-full">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-semibold text-slate-700 mb-2">Prazo / Conclusão</label>
                                            <input type="date" id="risk-due-date" class="w-full">
                                        </div>
                                    </div>

                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <label class="flex items-center gap-2 text-sm text-slate-700 font-semibold">
                                            <input type="checkbox" id="risk-recurring" class="w-4 h-4">
                                            Recorrente
                                        </label>
                                        <label class="flex items-center gap-2 text-sm text-slate-700 font-semibold">
                                            <input type="checkbox" id="risk-overdue" class="w-4 h-4">
                                            Atrasado
                                        </label>
                                        <label class="flex items-center gap-2 text-sm text-slate-700 font-semibold">
                                            <input type="checkbox" id="risk-completed" class="w-4 h-4">
                                            Concluído
                                        </label>
                                    </div>

                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-semibold text-slate-700 mb-2">Concluído em</label>
                                            <input type="datetime-local" id="risk-completed-at" class="w-full">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-semibold text-slate-700 mb-2">Concluído por</label>
                                            <input type="text" id="risk-completed-by" placeholder="Nome de quem concluiu" class="w-full">
                                        </div>
                                    </div>

                                    <div>
                                        <label class="block text-sm font-semibold text-slate-700 mb-2">Checklist</label>
                                        <textarea id="risk-checklist" rows="2" placeholder="Itens de controle separados por quebra de linha" class="w-full"></textarea>
                                    </div>

                                    <div>
                                        <label class="block text-sm font-semibold text-slate-700 mb-2">Rótulos / Labels</label>
                                        <input type="text" id="risk-labels" placeholder="Separar por vírgula" class="w-full">
                                    </div>

                                    <div>
                                        <label class="block text-sm font-semibold text-slate-700 mb-2">Descrição / Contexto</label>
                                        <textarea id="risk-description" rows="3" placeholder="Detalhes sobre o risco, impactos e próximos passos" class="w-full"></textarea>
                                    </div>

                                    <div class="flex gap-3 pt-4 border-t border-slate-200">
                                        <button onclick="saveRisk()" class="flex-1 px-4 py-2 bg-yellow-500 hover:bg-yellow-600 text-white font-semibold rounded transition-colors">
                                            <i class="fas fa-save mr-2"></i> Salvar Risco
                                        </button>
                                        <button onclick="selectEventCategory(null); showRiskForm = false; render()" class="flex-1 px-4 py-2 bg-slate-300 hover:bg-slate-400 text-slate-700 font-semibold rounded transition-colors">
                                            <i class="fas fa-arrow-left mr-2"></i> Voltar
                                        </button>
                                        <button onclick="closeEventModal()" class="flex-1 px-4 py-2 bg-red-300 hover:bg-red-400 text-red-700 font-semibold rounded transition-colors">
                                            <i class="fas fa-times mr-2"></i> Cancelar
                                        </button>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        }
        function renderDetailModalJourney() {
            if (!selectedPillar || !editingJourneyId) return '';
            const journey = journeys.find(j => j.id === editingJourneyId);
            if (!journey) return '';
            const attributes = pillarAttributes[selectedPillar];
            const pillarNames = { availability: 'Disponibilidade', quality: 'Qualidade', security: 'Segurança', performance: 'Performance' };
            const avgPercent = calculatePillarMaturity(journey, selectedPillar);
            const starCount = Math.max(1, Math.min(5, Math.round((avgPercent / 100) * 5)));
            return `
                <div class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center overflow-auto modal-overlay" onclick="if(event.target === this) closeDetailModalJourney()">
                    <div class="bg-white rounded-lg shadow-2xl max-w-3xl w-full m-4 modal-panel" onclick="event.stopPropagation()">
                        <div class="bg-white border-b border-slate-200 p-6 flex items-center justify-between sticky top-0">
                            <div>
                                <h2 class="text-2xl font-bold text-slate-900">${journey.name}</h2>
                                <div class="flex items-center gap-3 mt-1">
                                    <span class="text-sm text-slate-600">${pillarNames[selectedPillar]}</span>
                                    <div class="flex items-center gap-1">
                                        ${[...Array(5)].map((_, i) => `
                                            <i class="fas fa-star ${i < starCount ? 'star-filled' : 'star-empty'}"></i>
                                        `).join('')}
                                    </div>
                                    <span class="text-xs text-slate-500">${avgPercent}%</span>
                                </div>
                                ${selectedPillar === 'performance' ? `<p class="text-xs text-slate-500 mt-1">Referência: maturidade alinhada a métricas de experiência (ex.: APDEX).</p>` : ''}
                            </div>
                            <button onclick="closeDetailModalJourney()" class="p-2 hover:bg-slate-100 rounded-lg transition-colors">
                                <i class="fas fa-times text-slate-600 text-xl"></i>
                            </button>
                        </div>
                        <div class="p-6 space-y-6 overflow-y-auto max-h-[calc(85vh-120px)]">
                            <div class="bg-slate-50 rounded-lg p-4 border border-slate-200">
                                <h4 class="font-semibold text-slate-800 mb-3">Atributos de ${pillarNames[selectedPillar]}</h4>
                                <div class="space-y-4">
                                    ${Object.keys(attributes).map(attr => {
                                        const value = journey.maturity[selectedPillar][attr] || 0;
                                        const description = attributes[attr];
                                        return `
                                            <div>
                                                <div class="flex items-center justify-between mb-2">
                                                    <label class="text-sm font-semibold text-slate-700">${attr}</label>
                                                    <span class="text-sm font-bold text-slate-700">${value}%</span>
                                                </div>
                                                <p class="text-xs text-slate-500 mb-2">${description}</p>
                                                <input type="range" min="0" max="100" step="5" value="${value}" oninput="updateAttributeValue('${journey.id}', '${selectedPillar}', '${attr}', this.value)" class="w-full">
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                            <div class="border-t border-slate-200 pt-4">
                                <h4 class="font-semibold text-slate-800 mb-3">Interpretação:</h4>
                                <div class="space-y-2 text-sm text-slate-600">
                                    <p><span class="font-semibold">0-25%:</span> Não implementado ou muito básico</p>
                                    <p><span class="font-semibold">26-50%:</span> Implementação parcial</p>
                                    <p><span class="font-semibold">51-75%:</span> Bem implementado</p>
                                    <p><span class="font-semibold">76-100%:</span> Totalmente implementado e otimizado</p>
                                </div>
                            </div>
                            <div class="flex gap-3 pt-4 border-t border-slate-200">
                                <button onclick="closeDetailModalJourney()" class="flex-1 px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white font-semibold rounded transition-colors">
                                    <i class="fas fa-check mr-2"></i> Fechar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        // ========== PÁGINA PAINEL EXECUTIVO ==========
        
        function renderExecutivoPanelPage() {
            // Se não há coleção selecionada, mostrar lista de coleções
            if (selectedExecutivoCollectionId === null) {
                return renderExecutivoCollectionsList();
            }

            // Obter painéis da coleção selecionada
            const collectionPanels = executivoPanels.filter(p => p.collectionId === selectedExecutivoCollectionId);
            
            // Buscar a coleção atual (definir antes de usar em ambos os blocos)
            const collection = executivoCollections.find(c => c.id === selectedExecutivoCollectionId);
            
            if (collectionPanels.length === 0) {
                return `
                    <header class="bg-white border-b border-slate-200 shadow-sm sticky top-0 z-40">
                        <div class="max-w-7xl mx-auto px-6 py-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <button onclick="selectedExecutivoCollectionId = null; currentExecutivoPanelIndex = 0; render();" class="text-teal-600 hover:text-teal-700 mb-2 flex items-center gap-2">
                                        <i class="fas fa-arrow-left"></i> Voltar para Coleções
                                    </button>
                                    <h1 class="text-3xl font-bold text-slate-900">${collection?.name || 'Coleção'}</h1>
                                    <p class="text-slate-600 mt-1 text-sm">Nenhum painel cadastrado nesta coleção</p>
                                </div>
                                <nav class="flex items-center gap-2">
                                    <button onclick="navigateTo('dashboard')" class="px-3 py-2 bg-indigo-500 hover:bg-indigo-600 text-white font-semibold rounded transition-colors text-sm">
                                        <i class="fas fa-home mr-1"></i> Dashboard
                                    </button>
                                    <button onclick="creatingNewExecutivoPanel = true; render();" class="px-3 py-2 bg-teal-500 hover:bg-teal-600 text-white font-semibold rounded transition-colors text-sm">
                                        <i class="fas fa-plus mr-1"></i> Novo Painel
                                    </button>
                                </nav>
                            </div>
                        </div>
                    </header>
                    <main class="max-w-7xl mx-auto px-6 py-8">
                        <div class="bg-white rounded-lg shadow-md p-12 text-center border-2 border-teal-200">
                            <i class="fas fa-tv text-6xl text-teal-400 mb-4"></i>
                            <h2 class="text-2xl font-bold text-slate-900 mb-2">Nenhum Painel Cadastrado</h2>
                            <p class="text-slate-600 mb-6">Comece criando seu primeiro painel executivo para uma Squad nesta coleção.</p>
                            <button onclick="creatingNewExecutivoPanel = true; render();" class="px-6 py-3 bg-teal-500 hover:bg-teal-600 text-white font-semibold rounded-lg transition-colors">
                                <i class="fas fa-plus mr-2"></i> Criar Primeiro Painel
                            </button>
                        </div>
                    </main>
                    ${creatingNewExecutivoCollection ? renderNewExecutivoCollectionModal() : ''}
                    ${creatingNewExecutivoPanel ? renderNewExecutivoPanelModal() : ''}
                `;
            }

            // Ajustar índice se necessário
            if (currentExecutivoPanelIndex >= collectionPanels.length) {
                currentExecutivoPanelIndex = 0;
            }
            const currentPanel = collectionPanels[currentExecutivoPanelIndex] || collectionPanels[0];
            return `
                ${creatingNewExecutivoPanel ? renderNewExecutivoPanelModal() : ''}
                ${editingExecutivoPanelId ? renderEditExecutivoPanelModal() : ''}
                <header class="bg-white border-b border-slate-200 shadow-sm sticky top-0 z-40">
                    <div class="max-w-7xl mx-auto px-6 py-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <button onclick="selectedExecutivoCollectionId = null; currentExecutivoPanelIndex = 0; render();" class="text-teal-600 hover:text-teal-700 mb-2 flex items-center gap-2">
                                    <i class="fas fa-arrow-left"></i> Voltar para Coleções
                                </button>
                                <h1 class="text-3xl font-bold text-slate-900">${collection?.name || 'Coleção'}</h1>
                                <p class="text-slate-600 mt-1 text-sm">${currentPanel?.squadName || 'Carrossel de Squads'}</p>
                            </div>
                            <nav class="flex items-center gap-2">
                                <button onclick="navigateTo('dashboard')" class="px-3 py-2 bg-indigo-500 hover:bg-indigo-600 text-white font-semibold rounded transition-colors text-sm">
                                    <i class="fas fa-home mr-1"></i> Dashboard
                                </button>
                                <button onclick="creatingNewExecutivoPanel = true; render();" class="px-3 py-2 bg-teal-500 hover:bg-teal-600 text-white font-semibold rounded transition-colors text-sm">
                                    <i class="fas fa-plus mr-1"></i> Novo Painel
                                </button>
                            </nav>
                        </div>
                    </div>
                </header>
                <main class="max-w-7xl mx-auto px-6 py-8">
                    <div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-xl shadow-2xl p-8 text-white">
                        <!-- Controles do Carrossel -->
                        <div class="flex items-center justify-between mb-6">
                            <button onclick="previousExecutivoPanel()" class="p-3 bg-white/10 hover:bg-white/20 rounded-lg transition-colors" ${collectionPanels.length <= 1 ? 'disabled' : ''}>
                                <i class="fas fa-chevron-left text-2xl"></i>
                            </button>
                            <div class="text-center">
                                <div class="text-sm text-slate-300 mb-1">Painel ${currentExecutivoPanelIndex + 1} de ${collectionPanels.length}</div>
                                <div class="flex gap-1 justify-center">
                                    ${collectionPanels.map((_, idx) => `
                                        <div class="w-2 h-2 rounded-full ${idx === currentExecutivoPanelIndex ? 'bg-white' : 'bg-white/30'}" onclick="currentExecutivoPanelIndex = ${idx}; render();"></div>
                                    `).join('')}
                                </div>
                            </div>
                            <button onclick="nextExecutivoPanel()" class="p-3 bg-white/10 hover:bg-white/20 rounded-lg transition-colors" ${collectionPanels.length <= 1 ? 'disabled' : ''}>
                                <i class="fas fa-chevron-right text-2xl"></i>
                            </button>
                        </div>
                        
                        <div class="flex-1 flex items-center justify-center min-h-0">
                            ${currentPanel ? renderExecutivoPanelCard(currentPanel) : ''}
                        </div>
                    </div>
                </main>
            `;
        }

        function previousExecutivoPanel() {
            if (!selectedExecutivoCollectionId) return;
            const collectionPanels = executivoPanels.filter(p => p.collectionId === selectedExecutivoCollectionId);
            if (collectionPanels.length === 0) return;
            currentExecutivoPanelIndex = (currentExecutivoPanelIndex - 1 + collectionPanels.length) % collectionPanels.length;
            render();
        }

        function nextExecutivoPanel() {
            if (!selectedExecutivoCollectionId) return;
            const collectionPanels = executivoPanels.filter(p => p.collectionId === selectedExecutivoCollectionId);
            if (collectionPanels.length === 0) return;
            currentExecutivoPanelIndex = (currentExecutivoPanelIndex + 1) % collectionPanels.length;
            render();
        }
        function renderExecutivoCollectionsList() {
            return `
                ${creatingNewExecutivoCollection ? renderNewExecutivoCollectionModal() : ''}
                ${editingExecutivoCollectionId ? renderEditExecutivoCollectionModal() : ''}
                <header class="bg-white border-b border-slate-200 shadow-sm sticky top-0 z-40">
                    <div class="max-w-7xl mx-auto px-6 py-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <h1 class="text-3xl font-bold text-slate-900">Painel Executivo</h1>
                                <p class="text-slate-600 mt-1 text-sm">Gerencie suas coleções de painéis por período (ex: 2025, 2026)</p>
                            </div>
                            <nav class="flex items-center gap-2">
                                <button onclick="navigateTo('dashboard')" class="px-3 py-2 bg-indigo-500 hover:bg-indigo-600 text-white font-semibold rounded transition-colors text-sm">
                                    <i class="fas fa-home mr-1"></i> Dashboard
                                </button>
                                <button onclick="creatingNewExecutivoCollection = true; render();" class="px-3 py-2 bg-teal-500 hover:bg-teal-600 text-white font-semibold rounded transition-colors text-sm">
                                    <i class="fas fa-plus mr-1"></i> Nova Coleção
                                </button>
                            </nav>
                        </div>
                    </div>
                </header>
                <main class="max-w-7xl mx-auto px-6 py-8">
                    ${executivoCollections.length === 0 ? `
                        <div class="bg-white rounded-lg shadow-md p-12 text-center border-2 border-teal-200">
                            <i class="fas fa-folder-open text-6xl text-teal-400 mb-4"></i>
                            <h2 class="text-2xl font-bold text-slate-900 mb-2">Nenhuma Coleção Cadastrada</h2>
                            <p class="text-slate-600 mb-6">Crie uma coleção para organizar seus painéis por período (ex: 2025, 2026).</p>
                            <button onclick="creatingNewExecutivoCollection = true; render();" class="px-6 py-3 bg-teal-500 hover:bg-teal-600 text-white font-semibold rounded-lg transition-colors">
                                <i class="fas fa-plus mr-2"></i> Criar Primeira Coleção
                            </button>
                        </div>
                    ` : `
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            ${executivoCollections.map(collection => {
                                const panelsCount = executivoPanels.filter(p => p.collectionId === collection.id).length;
                                return `
                                    <div class="bg-white rounded-lg shadow-md hover:shadow-xl transition-shadow border-2 border-slate-200 hover:border-teal-400 p-6 cursor-pointer group" onclick="openExecutivoCollection('${collection.id}')">
                                        <div class="flex items-start justify-between mb-4">
                                            <div class="flex-1">
                                                <h3 class="text-2xl font-bold text-slate-900 mb-2">${collection.name}</h3>
                                                ${collection.description ? `<p class="text-slate-600 text-sm">${collection.description}</p>` : ''}
                                            </div>
                                            <div class="flex items-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                                <button onclick="event.stopPropagation(); editingExecutivoCollectionId = '${collection.id}'; render();" class="p-2 hover:bg-blue-50 rounded-lg text-blue-600">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button onclick="event.stopPropagation(); deleteExecutivoCollection('${collection.id}');" class="p-2 hover:bg-red-50 rounded-lg text-red-600">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="flex items-center gap-4 text-sm text-slate-600">
                                            <span class="flex items-center gap-2">
                                                <i class="fas fa-tv text-teal-500"></i>
                                                ${panelsCount} painel${panelsCount !== 1 ? 'éis' : ''}
                                            </span>
                                        </div>
                                        <div class="mt-4 pt-4 border-t border-slate-200">
                                            <button class="w-full px-4 py-2 bg-teal-500 hover:bg-teal-600 text-white font-semibold rounded transition-colors text-sm">
                                                Abrir Coleção
                                                <i class="fas fa-arrow-right ml-2"></i>
                                            </button>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `}
                </main>
            `;
        }
        function openExecutivoCollection(collectionId) {
            selectedExecutivoCollectionId = collectionId;
            currentExecutivoPanelIndex = 0;
            render();
        }

        function renderNewExecutivoCollectionModal() {
            return `
                <div class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center overflow-auto modal-overlay" onclick="if(event.target === this) { creatingNewExecutivoCollection = false; render(); }">
                    <div class="bg-white rounded-lg shadow-2xl max-w-md w-full m-4 modal-panel" onclick="event.stopPropagation()">
                        <div class="bg-white border-b border-slate-200 p-6 flex items-center justify-between sticky top-0">
                            <h2 class="text-2xl font-bold text-slate-900">Nova Coleção</h2>
                            <button onclick="creatingNewExecutivoCollection = false; render();" class="p-2 hover:bg-slate-100 rounded-lg">
                                <i class="fas fa-times text-slate-600 text-xl"></i>
                            </button>
                        </div>
                        <div class="p-6 space-y-4">
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-2">Nome da Coleção *</label>
                                <input type="text" id="new-collection-name" placeholder="Ex: Painéis 2025" class="w-full" required>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-2">Descrição (opcional)</label>
                                <textarea id="new-collection-description" placeholder="Ex: Painéis executivos do ano de 2025" class="w-full" rows="3"></textarea>
                            </div>
                            <div class="flex gap-3 pt-4 border-t border-slate-200">
                                <button onclick="saveNewExecutivoCollection()" class="flex-1 px-4 py-2 bg-green-500 hover:bg-green-600 text-white font-semibold rounded transition-colors">
                                    <i class="fas fa-save mr-2"></i> Salvar
                                </button>
                                <button onclick="creatingNewExecutivoCollection = false; render();" class="flex-1 px-4 py-2 bg-slate-300 hover:bg-slate-400 text-slate-700 font-semibold rounded transition-colors">
                                    Cancelar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderEditExecutivoCollectionModal() {
            const collection = executivoCollections.find(c => c.id === editingExecutivoCollectionId);
            if (!collection) return '';
            
            return `
                <div class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center overflow-auto modal-overlay" onclick="if(event.target === this) { editingExecutivoCollectionId = null; render(); }">
                    <div class="bg-white rounded-lg shadow-2xl max-w-md w-full m-4 modal-panel" onclick="event.stopPropagation()">
                        <div class="bg-white border-b border-slate-200 p-6 flex items-center justify-between sticky top-0">
                            <h2 class="text-2xl font-bold text-slate-900">Editar Coleção</h2>
                            <button onclick="editingExecutivoCollectionId = null; render();" class="p-2 hover:bg-slate-100 rounded-lg">
                                <i class="fas fa-times text-slate-600 text-xl"></i>
                            </button>
                        </div>
                        <div class="p-6 space-y-4">
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-2">Nome da Coleção *</label>
                                <input type="text" id="edit-collection-name" value="${collection.name}" placeholder="Ex: Painéis 2025" class="w-full" required>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-2">Descrição (opcional)</label>
                                <textarea id="edit-collection-description" placeholder="Ex: Painéis executivos do ano de 2025" class="w-full" rows="3">${collection.description || ''}</textarea>
                            </div>
                            <div class="flex gap-3 pt-4 border-t border-slate-200">
                                <button onclick="saveEditExecutivoCollection()" class="flex-1 px-4 py-2 bg-green-500 hover:bg-green-600 text-white font-semibold rounded transition-colors">
                                    <i class="fas fa-save mr-2"></i> Salvar
                                </button>
                                <button onclick="editingExecutivoCollectionId = null; render();" class="flex-1 px-4 py-2 bg-slate-300 hover:bg-slate-400 text-slate-700 font-semibold rounded transition-colors">
                                    Cancelar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        function renderExecutivoPanelForm(panel = null) {
            const isEdit = !!panel;
            const portaisList = [
                'Lojista Pionel B2C (Auto e B&S)',
                'Lojista Vivere B2C (Legado)',
                'CDC Varejo',
                'CDC Solar (Via C2 para a Rede)',
                'FinOnline (C2C Vivere - Legado)',
                'Portal SIM (Vivere)'
            ];
            const produtosList = [
                'Crédito Direto ao Consumidor (CDC)',
                'Cessão à Vista (CSC)',
                'Cessão Parcelada (CSP)'
            ];
            const segurosList = [
                'Seguro Auto',
                'Seguro Prestamista',
                'Seguro Mão na Roda'
            ];
            const indicadoresList = [
                'Proposta Aprovadas / Mês (Auto)',
                'Proposta Aprovadas / Mês (Non-Auto)'
            ];

            return `
                <!-- Squad Name e Avatar -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="md:col-span-2">
                        <label class="block text-sm font-semibold text-slate-700 mb-2">Nome da Squad *</label>
                        <input type="text" id="${isEdit ? 'edit-' : ''}executivo-squad-name" value="${panel?.squadName || ''}" placeholder="Ex: Squad de Crédito" class="w-full" required>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-2">Avatar do Owner (URL)</label>
                        <input type="text" id="${isEdit ? 'edit-' : ''}executivo-owner-avatar" value="${panel?.ownerAvatar || ''}" placeholder="https://..." class="w-full">
                        <p class="text-xs text-slate-500 mt-1">URL da imagem do responsável</p>
                        ${panel?.ownerAvatar ? `
                            <div class="mt-2">
                                <img src="${panel.ownerAvatar}" alt="Avatar" class="w-16 h-16 rounded-full object-cover border-2 border-teal-400" onerror="this.style.display='none'">
                            </div>
                        ` : ''}
                    </div>
                </div>

                <!-- Portais -->
                <div>
                    <label class="block text-sm font-semibold text-slate-700 mb-2">Portais Responsáveis</label>
                    <div class="space-y-2 border border-slate-200 rounded-lg p-4 max-h-48 overflow-y-auto mb-4">
                        ${portaisList.map(portal => `
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" value="${portal}" class="portal-checkbox" ${(panel?.portais || []).includes(portal) ? 'checked' : ''}>
                                <span>${portal}</span>
                            </label>
                        `).join('')}
                    </div>
                    <div class="flex items-center gap-2">
                        <input type="text" id="${isEdit ? 'edit-' : ''}new-portal" placeholder="Adicionar novo portal..." class="flex-1">
                        <button type="button" onclick="addCustomPortal(${isEdit})" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded">
                            <i class="fas fa-plus"></i> Adicionar
                        </button>
                    </div>
                    <div id="${isEdit ? 'edit-' : ''}custom-portais-list" class="mt-2 space-y-2">
                        ${(panel?.portais || []).filter(p => !portaisList.includes(p)).map(p => `
                            <div class="flex items-center justify-between bg-slate-50 p-2 rounded" data-value="${p}">
                                <span>${p}</span>
                                <button type="button" onclick="removeCustomItem('${p}', '${isEdit ? 'edit-' : ''}custom-portais-list')" class="text-red-600 hover:text-red-800">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <!-- Produtos -->
                <div>
                    <label class="block text-sm font-semibold text-slate-700 mb-2">Produtos</label>
                    <div class="space-y-2 border border-slate-200 rounded-lg p-4 mb-4">
                        ${produtosList.map(produto => `
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" value="${produto}" class="produto-checkbox" ${(panel?.produtos || []).includes(produto) ? 'checked' : ''}>
                                <span>${produto}</span>
                            </label>
                        `).join('')}
                    </div>
                    <div class="flex items-center gap-2">
                        <input type="text" id="${isEdit ? 'edit-' : ''}new-produto" placeholder="Adicionar novo produto..." class="flex-1">
                        <button type="button" onclick="addCustomProduto(${isEdit})" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded">
                            <i class="fas fa-plus"></i> Adicionar
                        </button>
                    </div>
                    <div id="${isEdit ? 'edit-' : ''}custom-produtos-list" class="mt-2 space-y-2">
                        ${(panel?.produtos || []).filter(p => !produtosList.includes(p)).map(p => `
                            <div class="flex items-center justify-between bg-slate-50 p-2 rounded">
                                <span>${p}</span>
                                <button type="button" onclick="removeCustomItem('${p}', '${isEdit ? 'edit-' : ''}custom-produtos-list')" class="text-red-600 hover:text-red-800">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        `).join('')}
                    </div>
                </div>
                <!-- Seguros -->
                <div>
                    <label class="block text-sm font-semibold text-slate-700 mb-2">Seguros</label>
                    <div class="space-y-2 border border-slate-200 rounded-lg p-4 mb-4">
                        ${segurosList.map(seguro => `
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" value="${seguro}" class="seguro-checkbox" ${(panel?.seguros || []).includes(seguro) ? 'checked' : ''}>
                                <span>${seguro}</span>
                            </label>
                        `).join('')}
                    </div>
                    <div class="flex items-center gap-2">
                        <input type="text" id="${isEdit ? 'edit-' : ''}new-seguro" placeholder="Adicionar novo seguro..." class="flex-1">
                        <button type="button" onclick="addCustomSeguro(${isEdit})" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded">
                            <i class="fas fa-plus"></i> Adicionar
                        </button>
                    </div>
                    <div id="${isEdit ? 'edit-' : ''}custom-seguros-list" class="mt-2 space-y-2">
                        ${(panel?.seguros || []).filter(s => !segurosList.includes(s)).map(s => `
                            <div class="flex items-center justify-between bg-slate-50 p-2 rounded">
                                <span>${s}</span>
                                <button type="button" onclick="removeCustomItem('${s}', '${isEdit ? 'edit-' : ''}custom-seguros-list')" class="text-red-600 hover:text-red-800">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        `).join('')}
                    </div>
                </div>
                <!-- Indicadores Disponíveis e Selecionados -->
                <div>
                    <label class="block text-sm font-semibold text-slate-700 mb-2">Indicadores Disponíveis</label>
                    <div class="space-y-2 border border-slate-200 rounded-lg p-4 max-h-40 overflow-y-auto mb-4">
                        ${indicadoresList.map(indicador => `
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" value="${indicador}" class="indicador-checkbox" ${(panel?.indicadores || []).includes(indicador) ? 'checked' : ''}>
                                <span>${indicador}</span>
                            </label>
                        `).join('')}
                    </div>
                    <div class="flex items-center gap-2">
                        <input type="text" id="${isEdit ? 'edit-' : ''}new-indicador" placeholder="Adicionar novo indicador..." class="flex-1">
                        <button type="button" onclick="addCustomIndicador(${isEdit})" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded">
                            <i class="fas fa-plus"></i> Adicionar
                        </button>
                    </div>
                    <div id="${isEdit ? 'edit-' : ''}custom-indicadores-list" class="mt-2 space-y-2">
                        ${(panel?.indicadores || []).filter(ind => !indicadoresList.includes(ind)).map(ind => `
                            <div class="flex items-center justify-between bg-slate-50 p-2 rounded">
                                <span>${ind}</span>
                                <button type="button" onclick="removeCustomIndicador('${ind}', ${isEdit})" class="text-red-600 hover:text-red-800">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <!-- Tecnologias -->
                <div>
                    <label class="block text-sm font-semibold text-slate-700 mb-2">Tecnologias</label>
                    <textarea id="${isEdit ? 'edit-' : ''}executivo-tecnologias" rows="3" placeholder="Descreva as tecnologias utilizadas..." class="w-full">${panel?.tecnologias || ''}</textarea>
                </div>
                <!-- Principais Entregas -->
                <div>
                    <label class="block text-sm font-semibold text-slate-700 mb-2">Principais Entregas para o Ano</label>
                    <div id="${isEdit ? 'edit-' : ''}principais-entregas-container" class="space-y-3">
                        ${(() => {
                            const entregas = panel?.principaisEntregas || [];
                            const items = Array.isArray(entregas) ? entregas : [];
                            return items.map((item, idx) => {
                                const okrId = typeof item === 'object' && item.okrId ? item.okrId : '';
                                const krId = typeof item === 'object' && item.krId ? item.krId : '';
                                const okrKrValue = (okrId && krId) ? `${okrId}|${krId}` : '';
                                return `
                                <div class="border border-slate-200 rounded-lg p-4">
                                    <textarea rows="2" placeholder="Descrição da entrega..." class="w-full mb-2 entrega-descricao">${typeof item === 'string' ? item : (item.descricao || '')}</textarea>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mb-2">
                                        <select class="w-full entrega-status">
                                            <option value="not-started" ${(typeof item === 'object' && item.status === 'not-started') || (typeof item === 'string') ? 'selected' : ''}>Não Iniciado</option>
                                            <option value="delivered" ${typeof item === 'object' && item.status === 'delivered' ? 'selected' : ''}>Entregue</option>
                                            <option value="in-progress" ${typeof item === 'object' && item.status === 'in-progress' ? 'selected' : ''}>Em Andamento</option>
                                            <option value="at-risk" ${typeof item === 'object' && item.status === 'at-risk' ? 'selected' : ''}>Em Risco</option>
                                        </select>
                                        <select class="w-full entrega-okr-kr">
                                            <option value="">Não relacionado a OKR/KR</option>
                                            ${(() => {
                                                let options = '';
                                                okrs.forEach(okr => {
                                                    if (okr.krs && okr.krs.length > 0) {
                                                        okr.krs.forEach(kr => {
                                                            const value = `${okr.id}|${kr.id}`;
                                                            const selected = (okrKrValue === value) ? 'selected' : '';
                                                            const label = `${okr.objetivo} - ${kr.description || 'KR sem descrição'}`;
                                                            options += `<option value="${value}" ${selected}>${label}</option>`;
                                                        });
                                                    }
                                                });
                                                return options;
                                            })()}
                                        </select>
                                    </div>
                                    <button type="button" onclick="this.parentElement.remove()" class="mt-2 text-red-600 hover:text-red-800 text-sm">
                                        <i class="fas fa-trash mr-1"></i> Remover
                                    </button>
                                </div>
                            `;
                            }).join('');
                        })()}
                    </div>
                    <button type="button" onclick="addPrincipaisEntregasItem(${isEdit})" class="mt-2 px-4 py-2 bg-teal-500 hover:bg-teal-600 text-white rounded">
                        <i class="fas fa-plus mr-1"></i> Adicionar Entregas
                    </button>
                </div>

                <!-- O que funciona bem -->
                <div>
                    <label class="block text-sm font-semibold text-slate-700 mb-2">O que funciona bem</label>
                    <textarea id="${isEdit ? 'edit-' : ''}executivo-o-que-funciona-bem" rows="4" placeholder="Descreva o que funciona bem na Squad..." class="w-full">${typeof panel?.oQueFuncionaBem === 'string' ? panel.oQueFuncionaBem : ''}</textarea>
                </div>
                <!-- Oportunidades -->
                <div>
                    <label class="block text-sm font-semibold text-slate-700 mb-2">Oportunidades</label>
                    <div id="${isEdit ? 'edit-' : ''}oportunidades-container" class="space-y-3">
                        ${(panel?.oportunidades || []).map(op => `
                            <div class="flex items-center gap-2 border border-slate-200 rounded-lg p-4">
                                <textarea rows="2" placeholder="Descreva a oportunidade..." class="flex-1 oportunidade-desc">${op}</textarea>
                                <button type="button" onclick="this.parentElement.remove()" class="text-red-600 hover:text-red-800">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        `).join('')}
                    </div>
                    <button type="button" onclick="addOportunidadeItem(${isEdit})" class="mt-2 px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded">
                        <i class="fas fa-plus mr-1"></i> Adicionar Oportunidade
                    </button>
                </div>
            `;
        }

        function addCustomPortal(isEdit) {
            const prefix = isEdit ? 'edit-' : '';
            const input = document.getElementById(prefix + 'new-portal');
            const value = input.value.trim();
            if (!value) return;
            
            const container = document.getElementById(prefix + 'custom-portais-list');
            container.insertAdjacentHTML('beforeend', `
                <div class="flex items-center justify-between bg-slate-50 p-2 rounded" data-value="${value}">
                    <span>${value}</span>
                    <button type="button" onclick="removeCustomItem('${value}', '${prefix}custom-portais-list')" class="text-red-600 hover:text-red-800">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `);
            input.value = '';
        }

        function addCustomProduto(isEdit) {
            const prefix = isEdit ? 'edit-' : '';
            const input = document.getElementById(prefix + 'new-produto');
            const value = input.value.trim();
            if (!value) return;
            
            const container = document.getElementById(prefix + 'custom-produtos-list');
            container.insertAdjacentHTML('beforeend', `
                <div class="flex items-center justify-between bg-slate-50 p-2 rounded" data-value="${value}">
                    <span>${value}</span>
                    <button type="button" onclick="removeCustomItem('${value}', '${prefix}custom-produtos-list')" class="text-red-600 hover:text-red-800">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `);
            input.value = '';
        }

        function addCustomSeguro(isEdit) {
            const prefix = isEdit ? 'edit-' : '';
            const input = document.getElementById(prefix + 'new-seguro');
            const value = input.value.trim();
            if (!value) return;
            
            const container = document.getElementById(prefix + 'custom-seguros-list');
            container.insertAdjacentHTML('beforeend', `
                <div class="flex items-center justify-between bg-slate-50 p-2 rounded" data-value="${value}">
                    <span>${value}</span>
                    <button type="button" onclick="removeCustomItem('${value}', '${prefix}custom-seguros-list')" class="text-red-600 hover:text-red-800">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `);
            input.value = '';
        }
        function addCustomIndicador(isEdit) {
            const prefix = isEdit ? 'edit-' : '';
            const input = document.getElementById(prefix + 'new-indicador');
            const value = input.value.trim();
            if (!value) return;
            
            const container = document.getElementById(prefix + 'custom-indicadores-list');
            container.insertAdjacentHTML('beforeend', `
                <div class="flex items-center justify-between bg-slate-50 p-2 rounded" data-value="${value}">
                    <span>${value}</span>
                    <button type="button" onclick="removeCustomIndicador('${value}', '${prefix}custom-indicadores-list')" class="text-red-600 hover:text-red-800">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `);
            input.value = '';
        }
        function removeCustomItem(value, containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            const items = container.querySelectorAll('div[data-value]');
            items.forEach(item => {
                if (item.getAttribute('data-value') === value || item.querySelector('span').textContent.trim() === value.trim()) {
                    item.remove();
                }
            });
        }

        function removeCustomIndicador(indicador, isEdit) {
            const prefix = isEdit ? 'edit-' : '';
            removeCustomItem(indicador, prefix + 'custom-indicadores-list');
        }
        function addPrincipaisEntregasItem(isEdit) {
            const prefix = isEdit ? 'edit-' : '';
            const container = document.getElementById(prefix + 'principais-entregas-container');
            
            // Gerar opções de OKR/KR
            let okrKrOptions = '<option value="">Não relacionado a OKR/KR</option>';
            okrs.forEach(okr => {
                if (okr.krs && okr.krs.length > 0) {
                    okr.krs.forEach(kr => {
                        const value = `${okr.id}|${kr.id}`;
                        const label = `${okr.objetivo} - ${kr.description || 'KR sem descrição'}`;
                        okrKrOptions += `<option value="${value}">${label}</option>`;
                    });
                }
            });
            
            container.insertAdjacentHTML('beforeend', `
                <div class="border border-slate-200 rounded-lg p-4">
                    <textarea rows="2" placeholder="Descrição da entrega..." class="w-full mb-2 entrega-descricao"></textarea>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mb-2">
                        <select class="w-full entrega-status">
                            <option value="not-started">Não Iniciado</option>
                            <option value="delivered">Entregue</option>
                            <option value="in-progress">Em Andamento</option>
                            <option value="at-risk">Em Risco</option>
                        </select>
                        <select class="w-full entrega-okr-kr">
                            ${okrKrOptions}
                        </select>
                    </div>
                    <button type="button" onclick="this.parentElement.remove()" class="mt-2 text-red-600 hover:text-red-800 text-sm">
                        <i class="fas fa-trash mr-1"></i> Remover
                    </button>
                </div>
            `);
        }

        function addOportunidadeItem(isEdit) {
            const prefix = isEdit ? 'edit-' : '';
            const container = document.getElementById(prefix + 'oportunidades-container');
            container.insertAdjacentHTML('beforeend', `
                <div class="flex items-center gap-2 border border-slate-200 rounded-lg p-4">
                    <textarea rows="2" placeholder="Descreva a oportunidade..." class="flex-1 oportunidade-desc"></textarea>
                    <button type="button" onclick="this.parentElement.remove()" class="text-red-600 hover:text-red-800">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `);
        }
        function saveNewExecutivoPanel() {
            if (!selectedExecutivoCollectionId) {
                alert('Por favor, selecione uma coleção primeiro.');
                return;
            }

            const squadName = document.getElementById('executivo-squad-name').value.trim();
            if (!squadName) {
                alert('Por favor, informe o nome da Squad.');
                return;
            }

            const panel = collectExecutivoPanelData();
            panel.id = Date.now().toString();
            panel.createdAt = new Date().toISOString();
            panel.collectionId = selectedExecutivoCollectionId;
            
            executivoPanels.push(panel);
            saveExecutivoPanels();
            creatingNewExecutivoPanel = false;
            
            // Ajustar índice para o novo painel
            const collectionPanels = executivoPanels.filter(p => p.collectionId === selectedExecutivoCollectionId);
            currentExecutivoPanelIndex = collectionPanels.length - 1;
            render();
        }

        function saveEditExecutivoPanel() {
            const panel = executivoPanels.find(p => p.id === editingExecutivoPanelId);
            if (!panel) return;

            const squadName = document.getElementById('edit-executivo-squad-name').value.trim();
            if (!squadName) {
                alert('Por favor, informe o nome da Squad.');
                return;
            }

            const updatedData = collectExecutivoPanelData(true);
            Object.assign(panel, updatedData);
            panel.updatedAt = new Date().toISOString();
            
            saveExecutivoPanels();
            editingExecutivoPanelId = null;
            render();
        }

        function collectExecutivoPanelData(isEdit = false) {
            const prefix = isEdit ? 'edit-' : '';
            
            // Portais (selecionados + customizados)
            const portaisSelecionados = Array.from(document.querySelectorAll('.portal-checkbox:checked')).map(cb => cb.value);
            const customPortais = Array.from(document.querySelectorAll(`#${prefix}custom-portais-list span`)).map(span => span.textContent.trim());
            const portais = [...portaisSelecionados, ...customPortais];
            
            // Produtos (selecionados + customizados)
            const produtosSelecionados = Array.from(document.querySelectorAll('.produto-checkbox:checked')).map(cb => cb.value);
            const customProdutos = Array.from(document.querySelectorAll(`#${prefix}custom-produtos-list span`)).map(span => span.textContent.trim());
            const produtos = [...produtosSelecionados, ...customProdutos];
            
            // Seguros (selecionados + customizados)
            const segurosSelecionados = Array.from(document.querySelectorAll('.seguro-checkbox:checked')).map(cb => cb.value);
            const customSeguros = Array.from(document.querySelectorAll(`#${prefix}custom-seguros-list span`)).map(span => span.textContent.trim());
            const seguros = [...segurosSelecionados, ...customSeguros];
            
            // Indicadores (selecionados + customizados)
            const indicadoresSelecionados = Array.from(document.querySelectorAll('.indicador-checkbox:checked')).map(cb => cb.value);
            const customIndicadores = Array.from(document.querySelectorAll(`#${prefix}custom-indicadores-list span`)).map(span => span.textContent.trim());
            const indicadores = [...indicadoresSelecionados, ...customIndicadores];
            
            // Principais Entregas (array com status e relação OKR/KR)
            const principaisEntregas = Array.from(document.querySelectorAll(`#${prefix}principais-entregas-container > div`)).map(div => {
                const descricao = div.querySelector('.entrega-descricao').value.trim();
                const status = div.querySelector('.entrega-status').value;
                const okrKrSelect = div.querySelector('.entrega-okr-kr');
                const okrKrValue = okrKrSelect ? okrKrSelect.value : '';
                
                const entrega = {
                    descricao,
                    status
                };
                
                // Adicionar relação OKR/KR se selecionado
                if (okrKrValue) {
                    const [okrId, krId] = okrKrValue.split('|');
                    entrega.okrId = okrId;
                    entrega.krId = krId;
                }
                
                return entrega;
            }).filter(item => item.descricao);
            // O que funciona bem (texto simples)
            const oQueFuncionaBem = document.getElementById(prefix + 'executivo-o-que-funciona-bem').value.trim();
            // Oportunidades
            const oportunidades = Array.from(document.querySelectorAll(`#${prefix}oportunidades-container > div textarea`)).map(ta => ta.value.trim()).filter(v => v);

            return {
                squadName: document.getElementById(prefix + 'executivo-squad-name').value.trim(),
                ownerAvatar: document.getElementById(prefix + 'executivo-owner-avatar').value.trim(),
                portais,
                produtos,
                seguros,
                indicadores,
                tecnologias: document.getElementById(prefix + 'executivo-tecnologias').value.trim(),
                principaisEntregas,
                oQueFuncionaBem,
                oportunidades
            };
        }
        function deleteExecutivoPanel(panelId) {
            if (!confirm('Tem certeza que deseja excluir este painel?')) return;
            
            executivoPanels = executivoPanels.filter(p => p.id !== panelId);
            saveExecutivoPanels();
            
            if (currentExecutivoPanelIndex >= executivoPanels.length) {
                currentExecutivoPanelIndex = Math.max(0, executivoPanels.length - 1);
            }
            
            render();
        }
        function renderFunctionalIncidentOverviewModal() {
            const journey = journeys.find(j => j.id === functionalIncidentOverviewJourneyId);
            if (!journey) return '';

            const bounds = getJourneyEventFilterBounds();
            const incidents = getJourneyFunctionalIncidents(journey, bounds);
            const totalIncidents = incidents.length;
            const resolvedCount = incidents.filter(incident => !!incident.resolvedAt).length;
            const openCount = totalIncidents - resolvedCount;

            const resolutionDurations = incidents.reduce((acc, incident) => {
                const start = parseEventDateValue(incident.createdAt);
                const end = parseEventDateValue(incident.resolvedAt);
                if (start !== null && end !== null && end >= start) {
                    acc.push(end - start);
                }
                return acc;
            }, []);

            const averageResolutionHours = resolutionDurations.length > 0
                ? (resolutionDurations.reduce((sum, duration) => sum + duration, 0) / resolutionDurations.length) / (1000 * 60 * 60)
                : null;

            const classificationCounts = incidents.reduce((acc, incident) => {
                const key = incident.classification && incident.classification.trim() !== ''
                    ? incident.classification.trim()
                    : 'Não classificado';
                acc[key] = (acc[key] || 0) + 1;
                return acc;
            }, {});

            const resolutionTypeCounts = incidents.reduce((acc, incident) => {
                const key = incident.resolutionType && incident.resolutionType.trim() !== ''
                    ? incident.resolutionType.trim()
                    : 'Tipo não informado';
                acc[key] = (acc[key] || 0) + 1;
                return acc;
            }, {});

            const topEntries = (countsObj, limit = 3) => Object.entries(countsObj)
                .sort((a, b) => b[1] - a[1])
                .slice(0, limit);

            const topClassifications = topEntries(classificationCounts);
            const topResolutionTypes = topEntries(resolutionTypeCounts);

            const formatHours = (hours) => {
                if (hours === null) return 'N/D';
                if (hours >= 24) {
                    const days = Math.floor(hours / 24);
                    const remaining = hours - days * 24;
                    return `${days}d ${remaining.toFixed(1)}h`;
                }
                return `${hours.toFixed(1)}h`;
            };

            const sortedIncidents = [...incidents].sort((a, b) => {
                const aDate = parseEventDateValue(a.createdAt) ?? 0;
                const bDate = parseEventDateValue(b.createdAt) ?? 0;
                return bDate - aDate;
            });

            const incidentCards = sortedIncidents.map(incident => {
                const createdAtDisplay = formatDateTimeDisplay(incident.createdAt);
                const resolvedAtDisplay = formatDateTimeDisplay(incident.resolvedAt);
                const sourceJourney = incident.sourceJourneyId && incident.sourceJourneyId !== journey.id
                    ? journeys.find(j => j.id === incident.sourceJourneyId)
                    : null;
                const durationHours = (() => {
                    const start = parseEventDateValue(incident.createdAt);
                    const end = parseEventDateValue(incident.resolvedAt);
                    if (start !== null && end !== null && end >= start) {
                        return (end - start) / (1000 * 60 * 60);
                    }
                    return null;
                })();

                return `
                    <div class="bg-slate-50 rounded-lg p-4 border border-slate-200 space-y-3">
                        <div class="flex items-start justify-between">
                            <div class="pr-4">
                                <h4 class="font-semibold text-slate-900">${incident.incidentNumber || 'Incidente sem número'}</h4>
                                <p class="text-sm text-slate-600 mt-1">${incident.shortDescription || 'Sem descrição curta informada.'}</p>
                                ${incident.description ? `<p class="text-xs text-slate-500 mt-2 whitespace-pre-line">${incident.description}</p>` : ''}
                            </div>
                            <div class="flex items-center gap-2">
                                <button onclick="openEditEvent('${journey.id}', '${incident.id}')" class="p-2 hover:bg-blue-100 rounded transition-colors text-blue-600" title="Editar incidente funcional">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deleteEvent('${journey.id}', '${incident.id}')" class="p-2 hover:bg-red-100 rounded transition-colors text-red-600" title="Excluir incidente funcional">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>

                        <div class="flex flex-wrap items-center gap-2 text-xs font-semibold">
                            ${incident.acronym ? `<span class="px-2 py-1 bg-purple-200 text-purple-800 rounded">${incident.acronym}</span>` : ''}
                            <span class="px-2 py-1 bg-slate-200 text-slate-700 rounded">${incident.classification || 'Não classificado'}</span>
                            ${incident.resolutionType ? `<span class="px-2 py-1 bg-emerald-200 text-emerald-800 rounded">${incident.resolutionType}</span>` : ''}
                            ${durationHours !== null ? `<span class="px-2 py-1 bg-blue-200 text-blue-800 rounded">Duração: ${formatHours(durationHours)}</span>` : ''}
                            ${sourceJourney ? `<span class="px-2 py-1 bg-teal-200 text-teal-800 rounded">Reportado por ${sourceJourney.name}</span>` : ''}
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-xs text-slate-600">
                            <div>
                                <span class="font-semibold text-slate-700">Criado em:</span>
                                <p class="mt-1">${createdAtDisplay}</p>
                            </div>
                            <div>
                                <span class="font-semibold text-slate-700">Resolvido em:</span>
                                <p class="mt-1">${resolvedAtDisplay}</p>
                            </div>
                            ${incident.resolutionNotes ? `
                                <div class="md:col-span-2">
                                    <span class="font-semibold text-slate-700">Notas de Resolução:</span>
                                    <p class="mt-1 text-slate-600 whitespace-pre-line">${incident.resolutionNotes}</p>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');

            return `
                <div class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center overflow-auto modal-overlay" onclick="if(event.target === this) closeFunctionalIncidentOverview()">
                    <div class="bg-white rounded-lg shadow-2xl max-w-4xl w-full m-4 modal-panel" onclick="event.stopPropagation()">
                        <div class="bg-white border-b border-slate-200 p-6 flex items-center justify-between sticky top-0">
                            <div>
                                <h2 class="text-2xl font-bold text-slate-900">Incidentes Funcionais - ${journey.name}</h2>
                                <p class="text-sm text-slate-600 mt-1">${journey.acronym} • ${totalIncidents} incidente${totalIncidents !== 1 ? 's' : ''} filtrado${totalIncidents !== 1 ? 's' : ''}</p>
                            </div>
                            <button onclick="closeFunctionalIncidentOverview()" class="p-2 hover:bg-slate-100 rounded-lg transition-colors">
                                <i class="fas fa-times text-slate-600 text-xl"></i>
                            </button>
                        </div>

                        <div class="p-6 space-y-6 overflow-y-auto max-h-[calc(85vh-120px)]">
                            ${totalIncidents === 0 ? `
                                <div class="bg-slate-50 border border-slate-200 rounded-lg p-8 text-center text-slate-600">
                                    <i class="fas fa-headset text-3xl text-slate-400 mb-3"></i>
                                    <p>Nenhum incidente funcional encontrado para os filtros aplicados.</p>
                            </div>
                            ` : `
                                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                    <div class="bg-purple-50 rounded-lg p-4 border border-purple-200">
                                        <p class="text-xs text-purple-600 mb-2 font-semibold">TOTAL</p>
                                        <div class="text-4xl font-bold text-purple-700">${totalIncidents}</div>
                                    </div>
                                    <div class="bg-emerald-50 rounded-lg p-4 border border-emerald-200">
                                        <p class="text-xs text-emerald-600 mb-2 font-semibold">RESOLVIDOS</p>
                                        <div class="text-4xl font-bold text-emerald-700">${resolvedCount}</div>
                                    </div>
                                    <div class="bg-amber-50 rounded-lg p-4 border border-amber-200">
                                        <p class="text-xs text-amber-600 mb-2 font-semibold">EM ABERTO</p>
                                        <div class="text-4xl font-bold text-amber-700">${openCount}</div>
                                    </div>
                                    <div class="bg-blue-50 rounded-lg p-4 border border-blue-200">
                                        <p class="text-xs text-blue-600 mb-2 font-semibold">TEMPO MÉDIO DE RESOLUÇÃO</p>
                                        <div class="text-lg font-bold text-blue-700">${formatHours(averageResolutionHours)}</div>
                                    </div>
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="bg-slate-50 border border-slate-200 rounded-lg p-4">
                                        <h3 class="text-sm font-semibold text-slate-800 mb-3">Classificações mais recorrentes</h3>
                                        ${topClassifications.length > 0 ? `
                                            <ul class="space-y-2 text-sm text-slate-600">
                                                ${topClassifications.map(([classification, count]) => `
                                                    <li class="flex items-center justify-between">
                                                        <span>${classification}</span>
                                                        <span class="px-2 py-1 bg-slate-200 text-slate-700 rounded text-xs font-semibold">${count}</span>
                                                    </li>
                                                `).join('')}
                                            </ul>
                                        ` : '<p class="text-sm text-slate-500">Sem classificações registradas.</p>'}
                                    </div>
                                    <div class="bg-slate-50 border border-slate-200 rounded-lg p-4">
                                        <h3 class="text-sm font-semibold text-slate-800 mb-3">Tipos de resolução</h3>
                                        ${topResolutionTypes.length > 0 ? `
                                            <ul class="space-y-2 text-sm text-slate-600">
                                                ${topResolutionTypes.map(([type, count]) => `
                                                    <li class="flex items-center justify-between">
                                                        <span>${type}</span>
                                                        <span class="px-2 py-1 bg-slate-200 text-slate-700 rounded text-xs font-semibold">${count}</span>
                                                    </li>
                                                `).join('')}
                                            </ul>
                                        ` : '<p class="text-sm text-slate-500">Sem tipos de resolução informados.</p>'}
                                    </div>
                                </div>

                                <div class="border-t border-slate-200 pt-6 space-y-4">
                                    <h3 class="font-semibold text-slate-900">Lista de Incidentes</h3>
                                    ${incidentCards}
                                </div>
                            `}

                            <div class="flex gap-3 pt-4 border-t border-slate-200">
                                <button onclick="closeFunctionalIncidentOverview()" class="flex-1 px-4 py-2 bg-purple-500 hover:bg-purple-600 text-white font-semibold rounded transition-colors">
                                    <i class="fas fa-check mr-2"></i> Fechar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        function renderVulnerabilityOverviewModal() {
            const journey = journeys.find(j => j.id === vulnerabilityOverviewJourneyId);
            if (!journey) return '';

            const bounds = getJourneyEventFilterBounds();
            const vulnerabilities = getJourneyVulnerabilities(journey, bounds);
            const total = vulnerabilities.length;
            const severityCounts = vulnerabilities.reduce((acc, vuln) => {
                const key = (vuln.severity || 'Não informada').trim();
                acc[key] = (acc[key] || 0) + 1;
                return acc;
            }, {});

            const statusCounts = vulnerabilities.reduce((acc, vuln) => {
                const key = (vuln.status || 'Não informado').trim();
                acc[key] = (acc[key] || 0) + 1;
                return acc;
            }, {});

            const averageCvss = (() => {
                const scores = vulnerabilities
                    .map(v => parseFloat(v.cvssScore))
                    .filter(score => !Number.isNaN(score));
                if (scores.length === 0) return null;
                return scores.reduce((sum, score) => sum + score, 0) / scores.length;
            })();

            const cards = vulnerabilities.sort((a, b) => {
                const aDate = parseEventDateValue(a.discoveredAt) ?? 0;
                const bDate = parseEventDateValue(b.discoveredAt) ?? 0;
                return bDate - aDate;
            }).map(vuln => `
                <div class="bg-slate-50 rounded-lg p-4 border border-slate-200 space-y-3">
                    <div class="flex items-start justify-between">
                        <div class="pr-4">
                            <h4 class="font-semibold text-slate-900">${vuln.identifier || 'Vulnerabilidade sem ID'}</h4>
                            <p class="text-sm text-slate-600 mt-1">${vuln.affectedService || ''}</p>
                            ${vuln.notes ? `<p class="text-xs text-slate-500 mt-2 whitespace-pre-line">${vuln.notes}</p>` : ''}
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="openEditEvent('${journey.id}', '${vuln.id}')" class="p-2 hover:bg-blue-100 rounded transition-colors text-blue-600" title="Editar vulnerabilidade">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteEvent('${journey.id}', '${vuln.id}')" class="p-2 hover:bg-red-100 rounded transition-colors text-red-600" title="Excluir vulnerabilidade">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="flex flex-wrap items-center gap-2 text-xs font-semibold">
                        ${vuln.severity ? `<span class="px-2 py-1 rounded bg-rose-200 text-rose-800">${vuln.severity}</span>` : ''}
                        ${vuln.status ? `<span class="px-2 py-1 rounded bg-slate-200 text-slate-700">${vuln.status}</span>` : ''}
                        ${vuln.cvssScore ? `<span class="px-2 py-1 rounded bg-amber-200 text-amber-800">CVSS ${vuln.cvssScore}</span>` : ''}
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-xs text-slate-600">
                        <div>
                            <span class="font-semibold text-slate-700">Descoberta em:</span>
                            <p class="mt-1">${formatDateTimeDisplay(vuln.discoveredAt)}</p>
                        </div>
                        <div>
                            <span class="font-semibold text-slate-700">Prazo para Correção:</span>
                            <p class="mt-1">${formatDateDisplay(vuln.dueAt)}</p>
                        </div>
                        ${vuln.owner ? `
                            <div class="md:col-span-2">
                                <span class="font-semibold text-slate-700">Responsável:</span>
                                <p class="mt-1">${vuln.owner}</p>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `).join('');

            const topSeverity = Object.entries(severityCounts).sort((a, b) => b[1] - a[1]);
            const topStatus = Object.entries(statusCounts).sort((a, b) => b[1] - a[1]);

            return `
                <div class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center overflow-auto modal-overlay" onclick="if(event.target === this) closeVulnerabilityOverview()">
                    <div class="bg-white rounded-lg shadow-2xl max-w-4xl w-full m-4 modal-panel" onclick="event.stopPropagation()">
                        <div class="bg-white border-b border-slate-200 p-6 flex items-center justify-between sticky top-0">
                            <div>
                                <h2 class="text-2xl font-bold text-slate-900">Vulnerabilidades - ${journey.name}</h2>
                                <p class="text-sm text-slate-600 mt-1">${journey.acronym} • ${total} item${total !== 1 ? 's' : ''}</p>
                            </div>
                            <button onclick="closeVulnerabilityOverview()" class="p-2 hover:bg-slate-100 rounded-lg transition-colors">
                                <i class="fas fa-times text-slate-600 text-xl"></i>
                            </button>
                        </div>
                        <div class="p-6 space-y-6 overflow-y-auto max-h-[calc(85vh-120px)]">
                            ${total === 0 ? `
                                <div class="bg-slate-50 border border-slate-200 rounded-lg p-8 text-center text-slate-600">
                                    <i class="fas fa-shield text-3xl text-slate-400 mb-3"></i>
                                    <p>Nenhuma vulnerabilidade cadastrada.</p>
                                </div>
                            ` : `
                                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                    <div class="bg-rose-50 rounded-lg p-4 border border-rose-200">
                                        <p class="text-xs text-rose-600 mb-2 font-semibold">TOTAL</p>
                                        <div class="text-4xl font-bold text-rose-700">${total}</div>
                                    </div>
                                    <div class="bg-amber-50 rounded-lg p-4 border border-amber-200">
                                        <p class="text-xs text-amber-600 mb-2 font-semibold">CVSS MÉDIO</p>
                                        <div class="text-lg font-bold text-amber-700">${averageCvss !== null ? averageCvss.toFixed(1) : 'N/D'}</div>
                                    </div>
                                    <div class="bg-blue-50 rounded-lg p-4 border border-blue-200 md:col-span-2">
                                        <p class="text-xs text-blue-600 mb-2 font-semibold">Severidades</p>
                                        ${topSeverity.length > 0 ? `
                                            <div class="flex flex-wrap gap-2">
                                                ${topSeverity.map(([severity, count]) => `
                                                    <span class="px-3 py-1 rounded-full bg-blue-100 text-blue-700 text-xs font-semibold">
                                                        ${severity}: ${count}
                                                    </span>
                                                `).join('')}
                                            </div>
                                        ` : '<p class="text-sm text-slate-500">Sem severidades informadas.</p>'}
                                    </div>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="bg-slate-50 border border-slate-200 rounded-lg p-4">
                                        <h3 class="text-sm font-semibold text-slate-800 mb-3">Status</h3>
                                        ${topStatus.length > 0 ? `
                                            <ul class="space-y-2 text-sm text-slate-600">
                                                ${topStatus.map(([status, count]) => `
                                                    <li class="flex items-center justify-between">
                                                        <span>${status}</span>
                                                        <span class="px-2 py-1 bg-slate-200 text-slate-700 rounded text-xs font-semibold">${count}</span>
                                                    </li>
                                                `).join('')}
                                            </ul>
                                        ` : '<p class="text-sm text-slate-500">Sem status informados.</p>'}
                                    </div>
                                    <div class="bg-slate-50 border border-slate-200 rounded-lg p-4">
                                        <h3 class="text-sm font-semibold text-slate-800 mb-3">Ações recomendadas</h3>
                                        <p class="text-sm text-slate-600">
                                            Priorize vulnerabilidades críticas, acompanhe o prazo de correção e registre as evidências de remediação.
                                        </p>
                                    </div>
                                </div>
                                <div class="border-t border-slate-200 pt-6 space-y-4">
                                    <h3 class="font-semibold text-slate-900">Lista de Vulnerabilidades</h3>
                                    ${cards}
                                </div>
                            `}
                            <div class="flex gap-3 pt-4 border-t border-slate-200">
                                <button onclick="closeVulnerabilityOverview()" class="flex-1 px-4 py-2 bg-rose-500 hover:bg-rose-600 text-white font-semibold rounded transition-colors">
                                    <i class="fas fa-check mr-2"></i> Fechar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderIntegraPage() {
            const registeredItems = cmdbData.length;
            return `
                <header class="bg-white border-b border-slate-200 shadow-sm sticky top-0 z-40">
                    <div class="max-w-7xl mx-auto px-6 py-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <h1 class="text-3xl font-bold text-slate-900">Integrações e CMDB</h1>
                                <p class="text-slate-600 mt-1 text-sm">Central de integrações com ServiceNow e ativos CMDB</p>
                            </div>
                            <nav class="flex items-center gap-3" aria-label="Navegação principal">
                                <button onclick="navigateTo('dashboard')" class="px-3 py-2 bg-indigo-500 hover:bg-indigo-600 text-white font-semibold rounded transition-colors text-sm">
                                    <i class="fas fa-home mr-1"></i> Dashboard
                                </button>
                            </nav>
                        </div>
                    </div>
                </header>
                <main class="max-w-7xl mx-auto px-6 py-8 space-y-6">
                    <div class="bg-white rounded-lg shadow-md border-2 border-slate-200 p-6">
                        <h2 class="text-xl font-bold text-slate-900 mb-2">Status das Integrações</h2>
                        <p class="text-sm text-slate-600">Funcionalidade em evolução. Utilize esta área para acompanhar configurações de ServiceNow, importar dados de CMDB e monitorar conexões.</p>
                        <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="bg-slate-50 border border-slate-200 rounded-lg p-4">
                                <p class="text-xs text-slate-500 uppercase tracking-wide mb-1">Itens CMDB cadastrados</p>
                                <div class="text-3xl font-bold text-slate-900">${registeredItems}</div>
                            </div>
                            <div class="bg-slate-50 border border-slate-200 rounded-lg p-4">
                                <p class="text-xs text-slate-500 uppercase tracking-wide mb-1">ServiceNow</p>
                                <div class="text-sm text-slate-700">${servicenowApiConfig.instanceUrl ? 'Configuração salva' : 'Configuração pendente'}</div>
                            </div>
                            <div class="bg-slate-50 border border-slate-200 rounded-lg p-4">
                                <p class="text-xs text-slate-500 uppercase tracking-wide mb-1">Próximos passos</p>
                                <div class="text-sm text-slate-700">Importação de planilha CMDB e automação de chamadas</div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-slate-50 border border-dashed border-slate-300 rounded-lg p-6 text-center text-slate-600 text-sm">
                        Esta seção está em construção. Compartilhe requisitos adicionais para priorizarmos a evolução.
                    </div>
                </main>
            `;
        }
        function render() {
            const app = document.getElementById('app');
            if (!app) return;

            const pageRenderers = {
                dashboard: renderDashboardPage,
                fronts: renderFrontsPage,
                journeys: renderJourneysPage,
                okrs: renderOKRsPage,
                indicators: renderIndicatorsPage,
                projects: renderProjectsPage,
                adjustments: renderAdjustmentsPage,
                executivo: renderExecutivoPanelPage,
                integra: renderIntegraPage
            };

            const pageLabels = {
                dashboard: 'Dashboard Executivo',
                fronts: 'Frentes de Engenharia',
                journeys: 'Maturidade de Jornadas',
                okrs: 'OKRs da Organização',
                indicators: 'Evolução de Indicadores',
                projects: 'Projetos Estratégicos',
                adjustments: 'Ajustes e Utilitários',
                executivo: 'Painel Executivo',
                integra: 'Integrações e CMDB'
            };

            const renderer = pageRenderers[currentPage] || renderDashboardPage;
            const html = renderer();
            app.innerHTML = html;

            const ariaLiveRegion = document.getElementById('aria-live-region');
            if (ariaLiveRegion) {
                ariaLiveRegion.textContent = `Página atual: ${pageLabels[currentPage] || 'Dashboard Executivo'}.`;
            }
        }

        render();
    </script>
</body>
</html>
         function renderRiskOverviewModal() {